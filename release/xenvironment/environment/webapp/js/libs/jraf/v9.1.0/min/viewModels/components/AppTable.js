define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/utils/ValidationUtils","jraf/utils/KeyboardUtils","jraf/models/components/MultipleSortDataSource","jraf/models/UIShellManager","ojs/ojknockout","jraf/utils/CustomBindings","ojs/ojcomponentcore","ojs/ojdatagrid","ojs/ojcollectiondatagriddatasource","ojs/ojarraydatagriddatasource","ojs/ojselectcombobox","ojs/ojbutton","ojs/ojmenu","ojs/ojtoolbar","ojs/ojdialog","ojs/ojradioset","ojs/ojpagingdatagriddatasource","ojs/ojpagingcontrol","ojs/ojvalidation-datetime","ojs/ojconveyorbelt"],(function(t,e,i,a,n,o,r,s){"use strict";c.DATA_TYPE_STRING="string",c.DATA_TYPE_ICON="icon",c.DATA_TYPE_DATE="date",c.DATA_TYPE_CUSTOM="custom",c.CREATE_PATTERN="create",c.ADD_PATTERN="add",c.DEFAULT_CREATE_ICON="jraf-create-icon",c.DEFAULT_ADD_ICON="jraf-add-icon",c.DEFAULT_DUPLICATE_ICON="jraf-duplicate-icon",c.DEFAULT_EDIT_ICON="jraf-edit-icon",c.DEFAULT_VIEW_ICON="jraf-view-icon",c.DEFAULT_DELETE_ICON="jraf-delete-icon",c.DEFAULT_ROW_HEADER_CLASS="jraf-appTable-default-row-header",c.SORTS_LIMIT=3;var l=t.Translations.getTranslatedString;function c(i){var o=this;if(!(n.isObjectStrict(i)&&i.collection instanceof t.Collection&&n.isArray(i.columns)&&n.isNonemptyString(e.unwrap(i.label))&&n.isFunction(i.handleRefresh)))throw new TypeError("AppTable: Invalid parameters");var s=i.createPatternType===c.ADD_PATTERN;this.createPattern=s?c.ADD_PATTERN:c.CREATE_PATTERN,this.cellTemplateId=a.UIShell.generateUniqueId(),this.wrapperId=a.UIShell.generateUniqueId(),this.actionMenuId=a.UIShell.generateUniqueId(),this.viewMenuId=a.UIShell.generateUniqueId(),this.detachButtonId=a.UIShell.generateUniqueId(),this.detachDialogId=a.UIShell.generateUniqueId(),this.dataGridId=a.UIShell.generateUniqueId(),this.toolbarId=a.UIShell.generateUniqueId(),this.sortDialogId=a.UIShell.generateUniqueId(),this.sortFormId=a.UIShell.generateUniqueId(),this.tableHeaderTemplateId=a.UIShell.generateUniqueId(),this.appTableId=a.UIShell.generateUniqueId(),this.pagingControlId=a.UIShell.generateUniqueId(),this.dialogAnchorId=a.UIShell.generateUniqueId(),this.actionMenuLabel=l("jraf.appTable.actionMenuLabel"),this.viewMenuLabel=l("jraf.appTable.viewMenuLabel"),this.sortMenuLabel=l("jraf.appTable.sortLabel"),this.queryMenuLabel=l("jraf.appTable.queryLabel"),this.attachButtonLabel=l("jraf.appTable.attachLabel"),this.detachButtonLabel=l("jraf.appTable.detachLabel"),this.createButtonLabel=l(s?"jraf.appTable.addLabel":"jraf.appTable.createLabel"),this.duplicateButtonLabel=l("jraf.appTable.duplicateLabel"),this.editButtonLabel=l("jraf.appTable.editLabel"),this.viewButtonLabel=l("jraf.appTable.viewLabel"),this.deleteButtonLabel=l("jraf.appTable.deleteLabel"),this.refreshButtonLabel=l("jraf.appTable.refreshLabel"),this.exportButtonLabel=l("jraf.appTable.exportLabel"),this.ascendingLabel=l("jraf.appTable.ascending"),this.descendingLabel=l("jraf.appTable.descending"),this.cancelLabel=l("jraf.common.cancel"),this.applyLabel=l("jraf.common.ok"),this.detachDialogTitle=i.title||l("jraf.appTable.defaultDetachTitle"),this.msgNoData=i.msgNoData,this.dateFormatter=t.Validation.converterFactory("datetime").createConverter({formatType:"datetime",dateFormat:"short",timeFormat:"medium"}),this.label=i.label,this.tableClassNames="jraf-app-table ",n.isNonemptyString(i.tableClassNames)&&(this.tableClassNames+=i.tableClassNames),this.tableStyle=i.tableStyle,this.selectMode=i.multipleSelect?"multiple":"single",this.selection=e.isObservable(i.selection)&&n.isArray(i.selection())?i.selection:e.observableArray([]),n.isFunction(i.selectionListener)&&(this.selectionListener=i.selectionListener),this.selectChange=function(t,e){o.Rn(t,e)},this.Mn=n.getBoolean(i.disableSorting,!1),this.Xn=i.collection,this.zn(i.columns),this.An=i.rowHeaderClassNameFunction,this.Wn=i.rowHeaderStyleFunction;var h={columns:this.columnNames,rowHeader:i.rowHeader};this.dataSource=new r(this.Xn,h),i.usePagingControls&&(this.renderPageControl=i.usePagingControls,this.tableClassNames+=" jraf-paginated",this.dataSource=new t.PagingDataGridDataSource(this.dataSource),this.pageSize=this.Xn.fetchSize),this.Xn.on(t.Events.EventType.ALLADDED,(function(){o.Gn()})),this.W(),this.closeDetachDialog=function(){o.Gt()},this.prepareCell=function(t){return o.lr(t)},this.getCellClass=function(t){return o.dr(t)},this.getCellStyle=function(t){return o.vr(t)},this.prepareColumn=function(t){return o.Kf(t.data)},this.getColumnHeaderClass=function(t){return o.ur(t)},this.getColumnHeaderStyle=function(t){return o.cr(t)},this.getRowHeaderClass=function(t){return o.fr(t)},this.getRowHeaderStyle=function(t){return o.ar(t)},this.getSortableValue=function(t){return o.hr(t)},this.detachOpen=e.observable(!1),this.queryRowActive=e.observable(!1),this.tt(i.actionMenu),this.createIcon=s?c.DEFAULT_ADD_ICON:c.DEFAULT_CREATE_ICON,this.duplicateIcon=c.DEFAULT_DUPLICATE_ICON,this.editIcon=c.DEFAULT_EDIT_ICON,this.viewIcon=c.DEFAULT_VIEW_ICON,this.deleteIcon=c.DEFAULT_DELETE_ICON,this.handleCreate=n.isFunction(i.handleCreate)&&i.handleCreate,this.handleDuplicate=n.isFunction(i.handleDuplicate)&&i.handleDuplicate,this.handleEdit=n.isFunction(i.handleEdit)&&i.handleEdit,this.handleView=n.isFunction(i.handleView)&&i.handleView,this.handleDelete=n.isFunction(i.handleDelete)&&i.handleDelete,this.hasCrud=!!(this.handleCreate||this.handleDuplicate||this.handleEdit||this.handleView||this.handleDelete),this.disableCreate=i.disableCreate||!1,this.disableDuplicate=i.disableDuplicate||!1,this.disableEdit=i.disableEdit||!1,this.disableView=i.disableView||!1,this.disableDelete=i.disableDelete||!1,this.disableRefresh=i.disableRefresh||!1,this.disableExport=i.disableExport||!1,this.handleRefresh=function(){i.handleRefresh()},this.exportHandler=i.handleExport,n.isFunction(this.exportHandler)&&(this.handleExport=function(t,e){o.exportHandler(t,e)}),this.customButtons=e.observableArray([]),i.extraButtons&&this.customButtons(this.li(i.extraButtons)),this.hasCustomButtons=e.pureComputed((function(){return 0<o.customButtons().length})),this.it()}return c.prototype.it=function(){this.bi().filter(this.vi,this).forEach(this.pi,this)},c.prototype.bi=function(){var t=this.mi();return this.renderActionMenu&&(t=t.concat(this.ji("actionMenuItems"))),this.hasCustomButtons()&&(t=t.concat(this.ji("customButtons"))),t},c.prototype.mi=function(){return[this.disableCreate,this.disableDuplicate,this.disableEdit,this.disableView,this.disableDelete,this.disableRefresh,this.disableExport]},c.prototype.ji=function(t){return this[t]().map((function(t){return t.disabled}))},c.prototype.vi=function(t){return e.isObservable(t)},c.prototype.pi=function(t){var e=this;t.subscribe((function(){e.gi()}))},c.prototype.gi=function(){i("#"+this.toolbarId).ojToolbar("refresh")},c.prototype.tt=function(t){var i=this,a=t||[];this.renderActionMenu=0<a.length,this.renderActionMenu&&(this.actionMenuItems=e.observableArray(this.si(this.actionMenuId,a))),this.viewMenuCallbacks=[{callback:function(){i.toggleDetachTable()}},{callback:function(){i.openSortDialog()}}],this.actionMenuSelect=function(t,e){i.hi(i.actionMenuItems(),e)},this.viewMenuSelect=function(t,e){i.hi(i.viewMenuCallbacks,e)}},c.prototype.Jf=function(){var t=this.dataSource.getCapability("sort");return"full"===t||"column"===t},c.prototype.Qf=function(){var t=this.columns();this.sortableColumns=[];for(var e=this.Jf(),i=0;i<t.length;i++){var a=t[i],o=a.sortable;e&&n.getBoolean(o,!0)&&this.sortableColumns.push({value:a.value,label:a.label})}},c.prototype.W=function(){this.sortByFirstLabel=l("jraf.appTable.sortFirstLabel"),this.sortByLaterLabel=l("jraf.appTable.sortSecondLabel"),this.sortCriteria=[];for(var t=0;t<c.SORTS_LIMIT;t++)this.sortCriteria.push({label:0===t?this.sortByFirstLabel:this.sortByLaterLabel,column:e.observableArray([]),direction:e.observable("asc")});this.Qf(),this.renderSortButton=0<this.sortableColumns.length},c.prototype.zn=function(t){this.columns=e.observableArray([]),this.columnNames=[],this.columnHeaders={};for(var i=0;i<t.length;i++){var a=t[i],n=a.label||a.valueName;this.columns.push({value:a.valueName,label:n,typeInfo:a.dataType||c.DATA_TYPE_STRING,callback:a.callback,width:a.width,cellAlignment:a.cellAlignment,headerClassNameFunction:a.headerClassNameFunction,headerStyleFunction:a.headerStyleFunction,cellClassNameFunction:a.cellClassNameFunction,cellStyleFunction:a.cellStyleFunction,customRenderer:a.customRenderer,sortable:!this.Mn&&a.sortable}),this.columnNames.push(t[i].valueName),this.columnHeaders[t[i].valueName]=n}},c.prototype.si=function(t,e){for(var i=[],a=0;a<e.length;a++){var n={id:t+"-entry-"+(a+1),label:e[a].label,callback:e[a].callback,icon:e[a].icon,disabled:e[a].disabled};i.push(n)}return i},c.prototype.li=function(t){for(var e=[],i=0;i<t.length;i++)e.push(this.di(t[i]));return e},c.prototype.hi=function(t,e){var a=e.item[0];(0,t[i(a).prevAll().length].callback)()},c.prototype.toggleDetachTable=function(){if(this.detachOpen())i("#"+this.detachDialogId).ojDialog("close");else{var e=i("#"+this.appTableId);t.Components.subtreeDetached(e.get(0)),e.appendTo("#"+this.dialogAnchorId),t.Components.subtreeAttached(e.get(0)),i("#"+this.detachDialogId).ojDialog("open"),this.detachOpen(!0)}},c.prototype.Gt=function(){var e=i("#"+this.appTableId);t.Components.subtreeDetached(e.get(0)),e.appendTo("#"+this.wrapperId),t.Components.subtreeAttached(e.get(0)),this.detachOpen(!1)},c.prototype.toggleQueryRow=function(){this.queryRowActive(!this.queryRowActive())},c.prototype.Ft=function(){var t=this.Xn.sortCriteria;n.isArray(t)||(t=[]);for(var e=Math.min(t.length,c.SORTS_LIMIT),i=0;i<e;i++){var a=t[i],o=this.sortCriteria[i];o.column([a.column]),o.direction(a.direction)}for(i=e;i<this.sortCriteria.length;i++)this.sortCriteria[i].column([]),this.sortCriteria[i].direction("asc")},c.prototype.openSortDialog=function(){this.Ft(),i("#"+this.sortDialogId).ojDialog("open")},c.prototype.closeSortDialog=function(){i("#"+this.sortDialogId).ojDialog("close")},c.prototype.executeSortDialog=function(){if(-1===this.Xn.fetchSize)this.Xn.comparator=this.G();else{var t=this.Nt();if(0===t.length)return void this.closeSortDialog();this.Xn.sortCriteria=t,this.Xn.comparator=t[0].column}this.Xn.sort(),this.Gn(),this.closeSortDialog()},c.prototype.Nt=function(){for(var t=[],e=this.sortCriteria,i=0;i<e.length;){var a=e[i].column()[0],n=e[i].direction();a&&t.push({column:a,direction:n}),i++}return t},c.prototype.G=function(){var t=this;return function(e,i){for(var a=0,n=t.sortCriteria,o=0;o<n.length&&0===a;){var r=n[o].column();a=("asc"===n[o].direction()?1:-1)*t.H(e.attributes[r],i.attributes[r]),o++}return a}},c.prototype.H=function(t,e){return e<t?1:t<e?-1:0},c.prototype.di=function(t){var i={component:"ojButton"};return t.icon&&(i.icons={start:"oj-icon "+t.icon}),t.iconOnly&&(i.display="icons"),i.label=t.label,i.disabled=!!n.isBoolean(e.unwrap(t.disabled))&&t.disabled,{button:i,buttonHandler:t.buttonHandler}},c.prototype.Gn=function(){i("#"+this.dataGridId).ojDataGrid("refresh")},c.prototype.Rn=function(t,e){this.selectionListener&&"selection"===e.option&&this.selectionListener(e.value)},c.prototype.Kf=function(t){return this.columnHeaders[t]},c.prototype.lr=function(e){var a=this.Fr(e),r=a.callback,s=a.typeInfo;if(r){var l=i(e.parentElement).parents(".oj-datagrid-cell").first();l.click((function(t){r(t,e)})),l.on("keydown",(function(t){o.isEnterKey(t)&&r(t,e)}))}if(s!==c.DATA_TYPE_ICON)return s===c.DATA_TYPE_DATE&&e.data?this.dateFormatter.format(t.IntlConverterUtils.dateToLocalIso(e.data)):s===c.DATA_TYPE_CUSTOM&&n.isFunction(a.customRenderer)?a.customRenderer(e):e.data;var h=e.data;if(!n.isObjectStrict(h)||!n.isNonemptyString(h.icon)||!n.isNonemptyString(h.label))return"";var u=document.createElement("span");return u.classList.add("jraf-appTable-cell-icon"),u.classList.add(h.icon),u.title=h.label,u.setAttribute("aria-label",h.label),u.setAttribute("role","img"),u},c.prototype.dr=function(t){var e=this.Fr(t),i=this.Cr(e);return n.isFunction(e.cellClassNameFunction)&&(i+=" "+e.cellClassNameFunction(t)),i},c.prototype.vr=function(t){var e=this.Fr(t),i="";return n.isFunction(e.cellStyleFunction)&&(i=e.cellStyleFunction(t)),i},c.prototype.ur=function(t){var e=this.Fr(t),i=this.Cr(e);return n.isFunction(e.headerClassNameFunction)&&(i+=" "+e.headerClassNameFunction(t)),i},c.prototype.cr=function(t){var e=this.Fr(t),i="";return n.isNonemptyString(e.width)&&(i+="width:"+e.width+";"),n.isFunction(e.headerStyleFunction)&&(i+=e.headerStyleFunction(t)),i},c.prototype.fr=function(t){var e=c.DEFAULT_ROW_HEADER_CLASS;return n.isFunction(this.An)&&(e=this.An(t)),e},c.prototype.ar=function(t){var e="";return n.isFunction(this.Wn)&&(e+=this.Wn(t)),e},c.prototype.hr=function(t){var e=this.Fr(t);return n.isBoolean(e.sortable)?e.sortable?"enable":"disable":"auto"},c.prototype.Fr=function(t){var e=n.isNumberStrict(t.index)?t.index:t.indexes.column;return this.columns()[e]},c.prototype.Cr=function(t){if(t.typeInfo===c.DATA_TYPE_ICON||t.typeInfo===c.DATA_TYPE_DATE)return"oj-helper-justify-content-center";var e=t.cellAlignment;return"start"===e||"left"===e?"oj-helper-justify-content-flex-start":"end"===e||"right"===e?"oj-helper-justify-content-flex-end":"center"===e?"oj-helper-justify-content-center":"oj-helper-justify-content-flex-end"},c}));