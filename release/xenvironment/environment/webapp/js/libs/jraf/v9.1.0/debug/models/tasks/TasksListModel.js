define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/models/UIShellManager","jraf/models/Content","jraf/models/favorites/FavoritesContent","jraf/utils/ValidationUtils","ojs/ojarraytreedataprovider"],(function(t,e,n,s,o,a,i,r){"use strict";var l=t.Translations.getTranslatedString;function d(t){if(!i.isObjectStrict(t)||!i.isFunction(t.getTasks))throw new TypeError("TasksListModel: Missing required getTasks callback");this.homeNodeId=n.UIShell.generateUniqueId(),this._hierarchyDrillPath=e.observableArray([]),this._drilledNode=e.observable({id:this.homeNodeId,label:l("jraf.sidebar.home"),isHome:!0}),this._getTasks=t.getTasks,this._taskId=t.taskId,this._tasksDataPromise=this._taskId?s.getDataPromise(this._taskId):this._getTasks(),this._sourceTasksData=null,this._sourceTasksContent=null,this._favoritesEnabled=!!t.favoritesEnabled,this._favoritesEnabled&&(this._favoritesType=t.favoritesType,this._favoritesContent=a.getInstance()),this._menuContentMap=null,this._menuContentIdsMap={},this._menuData=e.observable(null),this._menuDataLoaded=e.observable(!1),this._handleLoadingTasks()}return d.prototype._handleLoadingTasks=function(){var t=this;return s.startProcessingIndicator(),t._tasksDataPromise.then((function(e){t._handleSuccessfulGetTasks(e)})).catch((function(e){t._handleFailedGetTasks(e)}))},d.prototype._handleSuccessfulGetTasks=function(e){if(t.Logger.info("TasksListModel._handleSuccessfulGetTasks: Entering."),"object"==typeof e&&null!==e){this._sourceTasksData=e;try{this._sourceTasksContent=new o(e)}catch(e){t.Logger.warn("TasksListModel._handleSuccessfulGetTasks: invalid data returned."),this._sourceTasksData=null,this._sourceTasksContent=null}this._sourceTasksContent instanceof o&&(this._menuContentMap=this._buildContentMap(this._sourceTasksContent,{}),this._refreshMenuData(this._sourceTasksContent))}this._menuDataLoaded(!0),s.stopProcessingIndicator()},d.prototype._buildContentMap=function(t,e){if(e[t.getId()]=t,t.isFolder())for(var n=t.getChildren(),s=0;s<n.length;s++){var o=n[s];this._buildContentMap(o,e)}return e},d.prototype._refreshMenuData=function(t){for(var e=[],n=t.getChildren(),s=0;s<n.length;s++){var o=n[s],a=this._processMenuContent(o);e.push(a)}this._menuData(new r(e,{keyAttributes:"attr.id"}))},d.prototype._processMenuContent=function(t){var e=this,s=n.UIShell.generateUniqueId();this._menuContentIdsMap[s]=t.getId();var o={attr:{id:s,label:t.getTitle(),isSection:t.isSection(),isFavorite:this._favoritesEnabled&&this._favoritesContent.trackFavoriteState(t.getId()),toggleFavoriteSelection:function(t,n){e._toggleFavoriteSelection(n.data.attr)}}};if(t.isFolder()){for(var a=[],i=t.getChildren(),r=0;r<i.length;r++){var l=i[r],d=this._processMenuContent(l);a.push(d)}o.children=a,o.attr.isFolder=!0}return o},d.prototype._handleFailedGetTasks=function(e){t.Logger.warn("TasksListModel._handleFailedGetTasks: failed loading data with reason "+e),s.stopProcessingIndicator()},d.prototype.getUIContent=function(t){var e=this._menuContentIdsMap[t];if(!e)throw new Error("TasksListModel.getContent: no record for UI id: "+t);return this.getContent(e)},d.prototype.getContent=function(t){var e=this._menuContentMap[t];if(!(e instanceof o))throw new Error("TasksListModel.getContent: no content record for content id: "+t);return e},d.prototype.handleMenuBeforeExpand=function(e){var n=this.getUIContent(e);return t.Logger.info("TasksListModel.handleMenuBeforeExpand: Expanding %s (%s).",e,n.getId()),this._pushDrillPathState({id:e,label:n.getTitle(),isHome:!1}),!0},d.prototype.handleMenuBeforeCollapse=function(e){var n=this.getUIContent(e);return t.Logger.info("TasksListModel.handleMenuBeforeCollapse: Collapsing %s (%s).",e,n.getId()),this._popDrillPathState(),!0},d.prototype._pushDrillPathState=function(t){this._drilledNode().id!==t.id&&(this._hierarchyDrillPath.push(this._drilledNode()),this._drilledNode(t))},d.prototype._popDrillPathState=function(){var t=this._hierarchyDrillPath.pop();this._drilledNode(t)},d.prototype.getHierarchyDrillPath=function(){return this._hierarchyDrillPath},d.prototype.getDrilledNode=function(){return e.pureComputed((function(){return this._drilledNode()}),this)},d.prototype.getRootContent=function(){return this._sourceTasksContent},d.prototype.getMenuData=function(){return this._menuData},d.prototype.getMenuDataLoaded=function(){return e.pureComputed((function(){return this._menuDataLoaded()}),this)},d.prototype.isFavoritesEnabled=function(){return this._favoritesEnabled},d.prototype._toggleFavoriteSelection=function(t){t.isFavorite()?this._favoritesContent.removeFavorite(this._menuContentIdsMap[t.id]):this._favoritesContent.addFavorite(this._menuContentIdsMap[t.id],t.label,this._favoritesType)},d}));