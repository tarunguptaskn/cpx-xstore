define(["jraf/utils/ValidationUtils"],(function(e){"use strict";function t(t){if(!e.isObjectStrict(t)||!e.isNonemptyString(t.dbName))throw new TypeError("OfflineCache: Missing required parameters");this._openDB(t)}return t._instances={},t.prototype._openDB=function(e){var t=this;this._dbReady=new Promise((function(n,r){var o=window.indexedDB.open(e.dbName,e.dbVersion),i={modifiedDB:!1};o.onupgradeneeded=function(n){t._initializeDB(n,e),i.modifiedDB=!0},o.onsuccess=function(e){t._db=e.target.result,n(i)},o.onerror=function(e){r(e.target.error)}}))},t.prototype._initializeDB=function(e,t){var n=this,r=e.target.result,o=e.target.transaction,i=t.tables,a=[];i.forEach((function(e){a.push(e.name),r.objectStoreNames.contains(e.name)?n._updateTable(o,e):n._createTable(r,e)}));for(var s=0;s<r.objectStoreNames.length;s++)a.indexOf(r.objectStoreNames[s])<0&&r.deleteObjectStore(r.objectStoreNames[s])},t.prototype._createTable=function(e,t){var n=e.createObjectStore(t.name,{keyPath:t.pk});t.columns.forEach((function(e){n.createIndex(e.name,e.name,{unique:e.unique,multiEntry:!0})}))},t.prototype._updateTable=function(e,t){var n=e.objectStore(t.name),r=[];t.columns.forEach((function(e){r.push(e.name),n.indexNames.contains(e.name)||n.createIndex(e.name,e.name,{unique:e.unique,multiEntry:!0})}));for(var o=0;o<n.indexNames.length;o++)r.indexOf(n.indexNames[o])<0&&n.deleteIndex(n.indexNames[o])},t.prototype.whenReady=function(){return this._dbReady},t.prototype._handleTransactionResult=function(e){return new Promise((function(t,n){e.oncomplete=function(){t()},e.onerror=function(e){n(e.target.error)}}))},t.prototype.upsertRow=function(e,t){var n=this._db.transaction(e,"readwrite");return n.objectStore(e).put(t),this._handleTransactionResult(n)},t.prototype.deleteRow=function(e,t){var n=this._db.transaction(e,"readwrite");return n.objectStore(e).delete(t),this._handleTransactionResult(n)},t.prototype.upsertRows=function(e,t){var n=this._db.transaction(e,"readwrite"),r=n.objectStore(e);return t.forEach((function(e){r.put(e)})),this._handleTransactionResult(n)},t.prototype.deleteRows=function(e,t){var n=this._db.transaction(e,"readwrite"),r=n.objectStore(e);return t.forEach((function(e){r.delete(e)})),this._handleTransactionResult(n)},t.prototype._handleCursorResult=function(e){return new Promise((function(t,n){var r=[];e.onsuccess=function(e){var n=e.target.result;n?(r.push(n.value),n.continue()):t(r)},e.onerror=function(e){n(e.target.error)}}))},t.prototype.getRows=function(e,t,n){var r=this._db.transaction(e,"readonly").objectStore(e);if(n&&n!==r.keyPath){var o=r.index(n);return this._handleCursorResult(o.openCursor(t))}return this._handleCursorResult(r.openCursor(t))},t.prototype.queryRows=function(t,n){if(!e.isFunction(n))return Promise.reject(new TypeError("OfflineCache.queryRows: queryFunc must be a function"));var r=this._db.transaction(t,"readonly").objectStore(t).openCursor(),o=[];return new Promise((function(e,t){r.onsuccess=function(t){var r=t.target.result;if(r){var i=r.value;n(i)&&o.push(i),r.continue()}else e(o)},r.onerror=function(e){t(e.target.error)}}))},t.getInstance=function(e){var n=e.dbName;return t._instances[n]||(t._instances[n]=new t(e)),t._instances[n]},t}));