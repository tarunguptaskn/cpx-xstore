define(["jquery","ojs/ojcore","knockout","jraf/jrafcore","jraf/models/favorites/FavoritesContent","jraf/models/favorites/FavoritesConfig","jraf/models/favorites/PinnedFavoritesState","jraf/models/UIShellManager","jraf/utils/ValidationUtils","ojs/ojmodule-element-utils","jraf/composites/oj-rgbu-jraf-apps-panel-bar/loader","jraf/composites/oj-rgbu-jraf-snackbar/loader","ojs/ojtreeview","ojs/ojbutton","ojs/ojtoolbar","ojs/ojdialog","ojs/ojlabel","ojs/ojinputtext","ojs/ojvalidation-base","ojs/ojknockout-validation","ojs/ojmodel","ojs/ojmenu","ojs/ojvalidationgroup","ojs/ojmodule-element","ojs/ojformlayout"],(function(t,e,o,i,r,a,n,s,l,v){"use strict";u.MAX_FOLDER_NAME_LENGTH=200,u.MAX_CUSTOM_NAME_LENGTH=300;var d=e.Translations.getTranslatedString;function u(t){var e=this;this.snackbarId=i.UIShell.generateUniqueId(),this.av=a.getInstance().getFavoriteHandler(t.favoriteHandlerKey),this.Al=r.getInstance(this.av.getFavoritesService(),t.favoriteHandlerKey),this.hidePinnedFavorites=l.getBoolean(t.hidePinnedFavorites,!1),this.organizedFavoritesHeader=d("jraf.sidebar.favorites.organizedFavoritesHeader"),this.organizedFavoritesAriaLabel=d("jraf.sidebar.favorites.organizedFavoritesAriaLabel"),this.noFavoritesToDisplayMessage=d("jraf.sidebar.favorites.noFavoritesToDisplayMessage");var o={name:"jraf/favorites/EditPinnedFavoritesPanel",params:{favoriteHandlerKey:t.favoriteHandlerKey}};this.editPinnedFavoritesModuleConfig=v.createConfig(o),this.getLocalizedTitle=function(t){return e.fv(t)},this.getFavoriteGuid=function(t){return e.uv(t)},this.getImageClasses=function(t){return e.cv(t)},this.getPinClasses=function(t){return e.vv(t)},this.lv(),this.dv(),this.jv(),this.mv(),this.bv(),this.Al.saveCurrentOrder()}return u.prototype.lv=function(){var t=this;this.favoritesTreeId=i.UIShell.generateUniqueId(),this.favoritesTreeNodeTemplateId=i.UIShell.generateUniqueId(),this.pv(),this.favorites=this.Al.getFavorites(),this.gv(),this.hasFavorites=o.pureComputed((function(){return 0<t.favorites().length})),this.favoritesContentLoaded=this.Al.getFavoritesContentLoaded(),this.favoritesSubscription=this.favorites.subscribe((function(){t.gv(),t.Fv()})),this.favoritesSelection=o.observableArray([]),this.favoriteIsSelected=o.pureComputed((function(){return 0<t.favoritesSelection().length})),this.selectedFavoriteGuid=o.pureComputed((function(){return t.favoritesSelection()[0]})),this.selectedFavorite=o.pureComputed((function(){return t.guidToFavoriteMap[t.selectedFavoriteGuid()]})),this.selectedFavoriteIsFolder=o.pureComputed((function(){var e=t.selectedFavorite();return e&&e.isFolder})),this.handleDragStart=function(e,o){return t.Cv(e,o)},this.handleDrop=function(e,o){return t.kv(e,o)}},u.prototype.pv=function(){this.favoriteToGuidMap={},this.guidToFavoriteMap={}},u.prototype.gv=function(){var t=this;this.xv(),this.folderSubscriptions=[],this.favorites().forEach((function(e){if(e.isFolder){var o=e.children.subscribe((function(){t.Fv()}));t.folderSubscriptions.push(o)}}))},u.prototype.Fv=function(){var t=this,o=document.querySelector("#"+this.favoritesTreeId);o&&e.Context.getContext(o).getBusyContext().whenReady().then((function(){t.Pv()}))},u.prototype.Pv=function(){var t=document.querySelector("#"+this.favoritesTreeId);t&&t.refresh()},u.prototype.dv=function(){var t=this;this.doneButtonLabel=d("jraf.common.done"),this.importButtonLabel=d("jraf.sidebar.favorites.import"),this.okButtonLabel=d("jraf.common.ok"),this.cancelButtonLabel=d("jraf.common.cancel"),this.importButtonCallback=function(){t.wv()},this.doneButtonCallback=function(){t.yv()},this.okButtonCallback=function(){t.Bv()},this.cancelButtonCallback=function(){t.Dv()},this.extraActionButtons=o.pureComputed((function(){var e=[];return t.Al.hasSeededFavorites()&&e.push({label:t.importButtonLabel,callback:t.importButtonCallback}),e})),this.mainActionButtons=o.pureComputed((function(){var e=[];return 0!==t.favorites().length||t.Al.hasSeededFavorites()?(e.push({label:t.okButtonLabel,callback:t.okButtonCallback}),e.push({label:t.cancelButtonLabel,callback:t.cancelButtonCallback})):e.push({label:t.doneButtonLabel,callback:t.doneButtonCallback}),e}))},u.prototype.yv=function(){s.closeGlobalModalPage()},u.prototype.wv=function(){this.pv(),this.Al.importFavorites()},u.prototype.Bv=function(){s.closeGlobalModalPage()},u.prototype.Dv=function(){this.Al.revertOrder().then((function(){s.closeGlobalModalPage()}))},u.prototype.jv=function(){var t=this;this.favoritesToolbarId=i.UIShell.generateUniqueId(),this.toolbarEditButtonId=i.UIShell.generateUniqueId(),this.toolbarDeleteButtonId=i.UIShell.generateUniqueId(),this.toolbarCreateFolderButtonId=i.UIShell.generateUniqueId(),this.toolbarPinButtonId=i.UIShell.generateUniqueId(),this.favoritesToolbarAriaLabel=d("jraf.sidebar.favorites.favoritesToolbarAriaLabel"),this.toolbarEditButtonName=d("jraf.sidebar.favorites.toolbarEditButtonName"),this.toolbarDeleteButtonName=d("jraf.sidebar.favorites.toolbarDeleteButtonName"),this.toolbarCreateFolderButtonName=d("jraf.sidebar.favorites.toolbarCreateFolderButtonName"),this.toolbarPinButtonName=d("jraf.sidebar.favorites.toolbarPinButtonName"),this.deleteFolderConfirmMessage=d("jraf.sidebar.favorites.deleteFolderConfirmMessage"),this.noLabel=d("jraf.common.no"),this.yesLabel=d("jraf.common.yes"),this.handleEditButton=function(){t.Ev()},this.handleDeleteButton=function(){t.Nv(t.selectedFavorite())},this.handleCreateFolderButton=function(){t.Ov()},this.handlePinButton=function(){t.Tv()}},u.prototype.Ev=function(){var t=this.selectedFavorite();t.isFolder?this.Iv(t):this.Lv(t)},u.prototype.Iv=function(e){this.editFavoriteTarget=e;var o=this.av.getLocalizedTitle(e.entryId);this.folderName(o()),this.folderDialogEditMode(!0),t("#"+this.folderDialogId).ojDialog("open")},u.prototype.Lv=function(e){this.editFavoriteTarget=e;var o=this.av.getLocalizedTitle(e.entryId);this.customFavoriteName(o());var i=this.av.getLocalizedTitle(e.entryId,!0);this.originalFavoriteName(i()),t("#"+this.favoriteDialogId).ojDialog("open")},u.prototype.Nv=function(t){var e=this;if((this.editFavoriteTarget=t).isFolder){var o={message:this.deleteFolderConfirmMessage,severity:"warning",disableTimeout:!0,primaryButton:{label:this.yesLabel,callback:function(){e.Sv()}},secondaryButton:{label:this.noLabel,callback:function(){e.Av()}}};document.getElementById(this.snackbarId).openSnack(o)}else this.Mv()},u.prototype.Av=function(){document.getElementById(this.snackbarId).closeSnack()},u.prototype.Sv=function(){document.getElementById(this.snackbarId).closeSnack(),this.Mv()},u.prototype.Mv=function(){var t=this,e=this.editFavoriteTarget;this.Al.removeFavoriteById(e.entryId).then((function(){t.selectedFavorite()&&t.selectedFavorite().entryId===e.entryId&&t.favoritesSelection.removeAll()}))},u.prototype.Ov=function(){this.folderName(""),this.folderDialogEditMode(!1),t("#"+this.folderDialogId).ojDialog("open")},u.prototype.Tv=function(){var t=this.selectedFavorite();t.isPinned()?this.Al.unpinFavorite(t.entryId):this.Al.pinFavorite(t.entryId)},u.prototype.mv=function(){this.Hv(),this.Uv()},u.prototype.Hv=function(){var r=this;this.folderDialogId=i.UIShell.generateUniqueId(),this.folderNameInputId=i.UIShell.generateUniqueId(),this.createFolderDialogTitle=d("jraf.sidebar.favorites.createFolderDialogTitle"),this.editFolderDialogTitle=d("jraf.sidebar.favorites.editFolderDialogTitle"),this.folderNameInputLabel=d("jraf.sidebar.favorites.folderNameInputLabel"),this.folderDialogEditMode=o.observable(!1),this.folderDialogTitle=o.pureComputed((function(){return r.folderDialogEditMode()?r.editFolderDialogTitle:r.createFolderDialogTitle})),this.folderName=o.observable();var a=e.Validation.validatorFactory(e.ValidatorFactory.VALIDATOR_TYPE_LENGTH),n={countBy:"codePoint",max:u.MAX_FOLDER_NAME_LENGTH};this.folderNameValidators=[a.createValidator(n)],this.folderDialogTracker=i.UIShell.generateUniqueId()+"_folderDialogTracker",this.folderDialogGroupValid=o.observable(),this.handleFolderDialogCancel=function(){t("#"+r.folderDialogId).ojDialog("close")},this.handleFolderDialogOk=function(){r.Vv()},this.handleFolderDialogClose=function(){r.zv()}},u.prototype.zv=function(){document.getElementById(this.folderNameInputId).reset()},u.prototype.Vv=function(){var t=document.getElementById(this.folderDialogTracker);if("valid"!==t.valid)return t.showMessages(),void t.focusOn("@firstInvalidShown");this.folderDialogEditMode()?this._v():(this.pv(),this.qv())},u.prototype._v=function(){var e=this,o=this.editFavoriteTarget;this.Al.customizeFavoriteName(o,this.folderName()).then((function(){t("#"+e.folderDialogId).ojDialog("close")}))},u.prototype.qv=function(){var e=this;this.Al.addFolder(this.folderName()).then((function(){t("#"+e.folderDialogId).ojDialog("close")}))},u.prototype.Uv=function(){var r=this;this.favoriteDialogId=i.UIShell.generateUniqueId(),this.customFavoriteNameInputId=i.UIShell.generateUniqueId(),this.originalFavoriteNameInputId=i.UIShell.generateUniqueId(),this.favoriteDialogTitle=d("jraf.sidebar.favorites.editFavoriteDialogTitle"),this.customFavoriteNameInputLabel=d("jraf.sidebar.favorites.customFavoriteNameInputLabel"),this.originalFavoriteNameInputLabel=d("jraf.sidebar.favorites.originalFavoriteNameInputLabel"),this.customFavoriteNameHint=d("jraf.sidebar.favorites.customFavoriteNameHint"),this.customFavoriteNameError=d("jraf.sidebar.favorites.customFavoriteNameError"),this.customFavoriteName=o.observable(),this.originalFavoriteName=o.observable();var a=e.Validation.validatorFactory(e.ValidatorFactory.VALIDATOR_TYPE_LENGTH),n={countBy:"codePoint",max:u.MAX_CUSTOM_NAME_LENGTH},s={type:"regExp",options:{pattern:".*\\S+.*",hint:this.customFavoriteNameHint,messageDetail:this.customFavoriteNameError}};this.customFavoriteNameValidators=[a.createValidator(n),s],this.favoriteDialogTracker=i.UIShell.generateUniqueId()+"_favoriteDialogTracker",this.favoriteDialogGroupValid=o.observable(),this.handleFavoriteDialogClose=function(){r.Kv()},this.handleFavoriteDialogCancel=function(){t("#"+r.favoriteDialogId).ojDialog("close")},this.handleFavoriteDialogOk=function(){r.Gv()}},u.prototype.Kv=function(){document.getElementById(this.customFavoriteNameInputId).reset()},u.prototype.Gv=function(){var e=this,o=document.getElementById(this.favoriteDialogTracker);if("valid"!==o.valid)return o.showMessages(),void o.focusOn("@firstInvalidShown");var i=this.editFavoriteTarget;this.Al.customizeFavoriteName(i,this.customFavoriteName()).then((function(){t("#"+e.favoriteDialogId).ojDialog("close")}))},u.prototype.fv=function(t){return this.av.getLocalizedTitle(t.entryId)},u.prototype.uv=function(t){var e=this.favoriteToGuidMap[t.entryId];return e||(e=i.UIShell.generateUniqueId(),this.favoriteToGuidMap[t.entryId]=e,this.guidToFavoriteMap[e]=t),e},u.prototype.cv=function(t){if(t.isFolder)return"oj-treeview-item-icon";var e=n.favoriteIcons[t.favoriteType];return"jraf-favorites-treeview-icon "+(e||n.favoriteIcons.unknown)},u.prototype.vv=function(t){var e="jraf-favorites-treeview-icon";return!t.isFolder&&t.isPinned()&&(e+=" jraf-favorite-pinned-icon"),e},u.prototype.Cv=function(e,o){var i=t(e.target).parents(".oj-treeview-item").get(0);return e.dataTransfer.setDragImage(i,0,0),e.dataTransfer.dropEffect="move",!0},u.prototype.kv=function(t,e){var o=this.selectedFavorite(),i=e.item.id,r=this.guidToFavoriteMap[i],a=e.position;this.Jv(o,r,a)&&t.preventDefault()},u.prototype.Jv=function(t,e,o){var i,r,a=this.Al.getIndexOfFavorite(e.entryId);if("before"===o)i=e.parentFavItemId,r=a;else if("after"===o)i=e.parentFavItemId,r=a+1;else{if("inside"!==o&&"first"!==o||!e.isFolder)return!1;i=e.entryId,r=0}return!(t.isFolder&&i||(this.Al.reorderFavorite(t.entryId,r,i),0))},u.prototype.bv=function(){var t=this;this.favoriteContextMenuId=i.UIShell.generateUniqueId(),this.favoriteContextMenuAriaLabel=d("jraf.sidebar.favorites.favoriteContextMenuAriaLabel"),this.favoriteContextEditOption=d("jraf.sidebar.favorites.favoriteContextEditOption"),this.favoriteContextCutOption=d("jraf.sidebar.favorites.favoriteContextCutOption"),this.favoriteContextPasteBeforeOption=d("jraf.sidebar.favorites.favoriteContextPasteBeforeOption"),this.favoriteContextPasteAfterOption=d("jraf.sidebar.favorites.favoriteContextPasteAfterOption"),this.favoriteContextPasteInsideOption=d("jraf.sidebar.favorites.favoriteContextPasteInsideOption"),this.favoriteContextPinOption=d("jraf.sidebar.favorites.favoriteContextPinOption"),this.favoriteContextUnpinOption=d("jraf.sidebar.favorites.favoriteContextUnpinOption"),this.favoriteContextDeleteOption=d("jraf.sidebar.favorites.favoriteContextDeleteOption"),this.favoriteContextMenuTarget=o.observable(),this.favoriteToCut=o.observable(),this.favoriteToCutIsFolder=o.pureComputed((function(){return t.favoriteToCut()&&t.favoriteToCut().isFolder})),this.targetFavoriteIsInsideFolder=o.pureComputed((function(){return t.favoriteContextMenuTarget()&&t.favoriteContextMenuTarget().parentFavItemId})),this.preventPasteAdjacentToTarget=o.pureComputed((function(){var e=t.targetFavoriteIsInsideFolder();return!t.favoriteToCut()||t.favoriteToCutIsFolder()&&e})),this.preventPasteInsideTarget=o.pureComputed((function(){return!t.favoriteToCut()||t.favoriteToCutIsFolder()})),this.includePasteInsideMenuItem=o.pureComputed((function(){return t.favoriteContextMenuTarget()&&t.favoriteContextMenuTarget().isFolder})),this.includePinFavoriteMenuItem=o.pureComputed((function(){return t.favoriteContextMenuTarget()&&!t.favoriteContextMenuTarget().isFolder&&!t.favoriteContextMenuTarget().isPinned()})),this.includeUnpinFavoriteMenuItem=o.pureComputed((function(){return t.favoriteContextMenuTarget()&&!t.favoriteContextMenuTarget().isFolder&&t.favoriteContextMenuTarget().isPinned()})),this.favoriteContextMenuAction=function(e){t.Qv(e)},this.favoriteContextMenuBeforeOpen=function(e){t.Rv(e)},this.favoriteContextMenuActions={},this.favoriteContextMenuActions.edit=function(){t.Wv()},this.favoriteContextMenuActions.cut=function(){t.favoriteToCut(t.favoriteContextMenuTarget())},this.favoriteContextMenuActions.before=function(){t.Xv("before")},this.favoriteContextMenuActions.after=function(){t.Xv("after")},this.favoriteContextMenuActions.inside=function(){t.Xv("inside")},this.favoriteContextMenuActions.pin=function(){t.Al.pinFavorite(t.favoriteContextMenuTarget().entryId)},this.favoriteContextMenuActions.unpin=function(){t.Al.unpinFavorite(t.favoriteContextMenuTarget().entryId)},this.favoriteContextMenuActions.delete=function(){t.Yv()}},u.prototype.Qv=function(t){var e=t.target.value;this.favoriteContextMenuTarget()&&e&&this.favoriteContextMenuActions[e]()},u.prototype.Rv=function(e){var o=document.getElementById(this.favoritesTreeId),i=(t(e.detail.originalEvent.target).parents(".oj-treeview-item").get(0)||t("#"+o.currentItem)[0]).id,r=this.guidToFavoriteMap[i];this.favoriteContextMenuTarget(r),t("#"+this.favoriteContextMenuId).ojMenu("refresh")},u.prototype.Wv=function(){var t=this.favoriteContextMenuTarget();t&&(t.isFolder?this.Iv(t):this.Lv(t))},u.prototype.Xv=function(t){this.Jv(this.favoriteToCut(),this.favoriteContextMenuTarget(),t),this.favoriteToCut(void 0)},u.prototype.Yv=function(){this.favoriteToCut()&&this.favoriteToCut().entryId===this.favoriteContextMenuTarget().entryId&&this.favoriteToCut(void 0),this.Nv(this.favoriteContextMenuTarget())},u.prototype.disconnected=function(){e.Logger.info("EditFavoritesPage.disconnected: Entering."),this.favoritesSubscription&&this.favoritesSubscription.dispose(),this.xv()},u.prototype.xv=function(){this.folderSubscriptions&&this.folderSubscriptions.forEach((function(t){t.dispose()}))},u.prototype.transitionCompleted=function(){e.Logger.info("EditFavoritesPage.transitionCompleted: Entering.");var t=function(t){t.currentTarget.validate()};document.getElementById(this.folderNameInputId).addEventListener("rawValueChanged",t),document.getElementById(this.customFavoriteNameInputId).addEventListener("rawValueChanged",t)},u}));