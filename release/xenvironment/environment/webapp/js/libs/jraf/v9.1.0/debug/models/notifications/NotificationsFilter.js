define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/services/ServiceManager","jraf/utils/ValidationUtils"],(function(e,i,t,r,a){"use strict";var s=e.Translations.getTranslatedString;function o(e){var t=this;this._notificationsService=e,this._localizeConstants(),this._initializeFilterOptions(),this._initializeHierarchyOptions(),this.searchString=i.observableArray([""]),this.hierarchyLabels=i.observable({}),this.timePeriodLabels=i.observable({}),this.notificationTypeLabels=i.observable({}),this.severityLabels=i.observable({}),this.selectedTileIndex=i.observable(o.ALL_NOTIFICATIONS_TILE_INDEX).extend({notify:"always"}),Promise.all([this._hierarchyLoadPromise,this._timeLoadPromise,this._typeLoadPromise]).then((function(){t._buildLabelLookupMaps()}),(function(){t._buildLabelLookupMaps()})),this.filtersReady=this._loadPersistedCriteria()}return o._instances={},o.BASE_TIME_SELECT_OPTIONS=[{value:"-2",label:s("jraf.sidebar.notifications.timeAny")}],o.UNREAD_STATUS="U",o.READ_STATUS="R",o.SEVERITY_VALUE_NORMAL=3,o.SEVERITY_VALUE_IMPORTANT=2,o.SEVERITY_VALUE_CRITICAL=1,o.SEVERITY_CLASS_CRITICAL="jraf-severity-critical",o.SEVERITY_CLASS_MEDIUM="jraf-severity-medium",o.SEVERITY_CLASS_LOW="jraf-severity-low",o.SEVERITY_OPTIONS=[{value:o.SEVERITY_VALUE_CRITICAL,label:s("jraf.notifications.severityCritical"),class:o.SEVERITY_CLASS_CRITICAL},{value:o.SEVERITY_VALUE_IMPORTANT,label:s("jraf.notifications.severityImportant"),class:o.SEVERITY_CLASS_MEDIUM},{value:o.SEVERITY_VALUE_NORMAL,label:s("jraf.notifications.severityNormal"),class:o.SEVERITY_CLASS_LOW}],o.DEFAULT_HIERARCHY_LEVEL_TOKEN="type",o.HIERARCHY_NO_SELECTION={value:-1,label:s("jraf.notifications.groupNoSelection")},o.ALL_NOTIFICATIONS_TILE_INDEX=0,o.FILTER_TILE_INDEX=5,o.SUMMARY_TILE_INDEX=6,o.prototype._localizeConstants=function(){o.SEVERITY_OPTIONS[2].label=s("jraf.notifications.severityNormal"),o.SEVERITY_OPTIONS[1].label=s("jraf.notifications.severityImportant"),o.SEVERITY_OPTIONS[0].label=s("jraf.notifications.severityCritical"),o.HIERARCHY_NO_SELECTION.label=s("jraf.notifications.groupNoSelection"),o.BASE_TIME_SELECT_OPTIONS[0].label=s("jraf.sidebar.notifications.timeAny")},o.prototype._initializeFilterOptions=function(){var e=this;this.selectedTimePeriod=i.observable(void 0),this.timePeriodOptions=i.observableArray(o.BASE_TIME_SELECT_OPTIONS),this._timeLoadPromise=this._notificationsService.getNotificationTimes().then((function(i){e.timePeriodOptions(i)})),this.selectedNotificationTypes=i.observableArray([]),this.notificationTypeOptions=i.observableArray([]),this._typeLoadPromise=this._notificationsService.getNotificationTypes(!0).then((function(i){e.notificationTypeOptions(i)})),this.selectedSeverities=i.observableArray([]),this.severityOptions=o.SEVERITY_OPTIONS},o.prototype._initializeHierarchyOptions=function(){var t=this;this.useHierarchyOptions=i.observable(!1),this._baseHierarchyList=[o.HIERARCHY_NO_SELECTION],this.primaryHierarchySelection=i.observable(o.HIERARCHY_NO_SELECTION.value),this.secondaryHierarchySelection=i.observable(o.HIERARCHY_NO_SELECTION.value),this.primaryHierarchyOptions=i.observableArray(this._baseHierarchyList),this.secondaryHierarchyOptions=i.observableArray(this._baseHierarchyList),this.primaryHierarchySelection.subscribe((function(e){var i=e,r=t._getAvailableHierarchyLevels(t._baseHierarchyList,i);r.unshift(o.HIERARCHY_NO_SELECTION);for(var a=!1,s=0;s<r.length;s++)r[s].value===t.secondaryHierarchySelection()&&(a=!0);a||t.secondaryHierarchySelection(o.HIERARCHY_NO_SELECTION.value),t.secondaryHierarchyOptions(r)})),this._hierarchyLoadPromise=this._notificationsService.getNotificationHierarchyLevels().then((function(e){t._processHierarchyValues(e)}),(function(i){e.Logger.warn("NotificationsFilter._initializeHierarchyOptions: Unable to load hierarchy levels with reason: "+i)})),this.selectedSummaryValues={primaryGroup:i.observable(),primaryValue:i.observable(),secondaryGroup:i.observable(),secondaryValue:i.observable()}},o.prototype._processHierarchyValues=function(e){for(var i=e[0].id,t=[],r={},a=0;a<e.length;a++){var s=e[a];s.token===o.DEFAULT_HIERARCHY_LEVEL_TOKEN?(i=s.id,t.unshift({label:s.name,value:s.id})):t.push({label:s.name,value:s.id}),r[s.id]=s.parent}this._baseHierarchyList=t,this._hierarchyParentsMap=r,this.primaryHierarchyOptions(t),this.primaryHierarchySelection(i)},o.prototype._getAvailableHierarchyLevels=function(e,i){for(var t=[i],r=this._hierarchyParentsMap[i];"number"==typeof r;)t.push(r),r=this._hierarchyParentsMap[r];return e.filter((function(e){return t.indexOf(e.value)<0}))},o.prototype._buildLabelLookupMaps=function(){this.timePeriodLabels(this._mapLabels(this.timePeriodOptions)),this.notificationTypeLabels(this._mapLabels(this.notificationTypeOptions)),this.hierarchyLabels(this._mapLabels(this._baseHierarchyList.concat(o.HIERARCHY_NO_SELECTION))),this.severityLabels(this._mapLabels(o.SEVERITY_OPTIONS))},o.prototype._mapLabels=function(e){for(var t=i.unwrap(e),r={},a=0;a<t.length;a++)r[t[a].value]=t[a].label;return r},o.prototype.getFilterCriteria=function(){var e=this;return i.pureComputed((function(){return{status:o.UNREAD_STATUS,periodId:e.selectedTimePeriod(),typeIds:e.selectedNotificationTypes().length>0?e.selectedNotificationTypes():void 0,severities:e.selectedSeverities().length>0?e.selectedSeverities():void 0}}))},o.prototype.getActiveFiltersCount=function(){var e=this;return i.pureComputed((function(){var i=0;return i+=e.selectedTimePeriod()?1:0,i+=0!==e.selectedNotificationTypes().length?1:0,i+=0!==e.selectedSeverities().length?1:0}))},o.prototype.getGroupingCriteria=function(){var e=this;return i.pureComputed((function(){var i=e.selectedSummaryValues,t=e.getFilterCriteria()();return t.groupByLevelId=i.primaryGroup()[0],t.groupByHierarchyValue=i.primaryValue(),i.secondaryGroup()&&(t.thenByLevelId=i.secondaryGroup()[0],t.thenByHierarchyValue=i.secondaryValue()),t}))},o.prototype.persistCriteria=function(){var i={periodId:this.selectedTimePeriod(),typeIds:this.selectedNotificationTypes(),severities:this.selectedSeverities()};if(this.useHierarchyOptions()){var t=this.primaryHierarchySelection();t&&t!==o.HIERARCHY_NO_SELECTION.value&&(i.groupByLevelId=t);var r=this.secondaryHierarchySelection();r&&r!==o.HIERARCHY_NO_SELECTION.value&&(i.thenByLevelId=r)}this._notificationsService.persistCriteria(i).catch((function(i){e.Logger.warn("NotificationsFilter.persistCriteria: Error persisting criteria: ",i)}))},o.prototype._loadPersistedCriteria=function(){var i=this;return new Promise((function(t,r){i._notificationsService.loadCriteria().then((function(e){i.selectedTimePeriod(e.periodId?e.periodId:void 0),i.selectedNotificationTypes(e.typeIds||[]),i.selectedSeverities(e.severities||[]),i._hierarchyLoadPromise.then((function(){i.secondaryHierarchySelection(e.thenByLevelId||o.HIERARCHY_NO_SELECTION.value),e.groupByLevelId&&(i.primaryHierarchySelection(e.groupByLevelId),i.useHierarchyOptions(!0)),t()}))}),(function(i){e.Logger.warn("NotificationsFilter._loadPersistedCriteria: Failed to load persisted criteria: ",i),r()}))}))},o.getInstance=function(e){var i=a.isObjectStrict(e)?e:r.getNotificationsService(),s=t.App.getUserData(),n=s.userid,c=s.prefLang;n===o._activeUser&&c===o._activeLang||(o._instances={},o._activeUser=n,o._activeLang=c);var l=i.getServiceConfiguration(),h=o._getInstanceKey(l);return o._instances[h]instanceof o||(o._instances[h]=new o(i)),o._instances[h]},o._getInstanceKey=function(e){return e.baseUri+"|"+e.appCodes.sort().join(",")},o}));