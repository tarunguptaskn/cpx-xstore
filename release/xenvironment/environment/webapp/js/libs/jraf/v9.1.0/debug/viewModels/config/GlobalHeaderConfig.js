define(["knockout","jquery","ojs/ojcore","jraf/jrafcore","jraf/models/UIShellManager","jraf/utils/ValidationUtils","jraf/services/ServiceManager","jraf/composites/oj-rgbu-jraf-message-dialog/loader","ojs/ojinputtext","ojs/ojtoolbar","ojs/ojcolorspectrum","ojs/ojcolor","ojs/ojbutton","ojs/ojvalidation","ojs/ojknockout-validation","ojs/ojlabel","ojs/ojvalidationgroup","ojs/ojformlayout"],(function(o,e,i,t,r,a,n){"use strict";var s=i.Translations.getTranslatedString;function l(){var e=this;this.formId=t.UIShell.generateUniqueId(),this.colorSelectId=t.UIShell.generateUniqueId(),this.logoSelectId=t.UIShell.generateUniqueId(),this.errorDialogId=t.UIShell.generateUniqueId(),this.closeConfirmDialogId=t.UIShell.generateUniqueId(),this.colorSpectrumId=t.UIShell.generateUniqueId(),this.applicationNameId=t.UIShell.generateUniqueId(),this.colorLabel=s("jraf.settings.globalHeader.brandColor"),this.colorSwatchLabel=s("jraf.settings.globalHeader.colorSwatch"),this.logoLabel=s("jraf.settings.globalHeader.logo"),this.removeLogoLabel=s("jraf.settings.globalHeader.removeLogo"),this.colorSpectrumLabel=s("jraf.settings.globalHeader.colorSpectrumLabel"),this.applicationNameLabel=s("jraf.settings.globalHeader.applicationName"),this.applicationNamePlaceholder=s("jraf.settings.globalHeader.applicationNamePlaceholder"),this.toolbarLabel=s("jraf.settings.globalHeader.toolbarLabel"),this.applyLabel=s("jraf.settings.globalHeader.save"),this.cancelLabel=s("jraf.common.cancel"),this.applyCloseLabel=s("jraf.settings.globalHeader.saveClose"),this.invalidColorMessage=s("jraf.settings.globalHeader.colorError"),this.invalidFileTypeMessage=s("jraf.settings.globalHeader.logoTypeError"),this.closeConfirmMessage=s("jraf.settings.globalHeader.closeConfirmMessage"),this.defaultServiceErrorMessage=s("jraf.settings.globalHeader.serviceError"),this.applicationNameTracker=t.UIShell.generateUniqueId()+"_applicationNameTracker",this.applicationNameValid=o.observable();var r=i.Validation.validatorFactory(i.ValidatorFactory.VALIDATOR_TYPE_LENGTH),a={countBy:"codePoint",max:l.MAX_APP_NAME_LENGTH};this.applicationNameValidators=[r.createValidator(a)],this._configService=n.getGlobalAreaConfigurationService(),this.applicationName=o.observable(),this.colorString=o.observable(),this.logoFile=o.observable(),this.logoImage=o.observable(),this.hasLogo=o.pureComputed((function(){return!!e.logoImage()})),this._discardChanges=!1,this.errorDialogMessage=o.observable(),this._loadCurrentConfig(),this._initializeSpectrum(),this.removeLogo=function(){e._removeLogo()},this.submitChanges=function(){e._submitChanges()},this.submitChangesAndClose=function(){e._submitChanges().then((function(){e._closeTab()}))},this.cancelChangesAndClose=function(){e._closeTab()},this.discardChangesAndClose=function(){e._discardChanges=!0,e._closeTab()}}return l.COLOR_STRING_REGEX=/^#([\da-f]{3}|[\da-f]{6})$/i,l.LOGO_SIZE_CONVERSION_FACTOR=1048576,l.MAX_APP_NAME_LENGTH=100,l.prototype.uiShellClose=function(){this._revertChanges(),this._discardChanges=!1},l.prototype.uiShellBeforeClose=function(){return!(this._hasChanges()&&!this._discardChanges)||(this._showCloseConfirmDialog(),!1)},l.prototype._loadCurrentConfig=function(){var o=t.App.getGlobalHeaderConfig();this._globalConfig=o,this._previousConfig={logo:o.applicationIcon(),color:o.processingIndicatorColor(),maxLogoSize:o.maxLogoSize(),applicationName:o.applicationName()},this.invalidFileSizeMessage=s("jraf.settings.globalHeader.logoSizeError",[this._previousConfig.maxLogoSize]),this.logoImage(this._previousConfig.logo),this.colorString(this._previousConfig.color),this.applicationName(this._previousConfig.applicationName),this.renderProcessingIndicator=r.isRenderProcessingIndicator()},l.prototype._removeLogo=function(){this.logoImage(null)},l.prototype._submitChanges=function(){var o=this,e=document.getElementById(this.applicationNameTracker);if("valid"!==e.valid)return e.showMessages(),e.focusOn("@firstInvalidShown"),Promise.reject();var i=[];return this._previousConfig.applicationName!==this.applicationName()&&i.push(this._updateApplicationName()),a.isNonemptyString(this.logoFile())?i.push(this._updateLogo()):!this.logoImage()&&this._previousConfig.logo&&i.push(this._clearLogo()),this._previousConfig.color!==this.colorString()&&a.isNonemptyString(this.colorString())?i.push(this._updateColor()):!this.colorString()&&this._previousConfig.color&&i.push(this._clearColor()),Promise.all(i).catch((function(e){return o._showError(e),Promise.reject(e)}))},l.prototype._validateLogoFile=function(o){var e=o.get("logo");if(0!==e.type.indexOf("image/"))return this.invalidFileTypeMessage;var i=e.size/l.LOGO_SIZE_CONVERSION_FACTOR;return this._previousConfig.maxLogoSize>0&&i>this._previousConfig.maxLogoSize?this.invalidFileSizeMessage:null},l.prototype._validateColorString=function(o){return l.COLOR_STRING_REGEX.test(o)},l.prototype._updateLogo=function(){var o=this;r.startProcessingIndicator();var e=new FormData(document.getElementById(this.formId)),i=this._validateLogoFile(e);return i?(r.stopProcessingIndicator(),Promise.reject(i)):this._configService.uploadLogo(e).then((function(){o._updateGlobalApplicationIcon(e),o.logoFile(""),r.stopProcessingIndicator()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype._updateGlobalApplicationIcon=function(o){var e=this,i=o.get("logo"),t=new window.FileReader;t.addEventListener("load",(function(){e._globalConfig.applicationIcon(t.result),e.logoImage(t.result),e._previousConfig.logo=t.result})),t.readAsDataURL(i)},l.prototype._clearLogo=function(){var o=this;return r.startProcessingIndicator(),this._configService.clearLogo().then((function(){r.stopProcessingIndicator(),o._globalConfig.applicationIcon(null),o._previousConfig.logo=null}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype._updateColor=function(){var o=this;return r.startProcessingIndicator(),this._validateColorString(this.colorString())?this._configService.setProcessingIndicatorColor(this.colorString()).then((function(){r.stopProcessingIndicator(),o._globalConfig.processingIndicatorColor(o.colorString()),o._previousConfig.color=o.colorString()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)})):(r.stopProcessingIndicator(),Promise.reject(this.invalidColorMessage))},l.prototype._clearColor=function(){var o=this;return r.startProcessingIndicator(),this._configService.clearProcessingIndicatorColor().then((function(){r.stopProcessingIndicator(),o._globalConfig.processingIndicatorColor(""),o._previousConfig.color=""}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype._updateApplicationName=function(){var o=this;return r.startProcessingIndicator(),this._configService.setApplicationName(this.applicationName()).then((function(){r.stopProcessingIndicator(),o._globalConfig.applicationName(o.applicationName()),o._previousConfig.applicationName=o.applicationName()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype._showError=function(o){a.isNonemptyString(o)?this.errorDialogMessage(o):this.errorDialogMessage(this.defaultServiceErrorMessage),document.getElementById(this.errorDialogId).open()},l.prototype._hasChanges=function(){return this._previousConfig.applicationName!==this.applicationName()||this._previousConfig.logo!==this.logoImage()||this._previousConfig.color!==this.colorString()||!(this._previousConfig.logo||!this.logoFile())},l.prototype._showCloseConfirmDialog=function(){document.getElementById(this.closeConfirmDialogId).open()},l.prototype._closeTab=function(){r.closeContent()},l.prototype._revertChanges=function(){this.applicationName(this._previousConfig.applicationName),this.logoImage(this._previousConfig.logo),this.colorString(this._previousConfig.color)},l.prototype._initializeSpectrum=function(){var e=this.colorString(),t=i.Color.TRANSPARENT;a.isNonemptyString(e)&&(t=new i.Color(e)),this.spectrumSelection=o.observable(t),this.spectrumSelection.subscribe((function(){this._updateColorStringEntry()}),this),this.colorString.subscribe((function(){this._updateSpectrumSelection()}),this)},l.prototype._updateColorStringEntry=function(){var o=this.colorString(),e=this._rgbToHex(this.spectrumSelection());e!==o&&this.colorString(e)},l.prototype._updateSpectrumSelection=function(){var o=this.colorString(),e=this.spectrumSelection(),t=this._rgbToHex(e);this._validateColorString(o)&&t!==o&&this.spectrumSelection(new i.Color(o))},l.prototype._rgbToHex=function(o){var e=o.getRed(),i=o.getGreen(),t=o.getBlue();return"#"+this._channelValueToHex(e)+this._channelValueToHex(i)+this._channelValueToHex(t)},l.prototype._channelValueToHex=function(o){var e=o.toString(16).toUpperCase();return 1===e.length?"0"+e:e},l}));