define(["module","jquery","jraf/utils/ValidationUtils","jraf/services/CustomizedResourceService"],(function(n,e,r,o,i){"use strict";var t=n.config?n.config():{},u=null,a=/(^.*\/?nls\/)([^\/]*)\/?([^\/]*)/;function c(n){var e=a.exec(n);return r.isNonemptyString(e[3])?e[1]+e[3]:n}function f(){return u||(u=new Promise((function(n,e){(function(){if(t.hasOwnProperty("configPath")){var n=t.configPath;if(r.isNonemptyString(n))return new Promise((function(e,r){require(["text!"+n],(function(n){var r=JSON.parse(n);e(r)}),(function(){window.console.log("Warning: Failed to load jrafL10n configuration from: "+n),e(null)}))}))}return Promise.resolve(null)})().then((function(e){if(e&&e.hasOwnProperty("baseUri")&&e.hasOwnProperty("appCode")){var r=e.baseUri,i=e.appCode,t=e.pageSize;n(new o(i,r,t))}n(null)}))}))),u}return{load:function(n,o,i,t){(t=t||{}).isBuild?i():o([n],(function(o){(function(n,o){return new Promise((function(i,t){var u;(u=n,new Promise((function(n,e){var o,i,t=c(u),s=(o=u,i=a.exec(o),r.isNonemptyString(i[3])?i[2]:"root");f().then((function(e){e?e.getCustomizedResources(t,s).then((function(e){n(e)}),(function(e){window.console.log("Warning: jrafL10n failed to load customizations for resource "+u+": "+e),n([])})):n([])}))}))).then((function(t){if(r.isArray(t)&&0<t.length){var u=(f=n)===c(f),a=function(n,o,i){var t=o.reduce((function(n,e){for(var o=e.resourceKey,i=e.sourceText,t=o.split("."),u=n,a=null,c=!0,f=null,s=0;s<t.length;s++){if(f=t[s],!r.isNonemptyString(f)){c=!1;break}u.hasOwnProperty(f)||(u[f]={}),u=(a=u)[f]}return c&&a&&f&&(a[f]=i),n}),{});return i?e.extend(!0,n.root,t):e.extend(!0,n,t),n}(o,t,u);i(a)}else i(o);var f}))}))})(n,o).then((function(n){i(n)}))}))}}}));