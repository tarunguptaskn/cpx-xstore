define(["ojs/ojcore","knockout","jquery","ojs/ojlogger","./DashboardContent","./dashboardTile/DashboardTile","text!./dashboardTile/DashboardTile.html","jraf/composites/utils/TranslationLoaderUtil","module","ojs/ojconveyorbelt","ojs/ojmasonrylayout","ojs/ojdialog","ojs/ojlistview","ojs/ojbutton","ojs/ojoption","ojs/ojmodule","ojs/ojmodule-element","ojs/ojknockout","ojs/ojarraytabledatasource","jraf/composites/oj-rgbu-jraf-message-dialog/loader","jraf/composites/oj-rgbu-jraf-snackbar/loader"],(function(e,t,i,o,n,a,s,r,d){"use strict";function l(e){var t=this;this._initializing=l._translationLoader.getTranslations().then((function(e){t._initializeTranslations(e)})),this._initialize(e)}return l.TILE_WIDTH=183,l.UNLIMITED_TILES=0,l.DEFAULT_TILE_DISPLAY_LIMIT=12,l.SCROLL_ATTEMPT_LIMIT=10,l._translationLoader=new r("oj-rgbu-jraf-dashboard",d.id),l.prototype.activated=function(){return this._initializing},l.prototype.propertyChanged=function(e){if("external"===e.updatedFrom)if("selection"!==e.property)if("tileDisplayLimit"!==e.property){if("defaultBehavior"===e.property){var t=e.subproperty.path,i=e.subproperty.value||!1;return"defaultBehavior.tileInsertionRefresh"===t?void(this._tileInsertionRefreshDefault=i):"defaultBehavior.tileSelectionRefresh"===t?void(this._tileSelectionRefreshDefault=i):void 0}}else this._tileDisplayLimit=void 0===e.value?l.DEFAULT_TILE_DISPLAY_LIMIT:e.value;else{var o=e.value,n=this._idMap[o]||null;this._selectDashboardContent(n)}},l.prototype.refresh=function(){return this._insertedDashboardContent.removeAll(),this._availableDashboardContent.removeAll(),this._loadDashboardData(!0)},l.prototype._initializeTranslations=function(e){this._editDashboardLabel=e.editDashboardLabel,this._doneEditingLabel=e.doneEditingLabel,this.editDashboardButtonLabel=t.observable(e.editDashboardLabel),this._removeTileTitle(e.removeTile),this._reorderTileTitle(e.reorderTileTitle),this._reorderTileLabel(e.reorderTileLabel),this.dashboardReorderMenuLabel=e.dashboardReorderMenuLabel,this.addDashboardTileText=e.addDashboardTile,this.dashboardTilesListLabel=e.dashboardTilesListLabel,this.noDataText=e.noData,this.previewLabel=e.previewLabel,this.previewUnavailableText=e.previewUnavailableText,this.cancelText=e.cancel,this.addTileText=e.addTile,this._selectTileTryAgainMsg=e.selectTileTryAgainMsg,this.noTileDataMsg=e.noTileDataMsg,this.addTileLinkText=e.addTileLinkText,this._maxTilesMsg=e.maxTilesMsg,this._dashboardLoadError=e.dashboardLoadError},l.prototype._initialize=function(e){this._context=e,this._element=e.element,this._initializeBoundStrings(),this._initializeIds(e.uniqueId),this._initializeProperties(e.properties),this._initializeData(),this._initializeTileRegion(),this._initializeTileAdministration(),this._initializePrimaryRegion()},l.prototype._initializeBoundStrings=function(){this._removeTileTitle=t.observable(""),this._reorderTileTitle=t.observable(""),this._reorderTileLabel=t.observable(""),this.messageDialogBody=t.observable("")},l.prototype._initializeIds=function(e){this._unique=e,this.removedTilesContainerId=e+"_removedTiles",this.conveyorBeltId=e+"_conveyor",this.masonryLayoutId=e+"_masonry",this.addTileDialogId=e+"_addTileDialog",this.messageDialogId=e+"_messageDialogId",this.snackbarId=e+"_snackbar",this.adminTileId=e+"_adminTile"},l.prototype._initializeProperties=function(e){this._getDashboardDataCallback=e.getDashboardDataCallback,this._renderTileAdministration=e.renderTileAdministration,this._tileDisplayLimit=e.tileDisplayLimit,this._tileInsertionRefreshDefault=e.defaultBehavior.tileInsertionRefresh,this._tileSelectionRefreshDefault=e.defaultBehavior.tileSelectionRefresh},l.prototype._initializeData=function(){this.dashboardDataLoaded=t.observable(!1),this._insertedDashboardContent=t.observableArray([]),this._availableDashboardContent=t.observableArray([]),this._loadDashboardData()},l.prototype._initializeTileRegion=function(){this._currentTileScrollAttempts=0,this._insertedTileCount=t.observable(0),this.dashboardTiles=t.observableArray([]),this.availableDashboardTiles=t.observableArray([]),this._selectedDashboardContent=null,this.tileContainerWidth=t.pureComputed((function(){var e=this._renderTileAdministration?1:0;return e+=this._insertedTileCount(),this._getTileContainerWidth(e)+"px"}),this),this.hasTiles=t.pureComputed((function(){return this._insertedTileCount()>0}),this),this.editMode=t.observable(!1);var e=this;this.handleTileRemoval=function(t){e._handleTileRemoval(t)},this.handleTileInsertion=function(t){e._handleTileInsertion(t)},this.handleTileReorder=function(t){e._handleTileReorder(t)},this._dashboardTileView=i.parseHTML(s),this._dashboardTileParams={handleTileSelection:function(t){e._handleTileSelection(t)},editMode:this.editMode,removeTile:function(t){e._removeTile(t)},removeTileTitle:this._removeTileTitle,reorderTileTitle:this._reorderTileTitle,reorderTileLabel:this._reorderTileLabel,getBeforeLoadModuleHandler:function(){return e._context.properties.beforeLoadModuleHandler},getAfterUnloadModuleHandler:function(){return e._context.properties.afterUnloadModuleHandler}}},l.prototype._initializeTileAdministration=function(){this._renderTileAdministration&&(this._initializeTileAdminControls(),this._initializeTileAdminDialog())},l.prototype._initializePrimaryRegion=function(){this.contentModuleBinding=t.observable(null),this.contentModuleOptions=t.observable(null)},l.prototype._loadDashboardData=function(e){var t=this;return this._getDashboardDataCallback().then((function(i){t._handleSuccessfulDashboardDataLoad(i,e)}),(function(e){t._handleFailedDashboardDataLoad(e)}))},l.prototype._handleSuccessfulDashboardDataLoad=function(e,t){if(!Array.isArray(e))throw new TypeError("oj-rgbu-jraf-dashboard: getDashboardDataCallback did not return an array of dashboard content.");this._currentTileScrollAttempts=0,this._idMap={},this._tileIdMap={},this._dialogIdMap={},e.forEach((function(e,t){var i=this._parseDashboardData(e,t);this._processLoadedDashboardContent(i)}),this),this._processInsertedDashboardContents(),this._selectCurrentTile(),this.dashboardDataLoaded(!0),t&&this._getMasonryLayout().refresh()},l.prototype._parseDashboardData=function(e,t){return new n(e,this._unique+"_dc"+t)},l.prototype._processLoadedDashboardContent=function(e){this._idMap[e.getId()]=e,this._tileIdMap[e.getTileId()]=e,this._dialogIdMap[e.getDialogId()]=e,this._addDashboardContentData(e)},l.prototype._addDashboardContentData=function(e){e.isInserted()?this._insertedDashboardContent.push(e):this._availableDashboardContent.push(e)},l.prototype._processInsertedDashboardContents=function(){this._sortInsertedDashboardContent(),this._hasMaxTilesInserted()&&this._trimInsertedDashboardContents(),this._insertedTileCount(this._getInsertedTileCount());var e=this._insertedDashboardContent().map((function(e){return this._getModuleConfig(e)}),this);this._renderTileAdministration&&e.push({administrationTile:!0}),this.dashboardTiles(e),this.availableDashboardTiles(this._availableDashboardContent().map((function(e){return this._getModuleConfig(e)}),this))},l.prototype._getModuleConfig=function(e){return{id:e.getTileId(),moduleConfig:{view:[this._dashboardTileView[0].cloneNode(!0)],viewModel:new a({content:e,dashboard:this._dashboardTileParams})}}},l.prototype._sortInsertedDashboardContent=function(){this._insertedDashboardContent.sort(n.compareDashboardContent),this._insertedDashboardContent().forEach((function(e,t){e.setPosition(t),this._updateDashboardContentPosition(e,t)}),this)},l.prototype._trimInsertedDashboardContents=function(){this._insertedDashboardContent.splice(this._tileDisplayLimit,this._getInsertedTileCount()).forEach((function(e){e.setInserted(!1),this._availableDashboardContent.push(e)}),this)},l.prototype._selectCurrentTile=function(){var e=this._getDashboardContentForCurrentTile();null!==e?this._selectDashboardContent(e):this.contentModuleOptions(this._context.properties.noTileSelectedModuleOptions)},l.prototype._getDashboardContentForCurrentTile=function(){var e,t=this._getCurrentSelection();if("string"==typeof t&&t.length>0&&(e=this._idMap[t])&&!e.isDisabled())return e;var i=this._insertedDashboardContent().filter((function(e){return!e.isDisabled()}));return i.length>0?i[0]:null},l.prototype._selectDashboardContent=function(e){(o.info("oj-rgbu-jraf-dashboard: entering select dashboard content."),this._hasTileSelection())&&this._selectedDashboardContent.selected(!1);var t=null!==e&&e.isInserted()&&!e.isDisabled();t&&(o.info("oj-rgbu-jraf-dashboard: Selecting dashboard content %s (%s)",e.getId(),e.getTileId()),e.setSelected(!0)),this._selectedDashboardContent=t?e:null,this._setCurrentSelection(t?e.getId():null);var i=t?e.getContentModuleBinding():null;this.contentModuleBinding(i);var n=t?e.getContentModuleOptions():this._context.properties.noTileSelectedModuleOptions;this.contentModuleOptions(n);var a=this;window.requestAnimationFrame((function(){a._scrollToTile()}))},l.prototype._getCurrentSelection=function(){return this._context.properties.selection},l.prototype._setCurrentSelection=function(e){this._context.properties.selection=e},l.prototype._scrollToTile=function(){if(this._hasTileSelection()){var e=document.getElementById(this._selectedDashboardContent.getTileId()),t=document.querySelector("#"+this.conveyorBeltId+" div.oj-conveyorbelt-overflow-container");if(e&&t)this._scrollTileIntoView(e,t);else if(this._currentTileScrollAttempts<l.SCROLL_ATTEMPT_LIMIT){this._currentTileScrollAttempts++;var i=this;window.requestAnimationFrame((function(){i._scrollToTile()}))}else;}},l.prototype._scrollTileIntoView=function(e,t){var i=e.offsetLeft-5,o=i+e.offsetWidth+10,n=t.scrollLeft,a=n+t.offsetWidth;n>i?t.scrollLeft=i:o>a&&(t.scrollLeft=o-t.offsetWidth)},l.prototype._handleTileSelection=function(e){var t=this._tileIdMap[e];if(!this.editMode()){var i=t.getId();this._isContentSelected(i)||t.isDisabled()||(this._selectDashboardContent(t),t.isRefreshOnSelection(this._tileSelectionRefreshDefault)&&this._refreshDashboardContent(i))}},l.prototype._hasTileSelection=function(){return this._selectedDashboardContent instanceof n},l.prototype._isContentSelected=function(e){return this._hasTileSelection()&&this._selectedDashboardContent.getId()===e},l.prototype._handleFailedDashboardDataLoad=function(e){o.error("oj-rgbu-jraf-dashboard: Failed to load dashboard data with reason %s",e),this._showSnack(this._dashboardLoadError),this.dashboardDataLoaded(!0)},l.prototype._removeTile=function(e){var t=e.target.parentElement.parentElement;this._getMasonryLayout().removeTile("#"+t.id)},l.prototype._handleTileRemoval=function(e){if(e.target===this._getMasonryLayout()){var t=e.detail.tile,i=this._tileIdMap[t.id],n=i.getId();o.info("oj-rgbu-jraf-dashboard: handlines %s tile removal",n);var a=this._updateStateForTileRemoval(i,t);this._selectedDashboardContent===i&&this._selectNextDashboardTile(a),this._insertedTileCount()<=0&&this._exitEditMode(),this._raiseCustomEvent("ojRgbuJrafDashboardTileRemove",{id:n})}else o.info("oj-rgbu-jraf-dashboard: Ignoring remove event that did not originate from masonry layout.")},l.prototype._updateStateForTileRemoval=function(e,t){e.setInserted(!1),this._removeTileFromMasonryLayout(t);var i=this._removeAndAddDashboardContent(this._insertedDashboardContent,this._availableDashboardContent,e);return this._decrementInsertedTileCount(),i},l.prototype._removeTileFromMasonryLayout=function(e){document.getElementById(this.removedTilesContainerId).appendChild(e)},l.prototype._selectNextDashboardTile=function(e){var t=null,i=this._insertedDashboardContent(),o=i.length;o>0&&(t=i[Math.min(e,o-1)]);this._selectDashboardContent(t)},l.prototype._handleAddTile=function(){if(this._hasMaxTilesInserted())this._showMaxTilesInsertedMsg();else{var e=this.addTileSelection();if(0!==e.length){var t=e[0],i=this._dialogIdMap[t],o=this;return(i.isRefreshOnInsertion(this._tileInsertionRefreshDefault)?this._refreshDashboardContent(i.getId()):Promise.resolve()).then((function(){o._insertTile(i)}))}this._showMessage(this._selectTileTryAgainMsg)}},l.prototype._insertTile=function(e){this._incrementInsertedTileCount();var t=e.getTileId();this._insertTileInMasonryLayout(t,this._getInsertedTileCount())},l.prototype._handleTileInsertion=function(e){if(e.target===this._getMasonryLayout()){var t=e.detail.tile,i=e.detail.index,n=this._tileIdMap[t.id],a=n.getId();o.info("oj-rgbu-jraf-dashboard: Handling dashbord tile insert (%s, %d)",a,i),n.setInserted(!0),n.setPosition(i),this._resetTileAdminDialog(),-1===this._removeAndAddDashboardContent(this._availableDashboardContent,this._insertedDashboardContent,n)&&o.warn("oj-rgbu-jraf-dashboard: Could not find dashboard content %s when updating dashboard state on tile insert",a),1===this._insertedTileCount()&&this._selectDashboardContent(n),this._closeAddTileDialog(),this._raiseCustomEvent("ojRgbuJrafDashboardTileInsert",{id:a,position:i})}else o.info("oj-rgbu-jraf-dashboard: ignoring insert event that did not originate from the dashboard component.")},l.prototype._insertTileInMasonryLayout=function(e,t){o.info("oj-rgbu-jraf-dashboard: inserting %s at %d",e,t),this._getMasonryLayout().insertTile("#"+e,t)},l.prototype._incrementInsertedTileCount=function(){this._insertedTileCount(this._insertedTileCount()+1)},l.prototype._decrementInsertedTileCount=function(){this._insertedTileCount(this._insertedTileCount()-1)},l.prototype._removeAndAddDashboardContent=function(e,t,i){var o=this._removeDashboardContent(e,i);return t.push(i),o},l.prototype._removeDashboardContent=function(e,t){for(var i=-1,o=e(),n=0;n<o.length;n++){if(o[n]===t){i=n;break}}return i>=0&&e.splice(i,1),i},l.prototype._handleTileReorder=function(e){if(e.target===this._getMasonryLayout()){var t=this._tileIdMap[e.detail.tile.id],n=e.detail.toIndex;o.info("oj-rgbu-jraf-dashboard: handling tile %s reorder to %d",t.getId(),n);var a=this;i(this._getMasonryLayout()).find(".oj-rgbu-jraf-dashboard-tile").each((function(e,t){a.adminTileId!==t.id&&a._updateDashboardContentPosition(a._tileIdMap[t.id],e)}))}else o.info("oj-rgbu-jraf-dashboard: ignoring reorder event not originating from masonry layout component")},l.prototype._updateDashboardContentPosition=function(e,t){e.getPosition()!==t?(e.setPosition(t),this._raiseCustomEvent("ojRgbuJrafDashboardTileReorder",{id:e.getId(),position:t})):o.log("oj-rgbu-jraf-dashboard: ignoring tile move to %d since the tile is already at this position.",t)},l.prototype._raiseCustomEvent=function(e,t){var i={bubbles:!0,cancelable:!1,detail:t};return this._element.dispatchEvent(new CustomEvent(e,i))},l.prototype._initializeTileAdminControls=function(){var e=this;this.openAddTileDialog=function(){e._openAddTileDialog()},this.editDashboardChecked=t.observableArray([]),this.editDashboardChecked.subscribe((function(){e._toggleEditMode(),e.editDashboardButtonLabel(e.editMode()?e._doneEditingLabel:e._editDashboardLabel)}))},l.prototype._initializeTileAdminDialog=function(){var i=this;this.addTileDialogOpen=t.observable(!1),this.addTileCurrentItem=t.observable(null),this.addTileSelection=t.observableArray([]),this.addTileSelected=t.pureComputed((function(){return this.addTileSelection().length>0}),this),this.availableDashboardContentDataSource=new e.ArrayTableDataSource(this._availableDashboardContent,{idAttribute:"dialogId"}),this.availableDashboardContentDataSource.sort({key:"name",direction:"ascending"}),this.handleDialogCancel=function(){i._closeAddTileDialog()},this.handleDialogAddTile=function(){i._handleAddTile()}},l.prototype._refreshDashboardContent=function(e){var t=this;return this._getDashboardDataCallback(e).then((function(e){t._handleSuccessfulDashboardContentRefresh(e)}),(function(e){t._handleFailedDashboardContentRefresh(e)}))},l.prototype._handleSuccessfulDashboardContentRefresh=function(e){var t=this._idMap[e.id];t.update(e),this._isContentSelected(t.getId())&&this._selectDashboardContent(t)},l.prototype._handleFailedDashboardContentRefresh=function(e){o.warn("oj-rgbu-jraf-dashboard: Failed refreshing dashboard content %s.",e)},l.prototype._toggleEditMode=function(){this.editMode(!this.editMode()),this.editMode()&&this._getMasonryLayout().refresh()},l.prototype._exitEditMode=function(){this.editMode()&&this.editDashboardChecked([])},l.prototype._closeAddTileDialog=function(){document.getElementById(this.addTileDialogId).close()},l.prototype._openAddTileDialog=function(){document.getElementById(this.addTileDialogId).open(),this.addTileDialogOpen(!0)},l.prototype._resetTileAdminDialog=function(){this.addTileSelection().length&&(this.addTileSelection.pop(),this.addTileCurrentItem(null))},l.prototype._getMasonryLayout=function(){return document.getElementById(this.masonryLayoutId)},l.prototype._getTileContainerWidth=function(e){return e*l.TILE_WIDTH},l.prototype._getInsertedTileCount=function(){return this._insertedDashboardContent().length},l.prototype._hasMaxTilesInserted=function(){return this._tileDisplayLimit!==l.UNLIMITED_TILES&&this._getInsertedTileCount()>=this._tileDisplayLimit},l.prototype._showMaxTilesInsertedMsg=function(){this._showMessage(this._maxTilesMsg)},l.prototype._showMessage=function(e){this.messageDialogBody(e),this._openMessageDialog()},l.prototype._openMessageDialog=function(){document.getElementById(this.messageDialogId).open()},l.prototype._showSnack=function(e){document.getElementById(this.snackbarId).openSnack({message:e,severity:"error",showDismiss:!0,disableTimeout:!0})},l}));