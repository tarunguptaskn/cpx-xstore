define(["jquery","ojs/ojcore","knockout","jraf/jrafcore","jraf/models/favorites/FavoritesContent","jraf/models/favorites/FavoritesConfig","jraf/models/favorites/PinnedFavoritesState","jraf/models/UIShellManager","jraf/utils/ValidationUtils","ojs/ojlistview","ojs/ojmenu","ojs/ojoption","ojs/ojlistviewdnd"],(function(e,t,i,n,o,r,a,s,d){"use strict";var v=t.Translations.getTranslatedString;function u(e){var t=this;this.av=r.getInstance().getFavoriteHandler(e.favoriteHandlerKey),this.Al=o.getInstance(this.av.getFavoritesService(),e.favoriteHandlerKey),this.Zv=a.getInstance(),this.pinnedFavoritesListId=n.UIShell.generateUniqueId(),this.pinnedFavoriteItemTemplateId=n.UIShell.generateUniqueId(),this.pinnedFavoritesToolbarId=n.UIShell.generateUniqueId(),this.toolbarDeletePinButtonId=n.UIShell.generateUniqueId(),this.pinnedFavoritesHeader=v("jraf.sidebar.favorites.pinnedFavoritesHeader"),this.noFavoritesToDisplayMessage=v("jraf.sidebar.favorites.noFavoritesToDisplayMessage"),this.pinnedFavoritesListAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesListAriaLabel"),this.pinnedFavoritesToolbarAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesToolbarAriaLabel"),this.toolbarDeletePinButtonName=v("jraf.sidebar.favorites.toolbarDeletePinButtonName"),this.getPinnedFavoriteGuid=function(e){return t.$v(e)},this.getPinnedFavoriteIconClass=function(e){return t.fd(e)},this.getPinnedFavoriteTitle=function(e){return t.ud(e)},this.getPinnedFavoritePath=function(e){return t.cd(e)},this.vd(),this.jd(),this.ld()}return u.prototype.jd=function(){var e=this;this.guidToPinnedFavoriteMap={},this.pinnedFavoriteToGuidMap={},this.pinnedFavorites=this.Zv.getPinnedFavorites(),this.hasPinnedFavorites=i.pureComputed((function(){return 0<e.pinnedFavorites().length})),this.favoritesContentLoaded=this.Al.getFavoritesContentLoaded()},u.prototype.connected=function(){var e=this;this.pinnedFavoritesSubscription||(this.pinnedFavoritesSubscription=this.pinnedFavorites.subscribe((function(){e.bd()})))},u.prototype.bd=function(){var e=this,i=document.querySelector("#"+this.pinnedFavoritesListId);i&&t.Context.getContext(i).getBusyContext().whenReady().then((function(){e.pd()}))},u.prototype.pd=function(){var e=document.querySelector("#"+this.pinnedFavoritesListId);e&&e.refresh()},u.prototype.$v=function(e){var t=this.pinnedFavoriteToGuidMap[e.pinnedFavoriteId];return t||(t=n.UIShell.generateUniqueId(),this.pinnedFavoriteToGuidMap[e.pinnedFavoriteId]=t,this.guidToPinnedFavoriteMap[t]=e),t},u.prototype.fd=function(e){var t=a.favoriteIcons[e.favorite.favoriteType];return t||(t=a.favoriteIcons.unknown),"pin-icon "+t},u.prototype.ud=function(e){return this.av.getLocalizedTitle(e.favorite.entryId)},u.prototype.cd=function(e){for(var t=this.av.getLocalizedTitle(e.favorite.entryId,!0),i=t?t():"",n=e.favorite.parentFavItemId;n;){var o=this.Al.lookupFavoriteById(n);if(o){var r=this.av.getLocalizedTitle(o.entryId);i=(r?r():"")+"/"+i,n=o.parentFavItemId}else n=null}return i},u.prototype.disconnected=function(){this.pinnedFavoritesSubscription&&(this.pinnedFavoritesSubscription.dispose(),this.pinnedFavoritesSubscription=null)},u.prototype.ld=function(){var e=this;this.pinnedFavoritesSelection=i.observableArray([]),this.pinnedFavoriteIsSelected=i.pureComputed((function(){return 0<e.pinnedFavoritesSelection().length})),this.selectedPinnedFavoriteGuid=i.pureComputed((function(){return e.pinnedFavoritesSelection()[0]})),this.selectedPinnedFavorite=i.pureComputed((function(){return e.guidToPinnedFavoriteMap[e.selectedPinnedFavoriteGuid()]})),this.handleDragStart=function(t){return e.Cv(t)},this.handleReorder=function(t){return e.Fd(t)},this.handleDeleteButton=function(){e.Al.unpinFavorite(e.selectedPinnedFavorite().favorite.entryId).then((function(){e.selectedPinnedFavorite()&&e.pinnedFavoritesSelection.removeAll()}))}},u.prototype.vd=function(){var e=this;this.pinnedFavoritesContextMenuAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesContextMenuAriaLabel"),this.pinnedFavoritesContextCutOption=v("jraf.sidebar.favorites.pinnedFavoritesContextCutOption"),this.pinnedFavoritesContextPasteOption=v("jraf.sidebar.favorites.pinnedFavoritesContextPasteOption"),this.pinnedFavoritesContextPasteAfterOption=v("jraf.sidebar.favorites.pinnedFavoritesContextPasteAfterOption"),this.pinnedFavoritesContextUnpinOption=v("jraf.sidebar.favorites.pinnedFavoritesContextUnpinOption"),this.contextMenuTarget=i.observable(),this.pinnedFavoriteToCut=i.observable(),this.contextMenuAction=function(t){e.md(t)},this.contextMenuBeforeOpen=function(t){e.Cd(t)},this.preventPasteToTarget=i.pureComputed((function(){return!e.pinnedFavoriteToCut()})),this.contextMenuActions={},this.contextMenuActions.cut=function(){e.pinnedFavoriteToCut(e.contextMenuTarget())},this.contextMenuActions.paste=function(){e.xd("before")},this.contextMenuActions.pasteAfter=function(){e.xd("after")},this.contextMenuActions.unpin=function(){e.Al.unpinFavorite(e.contextMenuTarget().favorite.entryId).then((function(){e.contextMenuTarget()&&e.selectedPinnedFavorite()&&e.contextMenuTarget().favorite.entryId===e.selectedPinnedFavorite().favorite.entryId&&e.pinnedFavoritesSelection.removeAll()}))}},u.prototype.md=function(e){var t=e.target.value;this.contextMenuTarget()&&t&&this.contextMenuActions[t]()},u.prototype.Cd=function(t){var i=document.getElementById(this.pinnedFavoritesListId),n=e("#"+i.currentItem)[0],o=this.guidToPinnedFavoriteMap[n.id];this.contextMenuTarget(o),e("#"+this.pinnedFavoritesContextMenuId).ojMenu("refresh")},u.prototype.xd=function(e){this.Al.reorderPinnedFavorite(this.pinnedFavoriteToCut().pinnedFavoriteId,this.contextMenuTarget().pinnedFavoriteId,e),this.pinnedFavoriteToCut(void 0)},u.prototype.Fd=function(e){for(var t,i,n,o=document.getElementById(this.pinnedFavoritesListId),r=o.getContextByNode(e.detail.reference),a=e.detail.items,s=0;s<a.length;s++)t=o.getContextByNode(a[s]),i=this.guidToPinnedFavoriteMap[t.key],n=this.guidToPinnedFavoriteMap[r.key],this.Al.reorderPinnedFavorite(i.pinnedFavoriteId,n.pinnedFavoriteId,e.detail.position)},u.prototype.Cv=function(t,i){var n=e(t.target).parents(".oj-listview-item").get(0);return t.dataTransfer.setDragImage(n,0,0),!0},u}));