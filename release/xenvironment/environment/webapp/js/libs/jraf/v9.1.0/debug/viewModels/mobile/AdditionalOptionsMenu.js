define(["jquery","knockout","ojs/ojcore","jraf/jrafcore","jraf/models/UIShellManager","jraf/models/HeaderMenus","jraf/utils/ValidationUtils","ojs/ojknockouttemplateutils","ojs/ojknockout","ojs/ojnavigationlist","ojs/ojjsontreedatasource"],(function(e,t,a,n,i,r,s,l){"use strict";var o=a.Translations.getTranslatedString;function u(e){if(!(s.isObjectStrict(e)&&e.menus instanceof r))throw new TypeError("AdditionalOptionsMenu: Missing required parameters");var t=this;this.userMenuId=n.UIShell.generateUniqueId(),this.helpMenuId=n.UIShell.generateUniqueId(),this.menuItemTemplateId=n.UIShell.generateUniqueId(),this.navListId=n.UIShell.generateUniqueId(),this.preferencesLabel=o("jraf.global.preferences"),this.userMenuLogOutLabel=o("jraf.global.userMenuLogOutLabel"),this.helpLabel=o("jraf.global.help"),this.aboutLabel=o("jraf.global.about"),this.rootLabel=o("jraf.global.optionsMenu"),this._menuModel=e.menus,this._initializeMenuOptions(),this.getMenuItemTemplate=function(){return l.getRenderer(t.menuItemTemplateId,!0)}}return u.prototype._initializeMenuOptions=function(){var e=this._menuModel.getUserData();this.username=e.username,this._initializeAvatar(e.avatar),this.userMenuItems=this._menuModel.getUserMenu(),this.helpMenuItems=this._menuModel.getHelpMenu();var n=[{attr:{id:this.userMenuId,label:this.username,avatar:this.avatar,type:"usermenu"},children:this._preprocessMenuItems(this.userMenuItems)},{attr:{id:this.helpMenuId,label:this.helpLabel,type:"helpmenu"},children:this._preprocessMenuItems(this.helpMenuItems)}];this.dataSource=new a.JsonTreeDataSource(n),this._buildLabelsMap(),this._initializeCallbacks(),this._keyStack=t.observableArray([]),this.drillLabel=t.pureComputed((function(){var e=this._getCurrentKey();return null===e?null:t.unwrap(this._labelsMap[e])}),this)},u.prototype._preprocessMenuItems=function(t){for(var a=[],n=0;n<t.length;n++){var i={},r=t[n];if(r.rendered){if(r.children){var s=this._preprocessMenuItems(r.children);i.children=s}i.attr={},e.extend(i.attr,r),i.attr.children&&delete i.attr.children,a.push(i)}}return a},u.prototype._initializeCallbacks=function(){var e=this;this.beforeSelect=function(t){e._handleBeforeSelect(t)},this.beforeExpand=function(t){e._handleBeforeExpand(t)},this.beforeCollapse=function(){e._handleBeforeCollapse()},this.navigateBack=function(){e._navigateBack()}},u.prototype._initializeAvatar=function(e){this.avatar=t.pureComputed((function(){var t=e();return t?{backgroundImage:"url('"+t+"')"}:null}))},u.prototype._buildLabelsMap=function(){var e=this;this._labelsMap={},this._labelsMap[this.userMenuId]=this.username,this._labelsMap[this.helpMenuId]=this.helpLabel,this.userMenuItems.forEach((function(t){e._populateLabelsMap(t)})),this.helpMenuItems.forEach((function(t){e._populateLabelsMap(t)}))},u.prototype._populateLabelsMap=function(e){var t=this;this._labelsMap[e.id]=e.label,s.isArray(e.children)&&e.children.forEach((function(e){t._populateLabelsMap(e)}))},u.prototype._handleBeforeSelect=function(e){var t=e.detail.key;this._menuModel.isMenuLeaf(t)&&(this._menuModel.handleMenuItemSelection(t),e.preventDefault(),i.closeMobileOptionsMenu())},u.prototype._handleBeforeExpand=function(e){this._keyStack.push(e.detail.key)},u.prototype._handleBeforeCollapse=function(){this._keyStack.pop()},u.prototype._navigateBack=function(){var t=this._getCurrentKey();e("#"+this.navListId).ojNavigationList("collapse",t)},u.prototype._getCurrentKey=function(){var e=this._keyStack();return 0===e.length?null:e[e.length-1]},u}));