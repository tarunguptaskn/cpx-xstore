define(["module","jquery","jraf/utils/ValidationUtils","jraf/services/CustomizedResourceService"],(function(n,e,r,t,o){"use strict";var i=n.config?n.config():{},u=null,c=/(^.*\/?nls\/)([^\/]*)\/?([^\/]*)/;function f(n){var e=c.exec(n);return r.isNonemptyString(e[3])?e[1]+e[3]:n}function s(){return u||(u=new Promise((function(n,e){(function(){if(i.hasOwnProperty("configPath")){var n=i.configPath;if(r.isNonemptyString(n))return new Promise((function(e,r){require(["text!"+n],(function(n){var r=JSON.parse(n);e(r)}),(function(){window.console.log("Warning: Failed to load jrafL10n configuration from: "+n),e(null)}))}))}return Promise.resolve(null)})().then((function(e){if(e&&e.hasOwnProperty("baseUri")&&e.hasOwnProperty("appCode")){var r=e.baseUri,o=e.appCode,i=e.pageSize;n(new t(o,r,i))}n(null)}))}))),u}function a(n,t){return new Promise((function(o,i){(function(n){return new Promise((function(e,t){var o=f(n),i=function(n){var e=c.exec(n);return r.isNonemptyString(e[3])?e[2]:"root"}(n);s().then((function(r){r?r.getCustomizedResources(o,i).then((function(n){e(n)}),(function(r){window.console.log("Warning: jrafL10n failed to load customizations for resource "+n+": "+r),e([])})):e([])}))}))})(n).then((function(i){if(r.isArray(i)&&i.length>0){var u=function(n){return n===f(n)}(n),c=function(n,t,o){var i=function(n){return n.reduce((function(n,e){for(var t=e.resourceKey,o=e.sourceText,i=t.split("."),u=n,c=null,f=!0,s=null,a=0;a<i.length;a++){if(s=i[a],!r.isNonemptyString(s)){f=!1;break}u.hasOwnProperty(s)||(u[s]={}),c=u,u=u[s]}return f&&c&&s&&(c[s]=o),n}),{})}(t);o?e.extend(!0,n.root,i):e.extend(!0,n,i);return n}(t,i,u);o(c)}else o(t)}))}))}return{load:function(n,e,r,t){(t=t||{}).isBuild?r():e([n],(function(e){a(n,e).then((function(n){r(n)}))}))}}}));