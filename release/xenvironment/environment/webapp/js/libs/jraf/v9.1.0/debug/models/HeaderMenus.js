define(["jquery","knockout","ojs/ojcore","jraf/jrafcore","jraf/controllers/ThemeManager","jraf/controllers/LayoutManager","jraf/models/UIShellManager","jraf/utils/ValidationUtils","jraf/utils/RouterUtils"],(function(e,t,a,s,i,n,l,r,u){"use strict";var o=a.Translations.getTranslatedString;function h(e){this._menuLeaves={},this._preferencesMenuItemId=s.UIShell.generateUniqueId(),this._logoutMenuItemId=s.UIShell.generateUniqueId(),this._helpMenuItemId=s.UIShell.generateUniqueId(),this._aboutMenuItemId=s.UIShell.generateUniqueId(),this._preferencesLabel=o("jraf.global.preferences"),this._logoutLabel=o("jraf.global.userMenuLogOutLabel"),this._helpLabel=o("jraf.global.help"),this._aboutLabel=o("jraf.global.about"),this._defaultUsername=o("jraf.global.defaultUser"),this._initializeMenuOptions(e)}return h.prototype._initializeMenuOptions=function(e){r.isObjectStrict(e)&&(this._preferencesCallback=e.preferencesCallback,this._preferencesMenuConfig=e.preferencesMenuConfig,this._customMenuConfig=e.customMenuConfig,this._logoutCallback=e.logoutCallback,this._applicationHelpCallback=e.applicationHelpCallback,this._helpMenuConfig=e.helpMenuConfig,this._aboutCallback=e.aboutCallback,this._userDataCallback=e.userDataCallback),this._initializeThemesMenu(),this._initializeLayoutMenu(),this._loadUserData(),this._buildUserMenuOptions(),this._buildHelpMenuOptions()},h.prototype._buildUserMenuOptions=function(){var e=this,t=r.isFunction(this._preferencesCallback)||r.isArray(this._preferencesMenuConfig),a=r.isFunction(this._logoutCallback);if(this._userMenu=[],t){var i={rendered:t,id:this._preferencesMenuItemId,label:this._preferencesLabel,jrafTestId:"global-header-user-menu-preferences-option"};this._preferencesCallback&&(i.callback=this._preferencesCallback,this._menuLeaves[this._preferencesMenuItemId]=i),this._preferencesMenuConfig&&(i.children=this._parseMenuItems(this._preferencesMenuConfig,i.id)),this._userMenu.push(i)}if(this._userMenu.push({rendered:this._layoutConfigurable,id:this._layoutMenuItemId,label:this._layoutMenuLabel,children:this._layouts,jrafTestId:"global-header-user-menu-layout-option"}),this._userMenu.push({rendered:this._themeSelectEnabled,id:this._themeMenuItemId,label:this._themeMenuLabel,children:this._themes,jrafTestId:"global-header-user-menu-theme-option"}),r.isArray(this._customMenuConfig)&&this._customMenuConfig.forEach((function(t){var a={rendered:!0,label:o(t.label),callback:t.callback,id:s.UIShell.generateUniqueId(),classNameMap:e._parseClassNameMap(t.className)};this._userMenu.push(a),this._menuLeaves[a.id]=a}),this),a){var n={rendered:a,id:this._logoutMenuItemId,label:this._logoutLabel,callback:this._logoutCallback,jrafTestId:"global-header-user-menu-logout-option"};this._userMenu.push({rendered:!0,id:s.UIShell.generateUniqueId()}),this._userMenu.push(n),this._menuLeaves[this._logoutMenuItemId]=n}},h.prototype.getUserMenu=function(){return this._userMenu},h.prototype._initializeThemesMenu=function(){this._themeMenuItemId=s.UIShell.generateUniqueId(),this._themeMenuLabel=o("jraf.global.themeMenuLabel");var e=i.getInstance();if(this._themeSelectEnabled=e.isUserConfigurable()(),this._themeSelectEnabled){var t=e.getAvailableThemes(),a=e.getTheme();this._themes=this._parseMenuItems(t,this._themeMenuItemId,a,(function(t){e.setTheme(t.modelId)}))}},h.prototype._initializeLayoutMenu=function(){this._layoutMenuItemId=s.UIShell.generateUniqueId(),this._layoutMenuLabel=o("jraf.global.layoutMenuLabel");var e=n.getInstance();if(this._layoutConfigurable=e.isLayoutConfigurable(),this._layoutConfigurable){var t=e.getLayouts(),a=e.getActiveLayout();this._layouts=this._parseMenuItems(t,this._layoutMenuItemId,a,(function(t){e.setActiveLayout(t.modelId)}))}},h.prototype._parseMenuItems=function(e,a,s,i){var n=this;return e.map((function(e,l){var r=e.id,u={modelId:r,id:a+"-"+l,label:o(e.label),selected:!1,callback:i||e.callback,rendered:!0,classNameMap:n._parseClassNameMap(e.className)};return t.isObservable(s)&&(u.selected=t.pureComputed((function(){return s()===r}))),n._menuLeaves[u.id]=u,u}))},h.prototype._parseClassNameMap=function(e){var t={};return r.isNonemptyString(e)&&(t=e.split(" ").reduce((function(e,t){return e[t]=!0,e}),{})),t},h.prototype._loadUserData=function(){var e=this;if(this._username=t.observable(""),this._avatar=t.observable(""),!r.isFunction(this._userDataCallback))return a.Logger.info("HeaderMenus._loadUserData: No userDataCallback provided. Using defaults."),void this._setUserMenuDefaults();var i=s.App.getUserData();if(!r.isObjectStrict(i))return l.startProcessingIndicator(),this._userDataCallback().then((function(t){e._handleSuccessfulUserDataLoad(t)})).catch((function(){e._handleFailedUserDataLoad()}));this._handleSuccessfulUserDataLoad(i)},h.prototype._handleSuccessfulUserDataLoad=function(e){a.Logger.info("HeaderMenus._handleSuccessfulUserDataLoad: Successfully loaded user data.");var t=r.isNonemptyString(e.displayName)?e.displayName:e.userid;this._username(t),this._initializeAvatar(e.avatar),l.stopProcessingIndicator()},h.prototype._handleFailedUserDataLoad=function(){l.stopProcessingIndicator(),a.Logger.warn("HeaderMenus._handleFailedUserDataLoad: Failed to load user data."),this._setUserMenuDefaults()},h.prototype._initializeAvatar=function(t){var a=e("body").hasClass("oj-hicontrast");r.isNonemptyString(t)&&!a?this._avatar("data:image/jpeg;base64,"+t):this._avatar("")},h.prototype._setUserMenuDefaults=function(){this._username(this._defaultUsername),this._avatar("")},h.prototype.getUserData=function(){return{username:this._username,avatar:this._avatar}},h.prototype._buildHelpMenuOptions=function(){var e=this,t=this._aboutCallback;if(!r.isFunction(t)){var a=this._getAboutPageUrl();t=function(){window.open(a,"_blank")}}var i=r.isFunction(this._applicationHelpCallback);this._helpMenu=[],i&&this._helpMenu.push({rendered:!0,id:this._helpMenuItemId,label:this._helpLabel,callback:this._applicationHelpCallback,jrafTestId:"global-header-help-menu-help-option"}),this._helpMenu.push({rendered:!0,id:this._aboutMenuItemId,label:this._aboutLabel,callback:t,jrafTestId:"global-header-help-menu-about-option"}),r.isArray(this._helpMenuConfig)&&this._helpMenuConfig.forEach((function(t){var a={rendered:!0,label:o(t.label),callback:t.callback,id:s.UIShell.generateUniqueId(),classNameMap:e._parseClassNameMap(t.className)};this._helpMenu.push(a),this._menuLeaves[a.id]=a}),this),this._helpMenu.forEach((function(e){this._menuLeaves[e.id]=e}),this)},h.prototype.getHelpMenu=function(){return this._helpMenu},h.prototype._getAboutPageUrl=function(){return window.location.href.split("?",1)[0]+"?"+u.getRootRouterName()+"=About"},h.prototype.handleMenuItemSelection=function(e){var t=this._menuLeaves[e];t.callback&&t.callback(t)},h.prototype.isMenuLeaf=function(e){return r.isObjectStrict(this._menuLeaves[e])},h}));