define(["jquery","ojs/ojcore","knockout","jraf/utils/ValidationUtils"],(function(e,t,r,n){"use strict";function i(){this._defaultTheme=i.LIGHT_THEME.id,this._currentTheme=r.observable(this._defaultTheme),this._userConfigurable=r.observable(!1),this._currentTheme.subscribe((function(e){this._changeTheme(e)}),this)}return i.THEME_SUFFIX="_theme",i.LOCAL_THEME_KEY="jraf.userTheme",i.DARK_THEME={id:"dark",label:"jraf.global.darkThemeLabel"},i.LIGHT_THEME={id:"light",label:"jraf.global.lightThemeLabel"},i.prototype._setUserConfigurable=function(e){n.isBoolean(e)&&this._userConfigurable(e)},i.prototype.isUserConfigurable=function(){return this._userConfigurable},i.prototype._setDefaultTheme=function(e){this._validateThemeString(e)?this._defaultTheme=e:t.Logger.warn("ThemeManager.setDefaultTheme: Unknown theme "+e+" provided")},i.prototype.setTheme=function(e){this._validateThemeString(e)?(this._currentTheme(e),window.localStorage.setItem(i.LOCAL_THEME_KEY,e)):t.Logger.warn("ThemeManager.setTheme: Unknown theme "+e+" provided")},i.prototype.loadSavedTheme=function(){var e=window.localStorage.getItem(i.LOCAL_THEME_KEY);e&&this.setTheme(e)},i.prototype._validateThemeString=function(e){var t=this.getAvailableThemes();for(var r in t)if(t[r].id===e)return!0;return!1},i.prototype.getTheme=function(){return this._currentTheme},i.prototype.resetTheme=function(){this._currentTheme(this._defaultTheme)},i.prototype.getAvailableThemes=function(){return[i.LIGHT_THEME,i.DARK_THEME]},i.prototype._changeTheme=function(t){var r=this;e("link.jraf-update-url-theme").each((function(){r._updateLinkTheme(e(this),t)}))},i.prototype._updateLinkTheme=function(e,t){if(e){var r=e.attr("href"),n=this._updateURLTheme(r,t);e.attr({href:n})}},i.prototype._updateURLTheme=function(e,r){if(!e)return t.Logger.warn("ThemeManager._updateURLTheme: No URL provided"),e;var n="",i=e.split("/").pop(),a=i.indexOf(".");a>=0&&(n=i.substring(a));var o=e.substring(0,e.length-i.length),h=i.substring(0,i.length-n.length).split("-"),u=this._findThemeField(h);return u>=0?(h[u]=r,o+h.join("-")+n):(t.Logger.warn("ThemeManager._updateURLTheme: URL "+e+" is not a valid theme file"),e)},i.prototype._findThemeField=function(e){for(var t=e.length-1;t>=0&&t>=e.length-2;t--){var r=e[t];if(this._validateThemeString(r))return t}return-1},i.configure=function(e){var t=i.getInstance();t._setDefaultTheme(e.defaultTheme),t._setUserConfigurable(e.userConfigurable),t.resetTheme(),t.loadSavedTheme()},i.getInstance=function(){return i._currentInstance||(i._currentInstance=new i),i._currentInstance},i}));