define(["ojs/ojcore","jquery","jraf/utils/UrlUtils","jraf/utils/ValidationUtils","jraf/services/AbstractService"],(function(e,t,r,i,a){"use strict";function o(e,t){o.superclass.constructor.apply(this,arguments),i.isObjectStrict(t)?(this.appCode=t.appCode,this._clientAppCode=t.clientAppCode):this.appCode=t,this.appCodeUriString=encodeURIComponent(this.appCode)}return o.SERVICE_URL_PATH="services/private/Favorites",o.SERVICE_VERSION_OVERRIDE=null,o.REF_ITEM_ID_PREFIX="JRAF|",e.Object.createSubclass(o,a,"FavoritesService"),o.prototype.getServiceConfiguration=function(){return{baseUri:this.getBaseUri(),appCode:this.appCode}},o.prototype.GetStandardHeaders=function(){var e=o.superclass.GetStandardHeaders.apply(this);return e["Accept-Version"]=o.SERVICE_VERSION_OVERRIDE||e["Accept-Version"],e},o.prototype._buildFavoritesEndpoint=function(e){var t=this.BuildEndpoint(e,o.SERVICE_URL_PATH);return this._clientAppCode&&(t=r.injectQueryParameter(t,"clientAppCode",this._clientAppCode)),t},o.prototype.loadFavorites=function(){var e=this,r=this._buildFavoritesEndpoint("/fetch?appCode="+this.appCodeUriString),i=t.ajax(r,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return e.ParseFavorites(t.favorites)}))},o.prototype.getSeededFavoritesCount=function(){var e=this._buildFavoritesEndpoint("/Defaults?appCode="+this.appCodeUriString),r=t.ajax(e,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(e){return e.seededFavoritesCount}))},o.prototype.importSeededFavorites=function(){var e=this._buildFavoritesEndpoint("/Defaults?appCode="+this.appCodeUriString),r=t.ajax(e,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0},method:"POST"});return this.ConvertAjaxPromise(r)},o.prototype.addFavorite=function(e,r,i,a,o){var n=this._buildFavoritesEndpoint("/add"),s=o?JSON.stringify(o):null,d={applicationCode:this.appCode,refItemId:this.GetRefItemId(e,r,a),favoriteType:i,objectId:a,favoriteContext:s},p=t.ajax(n,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0},data:JSON.stringify(d),processData:!1,method:"POST"});return this.ConvertAjaxPromise(p)},o.prototype.deleteFavorite=function(e){var r=this._buildFavoritesEndpoint("/delete"),i={favItemId:e},a=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0},data:JSON.stringify(i),processData:!1,method:"DELETE"});return this.ConvertAjaxPromise(a)},o.prototype.updateFavorites=function(e){for(var r=this._buildFavoritesEndpoint("/update"),i=[],a=0;a<e.length;a++)i.push({favItemId:e[a].favItemId,sequenceNumber:e[a].sequenceNumber,localPinSequenceNumber:e[a].localPinSequenceNumber,globalPinSequenceNumber:e[a].globalPinSequenceNumber,customName:e[a].customName,parentFavItemId:e[a].parentFavItemId,applicationCode:this.appCode});var o=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0},data:JSON.stringify({favorites:i}),processData:!1,method:"POST"});return this.ConvertAjaxPromise(o)},o.prototype.replaceFavorites=function(e){var r=this._buildFavoritesEndpoint("/replace"),i=this._buildReplacementsPayload(e),a=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0},data:JSON.stringify({favorites:i}),processData:!1,method:"POST"});return this.ConvertAjaxPromise(a)},o.prototype._buildReplacementsPayload=function(e){return e.map((function(e){var t=e.favoriteContext,r=t?JSON.stringify(t):null,i={refItemId:this.GetRefItemId(e.refItemId,e.title,e.objectId),favoriteType:e.favoriteType,objectId:e.objectId,favoriteContext:r,seededFavItemId:e.seededFavItemId,localPinSequenceNumber:e.localPinSequenceNumber,globalPinSequenceNumber:e.globalPinSequenceNumber,customName:e.customName,applicationCode:this.appCode};return"folder"===e.favoriteType&&(i.children=this._buildReplacementsPayload(e.children)),i}),this)},o.prototype.GetRefItemId=function(e,t,r){return o.REF_ITEM_ID_PREFIX+e+"|"+t+(i.isNonemptyString(r)?"|"+r:"")},o.prototype.ParseFavorites=function(r){return i.isArray(r)?r.map((function(r){var i,a=this.GetFavoriteContentProperties(r);try{i=r.favoriteContext?JSON.parse(r.favoriteContext):null}catch(t){e.Logger.info("FavoritesService.ParseFavorites: could not parse favoriteContext for favorite id: "+r.favItemId)}var o="folder"===r.favoriteType?this.ParseFavorites(r.children):void 0;return t.extend({},r,{refItemId:a.refItemId,title:a.title,favoriteContext:i,children:o})}),this):[]},o.prototype.GetFavoriteContentProperties=function(e){var t=e.refItemId;if(!this._isJrafRefItemId(t))return{refItemId:t};var r=o.REF_ITEM_ID_PREFIX.length,i=t.indexOf("|",r),a=t.indexOf("|",i+1),n=t.substring(i+1);return a>0&&i!==a&&(n=n.split("|")[0]),{refItemId:t.substring(r,i),title:n}},o.prototype._isJrafRefItemId=function(e){var t=o.REF_ITEM_ID_PREFIX.length;return i.isNonemptyString(e)&&0===e.indexOf(o.REF_ITEM_ID_PREFIX)&&e.indexOf("|",t)>t},o}));