define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/services/ServiceManager","jraf/utils/ValidationUtils"],(function(e,i,t,r,s){"use strict";var a=e.Translations.getTranslatedString;function o(e){var t=this;this.pe=e,this.mh(),this.bh(),this.Nh(),this.searchString=i.observableArray([""]),this.hierarchyLabels=i.observable({}),this.timePeriodLabels=i.observable({}),this.notificationTypeLabels=i.observable({}),this.severityLabels=i.observable({}),this.selectedTileIndex=i.observable(o.ALL_NOTIFICATIONS_TILE_INDEX).extend({notify:"always"}),Promise.all([this.Ih,this.wh,this.Ch]).then((function(){t.Fh()}),(function(){t.Fh()})),this.filtersReady=this.Ph()}return o.Qe={},o.BASE_TIME_SELECT_OPTIONS=[{value:"-2",label:a("jraf.sidebar.notifications.timeAny")}],o.UNREAD_STATUS="U",o.READ_STATUS="R",o.SEVERITY_VALUE_NORMAL=3,o.SEVERITY_VALUE_IMPORTANT=2,o.SEVERITY_VALUE_CRITICAL=1,o.SEVERITY_CLASS_CRITICAL="jraf-severity-critical",o.SEVERITY_CLASS_MEDIUM="jraf-severity-medium",o.SEVERITY_CLASS_LOW="jraf-severity-low",o.SEVERITY_OPTIONS=[{value:o.SEVERITY_VALUE_CRITICAL,label:a("jraf.notifications.severityCritical"),class:o.SEVERITY_CLASS_CRITICAL},{value:o.SEVERITY_VALUE_IMPORTANT,label:a("jraf.notifications.severityImportant"),class:o.SEVERITY_CLASS_MEDIUM},{value:o.SEVERITY_VALUE_NORMAL,label:a("jraf.notifications.severityNormal"),class:o.SEVERITY_CLASS_LOW}],o.DEFAULT_HIERARCHY_LEVEL_TOKEN="type",o.HIERARCHY_NO_SELECTION={value:-1,label:a("jraf.notifications.groupNoSelection")},o.ALL_NOTIFICATIONS_TILE_INDEX=0,o.FILTER_TILE_INDEX=5,o.SUMMARY_TILE_INDEX=6,o.prototype.mh=function(){o.SEVERITY_OPTIONS[2].label=a("jraf.notifications.severityNormal"),o.SEVERITY_OPTIONS[1].label=a("jraf.notifications.severityImportant"),o.SEVERITY_OPTIONS[0].label=a("jraf.notifications.severityCritical"),o.HIERARCHY_NO_SELECTION.label=a("jraf.notifications.groupNoSelection"),o.BASE_TIME_SELECT_OPTIONS[0].label=a("jraf.sidebar.notifications.timeAny")},o.prototype.bh=function(){var e=this;this.selectedTimePeriod=i.observable(void 0),this.timePeriodOptions=i.observableArray(o.BASE_TIME_SELECT_OPTIONS),this.wh=this.pe.getNotificationTimes().then((function(i){e.timePeriodOptions(i)})),this.selectedNotificationTypes=i.observableArray([]),this.notificationTypeOptions=i.observableArray([]),this.Ch=this.pe.getNotificationTypes(!0).then((function(i){e.notificationTypeOptions(i)})),this.selectedSeverities=i.observableArray([]),this.severityOptions=o.SEVERITY_OPTIONS},o.prototype.Nh=function(){var t=this;this.useHierarchyOptions=i.observable(!1),this.Sh=[o.HIERARCHY_NO_SELECTION],this.primaryHierarchySelection=i.observable(o.HIERARCHY_NO_SELECTION.value),this.secondaryHierarchySelection=i.observable(o.HIERARCHY_NO_SELECTION.value),this.primaryHierarchyOptions=i.observableArray(this.Sh),this.secondaryHierarchyOptions=i.observableArray(this.Sh),this.primaryHierarchySelection.subscribe((function(e){var i=e,r=t.Uh(t.Sh,i);r.unshift(o.HIERARCHY_NO_SELECTION);for(var s=!1,a=0;a<r.length;a++)r[a].value===t.secondaryHierarchySelection()&&(s=!0);s||t.secondaryHierarchySelection(o.HIERARCHY_NO_SELECTION.value),t.secondaryHierarchyOptions(r)})),this.Ih=this.pe.getNotificationHierarchyLevels().then((function(e){t.Vh(e)}),(function(i){e.Logger.warn("NotificationsFilter._initializeHierarchyOptions: Unable to load hierarchy levels with reason: "+i)})),this.selectedSummaryValues={primaryGroup:i.observable(),primaryValue:i.observable(),secondaryGroup:i.observable(),secondaryValue:i.observable()}},o.prototype.Vh=function(e){for(var i=e[0].id,t=[],r={},s=0;s<e.length;s++){var a=e[s];a.token===o.DEFAULT_HIERARCHY_LEVEL_TOKEN?(i=a.id,t.unshift({label:a.name,value:a.id})):t.push({label:a.name,value:a.id}),r[a.id]=a.parent}this.Sh=t,this.kh=r,this.primaryHierarchyOptions(t),this.primaryHierarchySelection(i)},o.prototype.Uh=function(e,i){for(var t=[i],r=this.kh[i];"number"==typeof r;)t.push(r),r=this.kh[r];return e.filter((function(e){return t.indexOf(e.value)<0}))},o.prototype.Fh=function(){this.timePeriodLabels(this.Ah(this.timePeriodOptions)),this.notificationTypeLabels(this.Ah(this.notificationTypeOptions)),this.hierarchyLabels(this.Ah(this.Sh.concat(o.HIERARCHY_NO_SELECTION))),this.severityLabels(this.Ah(o.SEVERITY_OPTIONS))},o.prototype.Ah=function(e){for(var t=i.unwrap(e),r={},s=0;s<t.length;s++)r[t[s].value]=t[s].label;return r},o.prototype.getFilterCriteria=function(){var e=this;return i.pureComputed((function(){return{status:o.UNREAD_STATUS,periodId:e.selectedTimePeriod(),typeIds:0<e.selectedNotificationTypes().length?e.selectedNotificationTypes():void 0,severities:0<e.selectedSeverities().length?e.selectedSeverities():void 0}}))},o.prototype.getActiveFiltersCount=function(){var e=this;return i.pureComputed((function(){var i=0;return i+=e.selectedTimePeriod()?1:0,(i+=0!==e.selectedNotificationTypes().length?1:0)+(0!==e.selectedSeverities().length?1:0)}))},o.prototype.getGroupingCriteria=function(){var e=this;return i.pureComputed((function(){var i=e.selectedSummaryValues,t=e.getFilterCriteria()();return t.groupByLevelId=i.primaryGroup()[0],t.groupByHierarchyValue=i.primaryValue(),i.secondaryGroup()&&(t.thenByLevelId=i.secondaryGroup()[0],t.thenByHierarchyValue=i.secondaryValue()),t}))},o.prototype.persistCriteria=function(){var i={periodId:this.selectedTimePeriod(),typeIds:this.selectedNotificationTypes(),severities:this.selectedSeverities()};if(this.useHierarchyOptions()){var t=this.primaryHierarchySelection();t&&t!==o.HIERARCHY_NO_SELECTION.value&&(i.groupByLevelId=t);var r=this.secondaryHierarchySelection();r&&r!==o.HIERARCHY_NO_SELECTION.value&&(i.thenByLevelId=r)}this.pe.persistCriteria(i).catch((function(i){e.Logger.warn("NotificationsFilter.persistCriteria: Error persisting criteria: ",i)}))},o.prototype.Ph=function(){var i=this;return new Promise((function(t,r){i.pe.loadCriteria().then((function(e){i.selectedTimePeriod(e.periodId?e.periodId:void 0),i.selectedNotificationTypes(e.typeIds||[]),i.selectedSeverities(e.severities||[]),i.Ih.then((function(){i.secondaryHierarchySelection(e.thenByLevelId||o.HIERARCHY_NO_SELECTION.value),e.groupByLevelId&&(i.primaryHierarchySelection(e.groupByLevelId),i.useHierarchyOptions(!0)),t()}))}),(function(i){e.Logger.warn("NotificationsFilter._loadPersistedCriteria: Failed to load persisted criteria: ",i),r()}))}))},o.getInstance=function(e){var i=s.isObjectStrict(e)?e:r.getNotificationsService(),a=t.App.getUserData(),n=a.userid,l=a.prefLang;n===o.Gh&&l===o._h||(o.Qe={},o.Gh=n,o._h=l);var h=i.getServiceConfiguration(),c=o.Iu(h);return o.Qe[c]instanceof o||(o.Qe[c]=new o(i)),o.Qe[c]},o.Iu=function(e){return e.baseUri+"|"+e.appCodes.sort().join(",")},o}));