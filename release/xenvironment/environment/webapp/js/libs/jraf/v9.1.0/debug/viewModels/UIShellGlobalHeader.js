define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/utils/AppContextUtils","jraf/utils/ValidationUtils","jraf/models/UIShellManager","jraf/models/Content","jraf/models/HeaderState","jraf/models/HeaderMenus","ojs/ojknockouttemplateutils","ojs/ojarraydataprovider","jraf/composites/oj-rgbu-jraf-message-dialog/loader","ojs/ojknockout","ojs/ojselectsingle","ojs/ojselectcombobox","ojs/ojbutton","ojs/ojmenu","ojs/ojrouter"],(function(e,a,t,l,r,i,o,n,s,h,c,u){"use strict";var b=e.Translations.getTranslatedString;function g(e){if(!i.isObjectStrict(e)||!i.isBoolean(e.renderMenuPin())||!i.isBoolean(e.supportsMenuPin)||!i.isBoolean(e.renderGlobalMenuArea)||!i.isBoolean(e.renderApplicationName)||!i.isBoolean(e.renderProcessingIndicator)||!(e.headerState instanceof s)||e.supportsMenuPin&&!a.isPureComputed(e.pinned)||e.renderGlobalMenuArea&&!(e.headerMenus instanceof h))throw new TypeError("UIShellGlobalHeader: Invalid param(s).");this.currentSelectionLabel=b("jraf.common.currentSelectionLabel"),this.applicationName=l.App.getApplicationName(),this.logoLabel=b("jraf.global.logoLabel"),this.headerState=e.headerState,this.renderApplicationName=e.renderApplicationName,this.renderProcessingIndicator=e.renderProcessingIndicator,this.applicationContext=r.getApplicationContext(),this._initializeMenuPin(e),this._initializeGlobalMenuArea(e),this._initializeGlobalSearchArea(e)}return g.MINIMUM_AUTOSUGGEST_LENGTH=1,g.MAXIMUM_AUTOSUGGEST_RESULT_COUNT=3,g.DEFAULT_FILTER_SECTION={value:-1,label:b("jraf.global.searchDefaultFilterLabel"),jrafTestId:"global-header-search-section-default"},g.ALL_RESULTS_OPTION={value:"-1",label:b("jraf.global.searchAllResultsLabel")},g.prototype._initializeMenuPin=function(e){if(this.renderMenuPin=e.renderMenuPin,this.supportsMenuPin=e.supportsMenuPin,this.supportsMenuPin){var t=this;this.menuPinHeaderLabel=b("jraf.global.menu"),this.menuPinTooltipLabel=b("jraf.global.pin"),this.menuPinActiveTooltipLabel=b("jraf.global.unpin"),this.menuPinned=e.pinned,this.menuPinTooltip=a.computed((function(){return this.menuPinned()?this.menuPinActiveTooltipLabel:this.menuPinTooltipLabel}),this),this.toggleMenuPin=function(){t._toggleMenuPin()}}},g.prototype._initializeGlobalMenuArea=function(e){var t=this;this.renderGlobalMenuArea=e.renderGlobalMenuArea,this.renderGlobalMenuArea&&(this._menuData=e.headerMenus,this.userMenuId=l.UIShell.generateUniqueId(),this.helpMenuId=l.UIShell.generateUniqueId(),this.helpMenuLabel=b("jraf.global.help"),this._userData=this._menuData.getUserData(),this.handleMenuSelect=function(e,a){t._menuData.handleMenuItemSelection(e.target.id)},this.userMenuItems=this._menuData.getUserMenu(),this.helpMenuItems=this._menuData.getHelpMenu(),this.username=this._userData.username,this.userAvatar=a.pureComputed((function(){var e=this._userData.avatar();return i.isNonemptyString(e)?".jraf-global-header-user-button-icon { background-image: url('"+e+"'); }":null}),this))},g.prototype._initializeGlobalSearchArea=function(e){if(this.globalSearchSectionFilterCallback=e.globalSearchSectionFilterCallback,this.globalSearchCallback=e.globalSearchCallback,this.hasGlobalSearchCallback=i.isFunction(this.globalSearchCallback),this.globalSearchContextCallback=e.globalSearchContextCallback,this.globalSearchAllResultsCallback=e.globalSearchAllResultsCallback,this.hasGlobalSearchCallback&&i.isFunction(this.globalSearchSectionFilterCallback)&&i.isFunction(this.globalSearchContextCallback)&&i.isFunction(this.globalSearchAllResultsCallback)){var t=this;this.searchActive=a.observable(!1),this.sectionFilterInputId=l.UIShell.generateUniqueId(),this.globalSearchInputId=l.UIShell.generateUniqueId(),this.globalSearchOptionTemplateId=l.UIShell.generateUniqueId(),this.minimumAutosuggestLength=g.MINIMUM_AUTOSUGGEST_LENGTH,this.pickerAttributes={class:"jraf-global-header-search-result-list"},this.searchMenuFilterListSelection=a.observableArray([g.DEFAULT_FILTER_SECTION.value]),this.searchFilterComponentLabel=b("jraf.global.searchFilterComponentLabel"),this.sectionFilters=a.observableArray([{value:g.DEFAULT_FILTER_SECTION.value,label:g.DEFAULT_FILTER_SECTION.label,jrafTestId:g.DEFAULT_FILTER_SECTION.jrafTestId}]),this._initializeSectionFilterList(),this.sectionFiltersDataProvider=new u(this.sectionFilters,{keyAttributes:"value"}),this._globalSearchAutosuggestBuffer=[],this.globalSearchString=a.observableArray([]),this.globalSearchPlaceholderText=b("jraf.global.searchPlaceholderText"),this.noResultsLabel=b("jraf.messages.noResults"),this.deactivateGlobalSearchAriaLabel=b("jraf.global.deactivateGlobalSearchAriaLabel"),this.activateGlobalSearchAriaLabel=b("jraf.global.activateGlobalSearchAriaLabel"),this.globalSearchAriaLabel=b("jraf.global.globalSearchAriaLabel"),this.getGlobalSearchOptionTemplate=function(){return c.getRenderer(t.globalSearchOptionTemplateId)},this.getGlobalSearchAutosuggestOptions=function(e){return i.isString(e.term)?(t.lastSearchTerm=e.term,t._getGlobalSearchAutosuggestOptions(e.term)):(t.lastSearchTerm="",Promise.resolve([]))},this.handleGlobalSearchSubmission=function(e,a){t._handleGlobalSearchSubmission(e,a)},this.toggleGlobalSearch=function(){t._toggleGlobalSearch()},this.globalSearchState=a.pureComputed((function(){var e={};return this.searchActive()?(e.ariaLabel=this.deactivateGlobalSearchAriaLabel,e.filterDisabled=!1):(e.ariaLabel=this.activateGlobalSearchAriaLabel,e.filterDisabled=!0),e}),this),this.filterDisabled=a.pureComputed((function(){return this.globalSearchState().filterDisabled}),this),this.currentGlobalSearchAriaLabel=a.pureComputed((function(){return this.globalSearchState().ariaLabel}),this)}},g.prototype._toggleMenuPin=function(){this.menuPinned()?o.closeMenu():o.pinMenu()},g.prototype._initializeSectionFilterList=function(){var a=this;return this._getSectionFilterOptions().then((function(e){a.sectionFilters(e)}),(function(a){e.Logger.warn("UIShellGlobalHeader._initializeSectionFilterList: Error loading sections: ",a)}))},g.prototype._getSectionFilterOptions=function(){var a=this;return this.globalSearchSectionFilterCallback().then((function(e){return a._parseSectionFilterList(e)}),(function(a){e.Logger.warn("UIShellGlobalHeader._getSectionFilterOptions: Error loading sections: ",a)}))},g.prototype._parseSectionFilterList=function(e){var a=[];a.push({value:g.DEFAULT_FILTER_SECTION.value,label:g.DEFAULT_FILTER_SECTION.label,jrafTestId:g.DEFAULT_FILTER_SECTION.jrafTestId});for(var t=0;t<e.length;t++){var l=e[t];a.push({value:l.value,label:""+l.label,jrafTestId:"global-header-search-section-"+t})}return a},g.prototype._getGlobalSearchAutosuggestOptions=function(a){var t=this;if(a.length>=this.minimumAutosuggestLength){var l=this._getGlobalSearchParam(a);return this.globalSearchCallback(l).then((function(e){return t._globalSearchAutosuggestBuffer=e,t._parseGlobalSearchList(t._globalSearchAutosuggestBuffer)}),(function(a){e.Logger.warn("UIShellGlobalHeader._getGlobalSearchAutosuggestOptions: Error loading search: ",a)}))}},g.prototype._getGlobalSearchParam=function(e){var a=this.searchMenuFilterListSelection()[0];return a===g.DEFAULT_FILTER_SECTION.value?{searchText:e}:{searchText:e,sectionId:a}},g.prototype._handleGlobalSearchSubmission=function(e,a){if("ojValueUpdated"===e.type){var t=""+e.detail.value;if(i.isNonemptyString(t)){if(t===g.ALL_RESULTS_OPTION.value)return this._showAllResults(),!0;for(var l=this._globalSearchAutosuggestBuffer,r=0;r<l.length;r++){var o=l[r];if(""+o.value===t)return this._launchGlobalSearchResult(o.value),this.globalSearchString.pop(),!0}return this._showAllResults(),!0}if(!i.isNonemptyString(t))return this._showAllResults(),!0}return!1},g.prototype._showAllResults=function(){var e=this._getGlobalSearchParam(this.lastSearchTerm);this._launchGlobalSearchAllResults(e),this.globalSearchString.pop()},g.prototype._parseGlobalSearchList=function(e){for(var a=[],t={},l=e.length>g.MAXIMUM_AUTOSUGGEST_RESULT_COUNT?g.MAXIMUM_AUTOSUGGEST_RESULT_COUNT:e.length,r=0;r<l;r++){var i=e[r];a.push({value:""+i.value,label:i.label,metadata:i.metadata||"",jrafTestId:"global-header-search-result-"+r}),t[i.label]=void 0===t[i.label]}if(0===a.length)a.push({label:this.noResultsLabel});else{for(var o=0;o<a.length;o++){var n=a[o];t[n.label]||(n.label=n.label+" "+n.value)}e.length>g.MAXIMUM_AUTOSUGGEST_RESULT_COUNT&&a.push({value:g.ALL_RESULTS_OPTION.value,label:g.ALL_RESULTS_OPTION.label,last:!0})}return a},g.prototype._launchGlobalSearchResult=function(e){return this.globalSearchContextCallback(e).then((function(e){var a=new n(e);a&&o.openContent(a)}))},g.prototype._launchGlobalSearchAllResults=function(e){return this.globalSearchAllResultsCallback(e).then((function(e){"object"==typeof e.targetProperties&&null!==e.targetProperties&&(e.targetProperties.reloadTab=!0);var a=new n(e);a&&o.openContent(a)}))},g.prototype._toggleGlobalSearch=function(){this.searchActive()?(t(".jraf-global-header-search-container").removeClass("active"),t(".jraf-global-header-filter-container").removeClass("active"),t(".jraf-global-header-close-search-icon-container").removeClass("active")):(t(".jraf-global-header-search-container").addClass("active"),t(".jraf-global-header-filter-container").addClass("active"),t(".jraf-global-header-close-search-icon-container").addClass("active")),this.searchActive(!this.searchActive())},g}));