define(["knockout","jraf/jrafcore","dompurify","ojs/ojlogger","ojs/ojtranslation","ojs/ojcontext","jraf/services/ServiceManager","jraf/models/UIShellManager","jraf/utils/ValidationUtils","ojs/ojarraydataprovider","ojs/ojhtmlutils","ojs/ojdialog","ojs/ojconveyorbelt","ojs/ojnavigationlist","ojs/ojbinddom","ojs/ojknockout","ojs/ojtoolbar","ojs/ojbutton"],(function(t,e,o,i,n,r,s,a,l,d,c){"use strict";var h=n.getTranslatedString;function u(o){if(!l.isObjectStrict(o)||!l.isNonemptyString(o.popupId)||!t.isObservable(o.notificationId))throw new TypeError("AlertsPopup: Invalid Parameters");var i=this;this.popupId=o.popupId,this.notificationId=o.notificationId,this.tabbarId=e.UIShell.generateUniqueId(),this.alertDetailsDivId=e.UIShell.generateUniqueId(),this.htmlFrameId=e.UIShell.generateUniqueId(),this.popupTitle=h("jraf.notifications.alerts.popupTitle"),this.doneButtonLabel=h("jraf.common.done"),this.onBeforeOpen=function(){i.$j()},this.done=function(){i.qr()},this.alertsData=t.observableArray([]),this.alertsDataProvider=new d(this.alertsData,{keyAttributes:"id"}),this.selectedAlertId=t.observable(null),this.selectedAttachment=t.observable(null),this.hasMultipleAlerts=t.pureComputed((function(){return 1<this.alertsData().length}),this),this.selectedAlert=t.pureComputed((function(){for(var t=this.selectedAlertId(),e=null,o=0;o<this.alertsData().length;o++)if(this.alertsData()[o].id===t){e=this.alertsData()[o];break}return e}),this),this.selectedAlertSubject=t.pureComputed((function(){var t=this.selectedAlert();return t&&t.alertContext?t.alertContext.subject:""}),this),this.selectedAlertHasHtmlBody=t.pureComputed((function(){var t=this.selectedAlert();return t&&t.alertContext&&!0===t.alertContext.htmlBody}),this),this.selectedAlertBody=t.pureComputed((function(){var t=this.selectedAlert();return!t||this.selectedAlertHasHtmlBody()?"":t.alertContext.body}),this),this.selectedAlertHtmlBody=t.pureComputed((function(){var t=this.selectedAlert();return t&&this.selectedAlertHasHtmlBody()?t.alertContext.bodySanitized:""}),this),this.selectedAlertHasAttachments=t.pureComputed((function(){var t=this.selectedAlert();return t&&l.isArray(t.attachments)&&0<t.attachments.length}),this),this.selectedAlertAttachments=t.pureComputed((function(){var t=this.selectedAlert();return t&&this.selectedAlertHasAttachments?t.attachments:[]}),this),this.notificationsService=s.getNotificationsService(),this.handleAlertSelection=function(){i.Od(),document.getElementById(i.alertDetailsDivId).scrollTop=0},this.handleHtmlFrameLoaded=function(){if(i.selectedAlertHasHtmlBody()){var t=document.getElementById(i.htmlFrameId);t.height=t.contentWindow.document.documentElement.scrollHeight}},this.getAttachmentSelectHandler=function(t){return function(){i.Td(t)}}}return u.prototype.$j=function(){this.alertsData.removeAll(),this.selectedAlertId(void 0),this.Dd()},u.prototype.qr=function(){document.getElementById(this.popupId).close()},u.prototype.Dd=function(){var t=this;a.startProcessingIndicator(),this.notificationsService.getAlerts(this.notificationId()).then((function(e){t.Ad(e)}),(function(e){t.Id(e)}))},u.prototype.Ad=function(t){var e=this;a.stopProcessingIndicator();var o=[];l.isArray(t)&&0<t.length&&(o=t.map((function(t){var o={id:t.id,alertContext:JSON.parse(t.alertContext),notificationId:t.notificationId,attachments:t.attachments};return!0===o.alertContext.htmlBody&&(o.alertContext.bodySanitized=e.Yd(o.alertContext.body)),o}))),this.alertsData(o),this.Ld(),document.getElementById(this.tabbarId).refresh()},u.prototype.Yd=function(t){var e=o.sanitize(t,{WHOLE_DOCUMENT:!0});return 0===t.trim().indexOf("<!DOCTYPE")&&-1===e.trim().indexOf("<!DOCTYPE")&&(e="<!DOCTYPE html>"+e),e},u.prototype.Ld=function(){var t=this.alertsData()[0],e=t?t.id:null;this.selectedAlertId(e)},u.prototype.Od=function(){if(this.selectedAlertHasHtmlBody()){var t=document.getElementById(this.htmlFrameId),e=t.contentWindow.document;t.height="0px",e.open(),e.write(this.selectedAlertHtmlBody()),e.close()}},u.prototype.Td=function(t){var e=this,o=this.selectedAlertId();this.notificationsService.getAlertAttachment(o,t).then((function(o){e._d(t,o)}),(function(t){e.Id(t)}))},u.prototype._d=function(t,e){var o=document.createElement("a");o.href=window.URL.createObjectURL(e),o.download=t,o.style="display:none;",document.body.appendChild(o),o.click(),document.body.removeChild(o)},u.prototype.Id=function(t){i.warn("AlertsPopup._handleDataLoadFailure: failed loading alerts data with reason "+t),a.stopProcessingIndicator()},u}));