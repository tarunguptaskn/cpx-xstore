define(["ojs/ojcore","knockout","jquery","ojs/ojlogger","./DashboardContent","./dashboardTile/DashboardTile","text!./dashboardTile/DashboardTile.html","jraf/composites/utils/TranslationLoaderUtil","module","ojs/ojconveyorbelt","ojs/ojmasonrylayout","ojs/ojdialog","ojs/ojlistview","ojs/ojbutton","ojs/ojoption","ojs/ojmodule","ojs/ojmodule-element","ojs/ojknockout","ojs/ojarraytabledatasource","jraf/composites/oj-rgbu-jraf-message-dialog/loader","jraf/composites/oj-rgbu-jraf-snackbar/loader"],(function(t,i,e,s,o,n,r,a,h){"use strict";function d(t){var i=this;this.Ri=d.y.getTranslations().then((function(t){i.yi(t)})),this.Ji(t)}return d.TILE_WIDTH=183,d.UNLIMITED_TILES=0,d.DEFAULT_TILE_DISPLAY_LIMIT=12,d.SCROLL_ATTEMPT_LIMIT=10,d.y=new a("oj-rgbu-jraf-dashboard",h.id),d.prototype.activated=function(){return this.Ri},d.prototype.propertyChanged=function(t){if("external"===t.updatedFrom)if("selection"!==t.property)if("tileDisplayLimit"!==t.property){if("defaultBehavior"===t.property){var i=t.subproperty.path,e=t.subproperty.value||!1;return"defaultBehavior.tileInsertionRefresh"===i?void(this.Ui=e):"defaultBehavior.tileSelectionRefresh"===i?void(this.qi=e):void 0}}else this.Pi=void 0===t.value?d.DEFAULT_TILE_DISPLAY_LIMIT:t.value;else{var s=t.value,o=this.Gi[s]||null;this.Ki(o)}},d.prototype.refresh=function(){return this.Ni.removeAll(),this.Oi.removeAll(),this.Qi(!0)},d.prototype.yi=function(t){this.Vi=t.editDashboardLabel,this.Wi=t.doneEditingLabel,this.editDashboardButtonLabel=i.observable(t.editDashboardLabel),this.Xi(t.removeTile),this.Yi(t.reorderTileTitle),this.Zi(t.reorderTileLabel),this.dashboardReorderMenuLabel=t.dashboardReorderMenuLabel,this.addDashboardTileText=t.addDashboardTile,this.dashboardTilesListLabel=t.dashboardTilesListLabel,this.noDataText=t.noData,this.previewLabel=t.previewLabel,this.previewUnavailableText=t.previewUnavailableText,this.cancelText=t.cancel,this.addTileText=t.addTile,this.$i=t.selectTileTryAgainMsg,this.noTileDataMsg=t.noTileDataMsg,this.addTileLinkText=t.addTileLinkText,this.ts=t.maxTilesMsg,this.ss=t.dashboardLoadError},d.prototype.Ji=function(t){this.X=t,this.ns=t.element,this.hs(),this.os(t.uniqueId),this.M(t.properties),this.rs(),this.es(),this.as(),this.us()},d.prototype.hs=function(){this.Xi=i.observable(""),this.Yi=i.observable(""),this.Zi=i.observable(""),this.messageDialogBody=i.observable("")},d.prototype.os=function(t){this.fs=t,this.removedTilesContainerId=t+"_removedTiles",this.conveyorBeltId=t+"_conveyor",this.masonryLayoutId=t+"_masonry",this.addTileDialogId=t+"_addTileDialog",this.messageDialogId=t+"_messageDialogId",this.snackbarId=t+"_snackbar",this.adminTileId=t+"_adminTile"},d.prototype.M=function(t){this.ds=t.getDashboardDataCallback,this.cs=t.renderTileAdministration,this.Pi=t.tileDisplayLimit,this.Ui=t.defaultBehavior.tileInsertionRefresh,this.qi=t.defaultBehavior.tileSelectionRefresh},d.prototype.rs=function(){this.dashboardDataLoaded=i.observable(!1),this.Ni=i.observableArray([]),this.Oi=i.observableArray([]),this.Qi()},d.prototype.es=function(){this.ls=0,this.bs=i.observable(0),this.dashboardTiles=i.observableArray([]),this.availableDashboardTiles=i.observableArray([]),this.js=null,this.tileContainerWidth=i.pureComputed((function(){var t=this.cs?1:0;return t+=this.bs(),this.vs(t)+"px"}),this),this.hasTiles=i.pureComputed((function(){return 0<this.bs()}),this),this.editMode=i.observable(!1);var t=this;this.handleTileRemoval=function(i){t.gs(i)},this.handleTileInsertion=function(i){t.ms(i)},this.handleTileReorder=function(i){t.Ts(i)},this.ys=e.parseHTML(r),this.ws={handleTileSelection:function(i){t.ps(i)},editMode:this.editMode,removeTile:function(i){t.Ds(i)},removeTileTitle:this.Xi,reorderTileTitle:this.Yi,reorderTileLabel:this.Zi,getBeforeLoadModuleHandler:function(){return t.X.properties.beforeLoadModuleHandler},getAfterUnloadModuleHandler:function(){return t.X.properties.afterUnloadModuleHandler}}},d.prototype.as=function(){this.cs&&(this.ks(),this._s())},d.prototype.us=function(){this.contentModuleBinding=i.observable(null),this.contentModuleOptions=i.observable(null)},d.prototype.Qi=function(t){var i=this;return this.ds().then((function(e){i.Rs(e,t)}),(function(t){i.Cs(t)}))},d.prototype.Rs=function(t,i){if(!Array.isArray(t))throw new TypeError("oj-rgbu-jraf-dashboard: getDashboardDataCallback did not return an array of dashboard content.");this.ls=0,this.Gi={},this.Is={},this.Ms={},t.forEach((function(t,i){var e=this.Bs(t,i);this.Ls(e)}),this),this.xs(),this.As(),this.dashboardDataLoaded(!0),i&&this.Hs().refresh()},d.prototype.Bs=function(t,i){return new o(t,this.fs+"_dc"+i)},d.prototype.Ls=function(t){this.Gi[t.getId()]=t,this.Is[t.getTileId()]=t,this.Ms[t.getDialogId()]=t,this.Js(t)},d.prototype.Js=function(t){t.isInserted()?this.Ni.push(t):this.Oi.push(t)},d.prototype.xs=function(){this.Ss(),this.Es()&&this.Fs(),this.bs(this.Us());var t=this.Ni().map((function(t){return this.qs(t)}),this);this.cs&&t.push({administrationTile:!0}),this.dashboardTiles(t),this.availableDashboardTiles(this.Oi().map((function(t){return this.qs(t)}),this))},d.prototype.qs=function(t){return{id:t.getTileId(),moduleConfig:{view:[this.ys[0].cloneNode(!0)],viewModel:new n({content:t,dashboard:this.ws})}}},d.prototype.Ss=function(){this.Ni.sort(o.compareDashboardContent),this.Ni().forEach((function(t,i){t.setPosition(i),this.Ps(t,i)}),this)},d.prototype.Fs=function(){this.Ni.splice(this.Pi,this.Us()).forEach((function(t){t.setInserted(!1),this.Oi.push(t)}),this)},d.prototype.As=function(){var t=this.zs();null!==t?this.Ki(t):this.contentModuleOptions(this.X.properties.noTileSelectedModuleOptions)},d.prototype.zs=function(){var t,i=this.Gs();if("string"==typeof i&&0<i.length&&(t=this.Gi[i])&&!t.isDisabled())return t;var e=this.Ni().filter((function(t){return!t.isDisabled()}));return 0<e.length?e[0]:null},d.prototype.Ki=function(t){s.info("oj-rgbu-jraf-dashboard: entering select dashboard content."),this.Ks()&&this.js.selected(!1);var i=null!==t&&t.isInserted()&&!t.isDisabled();i&&(s.info("oj-rgbu-jraf-dashboard: Selecting dashboard content %s (%s)",t.getId(),t.getTileId()),t.setSelected(!0)),this.js=i?t:null,this.Ns(i?t.getId():null);var e=i?t.getContentModuleBinding():null;this.contentModuleBinding(e);var o=i?t.getContentModuleOptions():this.X.properties.noTileSelectedModuleOptions;this.contentModuleOptions(o);var n=this;window.requestAnimationFrame((function(){n.Os()}))},d.prototype.Gs=function(){return this.X.properties.selection},d.prototype.Ns=function(t){this.X.properties.selection=t},d.prototype.Os=function(){if(this.Ks()){var t=document.getElementById(this.js.getTileId()),i=document.querySelector("#"+this.conveyorBeltId+" div.oj-conveyorbelt-overflow-container");if(t&&i)this.Qs(t,i);else if(this.ls<d.SCROLL_ATTEMPT_LIMIT){this.ls++;var e=this;window.requestAnimationFrame((function(){e.Os()}))}}},d.prototype.Qs=function(t,i){var e=t.offsetLeft-5,s=e+t.offsetWidth+10,o=i.scrollLeft,n=o+i.offsetWidth;e<o?i.scrollLeft=e:n<s&&(i.scrollLeft=s-i.offsetWidth)},d.prototype.ps=function(t){var i=this.Is[t];if(!this.editMode()){var e=i.getId();this.Vs(e)||i.isDisabled()||(this.Ki(i),i.isRefreshOnSelection(this.qi)&&this.Ws(e))}},d.prototype.Ks=function(){return this.js instanceof o},d.prototype.Vs=function(t){return this.Ks()&&this.js.getId()===t},d.prototype.Cs=function(t){s.error("oj-rgbu-jraf-dashboard: Failed to load dashboard data with reason %s",t),this.Xs(this.ss),this.dashboardDataLoaded(!0)},d.prototype.Ds=function(t){var i=t.target.parentElement.parentElement;this.Hs().removeTile("#"+i.id)},d.prototype.gs=function(t){if(t.target===this.Hs()){var i=t.detail.tile,e=this.Is[i.id],o=e.getId();s.info("oj-rgbu-jraf-dashboard: handlines %s tile removal",o);var n=this.Ys(e,i);this.js===e&&this.Zs(n),this.bs()<=0&&this.$s(),this.sn("ojRgbuJrafDashboardTileRemove",{id:o})}else s.info("oj-rgbu-jraf-dashboard: Ignoring remove event that did not originate from masonry layout.")},d.prototype.Ys=function(t,i){t.setInserted(!1),this.hn(i);var e=this.rn(this.Ni,this.Oi,t);return this.en(),e},d.prototype.hn=function(t){document.getElementById(this.removedTilesContainerId).appendChild(t)},d.prototype.Zs=function(t){var i=null,e=this.Ni(),s=e.length;0<s&&(i=e[Math.min(t,s-1)]),this.Ki(i)},d.prototype.an=function(){if(this.Es())this.un();else{var t=this.addTileSelection();if(0!==t.length){var i=t[0],e=this.Ms[i],s=this;return(e.isRefreshOnInsertion(this.Ui)?this.Ws(e.getId()):Promise.resolve()).then((function(){s.fn(e)}))}this.dn(this.$i)}},d.prototype.fn=function(t){this.cn();var i=t.getTileId();this.ln(i,this.Us())},d.prototype.ms=function(t){if(t.target===this.Hs()){var i=t.detail.tile,e=t.detail.index,o=this.Is[i.id],n=o.getId();s.info("oj-rgbu-jraf-dashboard: Handling dashbord tile insert (%s, %d)",n,e),o.setInserted(!0),o.setPosition(e),this.bn(),-1===this.rn(this.Oi,this.Ni,o)&&s.warn("oj-rgbu-jraf-dashboard: Could not find dashboard content %s when updating dashboard state on tile insert",n),1===this.bs()&&this.Ki(o),this.jn(),this.sn("ojRgbuJrafDashboardTileInsert",{id:n,position:e})}else s.info("oj-rgbu-jraf-dashboard: ignoring insert event that did not originate from the dashboard component.")},d.prototype.ln=function(t,i){s.info("oj-rgbu-jraf-dashboard: inserting %s at %d",t,i),this.Hs().insertTile("#"+t,i)},d.prototype.cn=function(){this.bs(this.bs()+1)},d.prototype.en=function(){this.bs(this.bs()-1)},d.prototype.rn=function(t,i,e){var s=this.vn(t,e);return i.push(e),s},d.prototype.vn=function(t,i){for(var e=-1,s=t(),o=0;o<s.length;o++)if(s[o]===i){e=o;break}return 0<=e&&t.splice(e,1),e},d.prototype.Ts=function(t){if(t.target===this.Hs()){var i=this.Is[t.detail.tile.id],o=t.detail.toIndex;s.info("oj-rgbu-jraf-dashboard: handling tile %s reorder to %d",i.getId(),o);var n=this;e(this.Hs()).find(".oj-rgbu-jraf-dashboard-tile").each((function(t,i){n.adminTileId!==i.id&&n.Ps(n.Is[i.id],t)}))}else s.info("oj-rgbu-jraf-dashboard: ignoring reorder event not originating from masonry layout component")},d.prototype.Ps=function(t,i){t.getPosition()!==i?(t.setPosition(i),this.sn("ojRgbuJrafDashboardTileReorder",{id:t.getId(),position:i})):s.log("oj-rgbu-jraf-dashboard: ignoring tile move to %d since the tile is already at this position.",i)},d.prototype.sn=function(t,i){var e={bubbles:!0,cancelable:!1,detail:i};return this.ns.dispatchEvent(new CustomEvent(t,e))},d.prototype.ks=function(){var t=this;this.openAddTileDialog=function(){t.gn()},this.editDashboardChecked=i.observableArray([]),this.editDashboardChecked.subscribe((function(){t.mn(),t.editDashboardButtonLabel(t.editMode()?t.Wi:t.Vi)}))},d.prototype._s=function(){var e=this;this.addTileDialogOpen=i.observable(!1),this.addTileCurrentItem=i.observable(null),this.addTileSelection=i.observableArray([]),this.addTileSelected=i.pureComputed((function(){return 0<this.addTileSelection().length}),this),this.availableDashboardContentDataSource=new t.ArrayTableDataSource(this.Oi,{idAttribute:"dialogId"}),this.availableDashboardContentDataSource.sort({key:"name",direction:"ascending"}),this.handleDialogCancel=function(){e.jn()},this.handleDialogAddTile=function(){e.an()}},d.prototype.Ws=function(t){var i=this;return this.ds(t).then((function(t){i.Tn(t)}),(function(t){i.yn(t)}))},d.prototype.Tn=function(t){var i=this.Gi[t.id];i.update(t),this.Vs(i.getId())&&this.Ki(i)},d.prototype.yn=function(t){s.warn("oj-rgbu-jraf-dashboard: Failed refreshing dashboard content %s.",t)},d.prototype.mn=function(){this.editMode(!this.editMode()),this.editMode()&&this.Hs().refresh()},d.prototype.$s=function(){this.editMode()&&this.editDashboardChecked([])},d.prototype.jn=function(){document.getElementById(this.addTileDialogId).close()},d.prototype.gn=function(){document.getElementById(this.addTileDialogId).open(),this.addTileDialogOpen(!0)},d.prototype.bn=function(){this.addTileSelection().length&&(this.addTileSelection.pop(),this.addTileCurrentItem(null))},d.prototype.Hs=function(){return document.getElementById(this.masonryLayoutId)},d.prototype.vs=function(t){return t*d.TILE_WIDTH},d.prototype.Us=function(){return this.Ni().length},d.prototype.Es=function(){return this.Pi!==d.UNLIMITED_TILES&&this.Us()>=this.Pi},d.prototype.un=function(){this.dn(this.ts)},d.prototype.dn=function(t){this.messageDialogBody(t),this.wn()},d.prototype.wn=function(){document.getElementById(this.messageDialogId).open()},d.prototype.Xs=function(t){document.getElementById(this.snackbarId).openSnack({message:t,severity:"error",showDismiss:!0,disableTimeout:!0})},d}));