define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/services/ServiceManager","jraf/utils/ValidationUtils","jraf/models/UIShellManager","jraf/models/notifications/NotificationsFilter","ojs/ojarraydataprovider","ojs/ojselectsingle","ojs/ojselectcombobox","ojs/ojinputtext","jraf/composites/oj-rgbu-jraf-message-dialog/loader","ojs/ojbutton","ojs/ojpopup","ojs/ojlabel","ojs/ojdialog"],(function(e,i,t,s,o,a,r,n,c){"use strict";h.REASSIGN_TYPE_CODE="Reassign Notification",h.DESCRIPTION_CHARACTER_LIMIT=200;var l=e.Translations.getTranslatedString;function h(e){var t=this;if(!a.isObjectStrict(e)||!a.isNonemptyString(e.dialogId)||!a.isObjectStrict(e.notificationsService))throw new TypeError("CreateNotification: Invalid parameters");this.notificationsService=e.notificationsService,this.identityService=o.getIdentityService(),this.dialogId=e.dialogId,this.severitySelectId=s.UIShell.generateUniqueId(),this.typeSelectId=s.UIShell.generateUniqueId(),this.messageFieldId=s.UIShell.generateUniqueId(),this.assigneeSearchId=s.UIShell.generateUniqueId(),this.assigneeListId=s.UIShell.generateUniqueId(),this.errorId=s.UIShell.generateUniqueId(),this.createFailedDialogId=s.UIShell.generateUniqueId(),this.severitySelectLabel=l("jraf.notifications.create.severityField"),this.typeSelectLabel=l("jraf.notifications.create.typeField"),this.messageFieldLabel=l("jraf.notifications.create.descField"),this.assigneeSearchLabel=l("jraf.notifications.create.assigneeSearch"),this.assigneeSearchPlaceholder=l("jraf.notifications.create.assigneeSearchPlaceholder"),this.matchingRecipientsLabel=l("jraf.notifications.create.matchingRecipientsLabel"),this.assigneeListLabel=l("jraf.notifications.create.assigneeListLabel"),this.dialogTitle=a.isNonemptyString(e.dialogTitle)?e.dialogTitle:l("jraf.notifications.create.dialogTitle"),this.createFailedMsg=a.isNonemptyString(e.createFailedMsg)?e.createFailedMsg:l("jraf.notifications.create.createFailed"),this.removeAssigneeLabel=l("jraf.notifications.create.removeAssigneeLabel"),this.okLabel=l("jraf.common.ok"),this.cancelLabel=l("jraf.common.cancel"),this.noMessageError=l("jraf.notifications.create.noMessageError"),this.noRecipientsError=l("jraf.notifications.create.noRecipientsError"),this.minimumSearchStringError=l("jraf.notifications.create.minimumSearchStringError"),this.appCode=e.appCode,this.severityOptions=n.SEVERITY_OPTIONS,this.severityOptionsDataProvider=new c(this.severityOptions,{keyAttributes:"value"}),this.selectedSeverity=i.observable(n.SEVERITY_VALUE_IMPORTANT),this._initializeNotificationTypes(),this.maxMessageLength=h.DESCRIPTION_CHARACTER_LIMIT,this.messageCharLimitLabel=l("jraf.notifications.create.descCharLimit",this.maxMessageLength),this.messageValue=i.observable(""),this.assigneeSearchValue=i.observable(""),this.assigneeOptions=i.observableArray([]),this.selectedAssignees=i.observableArray([]),this.assigneeList=i.observableArray([]),this.assignedGroups=i.observableArray([]),this.errorAtPosH="start",this.errorAtPosV="bottom",this.errorMyPosH="start",this.errorMyPosV="top",this.errorMessage=i.observable(""),this.removeAssignee=function(e,i){t._removeAssignee(i)},this.closeDialog=function(){t._closeDialog()},this.createNotification=function(){t._createNotification()},this.handleUsersSearch=function(){t._handleUsersSearch()},this.handleTypeSelection=function(e,i){t._handleTypeSelection(e,i)},this.onOpen=function(){t.handleOpen()},this.createReadyPromise=Promise.resolve(),this._populateFields(),this.copySource={},a.isFunction(e.createCallback)&&(this.createCallback=e.createCallback),e.defaultNotification&&this._subscribeNotificationSelection(e.defaultNotification)}return h.prototype._initializeNotificationTypes=function(){this.typeOptions=n.getInstance(this.notificationsService).notificationTypeOptions,this.typeOptionsDataProvider=new c(this.typeOptions,{keyAttributes:"value"}),this.selectedType=i.observable()},h.prototype._populateFields=function(){var e=this;this.selectedAssignees.subscribe((function(){e._updateAssigneeList()}))},h.prototype._searchUsers=function(){var i=this;return this.identityService.searchUsers(this.assigneeSearchValue()).then((function(e){for(var t=[],s=0;s<e.length;s++){var o={};o.value=e[s].userid,o.label=e[s].displayName||e[s].userid,t.push(o)}i.assigneeOptions(t)}),(function(i){e.Logger.warn("CreateNotification._searchUsers: Error loading users: "+i)}))},h.prototype._subscribeNotificationSelection=function(e){var i=this;e.subscribe((function(e){if(e){i.messageValue(e.message);var t=n.SEVERITY_OPTIONS.filter((function(i){return i.label===e.severity}));t.length>0&&i.selectedSeverity(t[0].value);var s=i.typeOptions().filter((function(e){return e.typeCode===h.REASSIGN_TYPE_CODE}));s.length>0&&i.selectedType(s[0].value),i.copySource={id:e.id,launchable:e.launchable,hierarchy:e.hierarchy}}else i._resetFields()}))},h.prototype.handleOpen=function(){var e=this;this.copySource.id&&this.copySource.launchable&&(r.startProcessingIndicator(),this.createReadyPromise=e.notificationsService.getNotificationContext(e.copySource.id).then((function(i){e.copySource.context=i,r.stopProcessingIndicator()}),(function(){r.stopProcessingIndicator()})))},h.prototype._handleTypeSelection=function(e,i){for(var t=e.target.value,s=this.typeOptions(),o=0;o<s.length;o++)if(s[o].value===t){this.assignedGroups(s[o].groups||[]);break}},h.prototype._updateAssigneeList=function(){var e=this,i=this.assigneeList().filter((function(i){var t=e.assigneeOptions().some((function(e){return e.value===i.value})),s=e.selectedAssignees().some((function(e){return e.value===i.value}));return!t||s})),t=this.selectedAssignees().filter((function(e){return!i.some((function(i){return i.value===e.value}))})),s=i.concat(t);s.sort((function(e,i){return e.label.localeCompare(i.label)})),this.assigneeList(s)},h.prototype._removeAssignee=function(e){this.assigneeList.remove(e.data),this.selectedAssignees.remove(e.data)},h.prototype._createNotification=function(){var e=this,i=this.assigneeList().map((function(e){return e.value})),t={applicationCode:this.appCode,notificationDesc:this.messageValue(),notificationTypeId:this.selectedType(),severity:this.selectedSeverity(),recipients:i};if(a.isNonemptyString(t.notificationDesc)){if(0!==t.recipients.length||0!==this.assignedGroups().length){this.copySource.context&&(t.notificationContextObj=JSON.stringify(this.copySource.context),t.contextSource="JRAF",t.launchable=!0);var s=this.copySource.hierarchy;if(a.isArray(s))for(var o=0;o<s.length;o++){if(a.isNonemptyString(s[o]))t["hierValue"+(o+1)]=s[o]}return r.startProcessingIndicator(),this.createReadyPromise.then((function(){return e.notificationsService.createNotification(t).then((function(){e._handleSuccessfulNotificationCreation()}),(function(i){e._handleFailedNotificationCreation(i)}))}))}this._showErrorMessage(this.assigneeListId,this.noRecipientsError)}else this._showErrorMessage(this.messageFieldId,this.noMessageError)},h.prototype._handleSuccessfulNotificationCreation=function(){this._resetFields(),r.stopProcessingIndicator(),this._closeDialog(),this.createCallback&&this.createCallback()},h.prototype._handleFailedNotificationCreation=function(i){e.Logger.error("CreateNotification._createNotification: Error creating new notification: "+i),document.getElementById(this.createFailedDialogId).open(),r.stopProcessingIndicator()},h.prototype._resetFields=function(){this.selectedSeverity(void 0),this.selectedType(void 0),this.messageValue(""),this.assigneeSearchValue(void 0),this.assigneeOptions([]),this.selectedAssignees([]),this.assigneeList([]),this.copySource={}},h.prototype._closeDialog=function(){t("#"+this.dialogId).ojDialog("close")},h.prototype._handleUsersSearch=function(){a.isNonemptyString(this.assigneeSearchValue())&&(e.Logger.info("CreateNotification handleUsersSearch: Search value is %s",this.assigneeSearchValue()),this.assigneeSearchValue().length>=3?this._searchUsers():this._showErrorMessage(this.assigneeSearchId,this.minimumSearchStringError))},h.prototype._showErrorMessage=function(e,i){this.errorMessage(i),t("#"+this.errorId).ojPopup("open","#"+e)},h}));