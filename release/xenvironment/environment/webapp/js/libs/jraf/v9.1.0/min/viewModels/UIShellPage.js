define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/models/UIShellConfig","jraf/models/Content","jraf/models/UIShellManager","jraf/models/PopupManager","jraf/models/MenuManager","jraf/controllers/PopupMenuManager","jraf/controllers/LayoutManager","jraf/controllers/MobileMenuManager","jraf/models/MenuContents","jraf/utils/ValidationUtils","jraf/utils/UrlUtils","jraf/models/TabStateService","jraf/models/TabState","jraf/models/HeaderMenus","jraf/models/HeaderState","jraf/services/ServiceManager","jraf/models/notifications/NotificationsConfig","jraf/controllers/notifications/NotificationHandler","jraf/models/favorites/FavoritesConfig","jraf/controllers/favorites/FavoriteHandler","jraf/models/ModalPageManager","jraf/controllers/PollingManager","jraf/utils/RouterUtils","ojs/ojanimation","ojs/ojdialog","ojs/ojpopup","ojs/ojmodule","ojs/ojrouter","ojs/ojknockout","ojs/ojcomposite","jraf/composites/oj-rgbu-jraf-message-dialog/loader","jraf/composites/oj-rgbu-jraf-modal-page/loader","jraf/composites/oj-rgbu-jraf-apps-module/loader"],(function(e,t,n,o,i,a,r,s,l,p,u,d,c,g,h,f,m,C,b,I,v,M,y,S,j,L,U,A){"use strict";var N=e.Translations.getTranslatedString;function P(n){e.Logger.info("UIShellPage: entering constructor function.");var a=n&&n.routerState?n.routerState.detail.params:n;if(!(a instanceof i))throw new TypeError("UIShellPage: config was not UIShellConfig.");r.ActivateNewManager(a);var s=a.getNavigationConfig();this.layoutManager=u.getInstance(s),this.hasSidebarLayoutSupport=this.layoutManager.hasSidebarLayoutSupport(),this.hasHorizontalBarLayoutSupport=this.layoutManager.hasHorizontalBarLayoutSupport(),this.mainAreaId=o.UIShell.generateUniqueId(),this.menuDrawerId=o.UIShell.generateUniqueId(),this.popupComponentId=o.UIShell.generateUniqueId(),this.popupAppsModuleId=o.UIShell.generateUniqueId(),this.errorDialogId=o.UIShell.generateUniqueId(),this.additionalOptionsDrawerId=o.UIShell.generateUniqueId(),this.mobileSearchPopupId=o.UIShell.generateUniqueId(),this.mobileNavigationDrawerId=o.UIShell.generateUniqueId(),this.globalModalPageContainerId=o.UIShell.generateUniqueId(),this.errorMessage=t.observable(),this.activeMenuModuleBinding=null,this.xg(a);var l=a.getHeaderConfig();this.Hg=new b,this.zg(l),this.Og(l),this.Gg(s),this.Kg(s),this.Jg(a),this.Qg(a),this.Wg(a),this.xj=e.ResponsiveKnockoutUtils.createScreenRangeObservable(),this.Xg(a),this.Yg(),this.Zg(l),s.hasNavigation()&&(this.$g(s),this.Zm(s),this.$m(s.getDefaultContentCallbacks()),this.ep(s)),this.og=!1}return P.prototype.$g=function(e){if(e.hasNotificationsEnabled()){v.reset();var t=v.getInstance();t.setReassignNotificationSupport(e.getRenderNotificationReassignment()),t.registerNotificationHandler(v.DEFAULT_HANDLER_KEY,new M({serviceKey:I.NOTIFICATIONS_SERVICE_NAME}))}},P.prototype.Zm=function(e){e.hasFavoritesEnabled()&&(y.reset(),y.getInstance().registerFavoriteHandler(y.DEFAULT_HANDLER_KEY,new S({serviceKey:I.FAVORITES_SERVICE_NAME,displayFavoriteTitleInTab:e.isDisplayFavoriteTitleInTab()})))},P.prototype.connected=function(){e.Logger.info("UIShellPage.connected: Entering."),this.ap(),this.Yg()},P.prototype.disconnected=function(){e.Logger.info("UIShellPage.disconnected: Entering."),this.rp(),this.hp()},P.prototype.transitionCompleted=function(){e.Logger.info("UIShellPage.transitionCompleted: Entering."),this.lp()},P.prototype.dispose=function(){e.Logger.info("UIShellPage.dispose: Entering."),this.rp(),this.hp()},P.prototype.Yg=function(){var n=this;this.isMobileLayout&&this.isMobileLayout.isActive()||(this.isMobileLayout=t.pureComputed((function(){return this.xj()===e.ResponsiveUtils.SCREEN_RANGE.SM}),this),this.isMobileLayout.subscribe((function(e){r.closeAllMenus(),e||n.up()})))},P.prototype.hp=function(){this.isMobileLayout&&this.isMobileLayout.isActive()&&this.isMobileLayout.dispose()},P.prototype.Zg=function(e){var n=this;this.confirmLogoutId=o.UIShell.generateUniqueId(),this.confirmLogoutDefaultText=N("jraf.messages.confirmLogout"),this.confirmLogoutNoChangeText=N("jraf.messages.confirmLogoutUnchanged"),this.confirmLogoutText=t.observable(this.confirmLogoutDefaultText),this.ma=e.getLogoutCallback(),this.logoutUser=function(){n.cp()},this.unsavedChangesCallback=e.getUnsavedChangesCallback()},P.prototype.xg=function(e){this.hasSidebarLayoutSupport&&this.fp(e),this.hasHorizontalBarLayoutSupport&&this.dp()},P.prototype.fp=function(e){var n=t.observable(!1);this.readOnlyMenuOpened=t.pureComputed((function(){return n()}));var o=t.observable(!1);this.readOnlyMenuPinned=t.pureComputed((function(){return o()}));var i=e.getNavigationConfig(),a=i.getDefaultMenuItem(),r=a.getId(),s=t.observable(r);this.readOnlySelectedMenuId=t.pureComputed((function(){return s()}));var l=t.observable(a.getSidebarMenuModuleBinding());this.menuLoading=t.observable(!0),this.vp=[],this.activeMenuModuleBinding=t.pureComputed((function(){return this.gp(l)}),this),this.menuConfiguration={drawerId:this.menuDrawerId,appContentContainerId:this.mainAreaId,opened:n,pinned:o,selectedMenuItemId:s,activeMenuModuleBinding:l,menuItems:i.getMenuItems(),contentAreaResizedCallback:e.getContentAreaResizedCallback()}},P.prototype.gp=function(e){var t=e();return g.isObjectStrict(t)&&this.vp.indexOf(t.cacheKey)<0&&(this.mp(t,this.menuLoading),this.vp.push(t.cacheKey)),t},P.prototype.dp=function(){this.popupMenuContainerId=o.UIShell.generateUniqueId(),this.selectedPopupMenuItemId=t.observable(null);var e=t.observable(null);this.activePopupMenuModuleBinding=t.pureComputed((function(){return e()}),this),this.popupMenuConfiguration={popupId:this.popupMenuContainerId,selectedMenuItemId:this.selectedPopupMenuItemId,activeMenuModuleBinding:e},this.cancelAnimation=function(e,t){return e.preventDefault(),e.detail.endCallback(),!1}},P.prototype.mp=function(e,t){var n,o,i=e.lifecycleListener;i?(n=i.transitionCompleted,o=i.activated):(i={},e.lifecycleListener=i),i.transitionCompleted=function(){t(!1),g.isFunction(n)&&n.apply(this,arguments)},i.activated=function(){t(!0),g.isFunction(o)&&o.apply(this,arguments)}},P.prototype.zg=function(e){var t=this;if(e.isRenderGlobalMenuArea()){var n={preferencesCallback:e.getPreferencesCallback(),preferencesMenuConfig:e.getPreferencesMenuConfig(),userDataCallback:e.getUserDataCallback(),applicationHelpCallback:e.getApplicationHelpCallback(),helpMenuConfig:e.getHelpMenuConfig(),aboutCallback:e.getAboutCallback(),customMenuConfig:e.getCustomMenuConfig(),logoutCallback:g.isFunction(e.getLogoutCallback())?function(){t.pp()}:void 0};this.jp=new C(n)}},P.prototype.Og=function(e){var t=this.hasSidebarLayoutSupport,n=e.isRenderGlobalMenuArea(),o=e.isRenderApplicationName(),i=e.isRenderProcessingIndicator(),a={supportsMenuPin:t,renderMenuPin:this.layoutManager.getRenderMenuPin(),renderGlobalMenuArea:n,renderApplicationName:o,renderProcessingIndicator:i,headerState:this.Hg};if(t&&(a.pinned=this.readOnlyMenuPinned),n){a.headerMenus=this.jp;var r=e.getGlobalSearchConfig();r&&(a.globalSearchCallback=r.getGlobalSearchCallback(),a.globalSearchSectionFilterCallback=r.getGlobalSearchSectionFilterCallback(),a.globalSearchContextCallback=r.getGlobalSearchContextCallback(),a.globalSearchAllResultsCallback=r.getGlobalSearchAllResultsCallback())}this.globalHeaderModuleOptions={name:"jraf/UIShellGlobalHeader",params:a}},P.prototype.Gg=function(e){this.renderSidebarArea=this.layoutManager.getRenderSidebarMenu(),this.hasSidebarLayoutSupport&&(this.globalSidebarModuleOptions={name:"jraf/UIShellGlobalSidebar",params:{opened:this.readOnlyMenuOpened,selectedMenuItemId:this.readOnlySelectedMenuId,menuItems:this.menuConfiguration.menuItems,pinnedFavoritesEnabled:e.hasPinnedFavoritesEnabled()}})},P.prototype.Kg=function(e){if(this.renderNavigationBar=this.layoutManager.getRenderHorizontalBarMenu(),this.hasHorizontalBarLayoutSupport){var t={menuItems:e.getMenuItems(),menuContainerId:this.popupMenuContainerId,selectedMenuItemId:this.selectedPopupMenuItemId,pinnedFavoritesEnabled:e.hasPinnedFavoritesEnabled()};this.globalNavigationBarModuleOptions={name:"jraf/UIShellNavigationBar",params:t}}},P.prototype.Jg=function(e){var t={useCustomContentArea:e.isUseCustomContentArea(),beforeLoadModuleHandler:e.getNavigationConfig().getBeforeLoadModuleHandler(),afterUnloadModuleHandler:e.getNavigationConfig().getAfterUnloadModuleHandler()};t.useCustomContentArea&&(t.customContentAreaModuleBinding=e.getCustomContentAreaModuleBinding(),t.customContentAreaModuleOptions=e.getCustomContentAreaModuleOptions()),this.globalMainAreaModuleOptions={name:"jraf/UIShellGlobalMainArea",params:t}},P.prototype.Qg=function(e){var t=new s({popupComponentId:"#"+this.popupComponentId,popupAppsModuleId:this.popupAppsModuleId});this.popupModuleBinding=t.getModuleBinding(),this.popupModuleOptions=t.getModuleOptions(),this.popupBeforeLoadModuleHandler=e.getNavigationConfig().getBeforeLoadModuleHandler(),this.popupAfterLoadModuleHandler=t.getAfterLoadModuleHandler(),this.popupTransitionEndHandler=t.getTransitionEndHandler(),this.popupAfterUnloadModuleHandler=e.getNavigationConfig().getAfterUnloadModuleHandler(),r.RegisterPopupManager(t)},P.prototype.Wg=function(e){var t=new j({modalPageContainerId:this.globalModalPageContainerId,beforeLoadModuleHandler:e.getNavigationConfig().getBeforeLoadModuleHandler(),afterUnloadModuleHandler:e.getNavigationConfig().getAfterUnloadModuleHandler()});r.RegisterGlobalModalPageManager(t)},P.prototype.Xg=function(e){var t=e.getNavigationConfig(),n=e.getHeaderConfig();this.supportsNavigation=this.hasSidebarLayoutSupport||this.hasHorizontalBarLayoutSupport,this.hg=new d({navMenuId:this.mobileNavigationDrawerId,optionsMenuId:this.additionalOptionsDrawerId,mainAreaId:this.mainAreaId}),r.RegisterMobileMenuManager(this.hg),this.additionalOptionsModuleOptions=null,this.Ip(n),this.Mp(t,n),this.Sp(e)},P.prototype.Sp=function(e){var o=this,i=e.getHeaderConfig(),a={headerState:this.Hg,renderContentTitle:i.isRenderContentTitleForMobileCustomContentArea()};if(a.renderContentTitle&&e.isUseCustomContentArea()){var r=e.getCustomContentAreaTitle();this.Cp=t.observable(N(r)),a.currentContentTitle=t.pureComputed((function(){return o.Cp()})),n(window.document).on("jrafcontentchange",(function(e,t){o.Cp(t.title)}))}i.isRenderGlobalMenuArea()&&(a.openOptionsMenuCallback=function(){o.hg.openOptionsMenu()},this.bp()),this.mobileSearchModuleOptions&&(a.openSearchCallback=function(){o.Up()}),this.supportsNavigation&&(a.openNavigationCallback=function(){o.hg.openNavMenu()}),this.mobileHeaderModuleOptions={name:"jraf/mobile/UIShellMobileHeader",params:a}},P.prototype.bp=function(){this.additionalOptionsModuleOptions={name:"jraf/mobile/AdditionalOptionsMenu",params:{menus:this.jp}}},P.prototype.Ip=function(t){var n=this;this.mobileSearchModuleOptions=null;var o=t.getGlobalSearchConfig();if(o){var i={closeSearchCallback:function(){n.up()}};if(i.searchCallback=o.getGlobalSearchCallback(),i.searchSectionFilterCallback=o.getGlobalSearchSectionFilterCallback(),i.searchContextCallback=o.getGlobalSearchContextCallback(),!g.isFunction(i.searchCallback)||!g.isFunction(i.searchSectionFilterCallback)||!g.isFunction(i.searchContextCallback))return void e.Logger.warn("UIShellPage._initializeMobileSearchModule: Incomplete search configuration provided. Unable to initialize module.");this.mobileSearchModuleOptions={name:"jraf/mobile/SearchPopup",params:i}}},P.prototype.Mp=function(e,t){this.supportsNavigation&&(this.mobileNavigationModuleOptions={name:"jraf/mobile/NavigationMenu",params:{menus:e.getMenuItems(),pinnedFavoritesEnabled:e.hasPinnedFavoritesEnabled(),renderApplicationIcon:t.isRenderContentTitleForMobileCustomContentArea(),headerState:this.Hg}})},P.prototype.Up=function(){this.mobileSearchModuleOptions&&document.getElementById(this.mobileSearchPopupId).open(".jraf-global-bottom-content")},P.prototype.up=function(){this.mobileSearchModuleOptions&&document.getElementById(this.mobileSearchPopupId).close()},P.prototype.handleBindingsApplied=function(t){e.Logger.info("UIShellPage.handleBindingsApplied: Entering."),this.lp(),this.Yg(),this.ap()},P.prototype.lp=function(){if(!this.og){if(this.hasSidebarLayoutSupport){e.Logger.info("UIShellPage._initializeMenuManager: Supporting sidebar layout, so registering MenuManager.");var t=new l(this.menuConfiguration);r.RegisterMenuManager(t)}if(this.hasHorizontalBarLayoutSupport){e.Logger.info("UIShellPage._initializeMenuManager: Supporting horizontal bar layout, so registering PopupMenuManager.");var n=new p(this.popupMenuConfiguration);r.RegisterPopupMenuManager(n)}this.og=!0}},P.prototype.$m=function(t){e.Logger.info("UIShellPage._loadUIShellContent: Entering"),r.startProcessingIndicator(),this.Ye=c.getInstance();var n=[];for(var o in t){var i=t[o],a=this.Ye.registerMenuOptions(o,i);n.push(a)}this.Pp(n)},P.prototype.Pp=function(e){var t=this;Promise.all(e).then((function(e){c.getInstance().getContentLeaves().then((function(n){t.wp(e,n)}))}),(function(e){t.Lp(e)}))},P.prototype.wp=function(t,n){e.Logger.info("UIShellPage._handleSuccessfulNavigationContentLoad: Entering.");var o=this.Np(),i=h.getQueryParameters(window.location.href),a=this._p(i),s=this.xp(i),l=this.Ep(i);null!==o||a||s||l?a?this.Fp(o,n,i):s?this.kp(o,n,i):l?this.Hp(o,n,i):0<o.length&&this.yp(o,n):this.Ap(t),r.stopProcessingIndicator()},P.prototype.Np=function(){var e=f.get();return g.isArray(e)?e:null},P.prototype._p=function(e){return g.isObjectStrict(e)&&g.isNonemptyString(e.jrafContentId)},P.prototype.xp=function(e){return g.isObjectStrict(e)&&g.isNonemptyString(e.jrafNotificationId)},P.prototype.Ep=function(e){return g.isObjectStrict(e)&&g.isNonemptyString(e.jrafFavoriteId)},P.prototype.Tp=function(e){var t=n.extend({},e);return[U.getRootRouterName(),"jrafContentId","jrafNotificationId","jrafFavoriteId"].forEach((function(e){delete t[e]})),t},P.prototype.zp=function(e,t){var n=t[e];return n instanceof a?n:null},P.prototype.Fp=function(t,n,o){var i=o.jrafContentId,a=this.zp(i,n);if(null===a)return e.Logger.warn("UIShellPage._handleNavigationInContextLaunch: Could not find content",i),this.im("jraf.messages.inContextLaunch.invalidContentId"),void this.yp(t,n);var r=this.Bp(o,a),s=this.Op(a,r,t)?this.Gp(r,t):this.Kp(r,t);this.yp(s,n)},P.prototype.Op=function(e,t,n){return g.isArray(n)&&e.isReuseInstance()&&!e.getAllowContentKeyOverride()&&this.qp(t,n)},P.prototype.qp=function(e,t){return 0<t.filter((function(t){return t.equals(e)})).length},P.prototype.Gp=function(e,t){return t.map((function(t){return t.equals(e)?e:t})).concat([e])},P.prototype.Kp=function(e,t){return g.isArray(t)?t.concat(e):[e]},P.prototype.Bp=function(e,t){var n=this.Tp(e),o=e.jrafContentId,i=this.au(t,n),a=this.Dp(t,n),r=this.Rp(t,n);return new m({contentId:o,contentKey:i,moduleBinding:a,moduleOptions:r})},P.prototype.au=function(e,t){var n=0<Object.keys(t).length;return e.getAllowContentKeyOverride()&&n?this.Vp(e,t):e.getContentKey()},P.prototype.Vp=function(e,t){return e.getId()+"|"+Object.keys(t).sort().map((function(e){return e+"="+t[e]})).join("|")},P.prototype.Dp=function(e,t){return e.hasModuleOptions()?null:n.extend(!0,{},e.getModuleBinding(),{params:t})},P.prototype.Rp=function(e,t){return e.hasModuleOptions()?n.extend(!0,{},e.getModuleOptions(),{params:t}):null},P.prototype.kp=function(t,n,o){e.Logger.info("UIShellPage._handleNotificationInContextLaunch: Handling notification in-context launch");var i=I.getNotificationsService(),a=!1;g.isObjectStrict(i)&&g.isFunction(i.markNotificationAsRead)&&g.isFunction(i.getNotificationContext)||(e.Logger.warn("UIShellPage._handleNotificationInContextLaunch: No notifications service available to serve request"),this.im("jraf.messages.inContextLaunch.notificationsNotEnabled"),a=!0);var r=parseInt(o.jrafNotificationId);g.isNumber(r)||(e.Logger.warn("UIShellPage._handleNotificationInContextLaunch: jrafNotificationId was not a valid id."),this.im("jraf.messages.inContextLaunch.invalidNotificationId"),a=!0),a?this.yp(t,n):this.Jp(r,t,n)},P.prototype.Jp=function(e,t,n){var o=this;r.startProcessingIndicator();var i=I.getNotificationsService();return Promise.all([i.markNotificationAsRead(e,!0),i.getNotificationContext(e)]).then((function(e){o.Qp(e[1],t,n)}),(function(e){o.Wp(e,t,n)}))},P.prototype.Qp=function(t,n,o){var i=a.completeContent(t);null===i&&e.Logger.error("UIShellPage._handleSuccessfulNotificationCalls: Failed to parse notification context into Content"),this.yp(n,o),i instanceof a&&r.openContent(i),r.stopProcessingIndicator()},P.prototype.Wp=function(t,n,o){e.Logger.error("UIShellPage._handleFailedNotificationCalls:",t),this.yp(n,o),this.im("jraf.messages.inContextLaunch.notificationServiceError"),r.stopProcessingIndicator()},P.prototype.yp=function(t,n){g.isArray(t)&&0!==t.length?t.map((function(e){var t=this.zp(e.contentId,n);return null===t?null:a.extendContent(t,{contentKey:e.contentKey,moduleBinding:e.moduleBinding,moduleOptions:e.moduleOptions})}),this).filter((function(e){return null!==e})).forEach((function(e){r.openContent(e)})):e.Logger.warn("UIShellPage._openTabStates: Exiting since no tab states were provided.")},P.prototype.Lp=function(t){e.Logger.error("UIShellPage._handleFailedNavigationContentLoad: "+t),r.stopProcessingIndicator()},P.prototype.Ap=function(t){t.forEach((function(t){if(g.isObjectStrict(t)){var n=null;try{n=new a(t)}catch(t){e.Logger.warn("UIShellPage._handleDefaultContentLoad: Error parsing default content.")}n instanceof a&&this.Xp(n)}}),this)},P.prototype.Xp=function(e){if(e.isDefaultContent())r.openContent(e);else if(e.isFolder())for(var t=e.getChildren(),n=0;n<t.length;n++)this.Xp(t[n])},P.prototype.ep=function(e){var t=e.getMenuItems();if(g.isArray(t)){var n=t.filter((function(e){return e.isBadgingEnabled()&&e.getBadgeValueRefresh()})).map((function(e){return e.getBadgeValueRefresh()}));this.Yp=new L({key:"UIShellPage",interval:e.getPollingInterval(),callbacks:n})}},P.prototype.ap=function(){this.Yp&&this.Yp.startPolling(!0)},P.prototype.rp=function(){this.Yp&&this.Yp.stopPolling()},P.prototype.cp=function(){this.Zp(),o.App.clearAppData(),f.clear(),o.App.clearAppDataProperty(o.App.GLOBAL_HEADER_CONFIG_KEY),g.isFunction(this.ma)&&this.ma()},P.prototype.pp=function(){var e=this.unsavedChangesCallback();this.confirmLogoutText(e?this.confirmLogoutDefaultText:this.confirmLogoutNoChangeText),this.$p().open()},P.prototype.Zp=function(){this.$p().close()},P.prototype.$p=function(){return document.getElementById(this.confirmLogoutId)},P.prototype.im=function(t){var n=e.Translations.getTranslatedString(t);this.errorMessage(n);var o=document.getElementById(this.errorDialogId);e.Context.getContext(o).getBusyContext().whenReady().then((function(){o.open()}))},P.prototype.mobileSearchAnimation=function(e){"open"===e.detail.action&&(e.preventDefault(),A.fadeIn(e.detail.element,{duration:"200ms",persist:"all"}).then(e.detail.endCallback)),"close"===e.detail.action&&(e.preventDefault(),A.fadeOut(e.detail.element,{duration:"200ms",persist:"all"}).then(e.detail.endCallback))},P.prototype.Hp=function(t,n,o){e.Logger.info("UIShellPage._handleFavoriteInContextLaunch: Handling favorites in-context launch");var i=parseInt(o.jrafFavoriteId);if(!g.isNumber(i))return e.Logger.warn("UIShellPage._handleFavoriteInContextLaunch: jrafFavoriteId was not a valid id."),this.im("jraf.messages.inContextLaunch.invalidFavoriteId"),void this.yp(t,n);var a=y.getInstance().getFavoriteHandler();this.yp(t,n),a.openContent(i)},P.prototype.canExit=function(){return f.clear(),Promise.resolve()},P}));