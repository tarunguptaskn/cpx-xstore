define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/models/UIShellManager","jraf/utils/I18nUtils","jraf/models/notifications/NotificationsFilter","jraf/utils/KeyboardUtils","jraf/utils/ValidationUtils","jrafViewModels/notifications/NotificationsMenu","ojs/ojarraydataprovider","jraf/composites/oj-rgbu-jraf-apps-module/loader","jraf/utils/CustomBindings","ojs/ojknockout","ojs/ojbutton","ojs/ojinputtext","ojs/ojnavigationlist","ojs/ojarraytabledatasource","ojs/ojselectsingle","ojs/ojselectcombobox","ojs/ojlabel","ojs/ojformlayout"],(function(i,t,e,a,r,o,n,s,l,u,c){"use strict";var p=i.Translations.getTranslatedString;function g(i){g.superclass.constructor.apply(this,arguments)}return g.DEFAULT_MAX_NOTIFICATIONS=25,g.DEFAULT_MAX_GROUP_ITEMS=3,g.MAX_GROUP_ITEMS_LIMIT=25,g.MINIMUM_AUTOSUGGEST_LENGTH=1,i.Object.createSubclass(g,u,"UIShellNotificationsMenu"),g.prototype.handleDetached=function(){g.superclass.handleDetached.call(this),this.searchString.pop()},g.prototype.InitializeUniqueIds=function(){g.superclass.InitializeUniqueIds.call(this),this.groupingToggleId=a.UIShell.generateUniqueId(),this.groupingTabId=a.UIShell.generateUniqueId(),this.groupingFormId=a.UIShell.generateUniqueId(),this.notificationListTemplateId=a.UIShell.generateUniqueId(),this.groupingListTemplateId=a.UIShell.generateUniqueId(),this.groupingPrimarySelectId=a.UIShell.generateUniqueId(),this.groupingSecondarySelectId=a.UIShell.generateUniqueId(),this.searchInputId=a.UIShell.generateUniqueId()},g.prototype.InitializeStrings=function(){g.superclass.InitializeStrings.call(this),this.menuTitle=p("jraf.sidebar.notifications.title"),this.groupedNotificationsListDesc=p("jraf.sidebar.notifications.groupedNotificationsListDesc"),this.searchHint=p("jraf.sidebar.notifications.searchHint"),this.applyLabel=p("jraf.sidebar.notifications.filterApply"),this.cancelLabel=p("jraf.sidebar.notifications.filterCancel"),this.groupingTabLabel=p("jraf.sidebar.notifications.groupingTabLabel"),this.groupingPrimaryLabel=p("jraf.sidebar.notifications.groupBy"),this.groupingSecondaryLabel=p("jraf.sidebar.notifications.groupThenBy"),this.groupingResetLabel=p("jraf.sidebar.notifications.filterReset"),this.groupingSeeMoreLabel=p("jraf.sidebar.notifications.groupSeeMore"),this.dismissLabel=p("jraf.notifications.dismiss"),this.groupingToggleGroupViewLabel=p("jraf.sidebar.notifications.groupingToggleLabelGroupView"),this.groupingToggleListViewLabel=p("jraf.sidebar.notifications.groupingToggleLabelListView"),this.noResultsText=p("jraf.messages.noResults")},g.prototype.InitializeCallbacks=function(){g.superclass.InitializeCallbacks.call(this);var i=this;this.autosuggestSearch=function(t){return i.Nb(t.term)},this.handleAutosuggestSelect=function(t,e){return i.vb(t)},this.handleGroupShowMoreClick=function(t,e){return i.xb(e,!0),!1},this.launchDetailSummaryPage=function(t,e){i.Vb(e.data)},this.handleSummaryEvent=function(t,e){s.isEnterKey(t)&&i.Vb(e.data)}},g.prototype.InitializeFilters=function(){g.superclass.InitializeFilters.call(this),this.Rb=!1,this.Kb(),this.zb(),this.Jb(),this.Qb()},g.prototype.HandleFiltersReady=function(){g.superclass.HandleFiltersReady.call(this),this.Filter.useHierarchyOptions()&&this.groupingToggle(["groupingEnabled"]),this.Rb=!0},g.prototype.InitializeNotificationsList=function(){g.superclass.InitializeNotificationsList.call(this),this.displaySummary=t.observable(!1);var e=this;this.menuDataLoaded.subscribe((function(i){!1===i&&e.disableModeChange(!0)})),this.groupingList=new i.ArrayTableDataSource([],{idAttribute:"groupId"})},g.prototype.GetNotificationListHeight=function(){this.filterTabToggle(),this.groupingTabToggle(),this.Filter.selectedNotificationTypes(),this.Filter.selectedSeverities();var i=e(document.getElementById(this.notificationListTemplateId)).siblings().not(".jraf-menu-body").not(".oj-helper-module-cache").not("script"),t=e(".jraf-global-header-wrapper").outerHeight(!0);return void 0===t&&(t=e(".jraf-mobile-nav-header").outerHeight(!0)),i.each((function(){t+=e(this).outerHeight(!0)})),"calc(100vh - "+t+"px)"},g.prototype.GetMenuState=function(){return r.getMenuDrawerState()},g.prototype.HandleMenuStateChange=function(i){g.superclass.HandleMenuStateChange.call(this,i),i||this.searchString.pop()},g.prototype.GetNotifications=function(){var i=this.Wb(),t=this.NotificationsService.getNotifications;return this.groupingEnabled()&&(t=i.thenByLevelId?this.NotificationsService.getNotificationSummaries:this.NotificationsService.getNotificationGroups),this.Filter.persistCriteria(),t.call(this.NotificationsService,i)},g.prototype.HandleDataLoadSuccess=function(i){g.superclass.HandleDataLoadSuccess.call(this,i),this.disableModeChange(!1)},g.prototype.RefreshMenuData=function(i){this.groupingEnabled()?(this.Xb(i),this.displaySummary(0<=this.activeGrouping.secondary())):(g.superclass.RefreshMenuData.call(this,i),this.Yb=[],this.Zb(),this.displaySummary(!1))},g.prototype.GetNotificationDisplayLimit=function(){return g.DEFAULT_MAX_NOTIFICATIONS},g.prototype.HandleDataLoadFailure=function(i){g.superclass.HandleDataLoadFailure.call(this,i),this.disableModeChange(!1)},g.prototype.HandleSuccessfulMarkNotificationAsRead=function(i){if(this.groupingEnabled()){for(var t=0;t<this.Yb.length;t++)if(this.Yb[t].groupName===i.group){this.xb(this.Yb[t],!1),r.stopProcessingIndicator();break}}else g.superclass.HandleSuccessfulMarkNotificationAsRead.call(this,i)},g.prototype.CloseMenu=function(){r.closeMenu({closeOverlayMenuOnly:!0})},g.prototype.Kb=function(){this.searchString=this.Filter.searchString,this.minimumAutosuggestLength=g.MINIMUM_AUTOSUGGEST_LENGTH,this.$b=[]},g.prototype.zb=function(){var i=this;this.disableModeChange=t.observable(!1),this.groupingToggle=t.observableArray([]),this.groupingEnabled=t.pureComputed((function(){return 0<i.groupingToggle().length})),this.groupingToggleLabel=t.pureComputed((function(){return this.groupingEnabled()?this.groupingToggleListViewLabel:this.groupingToggleGroupViewLabel}),this)},g.prototype.Jb=function(){var i=this;this.groupingTabToggle=t.observableArray([]),this.openGroupingTab=t.pureComputed((function(){return 1===i.groupingTabToggle().length})),this.groupingEnabled.subscribe((function(t){!1===t&&i.openGroupingTab()&&i.groupingTabToggle([]),i.Filter.useHierarchyOptions(t),i.Rb&&i.LoadMenuData()})),this.filterTabToggle.subscribe((function(t){0<t.length&&i.groupingTabToggle([])})),this.groupingTabToggle.subscribe((function(t){0<t.length&&i.filterTabToggle([])}))},g.prototype.Qb=function(){var i=this;this.primaryGroupingSelectOptions=this.Filter.primaryHierarchyOptions,this.primaryGroupingSelectOptionsDataProvider=new c(this.primaryGroupingSelectOptions,{keyAttributes:"value"}),this.secondaryGroupingSelectOptions=this.Filter.secondaryHierarchyOptions,this.secondaryGroupingSelectOptionsDataProvider=new c(this.secondaryGroupingSelectOptions,{keyAttributes:"value"}),this.activeGrouping={primary:this.Filter.primaryHierarchySelection,secondary:this.Filter.secondaryHierarchySelection},this.ip={primary:t.observable(n.HIERARCHY_NO_SELECTION.value),secondary:t.observable(n.HIERARCHY_NO_SELECTION.value)},this.groupingCount=t.pureComputed((function(){var t=1;return i.activeGrouping.secondary()!==n.HIERARCHY_NO_SELECTION.value&&(t=2),t})),this.resetGrouping=function(){i.activeGrouping.secondary(i.secondaryGroupingSelectOptions()[0].value),i.activeGrouping.primary(i.primaryGroupingSelectOptions()[0].value)},this.revertGrouping=function(){var t=i.ip.primary();t===n.HIERARCHY_NO_SELECTION.value&&(t=i.primaryGroupingSelectOptions()[0].value),i.activeGrouping.primary(t),i.activeGrouping.secondary(i.ip.secondary()),i.groupingTabToggle([])},this.executeGrouping=function(){i.ip.primary(i.activeGrouping.primary()),i.ip.secondary(i.activeGrouping.secondary()),i.LoadMenuData(),i.groupingTabToggle([])}},g.prototype.vb=function(i){if(l.isNumberStrict(i.detail.value))for(var t=i.detail.value,e=this.$b,a=0;a<e.length;a++){var r=e[a];if(r.id===t)return r.launchable?this.HandleNotificationClick(r):this.MarkNotificationAsRead(r),this.searchString.pop(),!0}return!1},g.prototype.Nb=function(t){var e=this;return!l.isString(t)||t.length<this.minimumAutosuggestLength?Promise.resolve([]):this.NotificationsService.getNotifications({searchText:t}).then((function(i){return e.$b=e.ParseNotificationData(i.results),e.tp(e.$b)}),(function(t){i.Logger.warn("UIShellNotificationsMenu._autosuggestSearch: Error loading notifications: ",t)}))},g.prototype.tp=function(i){for(var t=[],e={},a=0;a<i.length;a++){var r=i[a];t.push({value:r.id,label:r.message}),e[r.message]=void 0===e[r.message]}for(var o=0;o<t.length;o++){var n=t[o];e[n.label]||(n.label=n.label+" "+n.value)}return 0===t.length&&t.push({label:this.noResultsText}),t},g.prototype.Xb=function(i){var t=this.sp(i);this.Yb=t,this.Zb(),this.om=[],this.UpdateDisplayedNotifications()},g.prototype.Zb=function(){for(var i=[],t=0;t<this.Yb.length;t++){var e=this.Yb[t],a=e.children.slice(0,e.displayLimit);i.push({groupName:e.groupName,groupId:e.groupId,displayLimit:e.displayLimit,children:a,canLoadMore:e.canLoadMore})}this.groupingList.reset(i)},g.prototype.np=function(i){var t={type:i.groupedByLevel2,criticalString:null,importantString:null,normalString:null,timestamp:o.formatDatetime(i.mostRecentDate),notificationCount:i.notificationCount};if(i.criticalSevCount){var e=1===i.criticalSevCount?"jraf.sidebar.notifications.criticalSevCount":"jraf.sidebar.notifications.criticalSevCountPlural";t.criticalString=p(e,[i.criticalSevCount])}if(i.importantSevCount){var a=1===i.importantSevCount?"jraf.sidebar.notifications.mediumSevCount":"jraf.sidebar.notifications.mediumSevCountPlural";t.importantString=p(a,[i.importantSevCount])}if(i.normalSevCount){var r=1===i.normalSevCount?"jraf.sidebar.notifications.lowSevCount":"jraf.sidebar.notifications.lowSevCountPlural";t.normalString=p(r,[i.normalSevCount])}return t},g.prototype.sp=function(i){for(var e=[],a=0;a<i.length;a++){for(var r=i[a],o={groupId:a,groupName:r.groupName,children:[],displayLimit:g.DEFAULT_MAX_GROUP_ITEMS,canLoadMore:t.observable(void 0!==r.containsAllChildren&&!r.containsAllChildren)},n=r.childNotificationRDOList||r.childNotificationSummaryRDOList,s=0;s<n.length;s++){var l=n[s];if(l.notificationId)o.children.push(this.ParseNotification(l,o.groupName));else{var u=this.np(l);u.parentName=o.groupName,o.children.push(u)}}e.push(o)}return e},g.prototype.xb=function(i,t){var e=this,a=this.Wb();return a.groupByHierarchyValue=i.groupName,r.startProcessingIndicator(),this.disableModeChange(!0),this.FiltersReady.then((function(){return e.displaySummary()?e.NotificationsService.getNotificationSummaries(a):e.NotificationsService.getNotifications(a)})).then((function(a){e.op(i.groupName,a.results,t)}),(function(i){e.HandleDataLoadFailure(i)}))},g.prototype.op=function(t,e,a){var o=null;for(var n in this.Yb){var s=this.Yb[n];if(s.groupName===t){o=s;break}}if(o){var l=[];if(this.displaySummary()){var u=this.sp(e);l=0<u.length?u[0].children:[]}else l=this.ParseNotificationData(e,o.groupName);o.children=l,a&&(o.displayLimit=Math.min(l.length,g.MAX_GROUP_ITEMS_LIMIT),o.canLoadMore(!1))}else i.Logger.warn("UIShellNotificationsMenu._updateGroupData: Unknown group to update");r.stopProcessingIndicator(),this.disableModeChange(!1),this.Zb()},g.prototype.Wb=function(){var i={},t=this.Filter.getFilterCriteria();if(e.extend(i,t()),this.groupingEnabled()){i.groupByLevelId=this.activeGrouping.primary();var a=this.activeGrouping.secondary();a!==n.HIERARCHY_NO_SELECTION.value&&(i.thenByLevelId=a)}return i},g.prototype.LaunchDetailPage=function(i){var t=i;void 0===t&&0<this.filtersCount()&&(t=n.FILTER_TILE_INDEX),g.superclass.LaunchDetailPage.call(this,t)},g.prototype.Vb=function(i){this.Filter.selectedSummaryValues.primaryGroup(this.Filter.primaryHierarchySelection()),this.Filter.selectedSummaryValues.primaryValue(i.parentName),this.Filter.selectedSummaryValues.secondaryGroup(this.Filter.secondaryHierarchySelection()),this.Filter.selectedSummaryValues.secondaryValue(i.type),this.Filter.selectedTileIndex(n.SUMMARY_TILE_INDEX),this.LaunchDetailPage(n.SUMMARY_TILE_INDEX)},g}));