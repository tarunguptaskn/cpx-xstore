define(["knockout","ojs/ojlogger","ojs/ojmodule-element-utils","ojs/ojknockout","ojs/ojmodule-element"],(function(e,o,t){"use strict";function n(o){var t=this;this.context=o,this.moduleBindingId=this.context.uniqueId+"_modulebinding",this.moduleConfig=e.observable(n.BLANK_MODULE_CONFIG),this.moduleBinding=e.observable(n.BLANK_MODULE_BINDING),this.showModuleElement=e.observable(!0),this.renderModuleElement=e.observable(!1),this.handleViewDisconnected=function(e){t._handleViewDisconnected(e.detail.viewModel,e.detail.view)},this._initModule()}return n.CHANGEABLE_PROPERTIES=["moduleBinding","moduleOptions"],n.BLANK_MODULE_CONFIG={view:[]},n.BLANK_MODULE_BINDING={view:"oj:blank"},n.prototype._initModule=function(){this._isModuleElementConfigured()?this._initModuleConfig():this._initModuleBinding()},n.prototype._initModuleBinding=function(){this._isModuleBindingConfigured()&&(this.moduleBinding(this.context.properties.moduleBinding),this._clearModuleConfig(),this.showModuleElement(!1),o.info("oj-rgbu-jraf-apps-module: Initialized Module Binding."))},n.prototype._isModuleBindingConfigured=function(){var e=this.context.properties.moduleBinding;return!(!e||"object"!=typeof e)},n.prototype._clearModuleBinding=function(){this._isModuleBindingConfigured()&&(this.context.properties.moduleBinding=void 0,this.moduleBinding(n.BLANK_MODULE_BINDING))},n.prototype._initModuleConfig=function(){var e=this;this._isModuleElementConfigured()&&this._loadModule().then((function(t){if(!t)throw new Error("oj-rgbu-jraf-apps-module: Failed to load module.");t.viewModel&&(e.moduleElementViewModel=t.viewModel),e.moduleConfig(t),e._clearModuleBinding(),e.showModuleElement(!0),e.renderModuleElement(!0),o.info("oj-rgbu-jraf-apps-module: Initialized Module Config.")}))},n.prototype._isModuleElementConfigured=function(){var e=this.context.properties.moduleOptions;return!(!e||"object"!=typeof e)},n.prototype._clearModuleConfig=function(){this._isModuleElementConfigured()&&(this.context.properties.moduleOptions=void 0,this.moduleConfig(n.BLANK_MODULE_CONFIG))},n.prototype._loadModule=function(){var e=this;o.info("oj-rgbu-jraf-apps-module: Loading module.");var t,n=this.context.properties.beforeLoadModuleHandler;t=n&&"function"==typeof n?this._invokeBeforeLoadModuleHandler(n):this._loadModuleDefault();var i=this.context.properties.afterLoadModuleHandler;return i&&"function"==typeof i?t.then((function(o){return e._invokeAfterLoadModuleHandler(i,o)})):t},n.prototype._invokeBeforeLoadModuleHandler=function(e){var t=this;return o.info("oj-rgbu-jraf-apps-module: Invoking before load module handler."),e(this.context.properties.moduleOptions).then((function(e){return e||t._loadModuleDefault()}))},n.prototype._loadModuleDefault=function(){return o.info("oj-rgbu-jraf-apps-module: Loading module via ModuleElementUtils."),t.createConfig(this.context.properties.moduleOptions)},n.prototype._invokeAfterLoadModuleHandler=function(e,t){return o.info("oj-rgbu-jraf-apps-module: Invoking after load module handler."),e(this.context.properties.moduleOptions,t)},n.prototype.invokeModuleEventHandler=function(e,o,t,n){var i=null;return i=this._isModuleElementConfigured()?this._getModuleElementViewModel():this._getModuleBindingViewModel(),this._invokeViewModelEventHandler(i,e,o,t,n)},n.prototype._getModuleElementViewModel=function(){return this.moduleElementViewModel},n.prototype._getModuleBindingViewModel=function(){var o=document.getElementById(this.moduleBindingId).children;if(0===o.length)return null;var t=o[0];return e.dataFor(t)},n.prototype._invokeViewModelEventHandler=function(e,t,n,i,d){return e&&e[t]&&"function"==typeof e[t]?(o.info("oj-rgbu-jraf-apps-module: Invoking view model event handler: "+t),e[t](n,i)):d},n.prototype._handleViewDisconnected=function(e,o){if(o&&Array.isArray(o)&&0!==o.length&&this._isModuleElementConfigured()){var t=this.context.properties.afterUnloadModuleHandler;if(t&&"function"==typeof t)t(this.context.properties.moduleOptions,e,o)}},n.prototype.refresh=function(){this._initModule()},n.prototype.propertyChanged=function(e){var o=e.property;"external"===e.updatedFrom&&n.CHANGEABLE_PROPERTIES.indexOf(o)>=0&&("moduleOptions"===o?this._initModuleConfig():"moduleBinding"===o&&this._initModuleBinding())},n}));