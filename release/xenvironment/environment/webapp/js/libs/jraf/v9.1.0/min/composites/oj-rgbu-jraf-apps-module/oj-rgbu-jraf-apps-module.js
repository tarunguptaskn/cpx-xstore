define(["knockout","ojs/ojlogger","ojs/ojmodule-element-utils","ojs/ojknockout","ojs/ojmodule-element"],(function(e,o,t){"use strict";function n(o){var t=this;this.context=o,this.moduleBindingId=this.context.uniqueId+"_modulebinding",this.moduleConfig=e.observable(n.BLANK_MODULE_CONFIG),this.moduleBinding=e.observable(n.BLANK_MODULE_BINDING),this.showModuleElement=e.observable(!0),this.renderModuleElement=e.observable(!1),this.handleViewDisconnected=function(e){t.t(e.detail.viewModel,e.detail.view)},this.i()}return n.CHANGEABLE_PROPERTIES=["moduleBinding","moduleOptions"],n.BLANK_MODULE_CONFIG={view:[]},n.BLANK_MODULE_BINDING={view:"oj:blank"},n.prototype.i=function(){this.n()?this.o():this.u()},n.prototype.u=function(){this.e()&&(this.moduleBinding(this.context.properties.moduleBinding),this.r(),this.showModuleElement(!1),o.info("oj-rgbu-jraf-apps-module: Initialized Module Binding."))},n.prototype.e=function(){var e=this.context.properties.moduleBinding;return!(!e||"object"!=typeof e)},n.prototype.s=function(){this.e()&&(this.context.properties.moduleBinding=void 0,this.moduleBinding(n.BLANK_MODULE_BINDING))},n.prototype.o=function(){var e=this;this.n()&&this.h().then((function(t){if(!t)throw new Error("oj-rgbu-jraf-apps-module: Failed to load module.");t.viewModel&&(e.moduleElementViewModel=t.viewModel),e.moduleConfig(t),e.s(),e.showModuleElement(!0),e.renderModuleElement(!0),o.info("oj-rgbu-jraf-apps-module: Initialized Module Config.")}))},n.prototype.n=function(){var e=this.context.properties.moduleOptions;return!(!e||"object"!=typeof e)},n.prototype.r=function(){this.n()&&(this.context.properties.moduleOptions=void 0,this.moduleConfig(n.BLANK_MODULE_CONFIG))},n.prototype.h=function(){var e=this;o.info("oj-rgbu-jraf-apps-module: Loading module.");var t,n=this.context.properties.beforeLoadModuleHandler;t=n&&"function"==typeof n?this.f(n):this.a();var i=this.context.properties.afterLoadModuleHandler;return i&&"function"==typeof i?t.then((function(o){return e.l(i,o)})):t},n.prototype.f=function(e){var t=this;return o.info("oj-rgbu-jraf-apps-module: Invoking before load module handler."),e(this.context.properties.moduleOptions).then((function(e){return e||t.a()}))},n.prototype.a=function(){return o.info("oj-rgbu-jraf-apps-module: Loading module via ModuleElementUtils."),t.createConfig(this.context.properties.moduleOptions)},n.prototype.l=function(e,t){return o.info("oj-rgbu-jraf-apps-module: Invoking after load module handler."),e(this.context.properties.moduleOptions,t)},n.prototype.invokeModuleEventHandler=function(e,o,t,n){var i;return i=this.n()?this.d():this.c(),this.j(i,e,o,t,n)},n.prototype.d=function(){return this.moduleElementViewModel},n.prototype.c=function(){var o=document.getElementById(this.moduleBindingId).children;if(0===o.length)return null;var t=o[0];return e.dataFor(t)},n.prototype.j=function(e,t,n,i,r){return e&&e[t]&&"function"==typeof e[t]?(o.info("oj-rgbu-jraf-apps-module: Invoking view model event handler: "+t),e[t](n,i)):r},n.prototype.t=function(e,o){if(o&&Array.isArray(o)&&0!==o.length&&this.n()){var t=this.context.properties.afterUnloadModuleHandler;t&&"function"==typeof t&&t(this.context.properties.moduleOptions,e,o)}},n.prototype.refresh=function(){this.i()},n.prototype.propertyChanged=function(e){var o=e.property;"external"===e.updatedFrom&&0<=n.CHANGEABLE_PROPERTIES.indexOf(o)&&("moduleOptions"===o?this.o():"moduleBinding"===o&&this.u())},n}));