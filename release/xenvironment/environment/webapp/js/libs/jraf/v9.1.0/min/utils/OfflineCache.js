define(["jraf/utils/ValidationUtils"],(function(e){"use strict";function t(t){if(!e.isObjectStrict(t)||!e.isNonemptyString(t.dbName))throw new TypeError("OfflineCache: Missing required parameters");this.qf(t)}return t.Qe={},t.prototype.qf=function(e){var t=this;this.Of=new Promise((function(n,r){var o=window.indexedDB.open(e.dbName,e.dbVersion),i={modifiedDB:!1};o.onupgradeneeded=function(n){t.Bf(n,e),i.modifiedDB=!0},o.onsuccess=function(e){t.Df=e.target.result,n(i)},o.onerror=function(e){r(e.target.error)}}))},t.prototype.Bf=function(e,t){var n=this,r=e.target.result,o=e.target.transaction,i=t.tables,a=[];i.forEach((function(e){a.push(e.name),r.objectStoreNames.contains(e.name)?n.Ff(o,e):n.Uf(r,e)}));for(var u=0;u<r.objectStoreNames.length;u++)a.indexOf(r.objectStoreNames[u])<0&&r.deleteObjectStore(r.objectStoreNames[u])},t.prototype.Uf=function(e,t){var n=e.createObjectStore(t.name,{keyPath:t.pk});t.columns.forEach((function(e){n.createIndex(e.name,e.name,{unique:e.unique,multiEntry:!0})}))},t.prototype.Ff=function(e,t){var n=e.objectStore(t.name),r=[];t.columns.forEach((function(e){r.push(e.name),n.indexNames.contains(e.name)||n.createIndex(e.name,e.name,{unique:e.unique,multiEntry:!0})}));for(var o=0;o<n.indexNames.length;o++)r.indexOf(n.indexNames[o])<0&&n.deleteIndex(n.indexNames[o])},t.prototype.whenReady=function(){return this.Of},t.prototype.Vf=function(e){return new Promise((function(t,n){e.oncomplete=function(){t()},e.onerror=function(e){n(e.target.error)}}))},t.prototype.upsertRow=function(e,t){var n=this.Df.transaction(e,"readwrite");return n.objectStore(e).put(t),this.Vf(n)},t.prototype.deleteRow=function(e,t){var n=this.Df.transaction(e,"readwrite");return n.objectStore(e).delete(t),this.Vf(n)},t.prototype.upsertRows=function(e,t){var n=this.Df.transaction(e,"readwrite"),r=n.objectStore(e);return t.forEach((function(e){r.put(e)})),this.Vf(n)},t.prototype.deleteRows=function(e,t){var n=this.Df.transaction(e,"readwrite"),r=n.objectStore(e);return t.forEach((function(e){r.delete(e)})),this.Vf(n)},t.prototype.xf=function(e){return new Promise((function(t,n){var r=[];e.onsuccess=function(e){var n=e.target.result;n?(r.push(n.value),n.continue()):t(r)},e.onerror=function(e){n(e.target.error)}}))},t.prototype.getRows=function(e,t,n){var r=this.Df.transaction(e,"readonly").objectStore(e);if(n&&n!==r.keyPath){var o=r.index(n);return this.xf(o.openCursor(t))}return this.xf(r.openCursor(t))},t.prototype.queryRows=function(t,n){if(!e.isFunction(n))return Promise.reject(new TypeError("OfflineCache.queryRows: queryFunc must be a function"));var r=this.Df.transaction(t,"readonly").objectStore(t).openCursor(),o=[];return new Promise((function(e,t){r.onsuccess=function(t){var r=t.target.result;if(r){var i=r.value;n(i)&&o.push(i),r.continue()}else e(o)},r.onerror=function(e){t(e.target.error)}}))},t.getInstance=function(e){var n=e.dbName;return t.Qe[n]||(t.Qe[n]=new t(e)),t.Qe[n]},t}));