define(["jquery","ojs/ojcore","knockout","jraf/jrafcore","jraf/models/favorites/FavoritesContent","jraf/models/favorites/FavoritesConfig","jraf/models/favorites/PinnedFavoritesState","jraf/models/UIShellManager","jraf/utils/ValidationUtils","ojs/ojlistview","ojs/ojmenu","ojs/ojoption","ojs/ojlistviewdnd"],(function(e,t,n,i,o,r,a,s,d){"use strict";var v=t.Translations.getTranslatedString;function u(e){var t=this;this._favoriteHandler=r.getInstance().getFavoriteHandler(e.favoriteHandlerKey),this._favoritesContent=o.getInstance(this._favoriteHandler.getFavoritesService(),e.favoriteHandlerKey),this._pinnedFavoritesState=a.getInstance(),this.pinnedFavoritesListId=i.UIShell.generateUniqueId(),this.pinnedFavoriteItemTemplateId=i.UIShell.generateUniqueId(),this.pinnedFavoritesToolbarId=i.UIShell.generateUniqueId(),this.toolbarDeletePinButtonId=i.UIShell.generateUniqueId(),this.pinnedFavoritesHeader=v("jraf.sidebar.favorites.pinnedFavoritesHeader"),this.noFavoritesToDisplayMessage=v("jraf.sidebar.favorites.noFavoritesToDisplayMessage"),this.pinnedFavoritesListAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesListAriaLabel"),this.pinnedFavoritesToolbarAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesToolbarAriaLabel"),this.toolbarDeletePinButtonName=v("jraf.sidebar.favorites.toolbarDeletePinButtonName"),this.getPinnedFavoriteGuid=function(e){return t._getPinnedFavoriteGuid(e)},this.getPinnedFavoriteIconClass=function(e){return t._getPinnedFavoriteIconClass(e)},this.getPinnedFavoriteTitle=function(e){return t._getPinnedFavoriteTitle(e)},this.getPinnedFavoritePath=function(e){return t._getPinnedFavoritePath(e)},this._initContextMenu(),this._initPinnedFavoritesData(),this._initPinnedFavoritesListView()}return u.prototype._initPinnedFavoritesData=function(){var e=this;this.guidToPinnedFavoriteMap={},this.pinnedFavoriteToGuidMap={},this.pinnedFavorites=this._pinnedFavoritesState.getPinnedFavorites(),this.hasPinnedFavorites=n.pureComputed((function(){return e.pinnedFavorites().length>0})),this.favoritesContentLoaded=this._favoritesContent.getFavoritesContentLoaded()},u.prototype.connected=function(){var e=this;this.pinnedFavoritesSubscription||(this.pinnedFavoritesSubscription=this.pinnedFavorites.subscribe((function(){e._refreshPinnedFavoritesListWhenReady()})))},u.prototype._refreshPinnedFavoritesListWhenReady=function(){var e=this,n=document.querySelector("#"+this.pinnedFavoritesListId);n&&t.Context.getContext(n).getBusyContext().whenReady().then((function(){e._refreshPinnedFavoritesListNow()}))},u.prototype._refreshPinnedFavoritesListNow=function(){var e=document.querySelector("#"+this.pinnedFavoritesListId);e&&e.refresh()},u.prototype._getPinnedFavoriteGuid=function(e){var t=this.pinnedFavoriteToGuidMap[e.pinnedFavoriteId];return t||(t=i.UIShell.generateUniqueId(),this.pinnedFavoriteToGuidMap[e.pinnedFavoriteId]=t,this.guidToPinnedFavoriteMap[t]=e),t},u.prototype._getPinnedFavoriteIconClass=function(e){var t=a.favoriteIcons[e.favorite.favoriteType];return t||(t=a.favoriteIcons.unknown),"pin-icon "+t},u.prototype._getPinnedFavoriteTitle=function(e){return this._favoriteHandler.getLocalizedTitle(e.favorite.entryId)},u.prototype._getPinnedFavoritePath=function(e){for(var t=this._favoriteHandler.getLocalizedTitle(e.favorite.entryId,!0),n=t?t():"",i=e.favorite.parentFavItemId;i;){var o=this._favoritesContent.lookupFavoriteById(i);if(o){var r=this._favoriteHandler.getLocalizedTitle(o.entryId);n=(r?r():"")+"/"+n,i=o.parentFavItemId}else i=null}return n},u.prototype.disconnected=function(){this.pinnedFavoritesSubscription&&(this.pinnedFavoritesSubscription.dispose(),this.pinnedFavoritesSubscription=null)},u.prototype._initPinnedFavoritesListView=function(){var e=this;this.pinnedFavoritesSelection=n.observableArray([]),this.pinnedFavoriteIsSelected=n.pureComputed((function(){return e.pinnedFavoritesSelection().length>0})),this.selectedPinnedFavoriteGuid=n.pureComputed((function(){return e.pinnedFavoritesSelection()[0]})),this.selectedPinnedFavorite=n.pureComputed((function(){return e.guidToPinnedFavoriteMap[e.selectedPinnedFavoriteGuid()]})),this.handleDragStart=function(t){return e._handleDragStart(t)},this.handleReorder=function(t){return e._handleReorder(t)},this.handleDeleteButton=function(){e._favoritesContent.unpinFavorite(e.selectedPinnedFavorite().favorite.entryId).then((function(){e.selectedPinnedFavorite()&&e.pinnedFavoritesSelection.removeAll()}))}},u.prototype._initContextMenu=function(){var e=this;this.pinnedFavoritesContextMenuAriaLabel=v("jraf.sidebar.favorites.pinnedFavoritesContextMenuAriaLabel"),this.pinnedFavoritesContextCutOption=v("jraf.sidebar.favorites.pinnedFavoritesContextCutOption"),this.pinnedFavoritesContextPasteOption=v("jraf.sidebar.favorites.pinnedFavoritesContextPasteOption"),this.pinnedFavoritesContextPasteAfterOption=v("jraf.sidebar.favorites.pinnedFavoritesContextPasteAfterOption"),this.pinnedFavoritesContextUnpinOption=v("jraf.sidebar.favorites.pinnedFavoritesContextUnpinOption"),this.contextMenuTarget=n.observable(),this.pinnedFavoriteToCut=n.observable(),this.contextMenuAction=function(t){e._handleContextMenuAction(t)},this.contextMenuBeforeOpen=function(t){e._handleContextMenuBeforeOpen(t)},this.preventPasteToTarget=n.pureComputed((function(){return!e.pinnedFavoriteToCut()})),this.contextMenuActions={},this.contextMenuActions.cut=function(){e.pinnedFavoriteToCut(e.contextMenuTarget())},this.contextMenuActions.paste=function(){e._handleContextMenuPasteAction("before")},this.contextMenuActions.pasteAfter=function(){e._handleContextMenuPasteAction("after")},this.contextMenuActions.unpin=function(){e._favoritesContent.unpinFavorite(e.contextMenuTarget().favorite.entryId).then((function(){e.contextMenuTarget()&&e.selectedPinnedFavorite()&&e.contextMenuTarget().favorite.entryId===e.selectedPinnedFavorite().favorite.entryId&&e.pinnedFavoritesSelection.removeAll()}))}},u.prototype._handleContextMenuAction=function(e){var t=e.target.value;this.contextMenuTarget()&&t&&this.contextMenuActions[t]()},u.prototype._handleContextMenuBeforeOpen=function(t){var n=document.getElementById(this.pinnedFavoritesListId),i=e("#"+n.currentItem)[0],o=this.guidToPinnedFavoriteMap[i.id];this.contextMenuTarget(o),e("#"+this.pinnedFavoritesContextMenuId).ojMenu("refresh")},u.prototype._handleContextMenuPasteAction=function(e){this._favoritesContent.reorderPinnedFavorite(this.pinnedFavoriteToCut().pinnedFavoriteId,this.contextMenuTarget().pinnedFavoriteId,e),this.pinnedFavoriteToCut(void 0)},u.prototype._handleReorder=function(e){for(var t,n,i,o=document.getElementById(this.pinnedFavoritesListId),r=o.getContextByNode(e.detail.reference),a=e.detail.items,s=0;s<a.length;s++)t=o.getContextByNode(a[s]),n=this.guidToPinnedFavoriteMap[t.key],i=this.guidToPinnedFavoriteMap[r.key],this._favoritesContent.reorderPinnedFavorite(n.pinnedFavoriteId,i.pinnedFavoriteId,e.detail.position)},u.prototype._handleDragStart=function(t,n){var i=e(t.target).parents(".oj-listview-item").get(0);return t.dataTransfer.setDragImage(i,0,0),!0},u}));