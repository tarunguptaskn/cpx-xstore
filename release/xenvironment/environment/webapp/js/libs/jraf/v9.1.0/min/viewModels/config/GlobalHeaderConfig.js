define(["knockout","jquery","ojs/ojcore","jraf/jrafcore","jraf/models/UIShellManager","jraf/utils/ValidationUtils","jraf/services/ServiceManager","jraf/composites/oj-rgbu-jraf-message-dialog/loader","ojs/ojinputtext","ojs/ojtoolbar","ojs/ojcolorspectrum","ojs/ojcolor","ojs/ojbutton","ojs/ojvalidation","ojs/ojknockout-validation","ojs/ojlabel","ojs/ojvalidationgroup","ojs/ojformlayout"],(function(o,t,e,i,r,s,a){"use strict";var n=e.Translations.getTranslatedString;function l(){var t=this;this.formId=i.UIShell.generateUniqueId(),this.colorSelectId=i.UIShell.generateUniqueId(),this.logoSelectId=i.UIShell.generateUniqueId(),this.errorDialogId=i.UIShell.generateUniqueId(),this.closeConfirmDialogId=i.UIShell.generateUniqueId(),this.colorSpectrumId=i.UIShell.generateUniqueId(),this.applicationNameId=i.UIShell.generateUniqueId(),this.colorLabel=n("jraf.settings.globalHeader.brandColor"),this.colorSwatchLabel=n("jraf.settings.globalHeader.colorSwatch"),this.logoLabel=n("jraf.settings.globalHeader.logo"),this.removeLogoLabel=n("jraf.settings.globalHeader.removeLogo"),this.colorSpectrumLabel=n("jraf.settings.globalHeader.colorSpectrumLabel"),this.applicationNameLabel=n("jraf.settings.globalHeader.applicationName"),this.applicationNamePlaceholder=n("jraf.settings.globalHeader.applicationNamePlaceholder"),this.toolbarLabel=n("jraf.settings.globalHeader.toolbarLabel"),this.applyLabel=n("jraf.settings.globalHeader.save"),this.cancelLabel=n("jraf.common.cancel"),this.applyCloseLabel=n("jraf.settings.globalHeader.saveClose"),this.invalidColorMessage=n("jraf.settings.globalHeader.colorError"),this.invalidFileTypeMessage=n("jraf.settings.globalHeader.logoTypeError"),this.closeConfirmMessage=n("jraf.settings.globalHeader.closeConfirmMessage"),this.defaultServiceErrorMessage=n("jraf.settings.globalHeader.serviceError"),this.applicationNameTracker=i.UIShell.generateUniqueId()+"_applicationNameTracker",this.applicationNameValid=o.observable();var r=e.Validation.validatorFactory(e.ValidatorFactory.VALIDATOR_TYPE_LENGTH),s={countBy:"codePoint",max:l.MAX_APP_NAME_LENGTH};this.applicationNameValidators=[r.createValidator(s)],this.$f=a.getGlobalAreaConfigurationService(),this.applicationName=o.observable(),this.colorString=o.observable(),this.logoFile=o.observable(),this.logoImage=o.observable(),this.hasLogo=o.pureComputed((function(){return!!t.logoImage()})),this.Wf=!1,this.errorDialogMessage=o.observable(),this.Xf(),this.Yf(),this.removeLogo=function(){t.Zf()},this.submitChanges=function(){t.tj()},this.submitChangesAndClose=function(){t.tj().then((function(){t.ij()}))},this.cancelChangesAndClose=function(){t.ij()},this.discardChangesAndClose=function(){t.Wf=!0,t.ij()}}return l.COLOR_STRING_REGEX=/^#([\da-f]{3}|[\da-f]{6})$/i,l.LOGO_SIZE_CONVERSION_FACTOR=1048576,l.MAX_APP_NAME_LENGTH=100,l.prototype.uiShellClose=function(){this.sj(),this.Wf=!1},l.prototype.uiShellBeforeClose=function(){return!(this.oj()&&!this.Wf&&(this.nj(),1))},l.prototype.Xf=function(){var o=i.App.getGlobalHeaderConfig();this.rj=o,this.hj={logo:o.applicationIcon(),color:o.processingIndicatorColor(),maxLogoSize:o.maxLogoSize(),applicationName:o.applicationName()},this.invalidFileSizeMessage=n("jraf.settings.globalHeader.logoSizeError",[this.hj.maxLogoSize]),this.logoImage(this.hj.logo),this.colorString(this.hj.color),this.applicationName(this.hj.applicationName),this.renderProcessingIndicator=r.isRenderProcessingIndicator()},l.prototype.Zf=function(){this.logoImage(null)},l.prototype.tj=function(){var o=this,t=document.getElementById(this.applicationNameTracker);if("valid"!==t.valid)return t.showMessages(),t.focusOn("@firstInvalidShown"),Promise.reject();var e=[];return this.hj.applicationName!==this.applicationName()&&e.push(this.ej()),s.isNonemptyString(this.logoFile())?e.push(this.aj()):!this.logoImage()&&this.hj.logo&&e.push(this.uj()),this.hj.color!==this.colorString()&&s.isNonemptyString(this.colorString())?e.push(this.lj()):!this.colorString()&&this.hj.color&&e.push(this.cj()),Promise.all(e).catch((function(t){return o.fj(t),Promise.reject(t)}))},l.prototype.jj=function(o){var t=o.get("logo");if(0!==t.type.indexOf("image/"))return this.invalidFileTypeMessage;var e=t.size/l.LOGO_SIZE_CONVERSION_FACTOR;return 0<this.hj.maxLogoSize&&e>this.hj.maxLogoSize?this.invalidFileSizeMessage:null},l.prototype.gj=function(o){return l.COLOR_STRING_REGEX.test(o)},l.prototype.aj=function(){var o=this;r.startProcessingIndicator();var t=new FormData(document.getElementById(this.formId)),e=this.jj(t);return e?(r.stopProcessingIndicator(),Promise.reject(e)):this.$f.uploadLogo(t).then((function(){o.dj(t),o.logoFile(""),r.stopProcessingIndicator()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype.dj=function(o){var t=this,e=o.get("logo"),i=new window.FileReader;i.addEventListener("load",(function(){t.rj.applicationIcon(i.result),t.logoImage(i.result),t.hj.logo=i.result})),i.readAsDataURL(e)},l.prototype.uj=function(){var o=this;return r.startProcessingIndicator(),this.$f.clearLogo().then((function(){r.stopProcessingIndicator(),o.rj.applicationIcon(null),o.hj.logo=null}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype.lj=function(){var o=this;return r.startProcessingIndicator(),this.gj(this.colorString())?this.$f.setProcessingIndicatorColor(this.colorString()).then((function(){r.stopProcessingIndicator(),o.rj.processingIndicatorColor(o.colorString()),o.hj.color=o.colorString()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)})):(r.stopProcessingIndicator(),Promise.reject(this.invalidColorMessage))},l.prototype.cj=function(){var o=this;return r.startProcessingIndicator(),this.$f.clearProcessingIndicatorColor().then((function(){r.stopProcessingIndicator(),o.rj.processingIndicatorColor(""),o.hj.color=""}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype.ej=function(){var o=this;return r.startProcessingIndicator(),this.$f.setApplicationName(this.applicationName()).then((function(){r.stopProcessingIndicator(),o.rj.applicationName(o.applicationName()),o.hj.applicationName=o.applicationName()}),(function(o){return r.stopProcessingIndicator(),Promise.reject(o)}))},l.prototype.fj=function(o){s.isNonemptyString(o)?this.errorDialogMessage(o):this.errorDialogMessage(this.defaultServiceErrorMessage),document.getElementById(this.errorDialogId).open()},l.prototype.oj=function(){return this.hj.applicationName!==this.applicationName()||this.hj.logo!==this.logoImage()||this.hj.color!==this.colorString()||!(this.hj.logo||!this.logoFile())},l.prototype.nj=function(){document.getElementById(this.closeConfirmDialogId).open()},l.prototype.ij=function(){r.closeContent()},l.prototype.sj=function(){this.applicationName(this.hj.applicationName),this.logoImage(this.hj.logo),this.colorString(this.hj.color)},l.prototype.Yf=function(){var t=this.colorString(),i=e.Color.TRANSPARENT;s.isNonemptyString(t)&&(i=new e.Color(t)),this.spectrumSelection=o.observable(i),this.spectrumSelection.subscribe((function(){this.mj()}),this),this.colorString.subscribe((function(){this.vj()}),this)},l.prototype.mj=function(){var o=this.colorString(),t=this.bj(this.spectrumSelection());t!==o&&this.colorString(t)},l.prototype.vj=function(){var o=this.colorString(),t=this.spectrumSelection(),i=this.bj(t);this.gj(o)&&i!==o&&this.spectrumSelection(new e.Color(o))},l.prototype.bj=function(o){var t=o.getRed(),e=o.getGreen(),i=o.getBlue();return"#"+this.Hj(t)+this.Hj(e)+this.Hj(i)},l.prototype.Hj=function(o){var t=o.toString(16).toUpperCase();return 1===t.length?"0"+t:t},l}));