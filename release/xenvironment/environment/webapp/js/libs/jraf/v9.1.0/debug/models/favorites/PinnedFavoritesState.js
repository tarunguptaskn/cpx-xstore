define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/utils/ValidationUtils"],(function(e,n,t,i){"use strict";function r(){this._pinnedFavorites=n.observableArray([])}return r._manageGlobalPins=!1,r._pinProperty="localPinSequence",r.favoriteIcons={task:"jraf-favorite-task-icon",report:"jraf-favorite-report-icon",document:"jraf-favorite-document-icon",user:"jraf-favorite-user-icon",unknown:"jraf-favorite-default-icon"},r.prototype.getPinnedObservable=function(e){return n.computed((function(){var n=e[r._pinProperty]();return i.isNumberStrict(n)}))},r.prototype.updateState=function(e,n){if(e.isPinned()){var t=this._lookupPinnedFavorite(e,n);t?t.favorite=e:this._addPinnedFavorite(e,n),this._sortPinnedFavorites()}else this._removePinnedFavorite(e,n)},r.prototype.removeAllPins=function(e,n){var t=this;e&&e.forEach((function(e){t._removePinnedFavorite(e,n),e.isFolder&&t.removeAllPins(e.children(),n)}))},r.prototype._lookupPinnedFavorite=function(e,n){var t=this._getPinnedFavoriteId(e,n);return this.lookupPinnedFavoriteById(t)},r.prototype._addPinnedFavorite=function(e,n){var t={pinnedFavoriteId:this._getPinnedFavoriteId(e,n),favorite:e,favoriteHandlerKey:n};this._pinnedFavorites.push(t)},r.prototype._getPinnedFavoriteId=function(e,n){return(i.isNonemptyString(n)?n:"local")+"."+e.entryId},r.prototype._sortPinnedFavorites=function(){this._pinnedFavorites.sort((function(e,n){var t=e.favorite[r._pinProperty](),i=n.favorite[r._pinProperty]();return t===i?0:t<i?-1:1}))},r.prototype._removePinnedFavorite=function(e,n){var t=this._getPinnedFavoriteId(e,n);this._pinnedFavorites.remove((function(e){return e.pinnedFavoriteId===t}))},r.prototype.pinFavorite=function(e,n){if(e.isPinned())return!1;var t=this._getNextPinSequence();return e[r._pinProperty](t),this._addPinnedFavorite(e,n),!0},r.prototype._getNextPinSequence=function(){var e=this._pinnedFavorites.slice(-1)[0];return e?e.favorite[r._pinProperty]()+1:1},r.prototype.unpinFavorite=function(e,n){return!(!e.isFolder&&!e.isPinned())&&(e[r._pinProperty](null),this._removePinnedFavorite(e,n),!0)},r.prototype.getPinnedFavorites=function(){return this._pinnedFavorites},r.prototype.lookupPinnedFavoriteById=function(e){return this._pinnedFavorites().filter((function(n){return n.pinnedFavoriteId===e}))[0]},r.getInstance=function(){var e=t.App.getUserData().userid;return e!==r._currentUser&&(r._instance=null,r._currentUser=e),r._instance instanceof r||(r._instance=new r),r._instance},r.manageGlobalPins=function(e){r._manageGlobalPins=e,r._pinProperty=r._manageGlobalPins?"globalPinSequence":"localPinSequence"},r.prototype.reorderPinnedFavorite=function(e,n,t,i,o){var a,s=this.lookupPinnedFavoriteById(e),p=this.lookupPinnedFavoriteById(t),d=this._getIndexOfPinnedFavorite(s.pinnedFavoriteId),v=this._getIndexOfPinnedFavorite(p.pinnedFavoriteId);if("after"===o&&v++,d===v)return!1;this._pinnedFavorites.splice(v,0,s),d>v?a=d+1:d<v&&(a=d),this._pinnedFavorites.splice(a,1);for(var u=0;u<this._pinnedFavorites().length;u++){var f=this._pinnedFavorites()[u].favorite;f[r._pinProperty]()!==u+1&&i.push(f),f[r._pinProperty](u+1)}return!0},r.prototype._getIndexOfPinnedFavorite=function(e){for(var n=0;n<this._pinnedFavorites().length;n++)if(e===this._pinnedFavorites()[n].pinnedFavoriteId)return n},r}));