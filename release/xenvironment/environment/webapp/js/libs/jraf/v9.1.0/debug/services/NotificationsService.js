define(["jquery","ojs/ojcore","jraf/jrafcore","jraf/utils/UrlUtils","jraf/utils/ValidationUtils","jraf/services/AbstractService"],(function(t,e,i,r,a,n){"use strict";function o(t,e){if(o.superclass.constructor.apply(this,arguments),a.isObjectStrict(e)?(this.appCodes=e.appCodes,this._clientAppCode=e.clientAppCode):this.appCodes=e,!a.isArray(this.appCodes))throw new TypeError("NotificationsService: Missing Application Codes.");this.appCodesUrlString="",this._initializeAppCodesUrlString()}return o.SERVICE_URL_PATH="services/private/Notifications/",o.ALERTS_SERVICE_URL_PATH="services/private/Alerts/",o.SERVICE_VERSION_OVERRIDE=null,o.UNREAD_NOTIFICATION_STATUS="U",o.READ_NOTIFICATION_STATUS="R",e.Object.createSubclass(o,n,"NotificationsService"),o.prototype.getServiceConfiguration=function(){return{baseUri:this.getBaseUri(),appCodes:this.appCodes}},o.prototype.GetStandardHeaders=function(){var t=o.superclass.GetStandardHeaders.apply(this);return t["Accept-Version"]=o.SERVICE_VERSION_OVERRIDE||t["Accept-Version"],t},o.prototype.getNotificationTypes=function(e){var i=this,r="fetch/notificationtypes?groups=true&appCode="+this.appCodesUrlString;e&&(r+="&ignoreUser=true");var a=this._buildNotificationsEndpoint(r),n=t.ajax(a,{headers:i.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(n).then((function(t){return i._parseNotificationTypes(t)}))},o.prototype._parseNotificationTypes=function(t){for(var e=[],i=0;i<t.length;i++){var r={label:t[i].name,value:t[i].typeId,typeCode:t[i].typeCode},a=t[i].groups;if(a){var n=[];r.groups=n;for(var o=0;o<a.length;o++)n.push({name:a[o].name,description:a[o].description,id:a[o].id})}e.push(r)}return e},o.prototype.getNotificationTimes=function(){var e=this,i=this._buildNotificationsEndpoint("fetch/timeperiods?appCode="+this.appCodesUrlString),r=t.ajax(i,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return e._parseNotificationTimes(t)}))},o.prototype._parseNotificationTimes=function(t){for(var e=[],i=0;i<t.length;i++)e.push({label:t[i].description,value:t[i].periodId});return e},o.prototype.getNotificationHierarchyLevels=function(){var e=this,i=this._buildNotificationsEndpoint("fetch/hierarchylevels?appCode="+this.appCodesUrlString),r=t.ajax(i,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return e._parseHierarchyLevels(t)}))},o.prototype._parseHierarchyLevels=function(t){for(var e=[],i=0;i<t.length;i++)e.push({name:t[i].description,id:t[i].hierLevelId,token:t[i].tokenName,parent:t[i].parentHierLevelId});return e},o.prototype.getUnreadNotificationCount=function(){var e=this,i=this._buildNotificationsEndpoint("fetch/unreadcount?appCode="+this.appCodesUrlString),r=t.ajax(i,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return new Promise((function(t,i){e.ConvertAjaxPromise(r).then((function(e){e&&a.isNumberStrict(e.unreadNotificationCount)?t(e.unreadNotificationCount):i("Did not receive unreadNotificationCount in response.")}),(function(t){i(t)}))}))},o.prototype.getNotificationCount=function(e){var i=this,r=this._buildNotificationsEndpoint("filter/count");e.appCodes=this.appCodes;var n=t.ajax(r,{headers:i.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return new Promise((function(t,e){i.ConvertAjaxPromise(n).then((function(i){i&&a.isNumberStrict(i.matchedCount)?t(i.matchedCount):e("Did not receive matchedCount in response.")}),(function(t){e(t)}))}))},o.prototype.getRecipients=function(e){var i=this._buildNotificationsEndpoint("fetch/recipients/"+e),r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return t.recipients}))},o.prototype.getNotifications=function(e){var i=this._buildNotificationsEndpoint("filter/list"),r=[];if(a.isArray(e.sortColumns))for(var n=0;n<e.sortColumns.length;n++)r.push(this._getSortString(e.sortColumns[n]));var o={};t.extend(o,e,{appCodes:this.appCodes,sortColumns:r});var s=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(o),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(s)},o.prototype.getNotificationGroups=function(e){var i=this._buildNotificationsEndpoint("filter/group");e.appCodes=this.appCodes;var r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return t}))},o.prototype.getNotificationSummaries=function(e){var i=this._buildNotificationsEndpoint("filter/summarize");e.appCodes=this.appCodes;var r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return t}))},o.prototype.markNotificationAsRead=function(e,i){if(!a.isNumberStrict(e))throw new TypeError("NotificationsService.markNotificationAsRead: notificationId must be a number.");var r=void 0===i||i,n=this._buildNotificationsEndpoint("update"),s=t.ajax(n,{headers:this.GetStandardHeaders(),method:"PUT",processData:!1,data:JSON.stringify({notificationId:e,notificationStatus:r?o.READ_NOTIFICATION_STATUS:o.UNREAD_NOTIFICATION_STATUS}),xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(s)},o.prototype.markMultipleNotificationsAsRead=function(e,i){var r={notificationIds:e,status:i?o.READ_NOTIFICATION_STATUS:o.UNREAD_NOTIFICATION_STATUS},a=this._buildNotificationsEndpoint("update/multiple"),n=t.ajax(a,{headers:this.GetStandardHeaders(),data:JSON.stringify(r),processData:!1,method:"PUT",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(n)},o.prototype.getNotificationContext=function(e){var i=this,r=this._buildNotificationsEndpoint("fetch/context/"+e),a=t.ajax(r,{headers:i.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return new Promise((function(t,e){i.ConvertAjaxPromise(a).then((function(r){try{var a=i.ParseNotificationContext(r.context);t(a)}catch(t){e(t)}}),(function(t){e(t)}))}))},o.prototype.ParseNotificationContext=function(t){return JSON.parse(t)},o.prototype.createNotification=function(e){e.applicationCode||(e.applicationCode=this.appCodes[0]);var i=this._buildNotificationsEndpoint("create"),r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"text",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r)},o.prototype.deleteNotification=function(e){var i=this._buildNotificationsEndpoint("delete/"+e),r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",method:"DELETE",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r)},o.prototype.deleteMultipleNotifications=function(e){var i=this._buildNotificationsEndpoint("delete/multiple"),r=t.ajax(i,{headers:this.GetStandardHeaders(),data:JSON.stringify({notificationIds:e}),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r)},o.prototype.persistCriteria=function(i){var r=this._buildNotificationsEndpoint("criteria");i.appCodes=this.appCodes;var a=t.ajax(r,{headers:this.GetStandardHeaders(),data:JSON.stringify(i),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(a).catch((function(t){e.Logger.warn("Failed to persist criteria: ",t)}))},o.prototype.loadCriteria=function(){var e=this._buildNotificationsEndpoint("fetch/criteria?appCode="+this.appCodesUrlString),i=t.ajax(e,{headers:this.GetStandardHeaders(),xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i)},o.prototype._buildNotificationsEndpoint=function(t){var e=this.BuildEndpoint(t,o.SERVICE_URL_PATH);return this._clientAppCode&&(e=r.injectQueryParameter(e,"clientAppCode",this._clientAppCode)),e},o.prototype._getSortString=function(t){var e="asc"===t.direction?"A":"D";return t.column+"|"+e},o.prototype._initializeAppCodesUrlString=function(){var t=this.appCodes.join(",");this.appCodesUrlString=encodeURIComponent(t)},o.prototype.getAlerts=function(e){var i=this._buildAlertsEndpoint("get?notificationId="+e),r=t.ajax(i,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r).then((function(t){return t}))},o.prototype.getAlertAttachment=function(e,i){var r=this._buildAlertsEndpoint("getAttachment?alertId="+e+"&fileName="+i),a=this.GetStandardHeaders();a.Accept="application/octet-stream";var n=t.ajax(r,{headers:a,xhrFields:{withCredentials:!0,responseType:"blob"}});return this.ConvertAjaxPromise(n).then((function(t){return t}))},o.prototype._buildAlertsEndpoint=function(t){var e=this.BuildEndpoint(t,o.ALERTS_SERVICE_URL_PATH);return this._clientAppCode&&(e=r.injectQueryParameter(e,"clientAppCode",this._clientAppCode)),e},o}));