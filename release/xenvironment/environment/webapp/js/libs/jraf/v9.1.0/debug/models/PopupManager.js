define(["ojs/ojcore","knockout","jquery","ojs/ojdialog"],(function(e,o,t){"use strict";function n(e){if("object"!=typeof e||null===e||"string"!=typeof e.popupComponentId||0!==e.popupComponentId.indexOf("#")||"string"!=typeof e.popupAppsModuleId)throw new Error("PopupManager: invalid popup configuration.");this.dialogComponentId=e.popupComponentId,this.popupAppsModuleId=e.popupAppsModuleId,this.popupOpen=o.observable(!1),this.popupProperties=o.observable(null),this.moduleBinding=o.observable(null),this.readOnlyModuleBinding=o.pureComputed((function(){return this.moduleBinding()}),this),this.moduleOptions=o.observable(null),this.readOnlyModuleOptions=o.pureComputed((function(){return this.moduleOptions()}),this)}return n.prototype._handlePopupOpen=function(e,o){this._isManagedEvent(e)&&this.popupOpen(!0)},n.prototype._handlePopupBeforeClose=function(e,o){if(this._isManagedEvent(e))return this._invokeCallback("uiShellBeforeClose",e,o)},n.prototype._handlePopupClose=function(e,o){if(this._isManagedEvent(e)){this.popupOpen(!1);var t=this._invokeCallback("uiShellClose",e,o);return this._closeDeferred&&this._closeDeferred.resolve(),this.moduleBinding(null),this.moduleOptions(null),document.querySelector(".jraf-global-popup-footer").innerHTML="",t}},n.prototype._isManagedEvent=function(e){return e.target===document.querySelector(this.dialogComponentId)},n._getResizeBehavior=function(e){return e.targetProperties.resizable?"resizable":"none"},n._getCancelBehavior=function(e){return e.targetProperties.showCloseIcon?"icon":"escape"},n._getStyle=function(e){var o=e.targetProperties.width,t=e.targetProperties.height,n={minWidth:"250px",minHeight:"250px"};return n.width=o,n.height=t,n},n.prototype.getModuleBinding=function(){return this.readOnlyModuleBinding},n.prototype.getModuleOptions=function(){return this.readOnlyModuleOptions},n.prototype.getAfterLoadModuleHandler=function(){var e=this;return function(o,t){return e._handleAfterLoadModule(o,t)}},n.prototype._handleAfterLoadModule=function(e,o){return this._updateDialogBody(o.view),Promise.resolve(o)},n.prototype._updateDialogBody=function(e){var o=this._getFirstNonTextElement(e);o&&this._removeDialogBodyClass(o)},n.prototype._getFirstNonTextElement=function(e){for(var o=null,t=0;t<e.length;t++){var n=e[t];if(n&&1===n.nodeType){o=n;break}}return o},n.prototype.getTransitionEndHandler=function(){var e=this;return function(o){return e._handleTransitionEnd(o)}},n.prototype._handleTransitionEnd=function(e){this._relocateDialogFooter(e.target.childNodes),this._openDialog()},n.prototype._relocateDialogFooter=function(e){var o=null;Array.prototype.forEach.call(e,(function(e){!o&&1===e.nodeType&&t(e).hasClass("oj-dialog-footer")&&(o=e)})),this._moveFooter(o)},n.prototype._getPopupProperties=function(e){var o=this;return{title:e.getTargetTitle(),modality:"modal",initialVisibility:"hide",resizeBehavior:n._getResizeBehavior(e),cancelBehavior:n._getCancelBehavior(e),style:n._getStyle(e),onOjOpen:function(e,t){o._handlePopupOpen(e,t)},onOjBeforeClose:function(e,t){return o._handlePopupBeforeClose(e,t)},onOjClose:function(e,t){return o._handlePopupClose(e,t)}}},n.prototype._constructModuleBinding=function(o){var t=this,n=o.getModuleBinding();return"object"==typeof n.lifecycleListener&&null!==n.lifecycleListener&&e.Logger.warn("PopupManager._constructModuleBinding: Modules lifecycleListener is being overwritten."),n.lifecycleListener={attached:function(e){t._handlePopupModuleAttached(e)},bindingsApplied:function(e){t._handlePopupModuleLoaded(e,o)}},n},n.prototype._handlePopupModuleAttached=function(e){for(var t=null,n=e.element,i=o.virtualElements.firstChild(n);i;){if(1===i.nodeType){t=i;break}i=o.virtualElements.nextSibling(i)}t&&this._removeDialogBodyClass(t)},n.prototype._removeDialogBodyClass=function(e){var o=t(e);o.hasClass("oj-dialog-body")&&"div"===o.prop("tagName").toLowerCase()&&o.removeClass("oj-dialog-body")},n.prototype._handlePopupModuleLoaded=function(e,o){this._attachFooter(e),this._updateDialog(o),this._openDialog()},n.prototype._attachFooter=function(e){for(var n=e.element,i=null,r=o.virtualElements.firstChild(n);r;){if(1===r.nodeType&&t(r).hasClass("oj-dialog-footer")){i=r;break}r=o.virtualElements.nextSibling(r)}this._moveFooter(i)},n.prototype._moveFooter=function(o){o&&(t(o).removeClass("oj-dialog-footer"),e.Components.subtreeDetached(o),document.querySelector(".jraf-global-popup-footer").appendChild(o),e.Components.subtreeAttached(o))},n.prototype.openContent=function(e){if(this.popupOpen())throw new Error("A popup is already open. Close the other popup first.");if(e.hasModuleOptions()){this._updateDialog(e);var o=e.getModuleOptions();this.moduleOptions(o)}else{var t=this._constructModuleBinding(e);this.moduleBinding(t)}},n.prototype._invokeCallback=function(e,o,t){return document.getElementById(this.popupAppsModuleId).invokeModuleEventHandler(e,o,t)},n.prototype._updateDialog=function(e){var o=this._getPopupProperties(e),t=document.querySelector(this.dialogComponentId);t.title=o.title,t.modality=o.modality,t.initialVisibility=o.initialVisibility,t.resizeBehavior=o.resizeBehavior,t.cancelBehavior=o.cancelBehavior,t.onOjOpen=o.onOjOpen,t.onOjBeforeClose=o.onOjBeforeClose,t.onOjClose=o.onOjClose,Object.keys(o.style).forEach((function(e){t.style[e]=o.style[e]}))},n.prototype._openDialog=function(){document.querySelector(this.dialogComponentId).open()},n.prototype.closeContent=function(){var e=this;return this.popupOpen()?(document.querySelector(this.dialogComponentId).close(),this._closeDeferred=new t.Deferred,new Promise((function(o){e._closeDeferred.then(o)}))):Promise.resolve()},n}));