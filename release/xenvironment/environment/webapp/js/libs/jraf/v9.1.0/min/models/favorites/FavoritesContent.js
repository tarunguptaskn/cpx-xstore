define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/services/ServiceManager","jraf/models/UIShellManager","jraf/models/MenuContents","jraf/models/favorites/PinnedFavoritesState","jraf/utils/ValidationUtils"],(function(e,t,o,r,i,n,a,s){"use strict";function c(e,o){if(!e)throw new Error("FavoritesContent: missing favoritesService parameter");var r=this;this.favoriteHandlerKey=o,this.favorites=t.observableArray([]),this.revertPoint=[],this.favoritesService=e,this.pinnedFavoritesState=a.getInstance(),this.hasSeededFavorites=t.observable(!1),this.favoritesContentLoaded=t.observable(!1),this.Je(),this.hasFolders=t.pureComputed((function(){var e=r.Ke(r.favorites,(function(e){return e.isFolder}));return Boolean(e)})),this.favoritesReady=this.loadFavorites(!0)}return c.Qe={},c.We=null,c.FAVORITE_TYPE_FOLDER="folder",c.prototype.Je=function(){this.trackingSelection=this.favoritesService===r.getFavoritesService(),this.trackingSelection&&(this.applicationContentMap={},this.Xe())},c.prototype.Xe=function(){var t=this;this.Ye=n.getInstance(),this.Ze=this.Ye.getContentLeaves().then((function(e){t.$e(e)}),(function(t){e.Logger.warn("UIShellFavoritesMenu._loadContentMap: Content did not load successfully: ",t)}))},c.prototype.$e=function(e){for(var o in e)this.applicationContentMap[o]={content:e[o],selected:t.observable(!1)}},c.prototype.loadFavorites=function(e){var t=this;this.favoritesContentLoaded(!1),i.startProcessingIndicator();var o=[this.favoritesService.loadFavorites()],r=this.$o();return o.push(r),this.trackingSelection&&o.push(this.Ze),Promise.all(o).then((function(o){t.tu(o[0],o[1],e)}),(function(e){t.iu(e)}))},c.prototype.getFavoritesContentLoaded=function(){var e=this;return t.pureComputed((function(){return e.favoritesContentLoaded()}))},c.prototype.$o=function(){return this.gettingSeedCountPromise||(this.gettingSeedCountPromise=this.favoritesService.getSeededFavoritesCount()),this.gettingSeedCountPromise},c.prototype.tu=function(t,o,r){e.Logger.info("UIShellFavoritesMenu._handleSuccessfulFavoritesLoad: Data successfully loaded."),this.nu(t),s.isNumberStrict(o)&&0<o&&this.hasSeededFavorites(!0),i.stopProcessingIndicator(),r&&0===this.favorites().length&&this.hasSeededFavorites()?this.importFavorites():this.favoritesContentLoaded(!0)},c.prototype.nu=function(e){this.eu();var t=[];this.ru(e,t),this.favorites(t),this.ou(this.favorites())},c.prototype.ru=function(e,o){e.filter((function(e){return!this.trackingSelection||e.favoriteType===c.FAVORITE_TYPE_FOLDER||this.applicationContentMap[e.refItemId]}),this).forEach((function(e){var r={entryId:e.favItemId,userId:e.userId,contentId:e.refItemId,contentTitle:e.title,appCode:e.applicationCode,sequenceNumber:e.sequenceNumber,favoriteType:e.favoriteType,objectId:e.objectId,favoriteContext:e.favoriteContext,seededFavItemId:e.seededFavItemId,localPinSequence:t.observable(e.localPinSequenceNumber),globalPinSequence:t.observable(e.globalPinSequenceNumber),customName:t.observable(e.customName),parentFavItemId:e.parentFavItemId};r.isFolder=e.favoriteType===c.FAVORITE_TYPE_FOLDER,r.isFolder?r.children=this.su(e.children):(r.isPinned=this.pinnedFavoritesState.getPinnedObservable(r),this.uu(e.refItemId,e.objectId,!0)),o.push(r)}),this)},c.prototype.su=function(e){var o=[];return s.isArray(e)&&this.ru(e,o),t.observableArray(o)},c.prototype.ou=function(e){for(var t=0;t<e.length;t++)e[t].isFolder?this.ou(e[t].children()):this.pinnedFavoritesState.updateState(e[t],this.favoriteHandlerKey)},c.prototype.eu=function(){if(this.trackingSelection)for(var e in this.applicationContentMap)this.applicationContentMap[e].selected(!1)},c.prototype.uu=function(e,o,r){if(this.trackingSelection&&this.applicationContentMap.hasOwnProperty(e)){var i=this.au(e,o);this.applicationContentMap.hasOwnProperty(i)||(this.applicationContentMap[i]={selected:t.observable(!1)}),this.applicationContentMap[i].selected(r)}},c.prototype.au=function(e,t){return s.isNonemptyString(t)?e+"|"+t:e},c.prototype.iu=function(t){e.Logger.warn("UIShellFavoritesMenu._handleFailedFavoritesLoad: Failed loading favorites (%s)",t),i.stopProcessingIndicator()},c.prototype.getFavorites=function(){return this.favorites},c.prototype.getHasSeededFavoritesObservable=function(){var e=this;return t.pureComputed((function(){return e.hasSeededFavorites()}))},c.prototype.getHasFoldersObservable=function(){return this.hasFolders},c.prototype.addFavorite=function(e,t,o,r,n){var a=this;if(o!==c.FAVORITE_TYPE_FOLDER){if(!this.getContent(e))return Promise.reject("FavoritesContent.addFavorite: no content exists with contentId: "+e);if(!0===this.trackFavoriteState(e,r)())return Promise.reject("FavoritesContent.addFavorite: favorite exists already.")}return i.startProcessingIndicator(),new Promise((function(s,c){a.favoritesService.addFavorite(e,t,o,r,n).then((function(){a.loadFavorites(),i.stopProcessingIndicator(),s()}),(function(){i.stopProcessingIndicator(),c()}))}))},c.prototype.addFolder=function(e,t){return this.addFavorite(null,e,"folder")},c.prototype.getContent=function(e){if(this.trackingSelection&&this.applicationContentMap.hasOwnProperty(e))return this.applicationContentMap[e].content},c.prototype.removeFavorite=function(e,t){var o=this.fu(e,t);return this.hu(o)},c.prototype.removeFavoriteById=function(e){var t=this.cu(e);return this.hu(t)},c.prototype.hu=function(t){var o=this;return new Promise((function(r,n){if(t){i.startProcessingIndicator();var a=t.favorite;o.favoritesService.deleteFavorite(a.entryId).then((function(){o.vu(a),t.container.splice(t.index,1),o.du(a),i.stopProcessingIndicator(),r()}),(function(){i.stopProcessingIndicator(),n()}))}else e.Logger.warn("FavoritesContent.removeFavorite: Did not find specified favorite to remove"),n()}))},c.prototype.vu=function(e){var t=this;e.isFolder?e.children().forEach((function(e){t.vu(e)})):this.pinnedFavoritesState.unpinFavorite(e,this.favoriteHandlerKey)},c.prototype.du=function(e){var t=this;e.isFolder?e.children().forEach((function(e){t.du(e)})):this.uu(e.contentId,e.objectId,!1)},c.prototype.lookupFavoriteById=function(e){var t=this.cu(e);return t?t.favorite:void 0},c.prototype.cu=function(e){return this.Ke(this.favorites,(function(t){return t.entryId===e}))},c.prototype.fu=function(e,t){var o=!s.isNonemptyString(t);return this.Ke(this.favorites,(function(r){return r.contentId===e&&(o&&!r.objectId||r.objectId===t)}))},c.prototype.Ke=function(e,t){for(var o=0;o<e().length;o++){if(t(e()[o]))return{favorite:e()[o],container:e,index:o};if(e()[o].isFolder){var r=this.Ke(e()[o].children,t);if(r)return r}}},c.prototype.trackFavoriteState=function(e,o){var r;if(this.trackingSelection){var i=this.au(e,o);!(r=this.applicationContentMap[i])&&s.isNonemptyString(o)&&(this.uu(e,o,!1),r=this.applicationContentMap[i])}return r?r.selected:t.observable(!1)},c.prototype.customizeFavoriteName=function(e,t){return e.customName(t),this.lu([e])},c.prototype.getIndexOfFavorite=function(e){var t=this.cu(e);return t?t.index:void 0},c.prototype.reorderFavorite=function(e,t,o){var r=this.cu(e);if(!r)return Promise.reject("FavoritesContent.reorderFavorite: No favorite found with matching favoriteId.");var i=r.favorite,n=r.container,a=r.index,s=this.favorites,c=i.parentFavItemId?i.parentFavItemId:void 0,u=o||void 0;if(u){var v=this.cu(u);if(!v)return Promise.reject("FavoritesContent.reorderFavorite: No favorite found with matching toParentId.");s=v.favorite.children}return u===c&&a<t?t--:i.parentFavItemId=u,u!==c||a!==t?(n.splice(a,1),s.splice(t,0,i),this.mu(s())):Promise.resolve()},c.prototype.saveCurrentOrder=function(){var e=this;this.favoritesReady.then((function(){e.revertPoint=e.Fu(e.favorites())}))},c.prototype.Fu=function(e){return e.map((function(e){var t={refItemId:e.contentId,title:e.contentTitle,favoriteType:e.favoriteType,objectId:e.objectId,favoriteContext:e.favoriteContext,seededFavItemId:e.seededFavItemId,localPinSequenceNumber:e.localPinSequence(),globalPinSequenceNumber:e.globalPinSequence(),customName:e.customName()};return e.isFolder&&(t.children=this.Fu(e.children())),t}),this)},c.prototype.revertOrder=function(){var t=this;return this.favoritesReady.then((function(){return i.startProcessingIndicator(),t.favoritesService.replaceFavorites(t.revertPoint).then((function(){t.pinnedFavoritesState.removeAllPins(t.favorites(),t.favoriteHandlerKey),t.loadFavorites(),i.stopProcessingIndicator()}),(function(t){e.Logger.warn("FavoritesContent.revertOrder: error reverting favorites: ",t),i.stopProcessingIndicator()}))}))},c.prototype.mu=function(e){for(var t=0;t<e.length;t++)e[t].sequenceNumber=t+1;return this.lu(e)},c.prototype.pinFavorite=function(e){var t=this.lookupFavoriteById(e);return this.pinnedFavoritesState.pinFavorite(t,this.favoriteHandlerKey)?this.lu([t]):Promise.resolve()},c.prototype.unpinFavorite=function(e){var t=this.lookupFavoriteById(e);return this.pinnedFavoritesState.unpinFavorite(t,this.favoriteHandlerKey)?this.lu([t]):Promise.resolve()},c.prototype.lu=function(t){var o=[];return t.forEach((function(e){var t={favItemId:e.entryId,applicationCode:e.appCode,sequenceNumber:e.sequenceNumber,seededFavItemId:e.seededFavItemId,localPinSequenceNumber:e.localPinSequence(),globalPinSequenceNumber:e.globalPinSequence(),objectId:e.objectId,favoriteContext:e.favoriteContext,customName:e.customName(),parentFavItemId:e.parentFavItemId};o.push(t)})),i.startProcessingIndicator(),this.favoritesService.updateFavorites(o).then((function(){i.stopProcessingIndicator()}),(function(t){i.stopProcessingIndicator(),e.Logger.warn("FavoritesContent._updateFavorites: Error updating favorites: ",t)}))},c.prototype.importFavorites=function(){var t=this;return i.startProcessingIndicator(),this.favoritesService.importSeededFavorites().then((function(){t.pinnedFavoritesState.removeAllPins(t.favorites(),t.favoriteHandlerKey),t.loadFavorites(),i.stopProcessingIndicator()}),(function(t){e.Logger.warn("FavoritesContent.importFavorites: error importing favorites: ",t),i.stopProcessingIndicator()}))},c.getInstance=function(e,t){var i=s.isObjectStrict(e)?e:r.getFavoritesService(),n=o.App.getUserData().userid;n!==c.We&&(c.Qe={},c.We=n);var a=i.getServiceConfiguration(),u=c.Iu(a);return c.Qe[u]instanceof c||(c.Qe[u]=new c(i,t)),c.Qe[u]},c.Iu=function(e){return e.baseUri+"|"+e.appCode},c.prototype.reorderPinnedFavorite=function(e,t,o){var r=[];return this.pinnedFavoritesState.reorderPinnedFavorite(e,this.favoriteHandlerKey,t,r,o)?this.lu(r):Promise.resolve()},c.prototype.whenReady=function(){return this.favoritesReady},c}));