define(["ojs/ojcore","jquery","knockout","jraf/jrafcore","jraf/models/Content","jraf/utils/ValidationUtils"],(function(e,t,o,a,n,l){"use strict";function r(e){if(!l.isObjectStrict(e)||!l.isNonemptyString(e.modalPageContainerId))throw new TypeError("ModalPageManager: Missing required parameters");this._modalPageContainerId=e.modalPageContainerId,this._beforeLoadModuleHandler=e.beforeLoadModuleHandler,this._afterUnloadModuleHandler=e.afterUnloadModuleHandler,this._modalPageRefs=[]}return r.prototype.openContent=function(e){if(!(e instanceof n))throw new TypeError("ModalPageManager.openContent: Invalid content passed");t("#"+this._modalPageContainerId).addClass("jraf-modal-page-container");var a=this._getModalPageViewModel(e),l=a.id,r=this._getModalPageElement(l,e.isFillContentArea());return this._modalPageRefs.push({id:l,viewModel:a,element:r,closing:!1}),document.getElementById(this._modalPageContainerId).appendChild(r),o.applyBindings(a,document.getElementById(l)),this._openWhenReady(l)},r.prototype._openWhenReady=function(t){return e.Context.getContext(document.getElementById(t)).getBusyContext().whenReady().then((function(){return document.getElementById(t).open()}))},r.prototype._getModalPageViewModel=function(e){var t=this;return{id:a.UIShell.generateUniqueId(),title:e.getTargetTitle(),moduleBinding:this._getModuleBinding(e),moduleOptions:this._getModuleOptions(e),handleBeforeClose:function(e,o){return t._handleBeforeClose(e,o)},handleClose:function(e,o){return t._handleClose(e,o)},handleBeforeLoadModule:this._beforeLoadModuleHandler,handleAfterUnloadModule:this._afterUnloadModuleHandler}},r.prototype._getModuleBinding=function(e){if(!e.hasModuleOptions()){var o=e.getModuleBinding();return t.extend(!0,{},o,{params:{jraf:{modalPageManager:this}}})}},r.prototype._getModuleOptions=function(e){if(e.hasModuleOptions()){var o=e.getModuleOptions();return t.extend(!0,{},o,{params:{jraf:{modalPageManager:this}}})}},r.prototype._getModalPageElement=function(e,t){var o=document.createElement("oj-rgbu-jraf-modal-page");return o.setAttribute("id",e),o.setAttribute("page-title","[[title]]"),o.setAttribute("page-content-module","[[moduleBinding]]"),o.setAttribute("page-content-module-options","[[moduleOptions]]"),o.setAttribute("on-oj-rgbu-jraf-modal-page-before-close","[[handleBeforeClose]]"),o.setAttribute("on-oj-rgbu-jraf-modal-page-close","[[handleClose]]"),o.setAttribute("before-load-module-handler","[[handleBeforeLoadModule]]"),o.setAttribute("after-unload-module-handler","[[handleAfterUnloadModule]]"),o.setAttribute("data-oj-context",""),t&&o.setAttribute("body-class","jraf-modal-page-fill-content-area"),o},r.prototype.closeContent=function(){var e=this._getDisclosedModalPageRef();if(null===e)throw new Error("ModalPageManager.closeContent: No modal pages to close.");return this._closeModalPage(e)},r.prototype._getDisclosedModalPageRef=function(){for(var e=null,t=this._modalPageRefs.length;t>0;t--){var o=this._modalPageRefs[t-1];if(!o.closing){e=o;break}}return e},r.prototype._closeModalPage=function(t){var o=t.id;return e.Logger.info("ModalPageManager._closeModalPage: Closing modal page %s.",o),t.closing=!0,document.getElementById(o).close()},r.prototype._getModalPageRefById=function(e){var t=this._modalPageRefs.filter((function(t){return t.id===e}));return 1===t.length?t[0]:null},r.prototype._handleBeforeClose=function(t,o){var a=t.target.id;return e.Logger.info("ModalPageManager._handleBeforeClose: Handling modal page beforeClose event (%s).",a),!1!==this._invokeCallback("uiShellBeforeClose",t,o,a)||(this._getModalPageRefById(a).closing=!1,t.preventDefault(),!1)},r.prototype._handleClose=function(t,o){var a=t.target.id;e.Logger.info("ModalPageManager._handleClose: Handling modal page close event (%s).",a),this._invokeCallback("uiShellClose",t,o,a);var n=this;e.Context.getContext(document.getElementById(a)).getBusyContext().whenReady().then((function(){n._cleanupModalPage(a)}))},r.prototype._cleanupModalPage=function(t){e.Logger.info("ModalPageManager._cleanupModalPage: Cleaning up %s.",t),o.removeNode(document.getElementById(t)),this._cleanupModalPageState(t)},r.prototype._cleanupModalPageState=function(t){for(var o=-1,a=0;a<this._modalPageRefs.length;a++){if(this._modalPageRefs[a].id===t){o=a;break}}-1!==o?this._modalPageRefs.splice(o,1):e.Logger.warn("ModalPageManager._cleanupModalPageState: Did not find state for modal page %s.",t)},r.prototype.dispose=function(){var e=this;t("#"+this._modalPageContainerId).children().each((function(t,o){e._cleanupModalPage(o.id)}))},r.prototype._invokeCallback=function(e,t,o,a){return document.getElementById(a).invokeModuleEventHandler(e,t,o)},r.prototype.handleBeforeCloseAll=function(t,o){for(var a=this._modalPageRefs.length-1;a>=0;a--){var n=this._modalPageRefs[a].id;if(e.Logger.info("ModalPageManager.handleBeforeCloseAll: Handling modal page beforeClose event (%s).",n),!1===this._invokeCallback("uiShellBeforeClose",t,o,n))return!1}return!0},r}));