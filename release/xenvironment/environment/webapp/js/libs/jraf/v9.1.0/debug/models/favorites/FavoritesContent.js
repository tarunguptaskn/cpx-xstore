define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/services/ServiceManager","jraf/models/UIShellManager","jraf/models/MenuContents","jraf/models/favorites/PinnedFavoritesState","jraf/utils/ValidationUtils"],(function(e,t,o,r,i,n,a,s){"use strict";function c(e,o){if(!e)throw new Error("FavoritesContent: missing favoritesService parameter");var r=this;this.favoriteHandlerKey=o,this.favorites=t.observableArray([]),this.revertPoint=[],this.favoritesService=e,this.pinnedFavoritesState=a.getInstance(),this.hasSeededFavorites=t.observable(!1),this.favoritesContentLoaded=t.observable(!1),this._initializeSelectionTracking(),this.hasFolders=t.pureComputed((function(){var e=r._findMatchingFavorite(r.favorites,(function(e){return e.isFolder}));return Boolean(e)})),this.favoritesReady=this.loadFavorites(!0)}return c._instances={},c._currentUser=null,c.FAVORITE_TYPE_FOLDER="folder",c.prototype._initializeSelectionTracking=function(){this.trackingSelection=this.favoritesService===r.getFavoritesService(),this.trackingSelection&&(this.applicationContentMap={},this._loadContentMap())},c.prototype._loadContentMap=function(){var t=this;this._menuContents=n.getInstance(),this._menusLoadedPromise=this._menuContents.getContentLeaves().then((function(e){t._buildContentMap(e)}),(function(t){e.Logger.warn("UIShellFavoritesMenu._loadContentMap: Content did not load successfully: ",t)}))},c.prototype._buildContentMap=function(e){for(var o in e)this.applicationContentMap[o]={content:e[o],selected:t.observable(!1)}},c.prototype.loadFavorites=function(e){var t=this;this.favoritesContentLoaded(!1),i.startProcessingIndicator();var o=[this.favoritesService.loadFavorites()],r=this._initSeedCount();return o.push(r),this.trackingSelection&&o.push(this._menusLoadedPromise),Promise.all(o).then((function(o){t._handleSuccessfulFavoritesLoad(o[0],o[1],e)}),(function(e){t._handleFailedFavoritesLoad(e)}))},c.prototype.getFavoritesContentLoaded=function(){var e=this;return t.pureComputed((function(){return e.favoritesContentLoaded()}))},c.prototype._initSeedCount=function(){return this.gettingSeedCountPromise||(this.gettingSeedCountPromise=this.favoritesService.getSeededFavoritesCount()),this.gettingSeedCountPromise},c.prototype._handleSuccessfulFavoritesLoad=function(t,o,r){e.Logger.info("UIShellFavoritesMenu._handleSuccessfulFavoritesLoad: Data successfully loaded."),this._parseFavoritesData(t),s.isNumberStrict(o)&&o>0&&this.hasSeededFavorites(!0),i.stopProcessingIndicator(),r&&0===this.favorites().length&&this.hasSeededFavorites()?this.importFavorites():this.favoritesContentLoaded(!0)},c.prototype._parseFavoritesData=function(e){this._clearAllSelections();var t=[];this._parseFavoritesDataForContainer(e,t),this.favorites(t),this._updatePinnedFavoritesState(this.favorites())},c.prototype._parseFavoritesDataForContainer=function(e,o){e.filter((function(e){return!this.trackingSelection||(e.favoriteType===c.FAVORITE_TYPE_FOLDER||this.applicationContentMap[e.refItemId])}),this).forEach((function(e){var r={entryId:e.favItemId,userId:e.userId,contentId:e.refItemId,contentTitle:e.title,appCode:e.applicationCode,sequenceNumber:e.sequenceNumber,favoriteType:e.favoriteType,objectId:e.objectId,favoriteContext:e.favoriteContext,seededFavItemId:e.seededFavItemId,localPinSequence:t.observable(e.localPinSequenceNumber),globalPinSequence:t.observable(e.globalPinSequenceNumber),customName:t.observable(e.customName),parentFavItemId:e.parentFavItemId};r.isFolder=e.favoriteType===c.FAVORITE_TYPE_FOLDER,r.isFolder?r.children=this._parseChildFavorites(e.children):(r.isPinned=this.pinnedFavoritesState.getPinnedObservable(r),this._updateSelection(e.refItemId,e.objectId,!0)),o.push(r)}),this)},c.prototype._parseChildFavorites=function(e){var o=[];return s.isArray(e)&&this._parseFavoritesDataForContainer(e,o),t.observableArray(o)},c.prototype._updatePinnedFavoritesState=function(e){for(var t=0;t<e.length;t++)e[t].isFolder?this._updatePinnedFavoritesState(e[t].children()):this.pinnedFavoritesState.updateState(e[t],this.favoriteHandlerKey)},c.prototype._clearAllSelections=function(){if(this.trackingSelection)for(var e in this.applicationContentMap)this.applicationContentMap[e].selected(!1)},c.prototype._updateSelection=function(e,o,r){if(this.trackingSelection&&this.applicationContentMap.hasOwnProperty(e)){var i=this._getContentKey(e,o);this.applicationContentMap.hasOwnProperty(i)||(this.applicationContentMap[i]={selected:t.observable(!1)}),this.applicationContentMap[i].selected(r)}},c.prototype._getContentKey=function(e,t){return s.isNonemptyString(t)?e+"|"+t:e},c.prototype._handleFailedFavoritesLoad=function(t){e.Logger.warn("UIShellFavoritesMenu._handleFailedFavoritesLoad: Failed loading favorites (%s)",t),i.stopProcessingIndicator()},c.prototype.getFavorites=function(){return this.favorites},c.prototype.getHasSeededFavoritesObservable=function(){var e=this;return t.pureComputed((function(){return e.hasSeededFavorites()}))},c.prototype.getHasFoldersObservable=function(){return this.hasFolders},c.prototype.addFavorite=function(e,t,o,r,n){var a=this;if(o!==c.FAVORITE_TYPE_FOLDER){if(!this.getContent(e))return Promise.reject("FavoritesContent.addFavorite: no content exists with contentId: "+e);if(!0===this.trackFavoriteState(e,r)())return Promise.reject("FavoritesContent.addFavorite: favorite exists already.")}return i.startProcessingIndicator(),new Promise((function(s,c){a.favoritesService.addFavorite(e,t,o,r,n).then((function(){a.loadFavorites(),i.stopProcessingIndicator(),s()}),(function(){i.stopProcessingIndicator(),c()}))}))},c.prototype.addFolder=function(e,t){return this.addFavorite(null,e,"folder")},c.prototype.getContent=function(e){if(this.trackingSelection&&this.applicationContentMap.hasOwnProperty(e))return this.applicationContentMap[e].content},c.prototype.removeFavorite=function(e,t){var o=this._lookupFavoriteByContentId(e,t);return this._removeFavorite(o)},c.prototype.removeFavoriteById=function(e){var t=this._lookupFavoriteById(e);return this._removeFavorite(t)},c.prototype._removeFavorite=function(t){var o=this;return new Promise((function(r,n){if(t){i.startProcessingIndicator();var a=t.favorite;o.favoritesService.deleteFavorite(a.entryId).then((function(){o._unpinNestedFavorites(a),t.container.splice(t.index,1),o._updateNestedSelection(a),i.stopProcessingIndicator(),r()}),(function(){i.stopProcessingIndicator(),n()}))}else e.Logger.warn("FavoritesContent.removeFavorite: Did not find specified favorite to remove"),n()}))},c.prototype._unpinNestedFavorites=function(e){var t=this;e.isFolder?e.children().forEach((function(e){t._unpinNestedFavorites(e)})):this.pinnedFavoritesState.unpinFavorite(e,this.favoriteHandlerKey)},c.prototype._updateNestedSelection=function(e){var t=this;e.isFolder?e.children().forEach((function(e){t._updateNestedSelection(e)})):this._updateSelection(e.contentId,e.objectId,!1)},c.prototype.lookupFavoriteById=function(e){var t=this._lookupFavoriteById(e);return t?t.favorite:void 0},c.prototype._lookupFavoriteById=function(e){return this._findMatchingFavorite(this.favorites,(function(t){return t.entryId===e}))},c.prototype._lookupFavoriteByContentId=function(e,t){var o=!s.isNonemptyString(t);return this._findMatchingFavorite(this.favorites,(function(r){return r.contentId===e&&(o&&!r.objectId||r.objectId===t)}))},c.prototype._findMatchingFavorite=function(e,t){for(var o=0;o<e().length;o++){if(t(e()[o]))return{favorite:e()[o],container:e,index:o};if(e()[o].isFolder){var r=this._findMatchingFavorite(e()[o].children,t);if(r)return r}}},c.prototype.trackFavoriteState=function(e,o){var r;if(this.trackingSelection){var i=this._getContentKey(e,o);!(r=this.applicationContentMap[i])&&s.isNonemptyString(o)&&(this._updateSelection(e,o,!1),r=this.applicationContentMap[i])}return r?r.selected:t.observable(!1)},c.prototype.customizeFavoriteName=function(e,t){return e.customName(t),this._updateFavorites([e])},c.prototype.getIndexOfFavorite=function(e){var t=this._lookupFavoriteById(e);return t?t.index:void 0},c.prototype.reorderFavorite=function(e,t,o){var r=this._lookupFavoriteById(e);if(!r)return Promise.reject("FavoritesContent.reorderFavorite: No favorite found with matching favoriteId.");var i=r.favorite,n=r.container,a=r.index,s=this.favorites,c=i.parentFavItemId?i.parentFavItemId:void 0,d=o||void 0;if(d){var v=this._lookupFavoriteById(d);if(!v)return Promise.reject("FavoritesContent.reorderFavorite: No favorite found with matching toParentId.");s=v.favorite.children}return d===c&&a<t?t--:i.parentFavItemId=d,d!==c||a!==t?(n.splice(a,1),s.splice(t,0,i),this._setFavoritesOrder(s())):Promise.resolve()},c.prototype.saveCurrentOrder=function(){var e=this;this.favoritesReady.then((function(){e.revertPoint=e._getCurrentOrder(e.favorites())}))},c.prototype._getCurrentOrder=function(e){return e.map((function(e){var t={refItemId:e.contentId,title:e.contentTitle,favoriteType:e.favoriteType,objectId:e.objectId,favoriteContext:e.favoriteContext,seededFavItemId:e.seededFavItemId,localPinSequenceNumber:e.localPinSequence(),globalPinSequenceNumber:e.globalPinSequence(),customName:e.customName()};return e.isFolder&&(t.children=this._getCurrentOrder(e.children())),t}),this)},c.prototype.revertOrder=function(){var t=this;return this.favoritesReady.then((function(){return i.startProcessingIndicator(),t.favoritesService.replaceFavorites(t.revertPoint).then((function(){t.pinnedFavoritesState.removeAllPins(t.favorites(),t.favoriteHandlerKey),t.loadFavorites(),i.stopProcessingIndicator()}),(function(t){e.Logger.warn("FavoritesContent.revertOrder: error reverting favorites: ",t),i.stopProcessingIndicator()}))}))},c.prototype._setFavoritesOrder=function(e){for(var t=0;t<e.length;t++)e[t].sequenceNumber=t+1;return this._updateFavorites(e)},c.prototype.pinFavorite=function(e){var t=this.lookupFavoriteById(e);return this.pinnedFavoritesState.pinFavorite(t,this.favoriteHandlerKey)?this._updateFavorites([t]):Promise.resolve()},c.prototype.unpinFavorite=function(e){var t=this.lookupFavoriteById(e);return this.pinnedFavoritesState.unpinFavorite(t,this.favoriteHandlerKey)?this._updateFavorites([t]):Promise.resolve()},c.prototype._updateFavorites=function(t){var o=[];return t.forEach((function(e){var t={favItemId:e.entryId,applicationCode:e.appCode,sequenceNumber:e.sequenceNumber,seededFavItemId:e.seededFavItemId,localPinSequenceNumber:e.localPinSequence(),globalPinSequenceNumber:e.globalPinSequence(),objectId:e.objectId,favoriteContext:e.favoriteContext,customName:e.customName(),parentFavItemId:e.parentFavItemId};o.push(t)})),i.startProcessingIndicator(),this.favoritesService.updateFavorites(o).then((function(){i.stopProcessingIndicator()}),(function(t){i.stopProcessingIndicator(),e.Logger.warn("FavoritesContent._updateFavorites: Error updating favorites: ",t)}))},c.prototype.importFavorites=function(){var t=this;return i.startProcessingIndicator(),this.favoritesService.importSeededFavorites().then((function(){t.pinnedFavoritesState.removeAllPins(t.favorites(),t.favoriteHandlerKey),t.loadFavorites(),i.stopProcessingIndicator()}),(function(t){e.Logger.warn("FavoritesContent.importFavorites: error importing favorites: ",t),i.stopProcessingIndicator()}))},c.getInstance=function(e,t){var i=s.isObjectStrict(e)?e:r.getFavoritesService(),n=o.App.getUserData().userid;n!==c._currentUser&&(c._instances={},c._currentUser=n);var a=i.getServiceConfiguration(),d=c._getInstanceKey(a);return c._instances[d]instanceof c||(c._instances[d]=new c(i,t)),c._instances[d]},c._getInstanceKey=function(e){return e.baseUri+"|"+e.appCode},c.prototype.reorderPinnedFavorite=function(e,t,o){var r=[];return this.pinnedFavoritesState.reorderPinnedFavorite(e,this.favoriteHandlerKey,t,r,o)?this._updateFavorites(r):Promise.resolve()},c.prototype.whenReady=function(){return this.favoritesReady},c}));