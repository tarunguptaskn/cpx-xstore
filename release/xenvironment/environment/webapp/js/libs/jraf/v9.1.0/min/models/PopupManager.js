define(["ojs/ojcore","knockout","jquery","ojs/ojdialog"],(function(e,t,o){"use strict";function n(e){if("object"!=typeof e||null===e||"string"!=typeof e.popupComponentId||0!==e.popupComponentId.indexOf("#")||"string"!=typeof e.popupAppsModuleId)throw new Error("PopupManager: invalid popup configuration.");this.dialogComponentId=e.popupComponentId,this.popupAppsModuleId=e.popupAppsModuleId,this.popupOpen=t.observable(!1),this.popupProperties=t.observable(null),this.moduleBinding=t.observable(null),this.readOnlyModuleBinding=t.pureComputed((function(){return this.moduleBinding()}),this),this.moduleOptions=t.observable(null),this.readOnlyModuleOptions=t.pureComputed((function(){return this.moduleOptions()}),this)}return n.prototype.tf=function(e,t){this.nf(e)&&this.popupOpen(!0)},n.prototype.if=function(e,t){if(this.nf(e))return this.bl("uiShellBeforeClose",e,t)},n.prototype.rf=function(e,t){if(this.nf(e)){this.popupOpen(!1);var o=this.bl("uiShellClose",e,t);return this.ef&&this.ef.resolve(),this.moduleBinding(null),this.moduleOptions(null),document.querySelector(".jraf-global-popup-footer").innerHTML="",o}},n.prototype.nf=function(e){return e.target===document.querySelector(this.dialogComponentId)},n.uf=function(e){return e.targetProperties.resizable?"resizable":"none"},n.sf=function(e){return e.targetProperties.showCloseIcon?"icon":"escape"},n.ff=function(e){var t=e.targetProperties.width,o=e.targetProperties.height,n={minWidth:"250px",minHeight:"250px"};return n.width=t,n.height=o,n},n.prototype.getModuleBinding=function(){return this.readOnlyModuleBinding},n.prototype.getModuleOptions=function(){return this.readOnlyModuleOptions},n.prototype.getAfterLoadModuleHandler=function(){var e=this;return function(t,o){return e.hf(t,o)}},n.prototype.hf=function(e,t){return this.cf(t.view),Promise.resolve(t)},n.prototype.cf=function(e){var t=this.lf(e);t&&this.af(t)},n.prototype.lf=function(e){for(var t=null,o=0;o<e.length;o++){var n=e[o];if(n&&1===n.nodeType){t=n;break}}return t},n.prototype.getTransitionEndHandler=function(){var e=this;return function(t){return e.pf(t)}},n.prototype.pf=function(e){this.df(e.target.childNodes),this.vf()},n.prototype.df=function(e){var t=null;Array.prototype.forEach.call(e,(function(e){!t&&1===e.nodeType&&o(e).hasClass("oj-dialog-footer")&&(t=e)})),this.gf(t)},n.prototype.jf=function(e){var t=this;return{title:e.getTargetTitle(),modality:"modal",initialVisibility:"hide",resizeBehavior:n.uf(e),cancelBehavior:n.sf(e),style:n.ff(e),onOjOpen:function(e,o){t.tf(e,o)},onOjBeforeClose:function(e,o){return t.if(e,o)},onOjClose:function(e,o){return t.rf(e,o)}}},n.prototype.mf=function(t){var o=this,n=t.getModuleBinding();return"object"==typeof n.lifecycleListener&&null!==n.lifecycleListener&&e.Logger.warn("PopupManager._constructModuleBinding: Modules lifecycleListener is being overwritten."),n.lifecycleListener={attached:function(e){o.bf(e)},bindingsApplied:function(e){o.yf(e,t)}},n},n.prototype.bf=function(e){for(var o=null,n=e.element,i=t.virtualElements.firstChild(n);i;){if(1===i.nodeType){o=i;break}i=t.virtualElements.nextSibling(i)}o&&this.af(o)},n.prototype.af=function(e){var t=o(e);t.hasClass("oj-dialog-body")&&"div"===t.prop("tagName").toLowerCase()&&t.removeClass("oj-dialog-body")},n.prototype.yf=function(e,t){this.wf(e),this.kf(t),this.vf()},n.prototype.wf=function(e){for(var n=e.element,i=null,r=t.virtualElements.firstChild(n);r;){if(1===r.nodeType&&o(r).hasClass("oj-dialog-footer")){i=r;break}r=t.virtualElements.nextSibling(r)}this.gf(i)},n.prototype.gf=function(t){t&&(o(t).removeClass("oj-dialog-footer"),e.Components.subtreeDetached(t),document.querySelector(".jraf-global-popup-footer").appendChild(t),e.Components.subtreeAttached(t))},n.prototype.openContent=function(e){if(this.popupOpen())throw new Error("A popup is already open. Close the other popup first.");if(e.hasModuleOptions()){this.kf(e);var t=e.getModuleOptions();this.moduleOptions(t)}else{var o=this.mf(e);this.moduleBinding(o)}},n.prototype.bl=function(e,t,o){return document.getElementById(this.popupAppsModuleId).invokeModuleEventHandler(e,t,o)},n.prototype.kf=function(e){var t=this.jf(e),o=document.querySelector(this.dialogComponentId);o.title=t.title,o.modality=t.modality,o.initialVisibility=t.initialVisibility,o.resizeBehavior=t.resizeBehavior,o.cancelBehavior=t.cancelBehavior,o.onOjOpen=t.onOjOpen,o.onOjBeforeClose=t.onOjBeforeClose,o.onOjClose=t.onOjClose,Object.keys(t.style).forEach((function(e){o.style[e]=t.style[e]}))},n.prototype.vf=function(){document.querySelector(this.dialogComponentId).open()},n.prototype.closeContent=function(){var e=this;return this.popupOpen()?(document.querySelector(this.dialogComponentId).close(),this.ef=new o.Deferred,new Promise((function(t){e.ef.then(t)}))):Promise.resolve()},n}));