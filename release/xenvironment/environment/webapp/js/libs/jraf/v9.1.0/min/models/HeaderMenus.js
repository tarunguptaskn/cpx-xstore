define(["jquery","knockout","ojs/ojcore","jraf/jrafcore","jraf/controllers/ThemeManager","jraf/controllers/LayoutManager","jraf/models/UIShellManager","jraf/utils/ValidationUtils","jraf/utils/RouterUtils"],(function(a,e,t,i,s,r,n,o,l){"use strict";var h=t.Translations.getTranslatedString;function u(a){this.ea={},this.aa=i.UIShell.generateUniqueId(),this.ha=i.UIShell.generateUniqueId(),this.la=i.UIShell.generateUniqueId(),this.oa=i.UIShell.generateUniqueId(),this.ua=h("jraf.global.preferences"),this.da=h("jraf.global.userMenuLogOutLabel"),this.fa=h("jraf.global.help"),this.ca=h("jraf.global.about"),this.ba=h("jraf.global.defaultUser"),this.ja(a)}return u.prototype.ja=function(a){o.isObjectStrict(a)&&(this.va=a.preferencesCallback,this.ga=a.preferencesMenuConfig,this.pa=a.customMenuConfig,this.ma=a.logoutCallback,this.Ma=a.applicationHelpCallback,this.ka=a.helpMenuConfig,this.Ia=a.aboutCallback,this.Ua=a.userDataCallback),this.La(),this.Ta(),this.ya(),this.wa(),this.Da()},u.prototype.wa=function(){var a=this,e=o.isFunction(this.va)||o.isArray(this.ga),t=o.isFunction(this.ma);if(this.Na=[],e){var s={rendered:e,id:this.aa,label:this.ua,jrafTestId:"global-header-user-menu-preferences-option"};this.va&&(s.callback=this.va,this.ea[this.aa]=s),this.ga&&(s.children=this._a(this.ga,s.id)),this.Na.push(s)}if(this.Na.push({rendered:this.Ha,id:this.Sa,label:this.Fa,children:this.qa,jrafTestId:"global-header-user-menu-layout-option"}),this.Na.push({rendered:this.Aa,id:this.Ca,label:this.Oa,children:this.Ra,jrafTestId:"global-header-user-menu-theme-option"}),o.isArray(this.pa)&&this.pa.forEach((function(e){var t={rendered:!0,label:h(e.label),callback:e.callback,id:i.UIShell.generateUniqueId(),classNameMap:a.Va(e.className)};this.Na.push(t),this.ea[t.id]=t}),this),t){var r={rendered:t,id:this.ha,label:this.da,callback:this.ma,jrafTestId:"global-header-user-menu-logout-option"};this.Na.push({rendered:!0,id:i.UIShell.generateUniqueId()}),this.Na.push(r),this.ea[this.ha]=r}},u.prototype.getUserMenu=function(){return this.Na},u.prototype.La=function(){this.Ca=i.UIShell.generateUniqueId(),this.Oa=h("jraf.global.themeMenuLabel");var a=s.getInstance();if(this.Aa=a.isUserConfigurable()(),this.Aa){var e=a.getAvailableThemes(),t=a.getTheme();this.Ra=this._a(e,this.Ca,t,(function(e){a.setTheme(e.modelId)}))}},u.prototype.Ta=function(){this.Sa=i.UIShell.generateUniqueId(),this.Fa=h("jraf.global.layoutMenuLabel");var a=r.getInstance();if(this.Ha=a.isLayoutConfigurable(),this.Ha){var e=a.getLayouts(),t=a.getActiveLayout();this.qa=this._a(e,this.Sa,t,(function(e){a.setActiveLayout(e.modelId)}))}},u.prototype._a=function(a,t,i,s){var r=this;return a.map((function(a,n){var o=a.id,l={modelId:o,id:t+"-"+n,label:h(a.label),selected:!1,callback:s||a.callback,rendered:!0,classNameMap:r.Va(a.className)};return e.isObservable(i)&&(l.selected=e.pureComputed((function(){return i()===o}))),r.ea[l.id]=l}))},u.prototype.Va=function(a){var e={};return o.isNonemptyString(a)&&(e=a.split(" ").reduce((function(a,e){return a[e]=!0,a}),{})),e},u.prototype.ya=function(){var a=this;if(this.xa=e.observable(""),this.za=e.observable(""),!o.isFunction(this.Ua))return t.Logger.info("HeaderMenus._loadUserData: No userDataCallback provided. Using defaults."),void this.Ba();var s=i.App.getUserData();if(!o.isObjectStrict(s))return n.startProcessingIndicator(),this.Ua().then((function(e){a.Ea(e)})).catch((function(){a.Ga()}));this.Ea(s)},u.prototype.Ea=function(a){t.Logger.info("HeaderMenus._handleSuccessfulUserDataLoad: Successfully loaded user data.");var e=o.isNonemptyString(a.displayName)?a.displayName:a.userid;this.xa(e),this.Ja(a.avatar),n.stopProcessingIndicator()},u.prototype.Ga=function(){n.stopProcessingIndicator(),t.Logger.warn("HeaderMenus._handleFailedUserDataLoad: Failed to load user data."),this.Ba()},u.prototype.Ja=function(e){var t=a("body").hasClass("oj-hicontrast");o.isNonemptyString(e)&&!t?this.za("data:image/jpeg;base64,"+e):this.za("")},u.prototype.Ba=function(){this.xa(this.ba),this.za("")},u.prototype.getUserData=function(){return{username:this.xa,avatar:this.za}},u.prototype.Da=function(){var a=this,e=this.Ia;if(!o.isFunction(e)){var t=this.Ka();e=function(){window.open(t,"_blank")}}var s=o.isFunction(this.Ma);this.Pa=[],s&&this.Pa.push({rendered:!0,id:this.la,label:this.fa,callback:this.Ma,jrafTestId:"global-header-help-menu-help-option"}),this.Pa.push({rendered:!0,id:this.oa,label:this.ca,callback:e,jrafTestId:"global-header-help-menu-about-option"}),o.isArray(this.ka)&&this.ka.forEach((function(e){var t={rendered:!0,label:h(e.label),callback:e.callback,id:i.UIShell.generateUniqueId(),classNameMap:a.Va(e.className)};this.Pa.push(t),this.ea[t.id]=t}),this),this.Pa.forEach((function(a){this.ea[a.id]=a}),this)},u.prototype.getHelpMenu=function(){return this.Pa},u.prototype.Ka=function(){return window.location.href.split("?",1)[0]+"?"+l.getRootRouterName()+"=About"},u.prototype.handleMenuItemSelection=function(a){var e=this.ea[a];e.callback&&e.callback(e)},u.prototype.isMenuLeaf=function(a){return o.isObjectStrict(this.ea[a])},u}));