define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/utils/ValidationUtils","jraf/utils/KeyboardUtils","jraf/models/components/MultipleSortDataSource","jraf/models/UIShellManager","ojs/ojknockout","jraf/utils/CustomBindings","ojs/ojcomponentcore","ojs/ojdatagrid","ojs/ojcollectiondatagriddatasource","ojs/ojarraydatagriddatasource","ojs/ojselectcombobox","ojs/ojbutton","ojs/ojmenu","ojs/ojtoolbar","ojs/ojdialog","ojs/ojradioset","ojs/ojpagingdatagriddatasource","ojs/ojpagingcontrol","ojs/ojvalidation-datetime","ojs/ojconveyorbelt"],(function(e,t,a,o,i,n,r,l){"use strict";c.DATA_TYPE_STRING="string",c.DATA_TYPE_ICON="icon",c.DATA_TYPE_DATE="date",c.DATA_TYPE_CUSTOM="custom",c.CREATE_PATTERN="create",c.ADD_PATTERN="add",c.DEFAULT_CREATE_ICON="jraf-create-icon",c.DEFAULT_ADD_ICON="jraf-add-icon",c.DEFAULT_DUPLICATE_ICON="jraf-duplicate-icon",c.DEFAULT_EDIT_ICON="jraf-edit-icon",c.DEFAULT_VIEW_ICON="jraf-view-icon",c.DEFAULT_DELETE_ICON="jraf-delete-icon",c.DEFAULT_ROW_HEADER_CLASS="jraf-appTable-default-row-header",c.SORTS_LIMIT=3;var s=e.Translations.getTranslatedString;function c(a){var n=this;if(!(i.isObjectStrict(a)&&a.collection instanceof e.Collection&&i.isArray(a.columns)&&i.isNonemptyString(t.unwrap(a.label))&&i.isFunction(a.handleRefresh)))throw new TypeError("AppTable: Invalid parameters");var l=a.createPatternType===c.ADD_PATTERN;this.createPattern=l?c.ADD_PATTERN:c.CREATE_PATTERN,this.cellTemplateId=o.UIShell.generateUniqueId(),this.wrapperId=o.UIShell.generateUniqueId(),this.actionMenuId=o.UIShell.generateUniqueId(),this.viewMenuId=o.UIShell.generateUniqueId(),this.detachButtonId=o.UIShell.generateUniqueId(),this.detachDialogId=o.UIShell.generateUniqueId(),this.dataGridId=o.UIShell.generateUniqueId(),this.toolbarId=o.UIShell.generateUniqueId(),this.sortDialogId=o.UIShell.generateUniqueId(),this.sortFormId=o.UIShell.generateUniqueId(),this.tableHeaderTemplateId=o.UIShell.generateUniqueId(),this.appTableId=o.UIShell.generateUniqueId(),this.pagingControlId=o.UIShell.generateUniqueId(),this.dialogAnchorId=o.UIShell.generateUniqueId(),this.actionMenuLabel=s("jraf.appTable.actionMenuLabel"),this.viewMenuLabel=s("jraf.appTable.viewMenuLabel"),this.sortMenuLabel=s("jraf.appTable.sortLabel"),this.queryMenuLabel=s("jraf.appTable.queryLabel"),this.attachButtonLabel=s("jraf.appTable.attachLabel"),this.detachButtonLabel=s("jraf.appTable.detachLabel"),this.createButtonLabel=s(l?"jraf.appTable.addLabel":"jraf.appTable.createLabel"),this.duplicateButtonLabel=s("jraf.appTable.duplicateLabel"),this.editButtonLabel=s("jraf.appTable.editLabel"),this.viewButtonLabel=s("jraf.appTable.viewLabel"),this.deleteButtonLabel=s("jraf.appTable.deleteLabel"),this.refreshButtonLabel=s("jraf.appTable.refreshLabel"),this.exportButtonLabel=s("jraf.appTable.exportLabel"),this.ascendingLabel=s("jraf.appTable.ascending"),this.descendingLabel=s("jraf.appTable.descending"),this.cancelLabel=s("jraf.common.cancel"),this.applyLabel=s("jraf.common.ok"),this.detachDialogTitle=a.title||s("jraf.appTable.defaultDetachTitle"),this.msgNoData=a.msgNoData;this.dateFormatter=e.Validation.converterFactory("datetime").createConverter({formatType:"datetime",dateFormat:"short",timeFormat:"medium"}),this.label=a.label,this.tableClassNames="jraf-app-table ",i.isNonemptyString(a.tableClassNames)&&(this.tableClassNames+=a.tableClassNames),this.tableStyle=a.tableStyle,this.selectMode=a.multipleSelect?"multiple":"single",this.selection=t.isObservable(a.selection)&&i.isArray(a.selection())?a.selection:t.observableArray([]),i.isFunction(a.selectionListener)&&(this.selectionListener=a.selectionListener),this.selectChange=function(e,t){n._selectChange(e,t)},this._disableSorting=i.getBoolean(a.disableSorting,!1),this._dataCollection=a.collection,this._initializeColumnsData(a.columns),this._rowHeaderClassNameFunction=a.rowHeaderClassNameFunction,this._rowHeaderStyleFunction=a.rowHeaderStyleFunction;var u={columns:this.columnNames,rowHeader:a.rowHeader};this.dataSource=new r(this._dataCollection,u),a.usePagingControls&&(this.renderPageControl=a.usePagingControls,this.tableClassNames+=" jraf-paginated",this.dataSource=new e.PagingDataGridDataSource(this.dataSource),this.pageSize=this._dataCollection.fetchSize),this._dataCollection.on(e.Events.EventType.ALLADDED,(function(){n._refreshUI()})),this._initializeSortDialog(),this.closeDetachDialog=function(){n._handleDetachDialogClose()},this.prepareCell=function(e){return n._prepareCell(e)},this.getCellClass=function(e){return n._getCellClass(e)},this.getCellStyle=function(e){return n._getCellStyle(e)},this.prepareColumn=function(e){return n._mapColumnHeader(e.data)},this.getColumnHeaderClass=function(e){return n._getColumnHeaderClass(e)},this.getColumnHeaderStyle=function(e){return n._getColumnHeaderStyle(e)},this.getRowHeaderClass=function(e){return n._getRowHeaderClass(e)},this.getRowHeaderStyle=function(e){return n._getRowHeaderStyle(e)},this.getSortableValue=function(e){return n._getSortableValue(e)},this.detachOpen=t.observable(!1),this.queryRowActive=t.observable(!1),this._initializeMenus(a.actionMenu),this.createIcon=l?c.DEFAULT_ADD_ICON:c.DEFAULT_CREATE_ICON,this.duplicateIcon=c.DEFAULT_DUPLICATE_ICON,this.editIcon=c.DEFAULT_EDIT_ICON,this.viewIcon=c.DEFAULT_VIEW_ICON,this.deleteIcon=c.DEFAULT_DELETE_ICON,this.handleCreate=i.isFunction(a.handleCreate)&&a.handleCreate,this.handleDuplicate=i.isFunction(a.handleDuplicate)&&a.handleDuplicate,this.handleEdit=i.isFunction(a.handleEdit)&&a.handleEdit,this.handleView=i.isFunction(a.handleView)&&a.handleView,this.handleDelete=i.isFunction(a.handleDelete)&&a.handleDelete,this.hasCrud=!!(this.handleCreate||this.handleDuplicate||this.handleEdit||this.handleView||this.handleDelete),this.disableCreate=a.disableCreate||!1,this.disableDuplicate=a.disableDuplicate||!1,this.disableEdit=a.disableEdit||!1,this.disableView=a.disableView||!1,this.disableDelete=a.disableDelete||!1,this.disableRefresh=a.disableRefresh||!1,this.disableExport=a.disableExport||!1,this.handleRefresh=function(){a.handleRefresh()},this.exportHandler=a.handleExport,i.isFunction(this.exportHandler)&&(this.handleExport=function(e,t){n.exportHandler(e,t)}),this.customButtons=t.observableArray([]),a.extraButtons&&this.customButtons(this._parseCustomButtons(a.extraButtons)),this.hasCustomButtons=t.pureComputed((function(){return n.customButtons().length>0})),this._setupToolbarRefresh()}return c.prototype._setupToolbarRefresh=function(){this._getChangeableToolbarObjectProps().filter(this._filterChangeableToolbarObjectProps,this).forEach(this._subscribeToToolbarObjectChanges,this)},c.prototype._getChangeableToolbarObjectProps=function(){var e=this._getChangeableBuiltInButtonProps();return this.renderActionMenu&&(e=e.concat(this._getPropsFromChangeableToolbarObjects("actionMenuItems"))),this.hasCustomButtons()&&(e=e.concat(this._getPropsFromChangeableToolbarObjects("customButtons"))),e},c.prototype._getChangeableBuiltInButtonProps=function(){return[this.disableCreate,this.disableDuplicate,this.disableEdit,this.disableView,this.disableDelete,this.disableRefresh,this.disableExport]},c.prototype._getPropsFromChangeableToolbarObjects=function(e){return this[e]().map((function(e){return e.disabled}))},c.prototype._filterChangeableToolbarObjectProps=function(e){return t.isObservable(e)},c.prototype._subscribeToToolbarObjectChanges=function(e){var t=this;e.subscribe((function(){t._refreshToolbar()}))},c.prototype._refreshToolbar=function(){a("#"+this.toolbarId).ojToolbar("refresh")},c.prototype._initializeMenus=function(e){var a=this,o=e||[];this.renderActionMenu=o.length>0,this.renderActionMenu&&(this.actionMenuItems=t.observableArray(this._parseMenu(this.actionMenuId,o))),this.viewMenuCallbacks=[{callback:function(){a.toggleDetachTable()}},{callback:function(){a.openSortDialog()}}],this.actionMenuSelect=function(e,t){a._handleMenuSelect(a.actionMenuItems(),t)},this.viewMenuSelect=function(e,t){a._handleMenuSelect(a.viewMenuCallbacks,t)}},c.prototype._isSortSupportedByDataSource=function(){var e=this.dataSource.getCapability("sort");return"full"===e||"column"===e},c.prototype._initializeSortableColumnsList=function(){var e=this.columns();this.sortableColumns=[];for(var t=this._isSortSupportedByDataSource(),a=0;a<e.length;a++){var o=e[a],n=o.sortable;t&&i.getBoolean(n,!0)&&this.sortableColumns.push({value:o.value,label:o.label})}},c.prototype._initializeSortDialog=function(){this.sortByFirstLabel=s("jraf.appTable.sortFirstLabel"),this.sortByLaterLabel=s("jraf.appTable.sortSecondLabel"),this.sortCriteria=[];for(var e=0;e<c.SORTS_LIMIT;e++)this.sortCriteria.push({label:0===e?this.sortByFirstLabel:this.sortByLaterLabel,column:t.observableArray([]),direction:t.observable("asc")});this._initializeSortableColumnsList(),this.renderSortButton=this.sortableColumns.length>0},c.prototype._initializeColumnsData=function(e){this.columns=t.observableArray([]),this.columnNames=[],this.columnHeaders={};for(var a=0;a<e.length;a++){var o=e[a],i=o.label||o.valueName;this.columns.push({value:o.valueName,label:i,typeInfo:o.dataType||c.DATA_TYPE_STRING,callback:o.callback,width:o.width,cellAlignment:o.cellAlignment,headerClassNameFunction:o.headerClassNameFunction,headerStyleFunction:o.headerStyleFunction,cellClassNameFunction:o.cellClassNameFunction,cellStyleFunction:o.cellStyleFunction,customRenderer:o.customRenderer,sortable:!this._disableSorting&&o.sortable}),this.columnNames.push(e[a].valueName),this.columnHeaders[e[a].valueName]=i}},c.prototype._parseMenu=function(e,t){for(var a=[],o=0;o<t.length;o++){var i={id:e+"-entry-"+(o+1),label:t[o].label,callback:t[o].callback,icon:t[o].icon,disabled:t[o].disabled};a.push(i)}return a},c.prototype._parseCustomButtons=function(e){for(var t=[],a=0;a<e.length;a++)t.push(this._createButton(e[a]));return t},c.prototype._handleMenuSelect=function(e,t){var o=t.item[0];(0,e[a(o).prevAll().length].callback)()},c.prototype.toggleDetachTable=function(){if(this.detachOpen())a("#"+this.detachDialogId).ojDialog("close");else{var t=a("#"+this.appTableId);e.Components.subtreeDetached(t.get(0)),t.appendTo("#"+this.dialogAnchorId),e.Components.subtreeAttached(t.get(0)),a("#"+this.detachDialogId).ojDialog("open"),this.detachOpen(!0)}},c.prototype._handleDetachDialogClose=function(){var t=a("#"+this.appTableId);e.Components.subtreeDetached(t.get(0)),t.appendTo("#"+this.wrapperId),e.Components.subtreeAttached(t.get(0)),this.detachOpen(!1)},c.prototype.toggleQueryRow=function(){this.queryRowActive(!this.queryRowActive())},c.prototype._applySortCriteria=function(){var e=this._dataCollection.sortCriteria;i.isArray(e)||(e=[]);for(var t=Math.min(e.length,c.SORTS_LIMIT),a=0;a<t;a++){var o=e[a],n=this.sortCriteria[a];n.column([o.column]),n.direction(o.direction)}for(a=t;a<this.sortCriteria.length;a++)this.sortCriteria[a].column([]),this.sortCriteria[a].direction("asc")},c.prototype.openSortDialog=function(){this._applySortCriteria(),a("#"+this.sortDialogId).ojDialog("open")},c.prototype.closeSortDialog=function(){a("#"+this.sortDialogId).ojDialog("close")},c.prototype.executeSortDialog=function(){if(-1===this._dataCollection.fetchSize)this._dataCollection.comparator=this._getSortComparator();else{var e=this._getSortCriteria();if(0===e.length)return void this.closeSortDialog();this._dataCollection.sortCriteria=e,this._dataCollection.comparator=e[0].column}this._dataCollection.sort(),this._refreshUI(),this.closeSortDialog()},c.prototype._getSortCriteria=function(){for(var e=[],t=this.sortCriteria,a=0;a<t.length;){var o=t[a].column()[0],i=t[a].direction();o&&e.push({column:o,direction:i}),a++}return e},c.prototype._getSortComparator=function(){var e=this;return function(t,a){for(var o=0,i=e.sortCriteria,n=0;n<i.length&&0===o;){var r=i[n].column();o=("asc"===i[n].direction()?1:-1)*e._compareCollectionValues(t.attributes[r],a.attributes[r]),n++}return o}},c.prototype._compareCollectionValues=function(e,t){return e>t?1:t>e?-1:0},c.prototype._createButton=function(e){var a={component:"ojButton"};return e.icon&&(a.icons={start:"oj-icon "+e.icon}),e.iconOnly&&(a.display="icons"),a.label=e.label,a.disabled=!!i.isBoolean(t.unwrap(e.disabled))&&e.disabled,{button:a,buttonHandler:e.buttonHandler}},c.prototype._refreshUI=function(){a("#"+this.dataGridId).ojDataGrid("refresh")},c.prototype._selectChange=function(e,t){this.selectionListener&&"selection"===t.option&&this.selectionListener(t.value)},c.prototype._mapColumnHeader=function(e){return this.columnHeaders[e]},c.prototype._prepareCell=function(t){var o=this._getColumnData(t),r=o.callback,l=o.typeInfo;if(r){var s=a(t.parentElement).parents(".oj-datagrid-cell").first();s.click((function(e){r(e,t)})),s.on("keydown",(function(e){n.isEnterKey(e)&&r(e,t)}))}if(l===c.DATA_TYPE_ICON){var u=t.data;if(!i.isObjectStrict(u)||!i.isNonemptyString(u.icon)||!i.isNonemptyString(u.label))return"";var h=document.createElement("span");return h.classList.add("jraf-appTable-cell-icon"),h.classList.add(u.icon),h.title=u.label,h.setAttribute("aria-label",u.label),h.setAttribute("role","img"),h}return l===c.DATA_TYPE_DATE&&t.data?this.dateFormatter.format(e.IntlConverterUtils.dateToLocalIso(t.data)):l===c.DATA_TYPE_CUSTOM&&i.isFunction(o.customRenderer)?o.customRenderer(t):t.data},c.prototype._getCellClass=function(e){var t=this._getColumnData(e),a=this._getCellAlignmentClass(t);return i.isFunction(t.cellClassNameFunction)&&(a+=" "+t.cellClassNameFunction(e)),a},c.prototype._getCellStyle=function(e){var t=this._getColumnData(e),a="";return i.isFunction(t.cellStyleFunction)&&(a=t.cellStyleFunction(e)),a},c.prototype._getColumnHeaderClass=function(e){var t=this._getColumnData(e),a=this._getCellAlignmentClass(t);return i.isFunction(t.headerClassNameFunction)&&(a+=" "+t.headerClassNameFunction(e)),a},c.prototype._getColumnHeaderStyle=function(e){var t=this._getColumnData(e),a="";return i.isNonemptyString(t.width)&&(a+="width:"+t.width+";"),i.isFunction(t.headerStyleFunction)&&(a+=t.headerStyleFunction(e)),a},c.prototype._getRowHeaderClass=function(e){var t=c.DEFAULT_ROW_HEADER_CLASS;return i.isFunction(this._rowHeaderClassNameFunction)&&(t=this._rowHeaderClassNameFunction(e)),t},c.prototype._getRowHeaderStyle=function(e){var t="";return i.isFunction(this._rowHeaderStyleFunction)&&(t+=this._rowHeaderStyleFunction(e)),t},c.prototype._getSortableValue=function(e){var t=this._getColumnData(e);return i.isBoolean(t.sortable)?t.sortable?"enable":"disable":"auto"},c.prototype._getColumnData=function(e){var t=i.isNumberStrict(e.index)?e.index:e.indexes.column;return this.columns()[t]},c.prototype._getCellAlignmentClass=function(e){if(e.typeInfo===c.DATA_TYPE_ICON||e.typeInfo===c.DATA_TYPE_DATE)return"oj-helper-justify-content-center";var t=e.cellAlignment;return"start"===t||"left"===t?"oj-helper-justify-content-flex-start":"end"===t||"right"===t?"oj-helper-justify-content-flex-end":"center"===t?"oj-helper-justify-content-center":"oj-helper-justify-content-flex-end"},c}));