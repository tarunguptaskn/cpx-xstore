define(["jquery","jraf/jrafcore","ojs/ojcore","knockout","jraf/utils/ValidationUtils","ojs/ojtoolbar","ojs/ojbutton","ojs/ojoffcanvas","ojs/ojknockout"],(function(e,t,n,i,o){"use strict";var a=n.Translations.getTranslatedString;function l(e){if(!o.isObjectStrict(e)||!o.isNonemptyString(e.title)&&!o.isObjectStrict(e.headerModule)||!o.isObjectStrict(e.mainContent))throw new TypeError("ContentFrame: Missing required properties");this._jrafParam=e.jraf,this.mainContentId=t.UIShell.generateUniqueId(),this.contentFrameDrawerId=t.UIShell.generateUniqueId(),this.headerTitle=a(e.title),this.headerModule=this._mergeJrafParam(e.headerModule),this.mainContentModule=this._mergeJrafParam(e.mainContent),this._loadedPanels=[],this.activePanelModuleBinding=i.observable(),this.panelLoading=i.observable(!1),this.panelOpen=i.observable(!1);var l=n.ResponsiveKnockoutUtils.createScreenRangeObservable();this.isSmallScreen=i.pureComputed((function(){return l()===n.ResponsiveUtils.SCREEN_RANGE.SM})),this.showModalOverlay=i.pureComputed((function(){return this.panelOpen()&&this.isSmallScreen()}),this),this.compactMainContent=i.pureComputed((function(){return this.panelOpen()&&!this.isSmallScreen()}),this),this._initializePanels(e),this._monitorPanelSelection()}return l.prototype._mergeJrafParam=function(t){return o.isObjectStrict(t)?e.extend(!0,{},t,{params:{jraf:this._jrafParam}}):t},l.prototype._initializePanels=function(e){var n=[];if(o.isObjectStrict(e.helpContent)){var l=t.UIShell.generateUniqueId();n.push({label:a("jraf.appframe.help"),icon:"jraf-help-icon",id:l,module:{name:"jraf/contentframe/ContentPanel",cacheKey:l,params:{title:a("jraf.appframe.help"),content:this._mergeJrafParam(e.helpContent)}}})}this._panelMap={};for(var r=0;r<n.length;r++){var s=n[r];this._panelMap[s.id]=s,this._addModuleLoadingCallbacks(s.module),this._addCloseCallbackParam(s.module)}this.defaultPanels=i.observableArray(n),this.hasPanels=i.pureComputed((function(){return this.defaultPanels().length>0}),this),this._panelAnimating=Promise.resolve()},l.prototype._monitorPanelSelection=function(){this.selectedToolbarButtons=i.observableArray([]);var e=null;this.selectedToolbarButtons.subscribe((function(t){e=t}),null,"beforeChange"),this.selectedToolbarButtons.subscribe((function(t){this._updatePanelState(e,t)}),this)},l.prototype._updatePanelState=function(e,t){if(0!==t.length){var n=t[0];t.length>1&&t.map((function(t){e.indexOf(t)<0&&(n=t)})),this._setActivePanel(n),this.panelOpen()||this._openPanel()}else this._closePanel()},l.prototype._setActivePanel=function(e){var t=this._panelMap[e];t&&this.activePanelModuleBinding(t.module)},l.prototype._openPanel=function(){var e=this;this._panelAnimating=this._panelAnimating.then((function(){return e.panelOpen(!0),n.OffcanvasUtils.open({selector:"#"+e.contentFrameDrawerId,content:"#"+e.mainContentId,displayMode:"overlay",autoDismiss:"none"})}))},l.prototype._closePanel=function(){var e=this;this._panelAnimating=this._panelAnimating.then((function(){return e.panelOpen(!1),n.OffcanvasUtils.close({selector:"#"+e.contentFrameDrawerId})}))},l.prototype._addModuleLoadingCallbacks=function(e){var t,n,i=this,a=e.lifecycleListener;a?(t=a.transitionCompleted,n=a.activated):(a={},e.lifecycleListener=a),a.transitionCompleted=function(){i.panelLoading(!1),o.isFunction(t)&&t.apply(this,arguments)},a.activated=function(){i.panelLoading(!0),o.isFunction(n)&&n.apply(this,arguments)}},l.prototype._addCloseCallbackParam=function(e){var t=this,n=e.params;n||(n={},e.params=n),n.closePanelCallback=function(){t.selectedToolbarButtons([])}},l.prototype._getMainContentViewModel=function(t){var n=(o.isObjectStrict(t)&&t instanceof e?t.find("#"+this.mainContentId):e("#"+this.mainContentId)).children().get(0);return n?i.dataFor(n):null},l.prototype._invokeMainContentEvent=function(e,t,n,i,a){var l=this._getMainContentViewModel(i);return o.isObjectStrict(l)&&o.isFunction(l[e])?l[e](t,n):a},l.prototype.uiShellBeforeDeselect=function(e,t){return this._invokeMainContentEvent("uiShellBeforeDeselect",e,t,t.fromContent,!0)},l.prototype.uiShellDeselect=function(e,t){return this._invokeMainContentEvent("uiShellDeselect",e,t,t.fromContent,void 0)},l.prototype.uiShellBeforeSelect=function(e,t){return this._invokeMainContentEvent("uiShellBeforeSelect",e,t,t.toContent,!0)},l.prototype.uiShellSelect=function(e,t){return this._invokeMainContentEvent("uiShellSelect",e,t,t.toContent,void 0)},l.prototype.uiShellBeforeClose=function(e,t){return this._invokeMainContentEvent("uiShellBeforeClose",e,t,t?t.content:null,!0)},l.prototype.uiShellClose=function(e,t){return this._invokeMainContentEvent("uiShellClose",e,t,t?t.content:null,void 0)},l}));