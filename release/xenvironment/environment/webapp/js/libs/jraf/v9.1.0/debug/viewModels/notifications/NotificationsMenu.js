define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/utils/ValidationUtils","jraf/utils/I18nUtils","jraf/models/notifications/NotificationsFilter","jraf/models/notifications/NotificationsConfig","jraf/models/Content","jraf/models/UIShellManager","jraf/models/NavigationHelper","jraf/services/ServiceManager","jraf/utils/CustomBindings","ojs/ojarraytabledatasource","jraf/composites/oj-rgbu-jraf-apps-module/loader"],(function(t,i,e,a,n,o,s,r,c,l,f,u){"use strict";var d=t.Translations.getTranslatedString;function h(e){if(t.Logger.info("NotificationsMenu: Entering constructor."),!n.isObjectStrict(e)||!i.isObservable(e.badgeValue))throw new TypeError("NotificationsMenu: Invalid parameters");h.superclass.constructor.apply(this),this._notificationHandler=r.getInstance().getNotificationHandler(e.notificationHandlerKey),this.NotificationsService=this._notificationHandler.getNotificationsService(),n.isFunction(e.getDetailPageContent)&&(this._getDetailPageContent=e.getDetailPageContent),this.InitializeUniqueIds(),this.InitializeStrings(),this.InitializeCallbacks(),this.InitializeFilters(),this.InitializeNotificationsList(),this._initializeAutoRefresh(e.badgeValue),this.LoadMenuData()}return t.Object.createSubclass(h,t.Object,"NotificationsMenu"),h.prototype.handleAttached=function(){this.isActive=!0,this._reloadMenuInSequence()},h.prototype.handleDetached=function(){this.isActive=!1},h.prototype.InitializeUniqueIds=function(){this.filterTabId=a.UIShell.generateUniqueId()},h.prototype.InitializeStrings=function(){this.filterTabLabel=d("jraf.sidebar.notifications.filterTabLabel"),this.footerButtonLabel=d("jraf.sidebar.notifications.allItems"),this.loadingText=d("jraf.messages.loading")},h.prototype.InitializeCallbacks=function(){var t=this;this.launchDetailPage=function(){t.ClearSummaryTile(),t.LaunchDetailPage()},this.markNotificationAsRead=function(i,a){e(i.srcElement).hasClass("jraf-read-indicator")&&t.MarkNotificationAsRead(a.data)},this.handleNotificationClick=function(i,a){e(i.currentTarget).hasClass("jraf-read-indicator")||t.HandleNotificationClick(a.data)}},h.prototype.InitializeFilters=function(){var t=this;this.Filter=s.getInstance(this.NotificationsService),this.FiltersReady=this.Filter.filtersReady.then((function(){t.HandleFiltersReady()}),(function(){t.HandleFiltersReadyFailure()})),this.filterTabToggle=i.observableArray([]),this.openFiltersTab=i.pureComputed((function(){return 1===t.filterTabToggle().length})),this.filtersCount=this.Filter.getActiveFiltersCount(),this.filtersTabModuleOptions={name:"jraf/notifications/FiltersTab",params:{loadDataCallback:function(){t.LoadMenuData()},closeTabCallback:function(){t.filterTabToggle([])},filter:this.Filter}}},h.prototype.HandleFiltersReady=function(){t.Logger.info("NotificationsMenu.HandleFiltersReady: Filters are ready")},h.prototype.HandleFiltersReadyFailure=function(){t.Logger.info("NotificationsMenu.HandleFiltersReadyFailure: Failed loading persisted criteria. Continuing with default values.")},h.prototype.InitializeNotificationsList=function(){this._internalNotificationsBuffer=[],this.notificationsList=new t.ArrayTableDataSource([],{idAttribute:"id"}),this.menuDataLoaded=i.observable(!1);var e=this;this.notificationListHeight=i.pureComputed((function(){return e.GetNotificationListHeight()})),this.notificationsListModuleOptions={name:"jraf/notifications/NotificationsList",params:{notificationsList:this.notificationsList,markNotificationAsRead:this.markNotificationAsRead,handleNotificationClick:this.handleNotificationClick}}},h.prototype.GetNotificationListHeight=function(){},h.prototype._initializeAutoRefresh=function(t){var i=this;this.isActive=!1,this._refreshSequencer=Promise.resolve(),this._lastRefresh=Date.now(),this._lastUpdate=Date.now(),t.subscribe((function(){i._lastUpdate=Date.now()})),t.extend({notify:"always"}),this._initializeMenuStateSubscription()},h.prototype._initializeMenuStateSubscription=function(){var t=this;this.GetMenuState().subscribe((function(i){t.HandleMenuStateChange(i)}))},h.prototype.GetMenuState=function(){},h.prototype.HandleMenuStateChange=function(t){t&&this.isActive&&this._reloadMenuInSequence()},h.prototype._reloadMenuInSequence=function(){var t=this;this._refreshSequencer=this._refreshSequencer.then((function(){t._reloadMenu()}))},h.prototype._reloadMenu=function(){this._lastRefresh<this._lastUpdate&&this.LoadMenuData()},h.prototype.LoadMenuData=function(){var t=this;return l.startProcessingIndicator(),this.menuDataLoaded(!1),this.FiltersReady.then((function(){return t.GetNotifications()})).then((function(i){t.HandleDataLoadSuccess(i),t._lastRefresh=Date.now()}),(function(i){t.HandleDataLoadFailure(i)}))},h.prototype.GetNotifications=function(){},h.prototype.HandleDataLoadSuccess=function(i){t.Logger.info("NotificationsMenu.HandleDataLoadSuccess: Entering"),i&&n.isArray(i.results)?this.RefreshMenuData(i.results):t.Logger.warn("NotificationsMenu.HandleDataLoadSuccess: invalid data returned."),this.menuDataLoaded(!0),l.stopProcessingIndicator()},h.prototype.RefreshMenuData=function(t){this._internalNotificationsBuffer=this.ParseNotificationData(t),this.UpdateDisplayedNotifications()},h.prototype.UpdateDisplayedNotifications=function(){var t=this._internalNotificationsBuffer.slice(0,this.GetNotificationDisplayLimit());this.notificationsList.reset(t)},h.prototype.GetNotificationDisplayLimit=function(){},h.prototype.ParseNotificationData=function(t,i){return t.map((function(t){return this.ParseNotification(t,i)}),this)},h.prototype.ParseNotification=function(t,e){var a=s.SEVERITY_OPTIONS[t.severity-1];return{id:t.notificationId,type:t.notificationTypeDescription,message:t.notificationDesc,timestamp:o.formatDatetime(t.createdDate),readState:i.observable(t.notificationStatus!==s.UNREAD_STATUS),author:t.createdBy,severity:a.label,severityClass:a.class,launchable:t.launchable,group:e}},h.prototype.HandleDataLoadFailure=function(i){t.Logger.warn("NotificationsMenu._handleDataLoadFailure: failed loading data with reason "+i),l.stopProcessingIndicator()},h.prototype.HandleNotificationClick=function(t){return t.launchable?(l.startProcessingIndicator(),Promise.all([this.MarkNotificationAsRead(t),this._openNotificationContext(t.id)]).then((function(){l.stopProcessingIndicator()}))):Promise.resolve()},h.prototype._openNotificationContext=function(i){var e=this;return this._notificationHandler.openContext(i).then((function(){e.CloseMenu()}),(function(i){t.Logger.warn("NotificationsMenu._openNotificationContext: Failed to open context with reason (%s)",i)}))},h.prototype.MarkNotificationAsRead=function(t){var i=this;return t.readState()?Promise.resolve():(l.startProcessingIndicator(),t.readState(!0),this.NotificationsService.markNotificationAsRead(t.id).then((function(){i.HandleSuccessfulMarkNotificationAsRead(t)})).catch((function(e){i.HandleFailedMarkNotificationAsRead(e,t)})))},h.prototype.HandleSuccessfulMarkNotificationAsRead=function(i){t.Logger.info("NotificationsMenu.HandleSuccessfulMarkNotificationAsRead: Marked %s as read",i.id),this.LoadMenuData(),l.stopProcessingIndicator()},h.prototype.HandleFailedMarkNotificationAsRead=function(i,e){l.stopProcessingIndicator(),e.readState(!1),t.Logger.warn("NotificationsMenu.HandleFailedMarkNotificationAsRead: Failed to mark notification as read.\n",i)},h.prototype.LaunchDetailPage=function(t){l.openContent(this._getDetailPageContent(t)),this.CloseMenu()},h.prototype._getDetailPageContent=function(t){return c.completeContent(f.getNotificationsPageContentConfig({initialTile:t}))},h.prototype.ClearSummaryTile=function(){this.Filter.selectedSummaryValues.primaryGroup(null),this.Filter.selectedTileIndex()===s.SUMMARY_TILE_INDEX&&this.Filter.selectedTileIndex(s.ALL_NOTIFICATIONS_TILE_INDEX)},h.prototype.CloseMenu=function(){},h}));