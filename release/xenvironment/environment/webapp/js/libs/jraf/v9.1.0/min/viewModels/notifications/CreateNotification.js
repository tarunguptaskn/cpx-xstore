define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/services/ServiceManager","jraf/utils/ValidationUtils","jraf/models/UIShellManager","jraf/models/notifications/NotificationsFilter","ojs/ojarraydataprovider","ojs/ojselectsingle","ojs/ojselectcombobox","ojs/ojinputtext","jraf/composites/oj-rgbu-jraf-message-dialog/loader","ojs/ojbutton","ojs/ojpopup","ojs/ojlabel","ojs/ojdialog"],(function(e,t,i,s,r,o,a,n,c){"use strict";h.REASSIGN_TYPE_CODE="Reassign Notification",h.DESCRIPTION_CHARACTER_LIMIT=200;var l=e.Translations.getTranslatedString;function h(e){var i=this;if(!o.isObjectStrict(e)||!o.isNonemptyString(e.dialogId)||!o.isObjectStrict(e.notificationsService))throw new TypeError("CreateNotification: Invalid parameters");this.notificationsService=e.notificationsService,this.identityService=r.getIdentityService(),this.dialogId=e.dialogId,this.severitySelectId=s.UIShell.generateUniqueId(),this.typeSelectId=s.UIShell.generateUniqueId(),this.messageFieldId=s.UIShell.generateUniqueId(),this.assigneeSearchId=s.UIShell.generateUniqueId(),this.assigneeListId=s.UIShell.generateUniqueId(),this.errorId=s.UIShell.generateUniqueId(),this.createFailedDialogId=s.UIShell.generateUniqueId(),this.severitySelectLabel=l("jraf.notifications.create.severityField"),this.typeSelectLabel=l("jraf.notifications.create.typeField"),this.messageFieldLabel=l("jraf.notifications.create.descField"),this.assigneeSearchLabel=l("jraf.notifications.create.assigneeSearch"),this.assigneeSearchPlaceholder=l("jraf.notifications.create.assigneeSearchPlaceholder"),this.matchingRecipientsLabel=l("jraf.notifications.create.matchingRecipientsLabel"),this.assigneeListLabel=l("jraf.notifications.create.assigneeListLabel"),this.dialogTitle=o.isNonemptyString(e.dialogTitle)?e.dialogTitle:l("jraf.notifications.create.dialogTitle"),this.createFailedMsg=o.isNonemptyString(e.createFailedMsg)?e.createFailedMsg:l("jraf.notifications.create.createFailed"),this.removeAssigneeLabel=l("jraf.notifications.create.removeAssigneeLabel"),this.okLabel=l("jraf.common.ok"),this.cancelLabel=l("jraf.common.cancel"),this.noMessageError=l("jraf.notifications.create.noMessageError"),this.noRecipientsError=l("jraf.notifications.create.noRecipientsError"),this.minimumSearchStringError=l("jraf.notifications.create.minimumSearchStringError"),this.appCode=e.appCode,this.severityOptions=n.SEVERITY_OPTIONS,this.severityOptionsDataProvider=new c(this.severityOptions,{keyAttributes:"value"}),this.selectedSeverity=t.observable(n.SEVERITY_VALUE_IMPORTANT),this.Rd(),this.maxMessageLength=h.DESCRIPTION_CHARACTER_LIMIT,this.messageCharLimitLabel=l("jraf.notifications.create.descCharLimit",this.maxMessageLength),this.messageValue=t.observable(""),this.assigneeSearchValue=t.observable(""),this.assigneeOptions=t.observableArray([]),this.selectedAssignees=t.observableArray([]),this.assigneeList=t.observableArray([]),this.assignedGroups=t.observableArray([]),this.errorAtPosH="start",this.errorAtPosV="bottom",this.errorMyPosH="start",this.errorMyPosV="top",this.errorMessage=t.observable(""),this.removeAssignee=function(e,t){i.Jd(t)},this.closeDialog=function(){i.qr()},this.createNotification=function(){i.Vd()},this.handleUsersSearch=function(){i.zd()},this.handleTypeSelection=function(e,t){i.Bd(e,t)},this.onOpen=function(){i.handleOpen()},this.createReadyPromise=Promise.resolve(),this.Gd(),this.copySource={},o.isFunction(e.createCallback)&&(this.createCallback=e.createCallback),e.defaultNotification&&this.Kd(e.defaultNotification)}return h.prototype.Rd=function(){this.typeOptions=n.getInstance(this.notificationsService).notificationTypeOptions,this.typeOptionsDataProvider=new c(this.typeOptions,{keyAttributes:"value"}),this.selectedType=t.observable()},h.prototype.Gd=function(){var e=this;this.selectedAssignees.subscribe((function(){e.Qd()}))},h.prototype.Wd=function(){var t=this;return this.identityService.searchUsers(this.assigneeSearchValue()).then((function(e){for(var i=[],s=0;s<e.length;s++){var r={};r.value=e[s].userid,r.label=e[s].displayName||e[s].userid,i.push(r)}t.assigneeOptions(i)}),(function(t){e.Logger.warn("CreateNotification._searchUsers: Error loading users: "+t)}))},h.prototype.Kd=function(e){var t=this;e.subscribe((function(e){if(e){t.messageValue(e.message);var i=n.SEVERITY_OPTIONS.filter((function(t){return t.label===e.severity}));0<i.length&&t.selectedSeverity(i[0].value);var s=t.typeOptions().filter((function(e){return e.typeCode===h.REASSIGN_TYPE_CODE}));0<s.length&&t.selectedType(s[0].value),t.copySource={id:e.id,launchable:e.launchable,hierarchy:e.hierarchy}}else t.Xd()}))},h.prototype.handleOpen=function(){var e=this;this.copySource.id&&this.copySource.launchable&&(a.startProcessingIndicator(),this.createReadyPromise=e.notificationsService.getNotificationContext(e.copySource.id).then((function(t){e.copySource.context=t,a.stopProcessingIndicator()}),(function(){a.stopProcessingIndicator()})))},h.prototype.Bd=function(e,t){for(var i=e.target.value,s=this.typeOptions(),r=0;r<s.length;r++)if(s[r].value===i){this.assignedGroups(s[r].groups||[]);break}},h.prototype.Qd=function(){var e=this,t=this.assigneeList().filter((function(t){var i=e.assigneeOptions().some((function(e){return e.value===t.value})),s=e.selectedAssignees().some((function(e){return e.value===t.value}));return!i||s})),i=this.selectedAssignees().filter((function(e){return!t.some((function(t){return t.value===e.value}))})),s=t.concat(i);s.sort((function(e,t){return e.label.localeCompare(t.label)})),this.assigneeList(s)},h.prototype.Jd=function(e){this.assigneeList.remove(e.data),this.selectedAssignees.remove(e.data)},h.prototype.Vd=function(){var e=this,t=this.assigneeList().map((function(e){return e.value})),i={applicationCode:this.appCode,notificationDesc:this.messageValue(),notificationTypeId:this.selectedType(),severity:this.selectedSeverity(),recipients:t};if(o.isNonemptyString(i.notificationDesc)){if(0!==i.recipients.length||0!==this.assignedGroups().length){this.copySource.context&&(i.notificationContextObj=JSON.stringify(this.copySource.context),i.contextSource="JRAF",i.launchable=!0);var s=this.copySource.hierarchy;if(o.isArray(s))for(var r=0;r<s.length;r++)o.isNonemptyString(s[r])&&(i["hierValue"+(r+1)]=s[r]);return a.startProcessingIndicator(),this.createReadyPromise.then((function(){return e.notificationsService.createNotification(i).then((function(){e.Zd()}),(function(t){e.$d(t)}))}))}this.im(this.assigneeListId,this.noRecipientsError)}else this.im(this.messageFieldId,this.noMessageError)},h.prototype.Zd=function(){this.Xd(),a.stopProcessingIndicator(),this.qr(),this.createCallback&&this.createCallback()},h.prototype.$d=function(t){e.Logger.error("CreateNotification._createNotification: Error creating new notification: "+t),document.getElementById(this.createFailedDialogId).open(),a.stopProcessingIndicator()},h.prototype.Xd=function(){this.selectedSeverity(void 0),this.selectedType(void 0),this.messageValue(""),this.assigneeSearchValue(void 0),this.assigneeOptions([]),this.selectedAssignees([]),this.assigneeList([]),this.copySource={}},h.prototype.qr=function(){i("#"+this.dialogId).ojDialog("close")},h.prototype.zd=function(){o.isNonemptyString(this.assigneeSearchValue())&&(e.Logger.info("CreateNotification handleUsersSearch: Search value is %s",this.assigneeSearchValue()),3<=this.assigneeSearchValue().length?this.Wd():this.im(this.assigneeSearchId,this.minimumSearchStringError))},h.prototype.im=function(e,t){this.errorMessage(t),i("#"+this.errorId).ojPopup("open","#"+e)},h}));