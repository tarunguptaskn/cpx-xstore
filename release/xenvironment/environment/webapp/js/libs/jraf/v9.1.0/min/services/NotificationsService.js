define(["jquery","ojs/ojcore","jraf/jrafcore","jraf/utils/UrlUtils","jraf/utils/ValidationUtils","jraf/services/AbstractService"],(function(t,e,r,i,a,s){"use strict";function n(t,e){if(n.superclass.constructor.apply(this,arguments),a.isObjectStrict(e)?(this.appCodes=e.appCodes,this.Sc=e.clientAppCode):this.appCodes=e,!a.isArray(this.appCodes))throw new TypeError("NotificationsService: Missing Application Codes.");this.appCodesUrlString="",this.rd()}return n.SERVICE_URL_PATH="services/private/Notifications/",n.ALERTS_SERVICE_URL_PATH="services/private/Alerts/",n.SERVICE_VERSION_OVERRIDE=null,n.UNREAD_NOTIFICATION_STATUS="U",n.READ_NOTIFICATION_STATUS="R",e.Object.createSubclass(n,s,"NotificationsService"),n.prototype.getServiceConfiguration=function(){return{baseUri:this.getBaseUri(),appCodes:this.appCodes}},n.prototype.GetStandardHeaders=function(){var t=n.superclass.GetStandardHeaders.apply(this);return t["Accept-Version"]=n.SERVICE_VERSION_OVERRIDE||t["Accept-Version"],t},n.prototype.getNotificationTypes=function(e){var r=this,i="fetch/notificationtypes?groups=true&appCode="+this.appCodesUrlString;e&&(i+="&ignoreUser=true");var a=this.sd(i),s=t.ajax(a,{headers:r.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(s).then((function(t){return r.nd(t)}))},n.prototype.nd=function(t){for(var e=[],r=0;r<t.length;r++){var i={label:t[r].name,value:t[r].typeId,typeCode:t[r].typeCode},a=t[r].groups;if(a){var s=[];i.groups=s;for(var n=0;n<a.length;n++)s.push({name:a[n].name,description:a[n].description,id:a[n].id})}e.push(i)}return e},n.prototype.getNotificationTimes=function(){var e=this,r=this.sd("fetch/timeperiods?appCode="+this.appCodesUrlString),i=t.ajax(r,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return e.ad(t)}))},n.prototype.ad=function(t){for(var e=[],r=0;r<t.length;r++)e.push({label:t[r].description,value:t[r].periodId});return e},n.prototype.getNotificationHierarchyLevels=function(){var e=this,r=this.sd("fetch/hierarchylevels?appCode="+this.appCodesUrlString),i=t.ajax(r,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return e.hd(t)}))},n.prototype.hd=function(t){for(var e=[],r=0;r<t.length;r++)e.push({name:t[r].description,id:t[r].hierLevelId,token:t[r].tokenName,parent:t[r].parentHierLevelId});return e},n.prototype.getUnreadNotificationCount=function(){var e=this,r=this.sd("fetch/unreadcount?appCode="+this.appCodesUrlString),i=t.ajax(r,{headers:e.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return new Promise((function(t,r){e.ConvertAjaxPromise(i).then((function(e){e&&a.isNumberStrict(e.unreadNotificationCount)?t(e.unreadNotificationCount):r("Did not receive unreadNotificationCount in response.")}),(function(t){r(t)}))}))},n.prototype.getNotificationCount=function(e){var r=this,i=this.sd("filter/count");e.appCodes=this.appCodes;var s=t.ajax(i,{headers:r.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return new Promise((function(t,e){r.ConvertAjaxPromise(s).then((function(r){r&&a.isNumberStrict(r.matchedCount)?t(r.matchedCount):e("Did not receive matchedCount in response.")}),(function(t){e(t)}))}))},n.prototype.getRecipients=function(e){var r=this.sd("fetch/recipients/"+e),i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return t.recipients}))},n.prototype.getNotifications=function(e){var r=this.sd("filter/list"),i=[];if(a.isArray(e.sortColumns))for(var s=0;s<e.sortColumns.length;s++)i.push(this.od(e.sortColumns[s]));var n={};t.extend(n,e,{appCodes:this.appCodes,sortColumns:i});var o=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(n),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(o)},n.prototype.getNotificationGroups=function(e){var r=this.sd("filter/group");e.appCodes=this.appCodes;var i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return t}))},n.prototype.getNotificationSummaries=function(e){var r=this.sd("filter/summarize");e.appCodes=this.appCodes;var i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return t}))},n.prototype.markNotificationAsRead=function(e,r){if(!a.isNumberStrict(e))throw new TypeError("NotificationsService.markNotificationAsRead: notificationId must be a number.");var i=void 0===r||r,s=this.sd("update"),o=t.ajax(s,{headers:this.GetStandardHeaders(),method:"PUT",processData:!1,data:JSON.stringify({notificationId:e,notificationStatus:i?n.READ_NOTIFICATION_STATUS:n.UNREAD_NOTIFICATION_STATUS}),xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(o)},n.prototype.markMultipleNotificationsAsRead=function(e,r){var i={notificationIds:e,status:r?n.READ_NOTIFICATION_STATUS:n.UNREAD_NOTIFICATION_STATUS},a=this.sd("update/multiple"),s=t.ajax(a,{headers:this.GetStandardHeaders(),data:JSON.stringify(i),processData:!1,method:"PUT",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(s)},n.prototype.getNotificationContext=function(e){var r=this,i=this.sd("fetch/context/"+e),a=t.ajax(i,{headers:r.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return new Promise((function(t,e){r.ConvertAjaxPromise(a).then((function(i){try{var a=r.ParseNotificationContext(i.context);t(a)}catch(i){e(i)}}),(function(t){e(t)}))}))},n.prototype.ParseNotificationContext=function(t){return JSON.parse(t)},n.prototype.createNotification=function(e){e.applicationCode||(e.applicationCode=this.appCodes[0]);var r=this.sd("create"),i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"text",data:JSON.stringify(e),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i)},n.prototype.deleteNotification=function(e){var r=this.sd("delete/"+e),i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",method:"DELETE",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i)},n.prototype.deleteMultipleNotifications=function(e){var r=this.sd("delete/multiple"),i=t.ajax(r,{headers:this.GetStandardHeaders(),data:JSON.stringify({notificationIds:e}),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i)},n.prototype.persistCriteria=function(r){var i=this.sd("criteria");r.appCodes=this.appCodes;var a=t.ajax(i,{headers:this.GetStandardHeaders(),data:JSON.stringify(r),processData:!1,method:"POST",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(a).catch((function(t){e.Logger.warn("Failed to persist criteria: ",t)}))},n.prototype.loadCriteria=function(){var e=this.sd("fetch/criteria?appCode="+this.appCodesUrlString),r=t.ajax(e,{headers:this.GetStandardHeaders(),xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(r)},n.prototype.sd=function(t){var e=this.BuildEndpoint(t,n.SERVICE_URL_PATH);return this.Sc&&(e=i.injectQueryParameter(e,"clientAppCode",this.Sc)),e},n.prototype.od=function(t){var e="asc"===t.direction?"A":"D";return t.column+"|"+e},n.prototype.rd=function(){var t=this.appCodes.join(",");this.appCodesUrlString=encodeURIComponent(t)},n.prototype.getAlerts=function(e){var r=this.dd("get?notificationId="+e),i=t.ajax(r,{headers:this.GetStandardHeaders(),dataType:"json",xhrFields:{withCredentials:!0}});return this.ConvertAjaxPromise(i).then((function(t){return t}))},n.prototype.getAlertAttachment=function(e,r){var i=this.dd("getAttachment?alertId="+e+"&fileName="+r),a=this.GetStandardHeaders();a.Accept="application/octet-stream";var s=t.ajax(i,{headers:a,xhrFields:{withCredentials:!0,responseType:"blob"}});return this.ConvertAjaxPromise(s).then((function(t){return t}))},n.prototype.dd=function(t){var e=this.BuildEndpoint(t,n.ALERTS_SERVICE_URL_PATH);return this.Sc&&(e=i.injectQueryParameter(e,"clientAppCode",this.Sc)),e},n}));