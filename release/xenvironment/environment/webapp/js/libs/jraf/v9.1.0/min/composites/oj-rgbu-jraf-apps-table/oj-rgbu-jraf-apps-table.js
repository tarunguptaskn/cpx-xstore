define(["knockout","jquery","ojs/ojcore","ojs/ojtranslation","ojs/ojcomponentcore","ojs/ojcontext","ojs/ojanimation","./adapters/AdapterCapabilities","./adapters/SimpleGridAdapter","./adapters/JetDataGridAdapter","./adapters/LuxGridAdapter","jraf/composites/utils/TranslationLoaderUtil","ojs/ojarraydataprovider","ojs/ojkeyset","module","ojs/ojtoolbar","ojs/ojmenu","ojs/ojdialog","ojs/ojbutton","ojs/ojoption","ojs/ojradioset","ojs/ojlistview","ojs/ojswitch","ojs/ojselectsingle","ojs/ojjsontreedatasource","ojs/ojknockout","ojs/ojlistviewdnd"],(function(t,e,i,n,o,a,s,r,l,h,u,c,d,p,b){"use strict";function m(t){var e=this;if(1!==t.slotCounts.grid)throw new Error("oj-rgbu-jraf-apps-table: A grid component must be provided in the grid slot.");this.J=m.y.getTranslations(),this.X=t,this.N=Promise.all([this.J,this.X.properties]).then((function(t){e.M(t[0],t[1])}))}return m.CHANGEABLE_PROPERTIES=["disableCreate","disableDuplicate","disableEdit","disableView","disableDelete","disableRefresh","disableExport"],m.MENU_VALUE_SEPARATOR="-entry-",m.STANDARD_ACTIONS=["Create","Duplicate","Edit","View","Delete","Refresh","Export"],m.GRID_TAG_JRAF_SIMPLE_GRID="OJ-RGBU-JRAF-SIMPLE-GRID",m.GRID_TAG_JET_DATA_GRID="OJ-DATA-GRID",m.GRID_TAG_LUX_GRID="OJ-LUX-GRID",m.CREATE_PATTERN="create",m.ADD_PATTERN="add",m.SORTS_LIMIT=3,m.FILTER_MENU_OPTIONS_CLEAR_FILTER="clear-filter",m.FILTER_MENU_OPTIONS_MATCH_TYPE_OR="match-type-or",m.FILTER_MENU_OPTIONS_MATCH_TYPE_AND="match-type-and",m.FILTER_MATCH_TYPE_OR="or",m.FILTER_MATCH_TYPE_AND="and",m.y=new c("oj-rgbu-jraf-apps-table",b.id),m.prototype.activated=function(){return this.N},m.prototype.M=function(t,e){var i=e.createPatternType===m.ADD_PATTERN,o=e.translations||{},a=this.X.uniqueId;this.wrapperId=a+"_wrapper",this.actionMenuId=a+"_actionMenu",this.viewMenuId=a+"_viewMenu",this.exportMenuId=a+"_exportMenu",this.detachDialogId=a+"_detachDialog",this.toolbarId=a+"_toolbar",this.gridId=a+"_grid",this.columnManagementDialogId=a+"_columnManagementDialog",this.columnManagementListHeaderTmplId=a+"_columnManagementListHeaderTmpl",this.columnManagementListItemTmplId=a+"_columnManagementListItemTmpl",this.columnManagementListItemIdPrefix=a+"_columnManagementListItem",this.columnManagementListViewId=a+"_columnManagementListView",this.sortDialogId=a+"_sortDialog",this.appTableId=a+"_appsTable",this.dialogAnchorId=a+"_dialogAnchor",this.qbeToggle=a+"_qbeToggle",this.detachToggle=a+"_detachToggle",this.manageColumnsContextMenuId=a+"_manageColumnsContextMenu",this.manageColumnsCutOptionId=a+"_manageColumnsCutOption",this.manageColumnsPasteBeforeOptionId=a+"_manageColumnsPasteBeforeOption",this.manageColumnsPasteAfterOptionId=a+"_manageColumnsPasteAfterOption",this.actionMenuLabel=t.actionMenuLabel,this.viewMenuLabel=t.viewMenuLabel,this.sortMenuLabel=t.sortLabel,this.attachButtonLabel=t.attachLabel,this.detachButtonLabel=t.detachLabel,this.createButtonLabel=o.createLabel?o.createLabel:i?t.addLabel:t.createLabel,this.duplicateButtonLabel=o.duplicateLabel?o.duplicateLabel:t.duplicateLabel,this.editButtonLabel=o.editLabel?o.editLabel:t.editLabel,this.viewButtonLabel=o.viewLabel?o.viewLabel:t.viewLabel,this.deleteButtonLabel=o.deleteLabel?o.deleteLabel:t.deleteLabel,this.refreshButtonLabel=o.refreshLabel?o.refreshLabel:t.refreshLabel,this.exportButtonLabel=o.exportLabel?o.exportLabel:t.exportLabel,this.ascendingLabel=t.ascending,this.descendingLabel=t.descending,this.cancelLabel=t.cancel,this.applyLabel=t.ok,this.detachDialogTitle=e.detachDialogTitle||t.defaultDetachTitle,this.sortByFirstLabel=t.sortFirstLabel,this.sortByLaterLabel=t.sortSecondLabel,this.queryLabel=t.queryLabel,this.filterMenuLabel=t.filterMenuLabel,this.clearFiltersLabel=t.clearFiltersLabel,this.filterMatchTypeOr=t.filterMatchTypeOr,this.filterMatchTypeAnd=t.filterMatchTypeAnd,this.exportVisible=t.exportVisible,this.exportAll=t.exportAll,this.enabled=t.enabled,this.manageColumnsLabel=t.manageColumns,this.column=t.column,this.displayed=t.displayed,this.manageColumnsList=t.manageColumnsList,this.resetToDefaults=t.resetToDefaults,this.yesLabel=t.yes,this.noLabel=t.no,this.gripperLabel=t.gripperLabel,this.manageColumnsContextMenuAriaLabel=t.manageColumnsContextMenuAriaLabel,this.toolbarLabel=n.applyParameters(t.toolbarLabel,{gridName:e.gridName}),this.K(e),this.Q(e),this.W(),this.Y(i,e),this.Z(e),this.$(),this.tt(e.actionMenu),this.it()},m.prototype.K=function(t){this.st=this.ht();var e=this.st.id;"string"==typeof e&&0<e.length?this.gridId=e:this.st.id=this.gridId,this.nt=this.ot(this.st),this.et=r.hasCapability(this.nt,r.HIDE_SHOW_COLUMNS),this.rt=r.hasCapability(this.nt,r.MULTI_COLUMN_SORT),this.renderQBE=t.filterShown&&r.hasCapability(this.nt,r.QUERY_BY_EXAMPLE)&&this.nt.hasConfiguredFilters(this.st),this.at=r.hasCapability(this.nt,r.EXPORT_TO_EXCEL)},m.prototype.ht=function(){return e(this.X.element).find("[slot='grid']").get(0)},m.prototype.ot=function(t){var e;switch(t.tagName.toUpperCase()){case m.GRID_TAG_JET_DATA_GRID:e=h;break;case m.GRID_TAG_JRAF_SIMPLE_GRID:e=l;break;case m.GRID_TAG_LUX_GRID:e=u;break;default:e=null}if(e)return e;throw new Error("oj-rgbu-jraf-apps-table: A JET Data Grid element, LUX Grid CCA, or oj-rgbu-jraf-simple-grid must be supplied in the grid slot.")},m.prototype.Q=function(t){var e=Array.isArray(t.columns),i="object"==typeof t.lux&&null!==t.lux&&Array.isArray(t.lux.columns)&&"object"==typeof t.lux.columnDefs&&null!==t.lux.columnDefs;if(this.ut=e||i,this.renderColumnManagement=this.ut&&this.et,this.ct=[],e)this.ct=t.columns.map((function(t){return this.ft(t)}),this);else if(i){var n=t.lux,o=n.columns,a=n.columnDefs;this.ct=o.filter((function(t){return a[t]})).map((function(t){return this.lt(t,a[t])}),this)}this.renderColumnManagement&&this.dt()},m.prototype.dt=function(){this.bt(),this.vt()},m.prototype.bt=function(){var t=this;this.beforeColumnManagementDialogOpen=function(){t.pt()},this.handleColumnManagementDialogClose=function(e){t.mt(e)},this.resetColumnsToDefaults=function(){t.jt()},this.cancelColumnChanges=function(){t.gt()},this.applyColumnChanges=function(){t._t()},this.handleColumnReorder=function(e){t.wt(e)}},m.prototype.vt=function(){this.columnManagementDataSource=t.observable(),this.yt=this.kt(this.ct),this.columnManagementCurrentItem=t.observable(),this.columnManagementExpandedKeySet=new p.ExpandAllKeySet,this.isColumnManagementListItemFocusable=function(t){return t.leaf},this.At(this.yt)},m.prototype.kt=function(e){return e.map((function(e,i){var n="boolean"!=typeof e.shown||e.shown;return{attr:{id:this.columnManagementListItemIdPrefix+i,value:e.value,label:e.label,shown:t.observable(n)}}}),this)},m.prototype.Dt=function(t){return t.map((function(t){var e=t.attr;return{value:e.value,label:e.label,shown:e.shown()}}))},m.prototype.Mt=function(t){return new i.JsonTreeDataSource([{attr:{id:this.columnManagementListItemIdPrefix+"_heading",label:this.manageColumnsLabel},children:t}])},m.prototype.At=function(t){this.Ct=this.Dt(t),this.Lt(t)},m.prototype.Lt=function(t){this.yt=t,this.columnManagementDataSource(this.Mt(t))},m.prototype.ft=function(t){return{value:t.valueName,label:t.label||t.valueName,sortable:"boolean"!=typeof t.sortable||t.sortable,shown:"boolean"!=typeof t.shown||t.shown}},m.prototype.lt=function(t,e){return{value:t,label:e.title||t,sortable:"boolean"==typeof e.sortable&&e.sortable}},m.prototype.It=function(){var e=this;this.detachButtonSetValue=t.observableArray([]),this.detachValue="detach",this.detachMenuItemLabel=t.pureComputed((function(){return 0<this.detachButtonSetValue().length?this.attachButtonLabel:this.detachButtonLabel}),this),this.detachButtonSetValue.subscribe((function(){e.Et()})),this.handleDetachDialogClose=function(t){return e.Gt(t)},this.handleDetachDialogResized=function(t){e.xt(t)}},m.prototype.Rt=function(){0<this.detachButtonSetValue().length?this.detachButtonSetValue([]):this.detachButtonSetValue([this.detachValue])},m.prototype.Et=function(){if(0!==this.detachButtonSetValue().length){var t=this;this.Tt(this.toolbarId,(function(){t.Ot()}))}else this.Jt(this.detachDialogId)},m.prototype.Ot=function(){var t=document.getElementById(this.appTableId);o.subtreeDetached(t),document.getElementById(this.dialogAnchorId).appendChild(t),o.subtreeAttached(t),document.getElementById(this.detachDialogId).open(),this.nt.handleDetached(this.st)},m.prototype.Jt=function(t){return this.Tt(t,(function(){var e=document.getElementById(t);e.isOpen()&&e.close()}))},m.prototype.Tt=function(t,e){var i=document.getElementById(t);return a.getContext(i).getBusyContext().whenReady(1e3).then((function(){e()}))},m.prototype.Gt=function(t){if(t.target!==document.getElementById(this.detachDialogId))return!1;var e=document.getElementById(this.appTableId);o.subtreeDetached(e),document.getElementById(this.wrapperId).appendChild(e),o.subtreeAttached(e),0<this.detachButtonSetValue().length&&this.detachButtonSetValue.pop(),this.nt.handleAttached(this.st)},m.prototype.xt=function(t){this.nt.handleDetachDialogResized(this.st)},m.prototype.Bt=function(){var e=this;this.filtersEnabledVal="enabled";var i=this.renderQBE&&this.nt.isFilterInitiallyShown(this.st)?[this.filtersEnabledVal]:[];this.filtersSelection=t.observableArray(i),this.Pt=t.pureComputed((function(){return 0<this.filtersSelection().length}),this),this.Pt.subscribe((function(){e.St()}))},m.prototype.Ut=function(){this.Pt()?this.filtersSelection.removeAll():this.filtersSelection([this.filtersEnabledVal]),this.Vt()},m.prototype.Vt=function(){document.getElementById(this.viewMenuId).refresh()},m.prototype.St=function(){this.Pt()?this.nt.showFilters(this.st):this.nt.hideFilters(this.st)},m.prototype.W=function(){if(this.rt){var e=this;this.closeSortDialog=function(){e.qt()},this.executeSortDialog=function(){e.Ht()},this.sortCriteria=[];for(var i=0;i<m.SORTS_LIMIT;i++)this.sortCriteria.push({label:0===i?this.sortByFirstLabel:this.sortByLaterLabel,column:t.observable(),direction:t.observable("asc")});this.sortableColumns=this.nt.getSortableColumns(this.st,this.ct),this.renderSorting=0<this.sortableColumns.length,this.sortableColumnsDataProvider=new d(this.sortableColumns,{keyAttributes:"value"})}else this.renderSorting=!1},m.prototype.Xt=function(){this.Ft(this.nt.getSortCriteria(this.st)),document.getElementById(this.sortDialogId).open()},m.prototype.Ft=function(t){for(var e=Math.min(t.length,m.SORTS_LIMIT),i=0;i<e;i++){var n=t[i],o=this.sortCriteria[i];o.column(n.column),o.direction(n.direction)}for(i=e;i<this.sortCriteria.length;i++)this.sortCriteria[i].column(null),this.sortCriteria[i].direction("asc")},m.prototype.qt=function(){document.getElementById(this.sortDialogId).close()},m.prototype.Ht=function(){var t=this.Nt();this.nt.executeSort(this.st,t),this.qt()},m.prototype.Nt=function(){for(var t=[],e=this.sortCriteria,i=0;i<e.length;){var n=e[i].column(),o=e[i].direction();n&&t.push({column:n,direction:o}),i++}return t},m.prototype.zt=function(){document.getElementById(this.columnManagementDialogId).open()},m.prototype.gt=function(){document.getElementById(this.columnManagementDialogId).close()},m.prototype.pt=function(){this.Kt=!0;var t=this.nt.getColumnConfiguration(this.st,this.Ct),e=this.kt(t);this.At(e)},m.prototype.mt=function(t){t.target.id===this.columnManagementDialogId&&(this.Kt&&(this.yt=this.kt(this.Ct)),this.At(this.yt))},m.prototype.jt=function(){var t=this.kt(this.ct);this.Lt(t)},m.prototype._t=function(){this.Kt=!1,this.Qt(this.yt),this.gt()},m.prototype.wt=function(t){for(var e=this,i=function(t){e.Wt(t)},n=document.getElementById(this.columnManagementListViewId),o=n.getContextByNode(t.detail.reference),a=t.detail.items,s=0;s<a.length;s++){var r,l=n.getContextByNode(a[s]);s===a.length-1&&(r={success:i}),this.columnManagementDataSource().move(l.key,o.key,t.detail.position,r)}},m.prototype.Wt=function(t){var e=document.getElementById(this.columnManagementListViewId),i=t.children;1===i.length&&(this.yt=this.Yt(i[0].children)),e.refresh();var n=this,o=e.currentItem;this.Tt(this.columnManagementListViewId,(function(){e.currentItem=o,document.getElementById(n.columnManagementListViewId).focus()}))},m.prototype.Yt=function(t){return t.map((function(t){return{attr:{id:t.attr.id,value:t.attr.value,label:t.attr.label,shown:t.attr.shown}}}),this)},m.prototype.Qt=function(t){var e=this.Dt(t);this.nt.applyColumnConfiguration(this.st,e)},m.prototype.tt=function(t){this.Zt(t),this.$t(),this.renderQBE&&this.ti()},m.prototype.Zt=function(t){var e=this,i=0<this.ii.length,n=t||[],o=0<n.length;if(this.renderActionMenu=i||o,this.renderActionMenu){var a=i&&o?[{separator:!0}]:[],s=this.ii.concat(a,n);this.actionMenuItems=this.si(this.actionMenuId,s),this.actionMenuSelect=function(t){e.hi(e.actionMenuItems,t.target)}}},m.prototype.$t=function(){var e=this,i=[];this.renderColumnManagement&&i.push({label:this.manageColumnsLabel,callback:function(){e.zt()}}),i.push({label:this.detachMenuItemLabel,callback:function(){e.Rt()}}),this.ut&&this.renderSorting&&i.push({label:this.sortMenuLabel,callback:function(){e.Xt()}}),this.renderQBE&&i.push({label:this.queryLabel,callback:function(){e.Ut()},ariaLabel:t.pureComputed((function(){return this.Pt()?this.enabled:""}),this),selected:t.pureComputed((function(){return{"oj-menu-item-icon":this.Pt(),"oj-rgbu-jraf-apps-table-checked-icon":this.Pt()}}),this)}),this.viewMenuItems=this.si(this.viewMenuId,i),this.viewMenuSelect=function(t){e.hi(e.viewMenuItems,t.target)},this.viewMenuAnimateListener=function(t){e.ni(t)}},m.prototype.si=function(t,e){if(!e||!e.length)return null;for(var i=[],n=0;n<e.length;n++){var o=t+m.MENU_VALUE_SEPARATOR+(n+1),a={id:o,label:e[n].label,callback:e[n].callback,icon:e[n].icon,disabled:e[n].disabled,ariaLabel:e[n].ariaLabel,selected:e[n].selected,separator:e[n].separator,children:this.si(o,e[n].children)};i.push(a)}return i},m.prototype.hi=function(t,e){var i=e.value.split(m.MENU_VALUE_SEPARATOR),n=2<i.length,o=t[parseInt(i[1],10)-1];(n?o.children[parseInt(i[2],10)-1]:o).callback(e)},m.prototype.ni=function(t){"close"===t.detail.action&&(t.preventDefault(),s.fadeOut(t.detail.element,{duration:"200ms"}).then(t.detail.endCallback))},m.prototype.ti=function(){var e=this;this.filterMatchOptionsShown=this.X.properties.filterMatchOptionsShown,this.filterMatchType=t.observable(this.nt.getFilterMatchType(this.st)),this.filterMenuSelect=function(t){e.oi(t)}},m.prototype.oi=function(t){var e=t.target.value;e===m.FILTER_MENU_OPTIONS_CLEAR_FILTER?this.nt.clearFilters(this.st):e===m.FILTER_MENU_OPTIONS_MATCH_TYPE_AND?(this.filterMatchType(m.FILTER_MATCH_TYPE_AND),this.nt.setFilterMatchType(this.st,m.FILTER_MATCH_TYPE_AND)):e===m.FILTER_MENU_OPTIONS_MATCH_TYPE_OR&&(this.filterMatchType(m.FILTER_MATCH_TYPE_OR),this.nt.setFilterMatchType(this.st,m.FILTER_MATCH_TYPE_OR))},m.prototype.Y=function(t,e){var i={hadCrudAction:!(this.createIcon={"oj-icon":!0,"oj-rgbu-jraf-apps-table-create-icon":!t,"oj-rgbu-jraf-apps-table-add-icon":t}),hadOtherStandardAction:!1,addedActionsMenuSeparator:!1};this.ii=[],m.STANDARD_ACTIONS.forEach((function(t){this.ei(t,e,i)}),this),this.hasCrud=!!i.hadCrudAction,this.ri(e),this.Bt(),this.It(),this.hasOtherStandardActions=!(!(this.handleRefresh||this.renderExportButton||this.renderQBE)&&e.hideDetachButton)},m.prototype.ei=function(e,i,n){var o="handle"+e;if(this[o]="function"==typeof i[o]&&i[o],"Refresh"!==e&&"Export"!==e?n.hadCrudAction=n.hadCrudAction||this[o]:n.hadOtherStandardAction=n.hadOtherStandardAction||this[o],n.hadCrudAction&&n.hadOtherStandardAction&&!n.addedActionsMenuSeparator&&(this.ii.push({separator:!0}),n.addedActionsMenuSeparator=!0),this[o]){var a="disable"+e,s=e.toLowerCase()+"ButtonLabel";this[a]=t.observable(i[a]||!1),this.ii.push({disabled:this[a],label:this[s],callback:this[o]})}},m.prototype.ri=function(t){var e=this;this.ai=t.enableDefaultExport;var i=this.ai&&this.at;return this.renderExportButton=i||this.handleExport,this.renderExportMenu=i&&this.handleExport,this.renderExportMenu?(this.exportMenuItems=this.ui(),this.exportMenuSelect=function(t){e.hi(e.exportMenuItems,t.target)},void this.ci(void 0,this.exportMenuItems)):this.renderExportButton?(this.invokeExportHandler=function(){e.handleExport?e.handleExport():e.fi()},void this.ci(this.invokeExportHandler)):void 0},m.prototype.ci=function(t,e){var i=this.ii.filter((function(t){return t.label===this.exportButtonLabel}),this);1===i.length&&(i[0].callback=t,i[0].children=e)},m.prototype.ui=function(){var t=this;return this.si(this.exportMenuId,[{label:this.exportVisible,callback:function(){t.fi()}},{label:this.exportAll,callback:function(){t.handleExport()}}])},m.prototype.fi=function(){this.nt.exportToExcel(this.st)},m.prototype.Z=function(t){this.customButtons=t.extraButtons?this.li(t.extraButtons):[],this.hasCustomButtons=0<this.customButtons.length},m.prototype.$=function(){this.hasExtraControls=0<this.X.slotCounts.extraControls},m.prototype.li=function(t){for(var e=[],i=0;i<t.length;i++)e.push(this.di(t[i]));return e},m.prototype.di=function(e){return{label:e.label,startIcon:e.icon?"oj-icon "+e.icon:"",display:e.iconOnly?"icons":"all",disabled:"boolean"==typeof t.unwrap(e.disabled)&&e.disabled,buttonHandler:e.buttonHandler}},m.prototype.it=function(){this.bi().filter(this.vi,this).forEach(this.pi,this)},m.prototype.bi=function(){var t=this.mi();return this.renderActionMenu&&(t=t.concat(this.ji("actionMenuItems"))),this.hasCustomButtons&&(t=t.concat(this.ji("customButtons"))),t},m.prototype.mi=function(){return m.CHANGEABLE_PROPERTIES.map((function(t){return this[t]}),this)},m.prototype.ji=function(t){return this[t].map((function(t){return t.disabled}))},m.prototype.vi=function(e){return t.isObservable(e)},m.prototype.pi=function(t){var e=this;t.subscribe((function(){e.gi()}))},m.prototype.gi=function(){document.getElementById(this.toolbarId).refresh()},m.prototype.propertyChanged=function(t){var e=t.property;"external"===t.updatedFrom&&0<=m.CHANGEABLE_PROPERTIES.indexOf(e)&&this[e](t.value)},m}));