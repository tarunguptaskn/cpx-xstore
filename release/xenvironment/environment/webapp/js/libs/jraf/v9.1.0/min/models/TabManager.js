define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/models/Content","jraf/models/TabState","jraf/models/TabStateService","jraf/models/ModalPageManager","jraf/utils/RouterUtils","jraf/utils/ValidationUtils","ojs/ojcorerouter","ojs/ojrouter","ojs/ojnavigationlist","ojs/ojswitcher"],(function(t,e,n,o,a,i,r,s,h,l,d){"use strict";function u(n){var o=this;if(!(l.isObjectStrict(n)&&l.isNonemptyString(n.tabBarComponentId)&&l.isNonemptyString(n.switcherComponentId)&&l.isNonemptyString(n.maxTabsDialogId)&&e.isObservable(n.activeTab)&&e.isObservable(n.tabsData))){var a="TabManager: Invalid configuration passed to TabManager.";throw t.Logger.error(a),new TypeError(a)}this.tabCounter=0,this.Th(),this.activeTab=n.activeTab,this.activeTab.subscribe((function(t){o.Eh(t),o.Bh instanceof d?o.Bh.go({path:t}):o.Bh.go(t)})),this.maxTabsDialogId=n.maxTabsDialogId,this.maxTabCount=l.isNumberStrict(n.maxTabCount)?n.maxTabCount:15,this.tabBarComponentId=n.tabBarComponentId,this.switcherComponentId=n.switcherComponentId,this.tabsData=n.tabsData,this.ul=n.beforeLoadModuleHandler,this.fl=n.afterUnloadModuleHandler,this.tabBarComponent=null,this.switcherComponent=null,this.openTabs={}}return u.STATUS_ICON_CLASSES={info:"jraf-tabbar-status jraf-tabbar-info",warning:"jraf-tabbar-status jraf-tabbar-warning",error:"jraf-tabbar-status jraf-tabbar-error",success:"jraf-tabbar-status jraf-tabbar-success"},u.prototype.Th=function(){var e=this,n=o.App.getRootRouter();n?(this.Bh=n.createChildRouter([{path:/.*/}]),this.Bh.currentState.subscribe((function(t){var n=t.state;if(n){var o=n.path;e.Dh(o)&&e.setActiveTab(o)}}))):(this.Bh=h.createChildRouterForCurrentState().configure((function(e){return e?new t.RouterState(e,{value:e}):void 0})),this.Bh.stateId.subscribe((function(t){e.Dh(t)?e.setActiveTab(t):e.Bh.direction?window.history.back():window.history.forward()})))},u.prototype.getOjTabBarComponent=function(){if(!this.tabBarComponent){if(this.tabBarComponent=document.getElementById(this.tabBarComponentId),!this.tabBarComponent){var e="TabManager.getOjTabBarComponent: Could not find tab bar component identified by: "+this.tabBarComponentId;throw t.Logger.error(e),new Error(e)}var n=this;this.tabBarComponent.onOjBeforeDeselect=function(t){return n.handleTabBeforeDeselectEvent(t)},this.tabBarComponent.onOjDeselect=function(t){n.handleTabDeselectEvent(t)},this.tabBarComponent.onOjBeforeSelect=function(t){return n.handleTabBeforeSelectEvent(t)},this.tabBarComponent.onSelectionChanged=function(t){n.handleTabSelectEvent(t)},this.tabBarComponent.onOjBeforeRemove=function(t){return n.handleTabBeforeRemoveEvent(t)},this.tabBarComponent.onOjRemove=function(t){n.handleTabRemoveEvent(t)},this.tabBarComponent.onOjAnimateStart=function(t){n.Oh(t)}}return this.tabBarComponent},u.prototype.qh=function(){if(this.switcherComponent||(this.switcherComponent=document.getElementById(this.switcherComponentId),this.switcherComponent))return this.switcherComponent;var e="TabManager._getOjSwitcherComponent: Could not find switcher component identified by: "+this.switcherComponentId;throw t.Logger.error(e),new Error(e)},u.prototype.setActiveTab=function(t){this.activeTab(t)},u.prototype.getActiveTab=function(){return this.activeTab()},u.prototype.Eh=function(e){if(t.Logger.info("TabManager._handleActiveTabChange: Entering (%s).",e),e){var n=this.Rh(e);this.xh(n.uniqueContentId),n.initialDisplay?n.initialDisplay=!1:(this.Hh(n.uniqueContentId,null),n.content.isRefreshOnDisclosure()&&this.Kh(n))}},u.prototype.xh=function(e){var o=this.getTabTitleId(e);return t.Context.getContext(this.getOjTabBarComponent()).getBusyContext().whenReady().then((function(){n("#"+o)[0].scrollIntoView(!1)}))},u.prototype.handleTabBeforeDeselectEvent=function(t){if(this.Lh(t)&&this.Dh(t.detail.fromKey)){var e=t.detail.fromKey,n=this.Rh(e),o=this.zh(t),a=this.Jh("uiShellBeforeDeselect",t,o,n.contentId,!0);return!1===a||t.defaultPrevented?(t.detail.fromItem.focus(),this.Qh(t),!1):a}},u.prototype.Dh=function(t){return l.isArray(t)&&(t=t[0]),!!t&&null!==this.findOpenTabReference(t)},u.prototype.Qh=function(t){t.defaultPrevented||t.preventDefault()},u.prototype.handleTabDeselectEvent=function(t){if(this.Lh(t)&&this.Dh(t.detail.fromKey)){var e=t.detail.fromKey,n=this.Rh(e),o=this.zh(t);this.Jh("uiShellDeselect",t,o,n.contentId,void 0)}},u.prototype.handleTabBeforeSelectEvent=function(t){if(this.Lh(t)&&this.Dh(t.detail.key)){var e=document.querySelector("#"+this.getActiveTab());e&&e.blur();var n=t.detail.key,o=this.Rh(n),a=this.zh(t),i=this.Jh("uiShellBeforeSelect",t,a,o.contentId,!0);return!1===i||t.defaultPrevented?(e&&e.focus(),this.Qh(t),!1):i}},u.prototype.handleTabSelectEvent=function(t){if(this.Lh(t)&&this.Dh(t.detail.value)){var e=t.detail.value,o=this.Rh(e),a=this.zh(t);this.Jh("uiShellSelect",t,a,o.contentId,void 0);var i=n(t.detail.item);this.Hl(this.Wh(i))}},u.prototype.Wh=function(t){return t.find("span").text()},u.prototype.Hl=function(t){n(window.document).trigger("jrafcontentchange",[{title:t}])},u.prototype.handleTabBeforeRemoveEvent=function(e){if(this.Lh(e)&&this.Dh(e.detail.key)){var n=e.detail.key,o=this.Xh(n),a=this.Rh(n),i=this.zh(e),r=this.Yh(o.contentKey,o.tabIndex),s=r.handleBeforeCloseAll(e,i);if(!1===s||e.defaultPrevented)return this.Qh(e),s;var h=this.Jh("uiShellBeforeClose",e,i,a.contentId,!0);return!1===h||e.defaultPrevented?(this.Qh(e),!1):(t.Logger.info("TabManager.handleTabBeforeRemoveEvent: Cleaning up tab."),r.dispose(),h)}},u.prototype.handleTabRemoveEvent=function(t){if(this.Lh(t)&&this.Dh(t.detail.key)){var n=t.detail.key,o=this.Xh(n),a=o.contentKey,i=this.Rh(n),r=this.zh(t);1<this.openTabs[a].length?this.openTabs[a].splice(o.tabIndex,1):delete this.openTabs[a],this.Jh("uiShellClose",t,r,i.contentId,void 0),this.Zh(n);var s=document.getElementById(i.contentId);e.cleanNode(s),this.tabsData.remove((function(t){return t.tabId===n})),this.$h(),0===this.getOpenTabCount()&&this.Hl("")}},u.prototype.Zh=function(t){var e=this;this.getActiveTab()===t&&this.tabsData().some((function(n,o){if(n.tabId===t)return e.Tf(o),!0}),this)},u.prototype.Tf=function(e){var n=this,o=e<this.tabsData().length-1?this.tabsData()[e+1].tabId:0<e?this.tabsData()[e-1].tabId:null;t.Context.getContext(this.getOjTabBarComponent()).getBusyContext().whenReady().then((function(){n.setActiveTab(o),n.getOjTabBarComponent().focus()}))},u.prototype.Xh=function(t){var e=this.findOpenTabReference(t);if(null!==e)return e;throw new Error("TabManager._requireOpenTabReference: Could not find tab: "+t)},u.prototype.Oh=function(t){this.Lh(t)&&(t.preventDefault(),t.detail.endCallback())},u.prototype.Yh=function(t,n){var o=this.openTabs[t];if(!Array.isArray(o)||0===o.length||n>=o.length)throw new Error("TabManager._getModalPageManager: cannot find data for "+t+"["+n+"].");var a=o[-1===n?o.length-1:n];return e.isObservable(a.viewModel.moduleBinding)?a.viewModel.moduleBinding().params.jraf.modalPageManager:a.viewModel.moduleOptions().params.jraf.modalPageManager},u.prototype.findOpenTabReference=function(t){for(var e in this.openTabs)for(var n=this.openTabs[e],o=0;o<n.length;o++)if(t===n[o].tabId)return{contentKey:e,tabIndex:o};return null},u.prototype.Rh=function(t){l.isArray(t)&&(t=t[0]);var e=this.findOpenTabReference(t);if(null===e)throw new Error("TabManager._getOpenTabData: Could not find data for tab: "+t);return this.openTabs[e.contentKey][e.tabIndex]},u.prototype.generateUniqueContentId=function(){return this.tabCounter++,this.tabCounter.toString()},u.prototype.getTabTitleId=function(t){if(!t)throw new Error("Invalid content ID passed to getTabTitleId.");return"jraf-main-content-tab-"+t},u.prototype.getTabContentId=function(t){if(!t)throw new Error("Invalid content ID passed to getTabContentId.");return"jraf-main-content-tab-content-"+t},u.prototype.Mf=function(t){if(!t)throw new TypeError("TabManager._getModalPageContainerId: Invalid content ID.");return"jraf-main-content-tab-content-modal-page-container-"+t},u.prototype.getOpenTabCount=function(){var t=0;for(var e in this.openTabs)t+=this.openTabs[e].length;return t},u.prototype.openModalPageInContent=function(t,e){this.openContent(e);var n=e.isReuseInstance()?0:-1;this.Yh(e.getContentKey(),n).openContent(t)},u.prototype.Cf=function(t,e){var n=this.getTabTitleId(t),o=this.Rh(n);o.displayProcessing(e),e?o.processing(e):window.setTimeout((function(){o.processing(e)}),250)},u.prototype.Hh=function(t,e){var n=this.getTabTitleId(t),o=this.Rh(n),a=u.STATUS_ICON_CLASSES[e]||null;n===this.activeTab()&&(a=null),o.displayStatus(a),a?o.statusClass(a):window.setTimeout((function(){o.statusClass(a)}),250)},u.prototype.handleSnackbarStatus=function(t,e){var n=t.detail,o=e.data.uniqueContentId;this.Hh(o,n)},u.prototype.openContent=function(e){if(!(e instanceof a)){var n="TabManager.openContent was not passed a Content instance.";throw t.Logger.error(n),new Error(n)}if(!this.shouldShowExistingTab(e))return this.getOpenTabCount()===this.maxTabCount?(t.Logger.warn("TabManager.openContent: Maximum number of tabs are open."),void this.openMaxTabsMessageDialog()):void this.addNewTab(e);this.showTab(e)},u.prototype.openMaxTabsMessageDialog=function(){document.getElementById(this.maxTabsDialogId).open()},u.prototype.shouldShowExistingTab=function(t){return!!t.isReuseInstance()&&this.isContentOpenInTabs(t)},u.prototype.isContentOpenInTabs=function(t){var e=t.getContentKey(),n=this.openTabs[e];return l.isArray(n)&&0<n.length},u.prototype.isTabRemovable=function(t){return this.Rh(t).content.isRemovable()},u.prototype.getViewModel=function(t,o){if(o.hasModuleOptions()){var a=o.getModuleOptions(),i=n.extend(!0,{},a,{params:this.If(t)});return{moduleOptions:e.observable(i)}}var r=o.getModuleBinding(),s=n.extend(!0,{},r,{params:this.If(t)});return{moduleBinding:e.observable(s)}},u.prototype.If=function(t){var e=this;return{jraf:{uniqueContentId:t,refreshCount:0,modalPageManager:this.Ef(t),startTabProcessingIndicator:function(){e.Cf(t,!0)},stopTabProcessingIndicator:function(){e.Cf(t,!1)}}}},u.prototype.Ef=function(t){return new s({modalPageContainerId:this.Mf(t),beforeLoadModuleHandler:this.ul,afterUnloadModuleHandler:this.fl})},u.prototype.addNewTab=function(t){var e=this.generateUniqueContentId(),n=this.getViewModel(e,t);this.openTab(e,t,n)},u.prototype.openTab=function(t,n,o){var a=this.getTabTitleId(t),i={uniqueContentId:t,tabId:a,contentId:this.getTabContentId(t),modalPageContainerId:this.Mf(t),content:n,viewModel:o,initialDisplay:!0,displayProcessing:e.observable(null),processing:e.observable(!1),displayStatus:e.observable(null),statusClass:e.observable(null),removable:l.getBoolean(n.isRemovable(),!0)};this.addOpenTabState(n.getContentKey(),i),this.tabsData.push(i),this.setActiveTab(a),this.getOjTabBarComponent().refresh(),this.qh().refresh(),this.$h()},u.prototype.addOpenTabState=function(t,e){l.isArray(this.openTabs[t])||(this.openTabs[t]=[]),this.openTabs[t].push(e)},u.prototype.showTab=function(e){var n=e.getContentKey(),o=this.openTabs[n];if(!l.isArray(o)||0===o.length){var a="TabManager.showTab: Could not find open tab reference for contentKey: "+n;throw t.Logger.error(a),new Error(a)}var i=o[0].tabId;t.Logger.info("TabManager.showTab - showing tab: "+i),e.isReloadTab()&&this.Kh(o[0],e),this.setActiveTab(i)},u.prototype.closeContent=function(e){if(e instanceof a){var n=e.getContentKey(),o=this.openTabs[n];if(!l.isArray(o)){var i="TabManager.closeContent could not find any tabs opened for content: "+n;return void t.Logger.warn(i)}var r,s=[];for(r=0;r<o.length;r++)s.push(o[r].tabId);for(r=0;r<s.length;r++)this.closeTab(s[r])}else{var h=this.getActiveTab();null!==h&&this.closeTab(h)}},u.prototype.closeTab=function(t){var e=document.querySelector("#"+t+" > a.oj-tabbar-remove-icon");e&&e.click()},u.prototype.Kh=function(o,i){if(t.Logger.info("TabManager._refreshTabContent: Entering."),"object"!=typeof o||null===o||"object"!=typeof o.viewModel||null===o.viewModel||!e.isObservable(o.viewModel.moduleBinding)&&!e.isObservable(o.viewModel.moduleOptions))throw new TypeError("TabManager._refreshTabContent: Invalid openTabData.");if(e.isObservable(o.viewModel.moduleBinding)){var r=o.viewModel.moduleBinding();r.params.jraf.refreshCount++;var s=i instanceof a?s=n.extend(!0,{},r,i.getModuleBinding()):r;o.viewModel.moduleBinding(s)}else if(e.isObservable(o.viewModel.moduleOptions)){var h=o.viewModel.moduleOptions();h.params.jraf.refreshCount++;var l=i instanceof a?n.extend(!0,{},h,i.getModuleOptions()):h;o.viewModel.moduleOptions(l)}},u.prototype.Lh=function(e){return e.target&&e.target.id&&e.currentTarget&&e.currentTarget.id?e.target.id===e.currentTarget.id||(t.Logger.info("TabManager._isOjTabBarEvent: Ignoring event from different origin %s",e.target.id),!1):(t.Logger.info("TabManager._isOjTabBarEvent: Ignoring event since no event target was provided."),!1)},u.prototype.Sf=function(t){if(!l.isNonemptyString(t))throw new TypeError("TabManager._getTabContentAppsModule: contentId is required");return n("#"+t).find("oj-rgbu-jraf-apps-module.jraf-global-tabs-tab-content-module").get(0)},u.prototype.Jh=function(t,e,n,o,a){return this.Sf(o).invokeModuleEventHandler(t,e,n,a)},u.prototype.zh=function(t){var e={};return t.detail.item&&t.detail.key&&(e.tab=n(t.detail.item),e.content=this._f(t.detail.key)),t.detail.fromKey&&t.detail.fromItem&&(e.fromTab=n(t.detail.fromItem),e.fromContent=this._f(t.detail.fromKey)),t.detail.toKey&&t.detail.toItem&&(e.toTab=n(t.detail.toItem),e.toContent=this._f(t.detail.toKey)),e},u.prototype._f=function(t){var e=this.Rh(t);return n("#"+e.contentId)},u.prototype.$h=function(){var e=this;t.Context.getContext(this.getOjTabBarComponent()).getBusyContext().whenReady().then((function(){r.save(e.Pf())}))},u.prototype.Pf=function(){var t=this;return n(this.getOjTabBarComponent()).find("li.jraf-tabs-uishell-tab").map((function(){var e=this.id,n=t.Rh(e).content;return i.fromContent(n)})).get()},u}));