define(["ojs/ojcore","jraf/jrafcore","jquery","knockout","jraf/models/UIShellConfig","jraf/models/ContentManager","jraf/models/PopupManager","jraf/models/TabManager","jraf/models/MenuManager","jraf/models/RegionManager","jraf/models/ModalPageManager","jraf/controllers/PopupMenuManager","jraf/controllers/MobileMenuManager","jraf/models/ProcessingIndicatorManager","jraf/services/ServiceManager","jraf/models/Content","jraf/utils/ValidationUtils"],(function(e,n,a,r,t,o,i,g,s,l,M,c,u,p,f,d,_){"use strict";function h(n){if(e.Logger.info("UIShellManager: entering constructor function."),!(n instanceof t))throw new TypeError("UIShellManager: configuration must be UIShellConfig");this._uiShellConfig=n,this._tabManager=null,this._popupManager=null,this._regionManager=null,this._contentManagerDeferred=a.Deferred(),this._contentManagerInitialized=this._contentManagerDeferred.promise(),this._contentManager=null,this._menuManagerDeferred=a.Deferred(),this._menuManagerInitialized=this._menuManagerDeferred.promise(),this._menuManager=null,this._popupMenuManagerDeferred=a.Deferred(),this._popupMenuManagerInitialized=this._popupMenuManagerDeferred.promise(),this._popupMenuManager=null,this._mobileMenuManagerDeferred=a.Deferred(),this._mobileMenuManagerInitialized=this._mobileMenuManagerDeferred.promise(),this._mobileMenuManager=null,this._renderProcessingIndicator=this._uiShellConfig.getHeaderConfig().isRenderProcessingIndicator(),this._processingIndicatorDeferred=a.Deferred(),this._processingIndicatorInitialized=this._processingIndicatorDeferred.promise(),this._processingIndicatorManager=null,this._globalToasterDeferred=a.Deferred(),this._globalToasterInitialized=this._globalToasterDeferred.promise(),this._globalToasterId=null,this._callbackRegistry={},this._dataPromises={};var r=this._uiShellConfig.getNavigationConfig();_.isFunction(r.getBeforeOpenContentHandler())?this._beforeOpenContentHandler=r.getBeforeOpenContentHandler():this._beforeOpenContentHandler=function(e){return Promise.resolve(e)}}return"object"!=typeof n._UIShellManager&&(n._UIShellManager={}),h.registerDataPromise=function(e,n){if(!(_.isNonemptyString(e)&&n instanceof Promise))throw new TypeError("UIShellManager.registerDataPromise: Invalid input.");h._getActiveInstance()._dataPromises[e]=n},h.getDataPromise=function(e){return h._getActiveInstance()._dataPromises[e]},h.openContent=function(e){return h._openContentWhenReady(e)},h.openModalPageInContent=function(e,n){if(!e.isContextualModalPageContent())throw new TypeError("UIShellManager.openModalPageInContent: modalPageContent must target a contextual modal page.");if(!n.isMainAreaContent())throw new TypeError("UIShellManager.openModalPageInContent: parentContent must target the main area.");return h._openContentWhenReady(e,n)},h._openContentWhenReady=function(e,n){var a=h._getActiveInstance();return Promise.all([a._contentManagerInitialized,a._globalToasterInitialized]).then((function(){return h.startProcessingIndicator(),a._invokeBeforeOpenContentHandler(e,n)}))},h.prototype._invokeBeforeOpenContentHandler=function(e,n){var a=this,r=[this._beforeOpenContentHandler(e)];return n instanceof d&&r.push(this._beforeOpenContentHandler(n)),Promise.all(r).then((function(e){if(2===e.length){var n=e[0],r=e[1],t=n instanceof d,o=r instanceof d;if(o&&r.isMainAreaContent()&&t&&n.isContextualModalPageContent())return a._openContent(r,n);if(!o&&a._isToastConfiguration(e[1]))return h.stopProcessingIndicator(),a._openToast(e[1]);throw h.stopProcessingIndicator(),new TypeError("UIShellManager._invokeBeforeOpenContentHandler: beforeOpenContentHandler returned unsupported scenario on UIShellManager.openModalPageInContent call.")}var i=e[0];if(i instanceof d)return a._openContent(i);if(a._isToastConfiguration(i))return h.stopProcessingIndicator(),a._openToast(i);throw h.stopProcessingIndicator(),new TypeError("UIShellManager._invokeBeforeOpenContentHandler: Callback did not return a Content object or toast configuration.")}),(function(e){throw h.stopProcessingIndicator(),new TypeError("UIShellManager._invokeBeforeOpenContentHandler: Handler rejected with reason ("+e+").")}))},h.prototype._isToastConfiguration=function(e){return _.isObjectStrict(e)&&_.isNonemptyString(e.severity)},h.prototype._openContent=function(n,a){var r=a instanceof d,t=[Promise.resolve(!0)],o=f.getAccessControlService();o&&_.isFunction(o.hasAccess)&&(t[0]=o.hasAccess(n),r&&t.push(o.hasAccess(a)));var i=this;return Promise.all(t).then((function(e){if(e[0]){if(r){var t=e[1]?a:i._getAccessDeniedContent(a);i._contentManager.openModalPageInContent(t,n)}else i._contentManager.openContent(n);h.stopProcessingIndicator()}else i._openAccessDeniedContent(n,!0)}),(function(a){e.Logger.warn("UIShellManager._openContent: Error checking access to content (%s)",a),i._openAccessDeniedContent(n,!0)}))},h.closeContent=function(e){var n=h._getActiveInstance();return n._contentManagerInitialized.then((function(){n._contentManager.closeContent(e)}))},h.openModuleAsDialog=function(e,n,a,r){var t=d.createDialogContent(e,n,a,r);this.openContent(t)},h.openModuleInDialog=function(e,n,a,r){var t=d.createModuleDialogContent(e,n,a,r);this.openContent(t)},h.openModuleAsTab=function(e,n){var a=d.createTabContent(e,n);this.openContent(a)},h.openModuleInTab=function(e,n){var a=d.createModuleTabContent(e,n);this.openContent(a)},h.openUrlAsTab=function(e,n,a,r){var t=d.createUrlTabContent(e,n,a,r);this.openContent(t)},h.closeContentDialog=function(){var e=h._getActiveInstance();return e._contentManagerInitialized.then((function(){return e._contentManager.closePopup()}))},h.closeGlobalModalPage=function(){var e=h._getActiveInstance();return e._contentManagerInitialized.then((function(){return e._contentManager.closeGlobalModalPage()}))},h.prototype._openAccessDeniedContent=function(e,n){var a=this._getAccessDeniedContent(e),r=this;this._contentManagerInitialized.then((function(){r._contentManager.openContent(a),n&&h.stopProcessingIndicator()}))},h.prototype._getAccessDeniedContent=function(e){var n=a.extend({},e.targetProperties,{showCloseIcon:!0,removable:!0});return n.targetType===d.CONTENT_TARGET_WINDOW&&(n.targetType=d.CONTENT_TARGET_MAIN_AREA),new d({title:e.getTitle(),targetProperties:n,resourceType:d.CONTENT_TYPE_MODULE,moduleBinding:{name:"jraf/UIShellAccessDenied"}})},h.openToast=function(e){var n=h._getActiveInstance();return n._globalToasterInitialized.then((function(){return n._openToast(e)}))},h.prototype._openToast=function(e){var n=document.getElementById(this._globalToasterId);if(n)return n.openToast(e)},h.isRenderProcessingIndicator=function(){return h._getActiveInstance()._renderProcessingIndicator},h.startProcessingIndicator=function(){var e=h._getActiveInstance();e._renderProcessingIndicator&&e._processingIndicatorInitialized.then((function(){e._processingIndicatorManager.startProcessing()}))},h.stopProcessingIndicator=function(){var e=h._getActiveInstance();e._renderProcessingIndicator&&e._processingIndicatorInitialized.then((function(){e._processingIndicatorManager.stopProcessing()}))},h.pinMenu=function(e){return"object"==typeof e&&null!==e||(e={}),e.displayMode=s.DISPLAY_MODE_PIN,h.openMenu(e)},h.overlayMenu=function(e){return"object"==typeof e&&null!==e||(e={}),e.displayMode=s.DISPLAY_MODE_OVERLAY,h.openMenu(e)},h.openMenu=function(n){if(e.Logger.info("UIShellManager.openMenu: Entering."),"object"!=typeof n||null===n||"string"!=typeof n.displayMode)throw new TypeError("UIShellManager.openMenu: Invalid menuConfig.");var a={displayMode:n.displayMode};"string"==typeof n.menuItemId&&n.menuItemId.length>0&&(a.menuItemId=n.menuItemId);var r=h._getActiveInstance();return new Promise((function(e,n){r._menuManagerInitialized.then((function(){r._menuManager.openMenu(a).then((function(n){e(n)})).catch((function(e){n(e)}))}))}))},h.closeMenu=function(n){e.Logger.info("UIShellManager.closeMenu: Entering.");var a=h._getActiveInstance();return a._mobileMenuManager&&h.closeMobileNavMenu(),new Promise((function(e,r){a._menuManagerInitialized.then((function(){a._menuManager.closeMenu(n).then((function(n){e(n)})).catch((function(e){r(e)}))}))}))},h.ResetMenu=function(){e.Logger.info("UIShellManager.ResetMenu: Entering.");var n=h._getActiveInstance();return n._menuManagerInitialized.then((function(){n._menuManager.resetMenu()}))},h.openPopupMenu=function(n){e.Logger.info("UIShellManager.openPopupMenu: Entering.");var a=h._getActiveInstance();return a._popupMenuManagerInitialized.then((function(){a._popupMenuManager.openMenu(n)}))},h.closePopupMenu=function(){e.Logger.info("UIShellManager.closePopupMenu: Entering.");var n=h._getActiveInstance();return n._mobileMenuManager&&h.closeMobileNavMenu(),n._popupMenuManagerInitialized.then((function(){n._popupMenuManager.closeMenu()}))},h.ResetPopupMenu=function(){e.Logger.info("UIShellManager.ResetPopupMenu: Entering.");var n=h._getActiveInstance();return n._popupMenuManagerInitialized.then((function(){n._popupMenuManager.resetMenu()}))},h.closeMobileNavMenu=function(){e.Logger.info("UIShellManager.closeMobileNavMenu: Entering.");var n=h._getActiveInstance();return n._mobileMenuManagerInitialized.then((function(){return n._mobileMenuManager.closeNavMenu()}))},h.closeMobileOptionsMenu=function(){e.Logger.info("UIShellManager.closeMobileOptionsMenu: Entering.");var n=h._getActiveInstance();return n._mobileMenuManagerInitialized.then((function(){return n._mobileMenuManager.closeOptionsMenu()}))},h.closeAllMenus=function(n){e.Logger.info("UIShellManager.closeAllMenus: Entering.");var a=h._getActiveInstance(),r=[];return a._menuManager&&r.push(a._menuManager.closeMenu(n)),a._popupMenuManager&&r.push(a._popupMenuManager.closeMenu()),a._mobileMenuManager&&(r.push(a._mobileMenuManager.closeNavMenu()),r.push(a._mobileMenuManager.closeOptionsMenu())),Promise.all(r)},h.registerCallback=function(e,n){var a=h._getActiveInstance();a&&(a._callbackRegistry[e]=n)},h.prototype._registerComponent=function(n){e.Logger.info("UIShellManager._registerComponent: registering "+n+"."),this._popupManager instanceof i&&(this._tabManager instanceof g||this._regionManager instanceof l)&&this._globalModalPageManager instanceof M&&null===this._contentManager&&(this._contentManager=new o({tabManager:this._tabManager,regionManager:this._regionManager,popupManager:this._popupManager,globalModalPageManager:this._globalModalPageManager}),this._contentManagerDeferred.resolve())},h.RegisterPopupManager=function(e){var n=h._getActiveInstance();if(this._popupManager instanceof i)throw new Error("UIShellManager.RegisterPopupManager: PopupManager has already been registered.");if(!(e instanceof i))throw new TypeError("UIShellManager.RegisterPopupManager: popupManager must be a PopupManager.");n._popupManager=e,n._registerComponent("_popupManagerRegistered")},h.RegisterGlobalModalPageManager=function(e){var n=h._getActiveInstance();if(this._globalModalPageManager instanceof M)throw new Error("UIShellManager.RegisterGlobalModalPageManager: ModalPageManager has already been registered.");if(!(e instanceof M))throw new TypeError("UIShellManager.RegisterGlobalModalPageManager: modalPageManager must be a ModalPageManager.");n._globalModalPageManager=e,n._registerComponent("_globalModalPageManagerRegistered")},h.RegisterGlobalToasterId=function(e){var n=h._getActiveInstance();if(_.isNonemptyString(n._globalToasterId))throw new Error("UIShellManager.RegisterGlobalToasterId: globalToasterId has already been registered.");if(!_.isNonemptyString(e))throw new TypeError("UIShellManager.RegisterGlobalToasterId: globalToasterId must be a non-empty string.");n._globalToasterId=e,n._globalToasterDeferred.resolve()},h.RegisterTabManager=function(e){var n=h._getActiveInstance();if(this._tabManager instanceof g)throw new Error("UIShellManager.RegisterTabManager: TabManager has already been registered.");if(!(e instanceof g))throw new TypeError("UIShellManager.RegisterTabManager: tabManager must be a TabManager.");n._tabManager=e,n._registerComponent("_tabManagerRegistered")},h.RegisterRegionManager=function(e){var n=h._getActiveInstance();if(this._regionManager instanceof l)throw new Error("UIShellManager.RegisterRegionManager: RegionManager has already been registered.");if(!(e instanceof l))throw new TypeError("UIShellManager.RegisterRegionManager: regionManager must be a RegionManager.");n._regionManager=e,n._registerComponent("_regionManagerRegistered")},h.RegisterMenuManager=function(n){e.Logger.info("UIShellManager.RegisterMenuManager: Entering.");var a=h._getActiveInstance();if(a._menuManager instanceof s)throw new Error("UIShellManager.RegisterMenuManager: A MenuManager has already been registered.");if(!(n instanceof s))throw new TypeError("UIShellManager.RegisterMenuManager: Invalid type for MenuManager.");a._menuManager=n,a._menuManagerDeferred.resolve()},h.RegisterPopupMenuManager=function(n){e.Logger.info("UIShellManager.RegisterMenuManager: Entering.");var a=h._getActiveInstance();if(a._popupMenuManager instanceof c)throw new Error("UIShellManager.RegisterPopupMenuManager: A PopupMenuManager has already been registered.");if(!(n instanceof c))throw new TypeError("UIShellManager.RegisterPopupMenuManager: Invalid type for PopupMenuManager.");a._popupMenuManager=n,a._popupMenuManagerDeferred.resolve()},h.RegisterMobileMenuManager=function(n){e.Logger.info("UIShellManager.RegisterMobileMenuManager: Entering.");var a=h._getActiveInstance();if(a._mobileMenuManager instanceof u)throw new Error("UIShellManager.RegisterMobileMenuManager: A MobileMenuManager has already been registered.");if(!(n instanceof u))throw new TypeError("UIShellManager.RegisterMobileMenuManager: Invalid type for MobileMenuManager.");a._mobileMenuManager=n,a._mobileMenuManagerDeferred.resolve()},h.RegisterProcessingIndicatorManager=function(e){var n=h._getActiveInstance();if(n._processingIndicatorManager)throw new Error("UIShellManager.RegisterProcessingIndicatorManager: ProcessingIndicatorManager has already been registered.");if(!(e instanceof p))throw new TypeError("UIShellManager.RegisterProcessingIndicatorManager: processingIndicatorManager must be a ProcessingIndicatorManager.");n._processingIndicatorManager=e,n._processingIndicatorDeferred.resolve()},h.ActivateNewManager=function(a){e.Logger.info("UIShellManager.ActivateNewManager: Entering."),n._UIShellManager.activeInstance=new h(a)},h._getActiveInstance=function(){if(!n._UIShellManager.activeInstance)throw new Error("UIShellManager has not been properly initialized.");return n._UIShellManager.activeInstance},h.getMenuDrawerState=function(){var e=this._getActiveInstance();if(!e._menuManager&&!e._mobileMenuManager)throw new Error("Neither MenuManager nor MobileMenuManager instances have been initialized.");return r.pureComputed((function(){var n=!!e._menuManager&&e._menuManager.menuOpened(),a=!!e._mobileMenuManager&&e._mobileMenuManager.getNavMenuStateTracker();return r.unwrap(n)||r.unwrap(a)}))},h.getPopupMenuState=function(){var e=this._getActiveInstance();if(!e._popupMenuManager)throw new Error("PopupMenuManager instance has not been initialized.");return e._popupMenuManager.getMenuState()},h}));