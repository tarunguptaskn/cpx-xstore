define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/models/UIShellManager","jraf/models/Content","libs/xenvironment/urlService","ojs/ojknockouttemplateutils","ojs/ojarraydataprovider","ojs/ojlistdataproviderview","ojs/ojknockout-keyset","ojs/ojtable","ojs/ojpagingcontrol","ojs/ojcollectiontabledatasource","ojs/ojselectcombobox","ojs/ojformlayout","ojs/ojknockout","ojs/ojcomposite","jraf/composites/oj-rgbu-jraf-message-dialog/loader"],(function(e,t,l,n,i,a,o,r,s,d,c){let v=e.Translations.getTranslatedString,u=[{value:"all",label:v("xenv.general.All")},{value:"mobile",label:v("xenv.devices.mobile")},{value:"server",label:v("xenv.devices.server")},{value:"desktop",label:v("xenv.devices.desktop")}],p=[{value:"all",label:v("xenv.general.All")},{value:"false",label:v("xenv.general.Closed")},{value:"true",label:v("xenv.general.Open")}],g=["SERVER","DESKTOP","MOBILE"],m=function(e,t){if(e.type===t.type){return e.regNum>t.regNum?1:-1}return g.indexOf(e.type)<g.indexOf(t.type)?-1:1};return new function(){let e=this;console.debug("Initting device module"),e.devicesTableId=n.UIShell.generateUniqueId(),e.errContainerId=n.UIShell.generateUniqueId(),e.refreshButtonId=n.UIShell.generateUniqueId(),e.deviceTypeOptions=new s(u,{keyAttributes:"value"}),e.deviceStatusOptions=new s(p,{keyAttributes:"value"}),e.selectedDeviceType=t.observable(),e.selectedDeviceStatus=t.observable(),e.noDataMsg=v("xenv.general.NoData"),e.deviceSummaryHeader=v("xenv.devices.Header"),e.refreshButtonLabel=v("xenv.general.Refresh"),e.typeFilterLabel=v("xenv.devices.TypeFilterLabel"),e.statusFilterLabel=v("xenv.devices.StatusFilterLabel"),this.selectedRows=new c.ObservableKeySet,e.DevicesTableDatasource=t.observable(),refresh=function(t){console.info("Refresh Pressed"),e.getDevices(),document.getElementById(e.devicesTableId).refresh()},e.columnList=[{headerText:v("xenv.device.regType"),field:"type",style:"width: calc(10%); white-space: normal"},{headerText:v("xenv.device.regNum"),field:"regNum",style:"width: calc(10%); white-space: normal"},{headerText:v("xenv.device.regOnline"),field:"onlineType",style:"width: calc(15%); white-space: normal"},{headerText:v("xenv.device.regStatus"),field:"registerOpen",style:"width: calc(15%); white-space: normal"},{headerText:v("xenv.device.regServicesInstalled"),field:"servicesInstalled",style:"width: calc(30%); white-space: normal",sortable:"disabled"},{headerText:v("xenv.device.regLastUpdatedSeen"),field:"lastUpdated",style:"width: calc(20%); white-space: normal"}],e.getDevices=function(){let t=document.getElementById(e.devicesTableId),n=document.getElementById(e.errContainerId);console.debug("Updating devices"),i.startProcessingIndicator();let a=l.ajax(o.getDevicesServiceUrl(),{type:"GET",dataType:"json",xhrFields:{withCredentials:!0}});a.done((function(l){null!==n&&(n.style.display="none"),null!==t&&(t.style.display="inline"),console.log("Device data fetched is : "+JSON.stringify(l)),e.DeviceCollection=l,e.handleSuccess(l),i.stopProcessingIndicator()})),a.fail((function(e,l,a){console.error("Could not get Device Information: "+a),null!==t&&(t.style.display="none"),null!==n&&(n.innerHTML=v("xenv.general.NoComms"),n.style.display="block"),i.stopProcessingIndicator()}))},this.rowRenderer=function(e){let t=e.rowContext.parentElement,l=document.createElement("td");e.row.lead&&(l.setAttribute("class","xenv-device-lead-icon"),l.setAttribute("title",v("xenv.devices.lead")));let n=e.row.type;l.innerHTML=v("xenv.devices."+n.toLowerCase()),t.appendChild(l);let i=document.createElement("td");i.innerHTML=e.row.regNum,t.appendChild(i);let a=document.createElement("td"),o="",r="xenv-device-detail-inactive-icon";"Active"===e.row.onlineType&&(r="xenv-device-detail-active-icon"),a.setAttribute("class",r),o=v("xenv.general."+e.row.onlineType),a.innerHTML=o,t.appendChild(a);let s=document.createElement("td"),d="";e.row.registerOpen?e.row.registerOpen&&(d=v("xenv.general.Open")):d=v("xenv.general.Closed"),s.innerHTML=d,t.appendChild(s);let c=document.createElement("td"),u=e.row.servicesInstalled;console.log(u);let p="";null!==u&&(p=u.join(", ")),c.innerHTML=p,t.appendChild(c);let g=document.createElement("td");console.log(e.row.lastUpdated);let m="";null!==e.row.lastUpdated&&(m=e.row.lastUpdatedStr),g.innerHTML=m,t.appendChild(g)}.bind(this),this.selectedChangedListener=function(t,l){let n=t.detail.value.row.values().keys().next().value;if(console.debug("key "+n),void 0===n)return;let o=e.DeviceCollection.find(e=>e.regNum===n).type;console.debug("Selected device is : "+o);let r=v("xenv.device.regNum")+" "+n,s="devicedetail_"+n;console.log("Page title = "+r);let d=new a({id:s,title:r,name:"devicedetail",resourceType:"module",moduleBinding:{name:"devicedetail",params:{deviceNumber:n,deviceType:o}}});i.openContent(d),i.closePopupMenu()},e.typeChangedHandler=function(t){t.detail.value&&e.prepareFilteredDevicesCollection(e.DeviceCollection)},e.statusChangedHandler=function(t){t.detail.value&&e.prepareFilteredDevicesCollection(e.DeviceCollection)},e.handleSuccess=function(t){e.selectedDeviceType("all"),e.selectedDeviceStatus("all"),e.prepareFilteredDevicesCollection(t)},e.deviceFilter=function(t){return("all"===e.selectedDeviceType()||t.type.toLowerCase()===e.selectedDeviceType())&&("all"===e.selectedDeviceStatus()||String(t.registerOpen)===e.selectedDeviceStatus())},e.prepareFilteredDevicesCollection=function(t){if(!t)return;let l=t.filter(e.deviceFilter);l.sort(m),e.DeviceCollectionDataProvider=new s(l,{keyAttributes:"regNum"}),e.listDataProvider=new d(e.DeviceCollectionDataProvider),e.DevicesTableDatasource(e.listDataProvider),e.DevicesTableDatasource.valueHasMutated()},e.getDevices()}}));