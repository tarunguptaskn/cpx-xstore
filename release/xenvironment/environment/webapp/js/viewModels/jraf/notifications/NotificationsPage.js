define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/utils/ValidationUtils","jraf/utils/KnockoutUtils","jraf/models/notifications/NotificationsFilter","jraf/models/notifications/NotificationsConfig","jraf/models/UIShellManager","ojs/ojmodule-element-utils","ojs/ojmodule-element","ojs/ojmodel","ojs/ojdialog","ojs/ojbutton","ojs/ojknockout","ojs/ojvalidation-number","ojs/ojconveyorbelt","jraf/composites/oj-rgbu-jraf-info-tile/loader","jraf/composites/oj-rgbu-jraf-apps-table/loader","jraf/composites/oj-rgbu-jraf-simple-grid/loader","jraf/composites/oj-rgbu-jraf-apps-module/loader"],(function(t,i,e,n,a,o,r,l,s,c){"use strict";u.FETCH_SIZE=50,u.READ_ICON_CLASS="jraf-notificationDetail-readIcon",u.UNREAD_ICON_CLASS="jraf-notificationDetail-unreadIcon",u.DEFAULT_TIME_LABEL_KEY="jraf.sidebar.notifications.filterTimePlaceholder",u.DEFAULT_TYPE_LABEL_KEY="jraf.sidebar.notifications.filterTypePlaceholder",u.DEFAULT_SEVERITY_LABEL_KEY="jraf.sidebar.notifications.filterSeverityPlaceholder",u.ALL_NOTIFICATIONS_CRITERIA={},u.ALL_UNREAD_CRITERIA={status:r.UNREAD_STATUS},u.UNREAD_NORMAL_CRITERIA={severities:[r.SEVERITY_VALUE_NORMAL],status:r.UNREAD_STATUS},u.UNREAD_IMPORTANT_CRITERIA={severities:[r.SEVERITY_VALUE_IMPORTANT],status:r.UNREAD_STATUS},u.UNREAD_CRITICAL_CRITERIA={severities:[r.SEVERITY_VALUE_CRITICAL],status:r.UNREAD_STATUS},u.GRAPH_COLOR_CRITICAL="#cd2027",u.GRAPH_COLOR_IMPORTANT="#eda620",u.GRAPH_COLOR_NORMAL="#72c17f",u.GRAPH_COLOR_OTHER="#e0e0e0",u.TILE_IDS=["allNotifications","unreadNotifications","unreadCritical","unreadImportant","unreadNormal","filters","grouping"];var f=t.Translations.getTranslatedString;function u(e){var a=this;this._initializeNotificationObjects(e),this.dataGridId=n.UIShell.generateUniqueId(),this.multipleAssignDialogId=n.UIShell.generateUniqueId(),this.createDialogId=n.UIShell.generateUniqueId(),this.notificationsTableLabel=f("jraf.notifications.detail.notificationsTableLabel"),this.rowsSelectedLabel=f("jraf.notifications.detail.rowsSelected"),this.assignmentDialogTitle=f("jraf.notifications.detail.assignmentDialogTitle"),this.peopleAssignmentsLabel=f("jraf.notifications.detail.assignmentPeople"),this.groupAssignmentsLabel=f("jraf.notifications.detail.assignmentGroups"),this.okLabel=f("jraf.common.ok"),this.readLabel=f("jraf.notifications.read"),this.unreadLabel=f("jraf.notifications.unread"),this.multipleFilterString=f("jraf.notifications.detail.multipleFilters"),this.singleAlertLabel=f("jraf.notifications.detail.singleAlertLabel"),this.currentAppTableSelection=i.observableArray([]),this.currentSelection=i.observableArray([]),this.selectedCount=i.pureComputed((function(){return this.currentSelection().length}),this),this.curRowAssignments=i.observableArray([]),this.assignDialogTarget=i.observable(),this.notificationsCollectionOffset=0;var o=t.Collection.extend({sync:function(t,i,e){return a._syncNotificationsCollection(t,i,e)},customPagingOptions:function(t){return a._getPagingOptions(t)},parse:function(t){return a._handleDataLoadSuccess(t)},fetchSize:u.FETCH_SIZE});this.notificationsCollection=new o,this._initAppTable(),this.closeAssignmentDialog=function(){a._closeAssignmentDialog()},this.handleTileSelection=function(t){a._selectTile(t)},this._initializeCreateDialog(),this._initializeTiles(),this._initializeAutoUpdates(),this._initializeAlertsPopup(),e.initialTile?this._notificationsFilter.selectedTileIndex(e.initialTile):this._refreshPage()}return u.prototype._initializeNotificationObjects=function(t){var i=l.getInstance();this.renderNotificationReassignment=i.hasReassignNotificationSupport(),this._notificationHandler=i.getNotificationHandler(t.notificationHandlerKey),this._notificationsService=this._notificationHandler.getNotificationsService(),this._notificationsFilter=r.getInstance(this._notificationsService),this._notificationsFilter.selectedTileIndex(r.ALL_NOTIFICATIONS_TILE_INDEX)},u.prototype._getColumnJson=function(){var t=this;return[{valueName:"severity",dataType:"text",label:f("jraf.notifications.detail.columnSeverity"),width:"100px",cellAlignment:"start",cellClassNameFunction:function(i){return t._getSeverityClass(i.data)}},{valueName:"notificationStatus",dataType:"icon",label:f("jraf.notifications.detail.columnStatus"),width:"60px"},{valueName:"notificationDesc",dataType:"custom",label:f("jraf.notifications.detail.columnMessage"),customRenderer:function(i){return t._renderNotificationDescription(i)},width:"350px",cellAlignment:"start"},{valueName:"notificationTypeDescription",dataType:"text",label:f("jraf.notifications.detail.columnType"),width:"180px",cellAlignment:"start"},{valueName:"alertCount",dataType:"custom",label:f("jraf.notifications.detail.columnAlerts"),customRenderer:function(i){return t._renderNotificationAlertCount(i)},width:"125px",cellAlignment:"start",sortable:!1},{valueName:"recipients",dataType:"custom",label:f("jraf.notifications.detail.columnAssigned"),customRenderer:function(i){return t._renderNotificationRecipients(i)},width:"125px",cellAlignment:"start",sortable:!1},{valueName:"createdDate",dataType:"date",label:f("jraf.notifications.detail.columnCreatedDate"),width:"150px",cellAlignment:"start"},{valueName:"createdBy",dataType:"text",label:f("jraf.notifications.detail.columnCreatedBy"),width:"125px",cellAlignment:"start"},{valueName:"lastUpdatedDate",dataType:"date",label:f("jraf.notifications.detail.columnUpdatedDate"),width:"150px",cellAlignment:"start"},{valueName:"lastUpdatedBy",dataType:"text",label:f("jraf.notifications.detail.columnUpdatedBy"),width:"125px",cellAlignment:"start"}]},u.prototype._initAppTable=function(){var t=this,e=i.observable(!0),n=i.observable(!0);function a(){t._updateReadState(!0)}function o(){t._updateReadState(!1)}function r(){document.getElementById(t.createDialogId).open()}function l(t){t.attributes.notificationStatus.isRead?n(!1):e(!1)}var s=i.pureComputed((function(){return 1!==t.selectedCount()})),c=i.pureComputed((function(){return t.selectedCount()<=0}));this.currentSelection.subscribe((function(i){e(!0),n(!0);for(var a=0;a<i.length;a++){l(t.notificationsCollection.models[i[a]])}}));var u=[{label:f("jraf.notifications.detail.markRead"),callback:a,disabled:e},{label:f("jraf.notifications.detail.markUnread"),callback:o,disabled:n}];if(this.renderNotificationReassignment){var d={label:f("jraf.notifications.detail.reassignNotificationTitle"),callback:r,disabled:s};u.push(d)}var p=[{label:f("jraf.notifications.detail.markRead"),buttonHandler:a,disabled:e},{label:f("jraf.notifications.detail.markUnread"),buttonHandler:o,disabled:n}];if(this.renderNotificationReassignment){var h={label:f("jraf.notifications.detail.reassignLabel"),icon:"jraf-createNotification-icon",iconOnly:!0,buttonHandler:r,disabled:s};p.push(h)}this.notificationTable={collection:this.notificationsCollection,label:this.notificationsTableLabel,handleRefresh:function(){t._refreshPage()},handleDelete:function(){t._deleteSelectedNotification()},disableDelete:c,deleteLabel:f("jraf.appTable.deleteLabel"),refreshLabel:f("jraf.notifications.detail.refreshNotifications"),selection:this.currentAppTableSelection,selectionListener:function(i){t._updateSelection(i)},columns:this._getColumnJson(),multipleSelect:!0,actionMenu:u,extraButtons:p}},u.prototype._initializeTiles=function(){var e=this,n=t.Validation.converterFactory("number").createConverter({style:"decimal",minimumFractionDigits:0,maximumFractionDigits:0,useGrouping:!0}),a=[{type:"value",converter:n},{type:"label",converter:n}];this.notificationCounts={totalNotifications:i.observable(0),unreadNormal:i.observable(0),unreadImportant:i.observable(0),unreadCritical:i.observable(0)},this.notificationCounts.unreadNotifications=i.pureComputed((function(){return e.notificationCounts.unreadCritical()+e.notificationCounts.unreadImportant()+e.notificationCounts.unreadNormal()})),this.notificationCounts.readNotifications=i.pureComputed((function(){return e.notificationCounts.totalNotifications()-e.notificationCounts.unreadNotifications()})),this.notificationCounts.unreadNonNormal=i.pureComputed((function(){return e.notificationCounts.unreadNotifications()-e.notificationCounts.unreadNormal()})),this.notificationCounts.unreadNonImportant=i.pureComputed((function(){return e.notificationCounts.unreadNotifications()-e.notificationCounts.unreadImportant()})),this.notificationCounts.unreadNonCritical=i.pureComputed((function(){return e.notificationCounts.unreadNotifications()-e.notificationCounts.unreadCritical()})),this._filterTileData=this._getFilterTileData(),this._ariaTileLabels=this._getAriaTileLabels(),this.tileBindings=[{filterCriteria:u.ALL_NOTIFICATIONS_CRITERIA,tileId:u.TILE_IDS[0],severity:"none",type:"metric",metric:o.formatObservable(this.notificationCounts.totalNotifications,n),infoTitle:f("jraf.notifications.detail.allNotificationsTileLabel"),label:this._ariaTileLabels.allNotifications,selected:i.observable(!0),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/MetricComparison",params:{metricData:[{name:f("jraf.notifications.read"),value:o.formatObservable(this.notificationCounts.readNotifications,n)},{name:f("jraf.notifications.unread"),value:o.formatObservable(this.notificationCounts.unreadNotifications,n)}]}}},{filterCriteria:u.ALL_UNREAD_CRITERIA,tileId:u.TILE_IDS[1],severity:"none",type:"metric",infoTitle:f("jraf.notifications.detail.allUnreadTileLabel"),label:this._ariaTileLabels.allUnread,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/SimpleDonutChart",params:{series:this._wrapSeries([{name:r.SEVERITY_OPTIONS[0].label,color:u.GRAPH_COLOR_CRITICAL,items:[this.notificationCounts.unreadCritical]},{name:r.SEVERITY_OPTIONS[1].label,color:u.GRAPH_COLOR_IMPORTANT,items:[this.notificationCounts.unreadImportant]},{name:r.SEVERITY_OPTIONS[2].label,color:u.GRAPH_COLOR_NORMAL,items:[this.notificationCounts.unreadNormal]}]),groups:["All Unread Notifications"],valueFormats:a,centerLabel:o.formatObservable(this.notificationCounts.unreadNotifications,n)}}},{filterCriteria:u.UNREAD_CRITICAL_CRITERIA,tileId:u.TILE_IDS[2],severity:"high",type:"metric",infoTitle:r.SEVERITY_OPTIONS[0].label,label:this._ariaTileLabels.unreadCritical,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/SimpleDonutChart",params:{series:this._wrapSeries([{name:r.SEVERITY_OPTIONS[0].label,color:u.GRAPH_COLOR_CRITICAL,items:[this.notificationCounts.unreadCritical]},{name:f("jraf.notifications.detail.graphLabelOther"),color:u.GRAPH_COLOR_OTHER,items:[this.notificationCounts.unreadNonCritical]}]),groups:["Critical Unread Notifications"],valueFormats:a,centerLabel:o.formatObservable(this.notificationCounts.unreadCritical,n)}}},{filterCriteria:u.UNREAD_IMPORTANT_CRITERIA,tileId:u.TILE_IDS[3],severity:"medium",type:"metric",infoTitle:r.SEVERITY_OPTIONS[1].label,label:this._ariaTileLabels.unreadImportant,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/SimpleDonutChart",params:{series:this._wrapSeries([{name:r.SEVERITY_OPTIONS[1].label,color:u.GRAPH_COLOR_IMPORTANT,items:[this.notificationCounts.unreadImportant]},{name:f("jraf.notifications.detail.graphLabelOther"),color:u.GRAPH_COLOR_OTHER,items:[this.notificationCounts.unreadNonImportant]}]),groups:["Important Unread Notifications"],valueFormats:a,centerLabel:o.formatObservable(this.notificationCounts.unreadImportant,n)}}},{filterCriteria:u.UNREAD_NORMAL_CRITERIA,tileId:u.TILE_IDS[4],severity:"low",type:"metric",infoTitle:r.SEVERITY_OPTIONS[2].label,label:this._ariaTileLabels.unreadNormal,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/SimpleDonutChart",params:{series:this._wrapSeries([{name:r.SEVERITY_OPTIONS[2].label,color:u.GRAPH_COLOR_NORMAL,items:[this.notificationCounts.unreadNormal]},{name:f("jraf.notifications.detail.graphLabelOther"),color:u.GRAPH_COLOR_OTHER,items:[this.notificationCounts.unreadNonNormal]}]),groups:["Normal Unread Notifications"],valueFormats:a,centerLabel:o.formatObservable(this.notificationCounts.unreadNormal,n)}}},{render:this._filterTileData.renderFilters,filterCriteria:this._notificationsFilter.getFilterCriteria(),tileId:u.TILE_IDS[5],severity:"none",type:"metric",infoTitle:f("jraf.notifications.detail.filterTileLabel"),label:this._ariaTileLabels.filters,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/ValueList",params:{values:[{label:f("jraf.notifications.detail.filterTileTimeLabel"),value:this._filterTileData.time},{label:f("jraf.notifications.detail.columnType"),value:this._filterTileData.type},{label:f("jraf.notifications.detail.columnSeverity"),value:this._filterTileData.severity}]}}},{render:this._filterTileData.renderGroups,filterCriteria:this._notificationsFilter.getGroupingCriteria(),tileId:u.TILE_IDS[6],severity:"none",type:"metric",infoTitle:f("jraf.notifications.detail.groupTileLabel"),label:this._ariaTileLabels.summary,selected:i.observable(!1),tileSelectionHandler:this.handleTileSelection,customBodyModuleOptions:{name:"jraf/tilecontent/ValueList",params:{values:[{label:this._filterTileData.primaryGroup,value:this._filterTileData.primaryValue},{label:this._filterTileData.secondaryGroup,value:this._filterTileData.secondaryValue},{message:f("jraf.notifications.detail.groupTileFilterMessage")}]}}}]},u.prototype._wrapSeries=function(t){return i.pureComputed((function(){return i.toJS(t)}))},u.prototype._syncNotificationsCollection=function(i,e,n){if(t.Logger.info("NotificationsPage._syncNotificationsCollection: Calling sync for method: %s",i),"read"!==i)return t.Logger.warn("NotificationsPage._syncNotificationsCollection: Method was not read!"),{};var a=this;return this._loadNotifications(n).then((function(t){n.success(t)}),(function(t){a._handleDataLoadFailure(t),n.error(t)})),{}},u.prototype._loadNotificationCounts=function(){var t=this;this._notificationsService.getNotificationCount(u.ALL_NOTIFICATIONS_CRITERIA).then((function(i){t.notificationCounts.totalNotifications(i)})),this._notificationsService.getNotificationCount(u.UNREAD_NORMAL_CRITERIA).then((function(i){t.notificationCounts.unreadNormal(i)})),this._notificationsService.getNotificationCount(u.UNREAD_IMPORTANT_CRITERIA).then((function(i){t.notificationCounts.unreadImportant(i)})),this._notificationsService.getNotificationCount(u.UNREAD_CRITICAL_CRITERIA).then((function(i){t.notificationCounts.unreadCritical(i)}))},u.prototype._getFilterTileData=function(){var t=this,e=f(u.DEFAULT_TIME_LABEL_KEY),n=f(u.DEFAULT_TYPE_LABEL_KEY),a=f(u.DEFAULT_SEVERITY_LABEL_KEY),o={time:this._getTimeFilterTileValue(this._notificationsFilter.selectedTimePeriod,this._notificationsFilter.timePeriodLabels,e),type:this._getFilterTileValue(this._notificationsFilter.selectedNotificationTypes,this._notificationsFilter.notificationTypeLabels,n),primaryGroup:this._getFilterTileValue(this._notificationsFilter.selectedSummaryValues.primaryGroup,this._notificationsFilter.hierarchyLabels),primaryValue:this._notificationsFilter.selectedSummaryValues.primaryValue,secondaryGroup:this._getFilterTileValue(this._notificationsFilter.selectedSummaryValues.secondaryGroup,this._notificationsFilter.hierarchyLabels),secondaryValue:this._notificationsFilter.selectedSummaryValues.secondaryValue,severity:this._getFilterTileValue(this._notificationsFilter.selectedSeverities,this._notificationsFilter.severityLabels,a)};return o.renderFilters=i.pureComputed((function(){return(t._notificationsFilter.selectedTimePeriod()?1:0)+t._notificationsFilter.selectedNotificationTypes().length+t._notificationsFilter.selectedSeverities().length>0})),o.renderGroups=i.pureComputed((function(){return!!o.primaryGroup()})),o},u.prototype._getFilterTileValue=function(t,e,n){return i.pureComputed((function(){var i=t();return a.isArray(i)?i.length>1?f("jraf.notifications.detail.multipleFilters"):0===i.length?n||f("jraf.notifications.detail.noFilters"):e()[i[0]]:null}))},u.prototype._getTimeFilterTileValue=function(t,e,n){return i.pureComputed((function(){var i=t();return i?e()[i]:n||f("jraf.notifications.detail.noFilters")}))},u.prototype._getAriaTileLabels=function(){var t=this,e={};return e.allNotifications=i.pureComputed((function(){var i=t.notificationCounts.totalNotifications(),e=t.notificationCounts.unreadNotifications(),n=t.notificationCounts.readNotifications();return f("jraf.notifications.detail.allNotificationsTileAriaLabel",[i,e,n])})),e.allUnread=i.pureComputed((function(){var i=t.notificationCounts.unreadNotifications(),e=t.notificationCounts.unreadCritical(),n=t.notificationCounts.unreadImportant(),a=t.notificationCounts.unreadNormal();return f("jraf.notifications.detail.allUnreadTileAriaLabel",[i,e,n,a])})),e.unreadCritical=i.pureComputed((function(){var i=t.notificationCounts.unreadNotifications(),e=t.notificationCounts.unreadCritical();return f("jraf.notifications.detail.unreadCriticalTileAriaLabel",[i,e])})),e.unreadImportant=i.pureComputed((function(){var i=t.notificationCounts.unreadNotifications(),e=t.notificationCounts.unreadImportant();return f("jraf.notifications.detail.unreadImportantTileAriaLabel",[i,e])})),e.unreadNormal=i.pureComputed((function(){var i=t.notificationCounts.unreadNotifications(),e=t.notificationCounts.unreadNormal();return f("jraf.notifications.detail.unreadNormalAriaLabel",[i,e])})),e.filters=i.pureComputed((function(){var i=t._filterTileData.time(),e=t._filterTileData.type(),n=t._filterTileData.severity();return f("jraf.notifications.detail.filterByAriaLabel",[i,e,n])})),e.summary=i.pureComputed((function(){var i=t._filterTileData.primaryValue(),e=t._filterTileData.secondaryValue();return f("jraf.notifications.detail.summaryAriaLabel",[i,e])})),e},u.prototype._initializeAutoUpdates=function(){var t=this;this._previousTileSelection=r.ALL_NOTIFICATIONS_TILE_INDEX;var i=this._notificationsFilter.selectedTileIndex.subscribe((function(i){t._handleTileSelectionUpdate(i)}));this.uiShellClose=function(){i.dispose()}},u.prototype._initializeCreateDialog=function(){if(this.renderNotificationReassignment){var e=this,n=i.pureComputed((function(){if(1!==e.selectedCount())return null;var i=e.currentSelection()[0];return i>=e.notificationsCollection.models.length?(t.Logger.warn("NotificationsPage (default selected notification logic): Selected notification index was out of bounds."),null):e.notificationsCollection.models[i].attributes.notificationSummary}));this.createNotificationDialogModuleOptions={name:"jraf/notifications/CreateNotification",params:{dialogId:this.createDialogId,dialogTitle:f("jraf.notifications.detail.reassignNotificationTitle"),createFailedMsg:f("jraf.notifications.detail.reassignFailed"),defaultNotification:n,notificationsService:this._notificationsService,createCallback:function(){e._refreshPage()}}}}},u.prototype._handleTileSelectionUpdate=function(t){var i=this._previousTileSelection;t!==r.FILTER_TILE_INDEX||this._filterTileData.renderFilters()?i!==t?(this.tileBindings[i].selected(!1),this.tileBindings[t].selected(!0),this._previousTileSelection=t,this._refreshPage()):t!==r.SUMMARY_TILE_INDEX&&t!==r.FILTER_TILE_INDEX||this._refreshPage():this._notificationsFilter.selectedTileIndex(r.ALL_NOTIFICATIONS_TILE_INDEX)},u.prototype._refreshPage=function(){this._loadNotificationCounts(),this._refreshNotifications()},u.prototype._refreshNotifications=function(){this.notificationsCollectionOffset=0,this.currentSelection([]),this.currentAppTableSelection.removeAll(),this.notificationsCollection.refresh()},u.prototype._getSelectedTile=function(){return this.tileBindings[this._notificationsFilter.selectedTileIndex()]},u.prototype._getSelectedFilterCriteria=function(){var t=this._getSelectedTile();return i.unwrap(t.filterCriteria)||u.ALL_NOTIFICATIONS_CRITERIA},u.prototype._loadNotifications=function(i){t.Logger.info("NotificationsPage._loadNotifications: Entering.");s.startProcessingIndicator(),i=i||{},this.notificationsCollectionOffset=i.startIndex||0;var n=i.fetchSize,a={pageNumber:Math.floor(i.startIndex/n)+1||1,pageSize:n,sortColumns:this.notificationsCollection.sortCriteria},o=this._getSelectedFilterCriteria();return e.extend(a,o),this._notificationsService.getNotifications(a)},u.prototype._handleDataLoadSuccess=function(i){t.Logger.info("NotificationsPage._handleDataLoadSuccess: Successfully loaded notification data.");var e=[];return i&&a.isArray(i.results)&&(e=this._parseNotificationData(i.results)),s.stopProcessingIndicator(),e},u.prototype._handleDataLoadFailure=function(i){t.Logger.warn("NotificationsPage._handleDataLoadFailure: failed loading data with reason "+i),s.stopProcessingIndicator()},u.prototype._getPagingOptions=function(i){t.Logger.info("NotificationsPage._getPagingOptions: Entering.");var e=i.totalRecordCount>this.notificationsCollectionOffset+i.results.length;return{totalResults:i.totalRecordCount,limit:u.FETCH_SIZE,count:i.results.length,offset:this.notificationsCollectionOffset,hasMore:e}},u.prototype._parseNotification=function(t){var i=t.notificationStatus===r.READ_STATUS,e=r.SEVERITY_OPTIONS[t.severity-1].label;return{id:t.notificationId,severity:e,notificationStatus:{isRead:i,icon:i?u.READ_ICON_CLASS:u.UNREAD_ICON_CLASS,label:i?this.readLabel:this.unreadLabel},notificationDesc:{notificationId:t.notificationId,description:t.notificationDesc,launchable:t.launchable},notificationTypeDescription:t.notificationTypeDescription,alertCount:{notificationId:t.notificationId,count:t.alertCount},recipients:{notificationId:t.notificationId,displayValue:this._getDisplayedRecipients(t),multipleAssigned:t.multipleRecipients},createdDate:new Date(t.createdDate),createdBy:t.createdBy,lastUpdatedDate:new Date(t.lastUpdatedDate),lastUpdatedBy:t.lastUpdatedBy,notificationSummary:{id:t.notificationId,message:t.notificationDesc,launchable:t.launchable,severity:e,hierarchy:[t.hierValue1,t.hierValue2,t.hierValue3,t.hierValue4,t.hierValue5,t.hierValue6,t.hierValue7,t.hierValue8,t.hierValue9]}}},u.prototype._getDisplayedRecipients=function(t){return t.multipleRecipients?f("jraf.notifications.detail.multipleUsers"):a.isArray(t.recipients)&&t.recipients[0]||""},u.prototype._deleteSelectedNotification=function(){t.Logger.info("NotificationsPage._deleteSelectedNotification: Entering.");var i=this;return s.startProcessingIndicator(),this._getSelectedNotificationIdsPromise().then((function(e){i._notificationsService.deleteMultipleNotifications(e).then((function(){i._refreshPage(),s.stopProcessingIndicator()}),(function(i){t.Logger.warn("NotificationsPage._deleteSelectedNotification: Failed to delete notifications (%s)",i),s.stopProcessingIndicator()}))}))},u.prototype._parseNotificationData=function(t){for(var i=[],e=0;e<t.length;e++){var n=t[e];i.push(this._parseNotification(n))}return i},u.prototype._updateSelection=function(t){var i=[];if(t){var e={};for(var n in t)for(var a=t[n],o=a.startIndex.row;o<=a.endIndex.row;o++)e[o]=!0;i=Object.keys(e)}for(var r=[],l=0;l<i.length;l++)r.push(parseInt(i[l]));this.currentSelection(r)},u.prototype._openAssignmentDialog=function(i,n){t.Logger.info("NotificationsPage._openAssignmentDialog: Loading notification recipients.");var a=this;return s.startProcessingIndicator(),this.assignDialogTarget(i),this._notificationsService.getRecipients(n).then((function(t){a.curRowAssignments(t),e("#"+a.multipleAssignDialogId).ojDialog("open"),s.stopProcessingIndicator()}),(function(i){t.Logger.warn("NotificationsPage._openAssignmentDialog: Error loading recipients: ",i),s.stopProcessingIndicator()}))},u.prototype._closeAssignmentDialog=function(){e("#"+this.multipleAssignDialogId).ojDialog("close")},u.prototype._getSelectedNotificationIdsPromise=function(){for(var t=this.currentSelection(),i=[],e=0;e<t.length;e++)i.push(this.notificationsCollection.at(t[e]));return Promise.all(i).then((function(t){for(var i=[],e=0;e<t.length;e++)i.push(t[e].attributes.id);return i}))},u.prototype._updateReadState=function(i){t.Logger.info("NotificationsPage._updateReadState: Updating read state to "+i);var e=this;return s.startProcessingIndicator(),this._getSelectedNotificationIdsPromise().then((function(n){e._notificationsService.markMultipleNotificationsAsRead(n,i).then((function(){s.stopProcessingIndicator(),e._refreshPage()}),(function(i){t.Logger.warn("NotificationsPage._updateReadState: Failed to update read state of notifications (%s)",i),s.stopProcessingIndicator()}))}))},u.prototype._selectTile=function(t){for(var i=0;i<this.tileBindings.length;i++)if(this.tileBindings[i].tileId===t){this._notificationsFilter.selectedTileIndex(i);break}},u.prototype._getSeverityClass=function(t){for(var i in r.SEVERITY_OPTIONS)if(t===r.SEVERITY_OPTIONS[i].label)return r.SEVERITY_OPTIONS[i].class;return""},u.prototype._renderNotificationDescription=function(t){var i=t.data;if(!i.launchable)return i.description;var n=this;return e("<a></a>").attr("href","#").text(i.description).click((function(){n._launchNotificationContext(i)})).get(0)},u.prototype._renderNotificationAlertCount=function(t){var i=t.data.count;if(!i||i<1)return"";var n=1===i?this.singleAlertLabel:f("jraf.notifications.detail.multipleAlertsLabel",[i]),a=this;return e("<a></a>").attr("href","#").text(n).click((function(){a._launchAlertsPopup(t.data.notificationId)})).get(0)},u.prototype._initializeAlertsPopup=function(){this.alertsPopupId=n.UIShell.generateUniqueId(),this.alertsNotificationId=i.observable(),this.alertsModuleConfig=c.createConfig({name:"jraf/notifications/AlertsPopup",params:{popupId:this.alertsPopupId,notificationId:this.alertsNotificationId}})},u.prototype._launchAlertsPopup=function(t){this.alertsNotificationId(t),document.getElementById(this.alertsPopupId).open()},u.prototype._renderNotificationRecipients=function(t){var i=this,n=t.data,a=n.displayValue;if(!n.multipleAssigned)return a;var o=document.createElement("a");return o.attributes.href="#",o.textContent=a,e(o).click((function(){i._openAssignmentDialog(o,n.notificationId)})),o},u.prototype._launchNotificationContext=function(i){if(!i.launchable)return Promise.resolve(null);s.startProcessingIndicator();var e=i.notificationId;return Promise.all([this._notificationsService.markNotificationAsRead(e).catch((function(){t.Logger.warn("NotificationsPage._launchNotificationContext: Failed to mark notification as read.")})),this._notificationHandler.openContext(e).catch((function(){t.Logger.warn("NotificationsPage._launchNotificationContext: Failed to open notification context.")}))]).then((function(){s.stopProcessingIndicator()}))},u}));