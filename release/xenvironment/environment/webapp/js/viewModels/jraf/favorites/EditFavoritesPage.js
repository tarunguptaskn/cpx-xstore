define(["jquery","ojs/ojcore","knockout","jraf/jrafcore","jraf/models/favorites/FavoritesContent","jraf/models/favorites/FavoritesConfig","jraf/models/favorites/PinnedFavoritesState","jraf/models/UIShellManager","jraf/utils/ValidationUtils","ojs/ojmodule-element-utils","jraf/composites/oj-rgbu-jraf-apps-panel-bar/loader","jraf/composites/oj-rgbu-jraf-snackbar/loader","ojs/ojtreeview","ojs/ojbutton","ojs/ojtoolbar","ojs/ojdialog","ojs/ojlabel","ojs/ojinputtext","ojs/ojvalidation-base","ojs/ojknockout-validation","ojs/ojmodel","ojs/ojmenu","ojs/ojvalidationgroup","ojs/ojmodule-element","ojs/ojformlayout"],(function(e,t,o,i,r,a,n,s,l,d){"use strict";f.MAX_FOLDER_NAME_LENGTH=200,f.MAX_CUSTOM_NAME_LENGTH=300;var u=t.Translations.getTranslatedString;function f(e){var t=this;this.snackbarId=i.UIShell.generateUniqueId(),this._favoriteHandler=a.getInstance().getFavoriteHandler(e.favoriteHandlerKey),this._favoritesContent=r.getInstance(this._favoriteHandler.getFavoritesService(),e.favoriteHandlerKey),this.hidePinnedFavorites=l.getBoolean(e.hidePinnedFavorites,!1),this.organizedFavoritesHeader=u("jraf.sidebar.favorites.organizedFavoritesHeader"),this.organizedFavoritesAriaLabel=u("jraf.sidebar.favorites.organizedFavoritesAriaLabel"),this.noFavoritesToDisplayMessage=u("jraf.sidebar.favorites.noFavoritesToDisplayMessage");var o={name:"jraf/favorites/EditPinnedFavoritesPanel",params:{favoriteHandlerKey:e.favoriteHandlerKey}};this.editPinnedFavoritesModuleConfig=d.createConfig(o),this.getLocalizedTitle=function(e){return t._getLocalizedTitle(e)},this.getFavoriteGuid=function(e){return t._getFavoriteGuid(e)},this.getImageClasses=function(e){return t._getImageClasses(e)},this.getPinClasses=function(e){return t._getPinClasses(e)},this._initFavoritesTree(),this._configurePageButtons(),this._configureToolbar(),this._configureDialogs(),this._configureContextMenu(),this._favoritesContent.saveCurrentOrder()}return f.prototype._initFavoritesTree=function(){var e=this;this.favoritesTreeId=i.UIShell.generateUniqueId(),this.favoritesTreeNodeTemplateId=i.UIShell.generateUniqueId(),this._resetGuidMaps(),this.favorites=this._favoritesContent.getFavorites(),this._refreshFolderSubscriptions(),this.hasFavorites=o.pureComputed((function(){return e.favorites().length>0})),this.favoritesContentLoaded=this._favoritesContent.getFavoritesContentLoaded(),this.favoritesSubscription=this.favorites.subscribe((function(){e._refreshFolderSubscriptions(),e._refreshFavoritesTreeWhenReady()})),this.favoritesSelection=o.observableArray([]),this.favoriteIsSelected=o.pureComputed((function(){return e.favoritesSelection().length>0})),this.selectedFavoriteGuid=o.pureComputed((function(){return e.favoritesSelection()[0]})),this.selectedFavorite=o.pureComputed((function(){return e.guidToFavoriteMap[e.selectedFavoriteGuid()]})),this.selectedFavoriteIsFolder=o.pureComputed((function(){var t=e.selectedFavorite();return t&&t.isFolder})),this.handleDragStart=function(t,o){return e._handleDragStart(t,o)},this.handleDrop=function(t,o){return e._handleDrop(t,o)}},f.prototype._resetGuidMaps=function(){this.favoriteToGuidMap={},this.guidToFavoriteMap={}},f.prototype._refreshFolderSubscriptions=function(){var e=this;this._disposeOfFolderSubscriptions(),this.folderSubscriptions=[],this.favorites().forEach((function(t){if(t.isFolder){var o=t.children.subscribe((function(){e._refreshFavoritesTreeWhenReady()}));e.folderSubscriptions.push(o)}}))},f.prototype._refreshFavoritesTreeWhenReady=function(){var e=this,o=document.querySelector("#"+this.favoritesTreeId);o&&t.Context.getContext(o).getBusyContext().whenReady().then((function(){e._refreshFavoritesTreeNow()}))},f.prototype._refreshFavoritesTreeNow=function(){var e=document.querySelector("#"+this.favoritesTreeId);e&&e.refresh()},f.prototype._configurePageButtons=function(){var e=this;this.doneButtonLabel=u("jraf.common.done"),this.importButtonLabel=u("jraf.sidebar.favorites.import"),this.okButtonLabel=u("jraf.common.ok"),this.cancelButtonLabel=u("jraf.common.cancel"),this.importButtonCallback=function(){e._handleImportButton()},this.doneButtonCallback=function(){e._handleDoneButton()},this.okButtonCallback=function(){e._handleOkButton()},this.cancelButtonCallback=function(){e._handleCancelButton()},this.extraActionButtons=o.pureComputed((function(){var t=[];return e._favoritesContent.hasSeededFavorites()&&t.push({label:e.importButtonLabel,callback:e.importButtonCallback}),t})),this.mainActionButtons=o.pureComputed((function(){var t=[];return 0!==e.favorites().length||e._favoritesContent.hasSeededFavorites()?(t.push({label:e.okButtonLabel,callback:e.okButtonCallback}),t.push({label:e.cancelButtonLabel,callback:e.cancelButtonCallback})):t.push({label:e.doneButtonLabel,callback:e.doneButtonCallback}),t}))},f.prototype._handleDoneButton=function(){s.closeGlobalModalPage()},f.prototype._handleImportButton=function(){this._resetGuidMaps(),this._favoritesContent.importFavorites()},f.prototype._handleOkButton=function(){s.closeGlobalModalPage()},f.prototype._handleCancelButton=function(){this._favoritesContent.revertOrder().then((function(){s.closeGlobalModalPage()}))},f.prototype._configureToolbar=function(){var e=this;this.favoritesToolbarId=i.UIShell.generateUniqueId(),this.toolbarEditButtonId=i.UIShell.generateUniqueId(),this.toolbarDeleteButtonId=i.UIShell.generateUniqueId(),this.toolbarCreateFolderButtonId=i.UIShell.generateUniqueId(),this.toolbarPinButtonId=i.UIShell.generateUniqueId(),this.favoritesToolbarAriaLabel=u("jraf.sidebar.favorites.favoritesToolbarAriaLabel"),this.toolbarEditButtonName=u("jraf.sidebar.favorites.toolbarEditButtonName"),this.toolbarDeleteButtonName=u("jraf.sidebar.favorites.toolbarDeleteButtonName"),this.toolbarCreateFolderButtonName=u("jraf.sidebar.favorites.toolbarCreateFolderButtonName"),this.toolbarPinButtonName=u("jraf.sidebar.favorites.toolbarPinButtonName"),this.deleteFolderConfirmMessage=u("jraf.sidebar.favorites.deleteFolderConfirmMessage"),this.noLabel=u("jraf.common.no"),this.yesLabel=u("jraf.common.yes"),this.handleEditButton=function(){e._handleEditFavoriteButton()},this.handleDeleteButton=function(){e._deleteFavorite(e.selectedFavorite())},this.handleCreateFolderButton=function(){e._handleCreateFolderButton()},this.handlePinButton=function(){e._handlePinButton()}},f.prototype._handleEditFavoriteButton=function(){var e=this.selectedFavorite();e.isFolder?this._openEditFolderDialog(e):this._openEditFavoriteDialog(e)},f.prototype._openEditFolderDialog=function(t){this.editFavoriteTarget=t;var o=this._favoriteHandler.getLocalizedTitle(t.entryId);this.folderName(o()),this.folderDialogEditMode(!0),e("#"+this.folderDialogId).ojDialog("open")},f.prototype._openEditFavoriteDialog=function(t){this.editFavoriteTarget=t;var o=this._favoriteHandler.getLocalizedTitle(t.entryId);this.customFavoriteName(o());var i=this._favoriteHandler.getLocalizedTitle(t.entryId,!0);this.originalFavoriteName(i()),e("#"+this.favoriteDialogId).ojDialog("open")},f.prototype._deleteFavorite=function(e){var t=this;if(this.editFavoriteTarget=e,e.isFolder){var o={message:this.deleteFolderConfirmMessage,severity:"warning",disableTimeout:!0,primaryButton:{label:this.yesLabel,callback:function(){t._handleDeleteConfirm()}},secondaryButton:{label:this.noLabel,callback:function(){t._handleDeleteCancel()}}};document.getElementById(this.snackbarId).openSnack(o)}else this._removeTargetFavorite()},f.prototype._handleDeleteCancel=function(){document.getElementById(this.snackbarId).closeSnack()},f.prototype._handleDeleteConfirm=function(){document.getElementById(this.snackbarId).closeSnack(),this._removeTargetFavorite()},f.prototype._removeTargetFavorite=function(){var e=this,t=this.editFavoriteTarget;this._favoritesContent.removeFavoriteById(t.entryId).then((function(){e.selectedFavorite()&&e.selectedFavorite().entryId===t.entryId&&e.favoritesSelection.removeAll()}))},f.prototype._handleCreateFolderButton=function(){this.folderName(""),this.folderDialogEditMode(!1),e("#"+this.folderDialogId).ojDialog("open")},f.prototype._handlePinButton=function(){var e=this.selectedFavorite();e.isPinned()?this._favoritesContent.unpinFavorite(e.entryId):this._favoritesContent.pinFavorite(e.entryId)},f.prototype._configureDialogs=function(){this._configureFolderDialog(),this._configureFavoriteDialog()},f.prototype._configureFolderDialog=function(){var r=this;this.folderDialogId=i.UIShell.generateUniqueId(),this.folderNameInputId=i.UIShell.generateUniqueId(),this.createFolderDialogTitle=u("jraf.sidebar.favorites.createFolderDialogTitle"),this.editFolderDialogTitle=u("jraf.sidebar.favorites.editFolderDialogTitle"),this.folderNameInputLabel=u("jraf.sidebar.favorites.folderNameInputLabel"),this.folderDialogEditMode=o.observable(!1),this.folderDialogTitle=o.pureComputed((function(){return r.folderDialogEditMode()?r.editFolderDialogTitle:r.createFolderDialogTitle})),this.folderName=o.observable();var a=t.Validation.validatorFactory(t.ValidatorFactory.VALIDATOR_TYPE_LENGTH),n={countBy:"codePoint",max:f.MAX_FOLDER_NAME_LENGTH};this.folderNameValidators=[a.createValidator(n)],this.folderDialogTracker=i.UIShell.generateUniqueId()+"_folderDialogTracker",this.folderDialogGroupValid=o.observable(),this.handleFolderDialogCancel=function(){e("#"+r.folderDialogId).ojDialog("close")},this.handleFolderDialogOk=function(){r._handleFolderDialogOk()},this.handleFolderDialogClose=function(){r._resetFolderFormFields()}},f.prototype._resetFolderFormFields=function(){document.getElementById(this.folderNameInputId).reset()},f.prototype._handleFolderDialogOk=function(){var e=document.getElementById(this.folderDialogTracker);if("valid"!==e.valid)return e.showMessages(),void e.focusOn("@firstInvalidShown");this.folderDialogEditMode()?this._updateFolderName():(this._resetGuidMaps(),this._createFolder())},f.prototype._updateFolderName=function(){var t=this,o=this.editFavoriteTarget;this._favoritesContent.customizeFavoriteName(o,this.folderName()).then((function(){e("#"+t.folderDialogId).ojDialog("close")}))},f.prototype._createFolder=function(){var t=this;this._favoritesContent.addFolder(this.folderName()).then((function(){e("#"+t.folderDialogId).ojDialog("close")}))},f.prototype._configureFavoriteDialog=function(){var r=this;this.favoriteDialogId=i.UIShell.generateUniqueId(),this.customFavoriteNameInputId=i.UIShell.generateUniqueId(),this.originalFavoriteNameInputId=i.UIShell.generateUniqueId(),this.favoriteDialogTitle=u("jraf.sidebar.favorites.editFavoriteDialogTitle"),this.customFavoriteNameInputLabel=u("jraf.sidebar.favorites.customFavoriteNameInputLabel"),this.originalFavoriteNameInputLabel=u("jraf.sidebar.favorites.originalFavoriteNameInputLabel"),this.customFavoriteNameHint=u("jraf.sidebar.favorites.customFavoriteNameHint"),this.customFavoriteNameError=u("jraf.sidebar.favorites.customFavoriteNameError"),this.customFavoriteName=o.observable(),this.originalFavoriteName=o.observable();var a=t.Validation.validatorFactory(t.ValidatorFactory.VALIDATOR_TYPE_LENGTH),n={countBy:"codePoint",max:f.MAX_CUSTOM_NAME_LENGTH},s={type:"regExp",options:{pattern:".*\\S+.*",hint:this.customFavoriteNameHint,messageDetail:this.customFavoriteNameError}};this.customFavoriteNameValidators=[a.createValidator(n),s],this.favoriteDialogTracker=i.UIShell.generateUniqueId()+"_favoriteDialogTracker",this.favoriteDialogGroupValid=o.observable(),this.handleFavoriteDialogClose=function(){r._resetFavoriteFormFields()},this.handleFavoriteDialogCancel=function(){e("#"+r.favoriteDialogId).ojDialog("close")},this.handleFavoriteDialogOk=function(){r._handleFavoriteDialogOk()}},f.prototype._resetFavoriteFormFields=function(){document.getElementById(this.customFavoriteNameInputId).reset()},f.prototype._handleFavoriteDialogOk=function(){var t=this,o=document.getElementById(this.favoriteDialogTracker);if("valid"!==o.valid)return o.showMessages(),void o.focusOn("@firstInvalidShown");var i=this.editFavoriteTarget;this._favoritesContent.customizeFavoriteName(i,this.customFavoriteName()).then((function(){e("#"+t.favoriteDialogId).ojDialog("close")}))},f.prototype._getLocalizedTitle=function(e){return this._favoriteHandler.getLocalizedTitle(e.entryId)},f.prototype._getFavoriteGuid=function(e){var t=this.favoriteToGuidMap[e.entryId];return t||(t=i.UIShell.generateUniqueId(),this.favoriteToGuidMap[e.entryId]=t,this.guidToFavoriteMap[t]=e),t},f.prototype._getImageClasses=function(e){if(e.isFolder)return"oj-treeview-item-icon";var t=n.favoriteIcons[e.favoriteType];return"jraf-favorites-treeview-icon "+(t=t||n.favoriteIcons.unknown)},f.prototype._getPinClasses=function(e){var t="jraf-favorites-treeview-icon";return!e.isFolder&&e.isPinned()&&(t+=" jraf-favorite-pinned-icon"),t},f.prototype._handleDragStart=function(t,o){var i=e(t.target).parents(".oj-treeview-item").get(0);return t.dataTransfer.setDragImage(i,0,0),t.dataTransfer.dropEffect="move",!0},f.prototype._handleDrop=function(e,t){var o=this.selectedFavorite(),i=t.item.id,r=this.guidToFavoriteMap[i],a=t.position;this._reorderFavorite(o,r,a)&&e.preventDefault()},f.prototype._reorderFavorite=function(e,t,o){var i,r,a=this._favoritesContent.getIndexOfFavorite(t.entryId);if("before"===o)i=t.parentFavItemId,r=a;else if("after"===o)i=t.parentFavItemId,r=a+1;else{if("inside"!==o&&"first"!==o||!t.isFolder)return!1;i=t.entryId,r=0}return(!e.isFolder||!i)&&(this._favoritesContent.reorderFavorite(e.entryId,r,i),!0)},f.prototype._configureContextMenu=function(){var e=this;this.favoriteContextMenuId=i.UIShell.generateUniqueId(),this.favoriteContextMenuAriaLabel=u("jraf.sidebar.favorites.favoriteContextMenuAriaLabel"),this.favoriteContextEditOption=u("jraf.sidebar.favorites.favoriteContextEditOption"),this.favoriteContextCutOption=u("jraf.sidebar.favorites.favoriteContextCutOption"),this.favoriteContextPasteBeforeOption=u("jraf.sidebar.favorites.favoriteContextPasteBeforeOption"),this.favoriteContextPasteAfterOption=u("jraf.sidebar.favorites.favoriteContextPasteAfterOption"),this.favoriteContextPasteInsideOption=u("jraf.sidebar.favorites.favoriteContextPasteInsideOption"),this.favoriteContextPinOption=u("jraf.sidebar.favorites.favoriteContextPinOption"),this.favoriteContextUnpinOption=u("jraf.sidebar.favorites.favoriteContextUnpinOption"),this.favoriteContextDeleteOption=u("jraf.sidebar.favorites.favoriteContextDeleteOption"),this.favoriteContextMenuTarget=o.observable(),this.favoriteToCut=o.observable(),this.favoriteToCutIsFolder=o.pureComputed((function(){return e.favoriteToCut()&&e.favoriteToCut().isFolder})),this.targetFavoriteIsInsideFolder=o.pureComputed((function(){return e.favoriteContextMenuTarget()&&e.favoriteContextMenuTarget().parentFavItemId})),this.preventPasteAdjacentToTarget=o.pureComputed((function(){var t=e.targetFavoriteIsInsideFolder();return!e.favoriteToCut()||e.favoriteToCutIsFolder()&&t})),this.preventPasteInsideTarget=o.pureComputed((function(){return!e.favoriteToCut()||e.favoriteToCutIsFolder()})),this.includePasteInsideMenuItem=o.pureComputed((function(){return e.favoriteContextMenuTarget()&&e.favoriteContextMenuTarget().isFolder})),this.includePinFavoriteMenuItem=o.pureComputed((function(){return e.favoriteContextMenuTarget()&&!e.favoriteContextMenuTarget().isFolder&&!e.favoriteContextMenuTarget().isPinned()})),this.includeUnpinFavoriteMenuItem=o.pureComputed((function(){return e.favoriteContextMenuTarget()&&!e.favoriteContextMenuTarget().isFolder&&e.favoriteContextMenuTarget().isPinned()})),this.favoriteContextMenuAction=function(t){e._handleFavoriteContextMenuAction(t)},this.favoriteContextMenuBeforeOpen=function(t){e._handleFavoriteContextMenuBeforeOpen(t)},this.favoriteContextMenuActions={},this.favoriteContextMenuActions.edit=function(){e._handleFavoriteContextMenuEditAction()},this.favoriteContextMenuActions.cut=function(){e.favoriteToCut(e.favoriteContextMenuTarget())},this.favoriteContextMenuActions.before=function(){e._handleFavoriteContextMenuPasteAction("before")},this.favoriteContextMenuActions.after=function(){e._handleFavoriteContextMenuPasteAction("after")},this.favoriteContextMenuActions.inside=function(){e._handleFavoriteContextMenuPasteAction("inside")},this.favoriteContextMenuActions.pin=function(){e._favoritesContent.pinFavorite(e.favoriteContextMenuTarget().entryId)},this.favoriteContextMenuActions.unpin=function(){e._favoritesContent.unpinFavorite(e.favoriteContextMenuTarget().entryId)},this.favoriteContextMenuActions.delete=function(){e._handleFavoriteContextMenuDeleteAction()}},f.prototype._handleFavoriteContextMenuAction=function(e){var t=e.target.value;this.favoriteContextMenuTarget()&&t&&this.favoriteContextMenuActions[t]()},f.prototype._handleFavoriteContextMenuBeforeOpen=function(t){var o=document.getElementById(this.favoritesTreeId),i=(e(t.detail.originalEvent.target).parents(".oj-treeview-item").get(0)||e("#"+o.currentItem)[0]).id,r=this.guidToFavoriteMap[i];this.favoriteContextMenuTarget(r),e("#"+this.favoriteContextMenuId).ojMenu("refresh")},f.prototype._handleFavoriteContextMenuEditAction=function(){var e=this.favoriteContextMenuTarget();e&&(e.isFolder?this._openEditFolderDialog(e):this._openEditFavoriteDialog(e))},f.prototype._handleFavoriteContextMenuPasteAction=function(e){this._reorderFavorite(this.favoriteToCut(),this.favoriteContextMenuTarget(),e),this.favoriteToCut(void 0)},f.prototype._handleFavoriteContextMenuDeleteAction=function(){this.favoriteToCut()&&this.favoriteToCut().entryId===this.favoriteContextMenuTarget().entryId&&this.favoriteToCut(void 0),this._deleteFavorite(this.favoriteContextMenuTarget())},f.prototype.disconnected=function(){t.Logger.info("EditFavoritesPage.disconnected: Entering."),this.favoritesSubscription&&this.favoritesSubscription.dispose(),this._disposeOfFolderSubscriptions()},f.prototype._disposeOfFolderSubscriptions=function(){this.folderSubscriptions&&this.folderSubscriptions.forEach((function(e){e.dispose()}))},f.prototype.transitionCompleted=function(){t.Logger.info("EditFavoritesPage.transitionCompleted: Entering.");var e=function(e){e.currentTarget.validate()};document.getElementById(this.folderNameInputId).addEventListener("rawValueChanged",e),document.getElementById(this.customFavoriteNameInputId).addEventListener("rawValueChanged",e)},f}));