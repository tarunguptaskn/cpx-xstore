define(["jquery","ojs/ojcore","knockout","jraf/jrafcore","jraf/models/favorites/FavoritesContent","jraf/models/favorites/FavoritesConfig","jraf/models/UIShellManager","jraf/utils/ValidationUtils","jraf/models/Content","ojs/ojmodule-element-utils","ojs/ojknockouttemplateutils","ojs/ojknockout","ojs/ojbutton","ojs/ojselectcombobox","ojs/ojnavigationlist","ojs/ojmodule-element"],(function(e,t,i,a,o,s,r,n,l,d,h){"use strict";var u=t.Translations.getTranslatedString;function g(e){var t=this;this.favoriteHandlerKey=e?e.favoriteHandlerKey:void 0,this.hidePinnedFavorites=n.getBoolean(e.hidePinnedFavorites,!1),this.hideEditFavorites=n.getBoolean(e.hideEditFavorites,!1),this.favoritesNavListId=a.UIShell.generateUniqueId(),this.searchInputId=a.UIShell.generateUniqueId(),this.autosuggestOptionTemplateId=a.UIShell.generateUniqueId(),this.flatListToggleId=a.UIShell.generateUniqueId(),this.headerText=u("jraf.sidebar.favorites.title"),this.editFavoritesButtonLabel=u("jraf.sidebar.favorites.editFavoritesLabel"),this.defaultEditFavoritesPageTitle=u("jraf.sidebar.favorites.editFavoritesPageTitle"),this.editFavoritesPageTitle=e.editFavoritesPageTitle||this.defaultEditFavoritesPageTitle,this.toggleGroupViewLabel=u("jraf.sidebar.favorites.toggleLabelGroupView"),this.toggleFlatListViewLabel=u("jraf.sidebar.favorites.toggleLabelFlatListView"),this.loadingText=u("jraf.messages.loading"),this.searchHint=u("jraf.sidebar.favorites.searchHint"),this.noResultsText=u("jraf.messages.noResults"),this.minimumAutosuggestLength=g.MINIMUM_AUTOSUGGEST_LENGTH,this.searchString=i.observableArray([]),this._favoriteHandler=s.getInstance().getFavoriteHandler(this.favoriteHandlerKey),this._favoritesContent=o.getInstance(this._favoriteHandler.getFavoritesService(),this.favoriteHandlerKey),this._favorites=this._favoritesContent.getFavorites();var r=i.observable(!1);this.menuDataLoaded=i.pureComputed((function(){return r()})),this.drilledPath=i.observableArray([]),this.isHierarchyRoot=i.pureComputed((function(){return t.drilledPath().length<1})),this.lastDrilledNode=i.pureComputed((function(){return t.isHierarchyRoot()?null:t.drilledPath()[t.drilledPath().length-1]})),this.drilledNodeLabel=i.pureComputed((function(){return t.isHierarchyRoot()?"":t._getLocalizedTitle(t.lastDrilledNode().favorite.entryId)()})),this._initializeFlatListToggle();var l={name:"jraf/favorites/FavoritesMenuBody",params:{favoritesNavListId:this.favoritesNavListId,menuDataLoaded:r,favoriteHandlerKey:this.favoriteHandlerKey,hidePinnedFavorites:this.hidePinnedFavorites,drilledPath:this.drilledPath,openContentCallback:function(e){t._openContent(e)},flatListEnabled:t.flatListEnabled}};this.favoritesBodyModuleConfig=d.createConfig(l),this.editFavorites=function(){t._handleEditFavorites()},this.navigateUpHierarchy=function(){t._handleNavigateUpHierarchy()},this._initializeFavoritesSearch(),this.getAutosuggestOptionTemplate=function(){return h.getRenderer(t.autosuggestOptionTemplateId)},this.searchInputPickerAttributes={class:"jraf-sidebar-search"}}return g.MINIMUM_AUTOSUGGEST_LENGTH=1,g.prototype._getLocalizedTitle=function(e){return this._favoriteHandler.getLocalizedTitle(e)},g.prototype._openContent=function(e){this._favoriteHandler.openContent(e),this._closeFavoritesMenu()},g.prototype._closeFavoritesMenu=function(){r.closeMenu({closeOverlayMenuOnly:!0})},g.prototype._handleEditFavorites=function(){r.openContent(this._getEditFavoritesPageContent()),this._closeFavoritesMenu(),this.isHierarchyRoot()||this.navigateUpHierarchy()},g.prototype._getEditFavoritesPageContent=function(){return l.createModuleGlobalModalPageContent(this.editFavoritesPageTitle,{name:"jraf/favorites/EditFavoritesPage",params:{hidePinnedFavorites:this.hidePinnedFavorites,favoriteHandlerKey:this.favoriteHandlerKey}})},g.prototype._handleNavigateUpHierarchy=function(t,i){var a=this.lastDrilledNode().guid;e("#"+this.favoritesNavListId).ojNavigationList("collapse",a,!0)},g.prototype._initializeFavoritesSearch=function(){var e=this;this._fullAutosuggestOptions=i.pureComputed((function(){var e=[],t=this._favorites();return t.length>0&&this._buildFavoritesAutosuggestOptions(e,t),e}),this),this.autosuggestSearch=function(t){return n.isString(t.term)?e._getAutosuggestOptions(t.term):Promise.resolve([])},this.handleAutosuggestSelect=function(t,i){e._handleAutosuggestSelect(t)}},g.prototype._buildFavoritesAutosuggestOptions=function(e,t,a){for(var o=a?this._favoriteHandler.getLocalizedTitle(a.entryId):"",s=""!==o,r=0;r<t.length;r++){var n=t[r];n.isFolder?this._buildFavoritesAutosuggestOptions(e,n.children(),n):e.push({value:""+n.entryId,label:i.unwrap(this._favoriteHandler.getLocalizedTitle(n.entryId)),path:o,pathAvailable:s})}},g.prototype._getAutosuggestOptions=function(e){var t=this._fullAutosuggestOptions().filter((function(t){var a=e.toLowerCase(),o=i.unwrap(t.label).toLowerCase(),s=i.unwrap(t.path).toLowerCase();return o.indexOf(a)>=0||s.indexOf(a)>=0}));return 0===t.length&&t.push({label:this.noResultsText,pathAvailable:!1}),Promise.resolve(t)},g.prototype._handleAutosuggestSelect=function(e){var t=e.target.value;return t&&(this._openContent(Number(t)),this.searchString.pop()),!0},g.prototype._initializeFlatListToggle=function(){var e=this;this.hasFolders=this._favoritesContent.getHasFoldersObservable(),this.flatListToggle=i.observableArray([]),this.flatListEnabled=i.pureComputed((function(){return e.flatListToggle().length>0})),this.flatListToggleLabel=i.pureComputed((function(){return this.flatListEnabled()?this.toggleGroupViewLabel:this.toggleFlatListViewLabel}),this)},g}));