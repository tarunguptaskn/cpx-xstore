define(["ojs/ojcore","knockout","jraf/jrafcore","jraf/models/UIShellManager","jraf/models/Content","jraf/utils/ValidationUtils","ojs/ojarraydataprovider","ojs/ojinputtext","ojs/ojselectsingle","ojs/ojlistview","ojs/ojknockout"],(function(e,t,a,r,l,i,s){"use strict";var n=e.Translations.getTranslatedString;function c(e){if(!(i.isObjectStrict(e)&&i.isFunction(e.searchCallback)&&i.isFunction(e.searchSectionFilterCallback)&&i.isFunction(e.searchContextCallback)&&i.isFunction(e.closeSearchCallback)))throw new TypeError("SearchPopup: Missing required parameters");this.sectionFilterInputId=a.UIShell.generateUniqueId(),this.searchInputId=a.UIShell.generateUniqueId(),this.mobileSearchResultTemplateId=a.UIShell.generateUniqueId(),this.searchSectionFilterCallback=e.searchSectionFilterCallback,this.searchCallback=e.searchCallback,this.searchContextCallback=e.searchContextCallback,this.closeSearchCallback=e.closeSearchCallback,this.searchPlaceholderText=n("jraf.global.searchPlaceholderText"),this.noResultsLabel=n("jraf.messages.noResults"),this.closeSearchLabel=n("jraf.global.deactivateGlobalSearchAriaLabel"),this.searchFilterComponentLabel=n("jraf.global.searchFilterComponentLabel"),this._initializeSearch(),this._initializeFilters()}return c.DEFAULT_FILTER_SECTION={value:-1,label:n("jraf.global.searchDefaultFilterLabel")},c.prototype._initializeSearch=function(){var e=this;this.searchString=t.observableArray([]),this.searchResults=t.observableArray([]),this.hasSearchResults=t.pureComputed((function(){return this.searchResults().length>0}),this),this.searchOptionChange=function(t,a){e._handleSearchStringChange(t,a)},this.launchSearchResult=function(t){e._launchSearchResult(t.value)}},c.prototype._initializeFilters=function(){this.sectionFilterSelection=t.observableArray([c.DEFAULT_FILTER_SECTION.value]),this.sectionFilters=t.observableArray([{value:c.DEFAULT_FILTER_SECTION.value,label:c.DEFAULT_FILTER_SECTION.label}]),this.sectionFiltersDataProvider=new s(this.sectionFilters,{keyAttributes:"value"}),this._initializeSectionFilterList()},c.prototype._initializeSectionFilterList=function(){var t=this;return this.searchSectionFilterCallback().then((function(e){t.sectionFilters(t._parseSectionFilterList(e))}),(function(t){e.Logger.warn("SearchPopup._getSectionFilterOptions: Error loading sections: ",t)}))},c.prototype._parseSectionFilterList=function(e){var t=[];t.push({value:c.DEFAULT_FILTER_SECTION.value,label:c.DEFAULT_FILTER_SECTION.label});for(var a=0;a<e.length;a++){var r=e[a];t.push({value:r.value,label:""+r.label})}return t},c.prototype._handleSearchStringChange=function(e,t){if("rawValueChanged"===e.type){var a=e.detail.value;i.isNonemptyString(a)?this._executeSearch(a):this.searchResults([])}},c.prototype._executeSearch=function(t){var a=this,r=this._getSearchParam(t);return this.searchCallback(r).then((function(e){a.searchResults(a._parseSearchResults(e))}),(function(t){e.Logger.warn("SearchPopup._executeSearch: Error running search: ",t)}))},c.prototype._getSearchParam=function(e){var t=this.sectionFilterSelection()[0],a={searchText:e};return t!==c.DEFAULT_FILTER_SECTION.value&&(a.sectionId=t),a},c.prototype._parseSearchResults=function(e){for(var t=[],a={},r=0;r<e.length;r++){var l=e[r];t.push({value:""+l.value,label:l.label,metadata:l.metadata||""}),a[l.label]=void 0===a[l.label]}for(var i=0;i<t.length;i++){var s=t[i];a[s.label]||(s.label=s.label+" "+s.value)}return t},c.prototype._launchSearchResult=function(e){var t=this;return this.searchContextCallback(e).then((function(e){var a=new l(e);a&&(r.openContent(a),t.searchString([""]),t.closeSearchCallback())}))},c}));