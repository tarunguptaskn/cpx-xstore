define(["ojs/ojcore","knockout","jquery","jraf/jrafcore","jraf/models/UIShellManager","factories/AlertDataFactory","ojs/ojknockouttemplateutils","ojs/ojcollectiondataprovider","ojs/ojlistdataproviderview","ojs/ojarraydataprovider","ojs/ojknockout-keyset","ojs/ojtable","ojs/ojpagingcontrol","ojs/ojcollectiontabledatasource","ojs/ojknockout","ojs/ojcomposite","jraf/composites/oj-rgbu-jraf-message-dialog/loader"],(function(e,t,r,l,o,n,a,i,s,d,u){let c=e.Translations.getTranslatedString;return function(e){let r=this;console.debug("Initting status module"),console.debug("fetch alerts for deviceNumber "+e.deviceNumber),r.alertsTableId=l.UIShell.generateUniqueId(),r.errContainerId=l.UIShell.generateUniqueId(),r.alertErrorDialogId=l.UIShell.generateUniqueId(),r.alertWarnDialogId=l.UIShell.generateUniqueId(),r.alertErrorDialogMessageBodyId=l.UIShell.generateUniqueId(),r.alertWarnDialogMessageBodyId=l.UIShell.generateUniqueId(),r.currentStoreStateText=t.observable(),r.isOpen=t.observable(),r.cancelButtonLabel=c("xenv.general.Delete"),r.okButtonLabel=c("jraf.common.ok"),r.noDataMsg=c("xenv.status.NoData"),r.statusHeader=c("xenv.status.HeaderLabel"),r.deviceNumber=e.deviceNumber,r.selectedRows=new u.ObservableKeySet,r.alertsTableDatasource=t.observable(),r.columnList=[{style:"width: 24px;"},{headerText:c("xenv.status.AlertDescription"),style:"width: calc(100% - 44px); white-space: normal"}];let o=["noAlerts"];r.getAlerts=function(){r.table=document.getElementById(r.alertsTableId),r.errContainer=document.getElementById(r.errContainerId),null!==r.table&&(r.firstColumnHeader=document.getElementById(r.alertsTableId+":_hdrCol0"),null!==r.firstColumnHeader&&(r.firstColumnHeaderStyle=r.firstColumnHeader.getAttribute("style"),null!==r.firstColumnHeaderStyle&&-1===r.firstColumnHeaderStyle.indexOf("visibility")&&(""===r.firstColumnHeaderStyle?r.newStyle="":r.newStyle=r.firstColumnHeaderStyle+" ",r.firstColumnHeader.setAttribute("style",r.newStyle+"visibility: hidden")),r.firstColumnHeader.setAttribute("style","visibility: hidden"))),console.debug("Updating alerts"),r.alertCollection=n.createAlertCollection(r.deviceNumber),new Promise((function(e,t){r.alertCollection.fetch({success:function(e,t,l){null!==r.errContainer&&(r.errContainer.style.display="none"),null!==r.table&&(r.table.style.display="inline");let n,a=[];for(n in e.models)a[n]=e.models[n].id;(function(e){if(e.length!==o.length)return!1;{let t;for(t in e)if(!o.includes(e[t]))return!1}return!0})(a)||(r.listDataProvider=new s(new i(e)),r.alertsTableDatasource(r.listDataProvider),r.alertsTableDatasource.valueHasMutated(),o=a)},error:function(e,t,l){null!==r.table&&(r.table.style.display="none"),null!==r.errContainer&&(r.errContainer.innerHTML=c("xenv.general.NoComms"),r.errContainer.style.display="block",o=["noAlerts"])}})})).catch((function(e){console.error(e),o=["noAlerts"]}))},r.getAlerts(),setInterval(r.getAlerts,5e3),this.rowRenderer=function(e){let t=e.rowContext.parentElement,r=document.createElement("td"),l=function(e){let t="SYSTEM_ERROR"===e?"oj-fwk-icon oj-fwk-icon-status-error":"oj-fwk-icon oj-fwk-icon-status-warning",r=c("SYSTEM_ERROR"===e?"jraf.common.error":"jraf.common.warning"),l=document.createElement("span");return l.setAttribute("role","img"),l.setAttribute("class",t),l.setAttribute("title",r),l}(e.row.promptKey);r.appendChild(l);let o=document.createElement("td");o.innerHTML=e.row.mainMsg,t.appendChild(r),t.appendChild(o)}.bind(this),this.selectedChangedListener=function(e,t){let l=e.detail.value.row.values().keys().next().value;if(void 0===l)return;let o=r.alertCollection.get(l).attributes.detail;if(void 0===o)return;r.alertCollection.get(l).attributes.mainMsg;let n="error";"SYSTEM_ERROR"!==r.alertCollection.get(l).attributes.promptKey&&(n="warning");let a,i,s=document.getElementById("messageBodyPre");null===s&&(s=document.createElement("pre"),s.setAttribute("style","width: 95%; word-wrap: break-word; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap;")),s.id="messageBodyPre",s.innerHTML=o,"error"===n?(a=document.getElementById(r.alertErrorDialogMessageBodyId),i=document.getElementById(r.alertErrorDialogId)):(a=document.getElementById(r.alertWarnDialogMessageBodyId),i=document.getElementById(r.alertWarnDialogId)),a.appendChild(s),i.dialogStyle={"max-width":"90%"},i.open()},this.deleteAlert=function(e){let t=r.selectedRows().values().values().next().value;console.debug("marker file to delete :"+t),r.alertCollection.get(t).destroy({data:JSON.stringify({alertId:t}),xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"}}),document.getElementById(r.alertErrorDialogId).close(),document.getElementById(r.alertWarnDialogId).close(),r.alertsTableDatasource.valueHasMutated()},this.closeDialog=function(e){r.selectedRows.clear(),document.getElementById(r.alertErrorDialogId).close(),document.getElementById(r.alertWarnDialogId).close()}}}));